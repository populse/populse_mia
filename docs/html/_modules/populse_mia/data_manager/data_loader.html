<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>populse_mia.data_manager.data_loader &#8212; populse_mia 3.0.0-dev+881d2af6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=f63d8bfa" />
    <link rel="stylesheet" type="text/css" href="../../../_static/haiku.css?v=dfa0e015" />
    <script src="../../../_static/documentation_options.js?v=a73ba755"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../index.html">
          <span>populse_mia 3.0.0-dev+881d2af6 documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.data_manager.data_loader</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for populse_mia.data_manager.data_loader</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module to handle the importation from MRIFileManager and its progress.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - ImportProgress: Inherit from QProgressDialog and handle the</span>
<span class="sd">                          progress bar</span>
<span class="sd">        - ImportWorker: Inherit from QThread and manage the threads</span>

<span class="sd">    :Functions:</span>
<span class="sd">        - read_log: Show the evolution of the progress bar and returns its</span>
<span class="sd">                    feedback</span>
<span class="sd">        - tags_from_file: Returns a list of [tag, value] contained in a Json</span>
<span class="sd">                          file</span>
<span class="sd">        - verify_scans: Check if the project&#39;s scans have been modified</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># import datetime</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">hashlib</span>  <span class="c1"># To generate the md5 of each path</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">time_time</span>

<span class="c1"># PyQt5 imports</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">pyqtSignal</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QProgressDialog</span>

<span class="c1"># Populse_mia import</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_BOOLEAN</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_DATE</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_DATETIME</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_FLOAT</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_INTEGER</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_BOOLEAN</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_DATE</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_DATETIME</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_FLOAT</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_INTEGER</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_STRING</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_TIME</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_MAPPING</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_STRING</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_TIME</span><span class="p">,</span>
    <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
    <span class="n">TAG_FILENAME</span><span class="p">,</span>
    <span class="n">TAG_ORIGIN_BUILTIN</span><span class="p">,</span>
    <span class="n">TAG_ORIGIN_USER</span><span class="p">,</span>
    <span class="n">TAG_TYPE</span><span class="p">,</span>
    <span class="n">TYPE_BVAL</span><span class="p">,</span>
    <span class="n">TYPE_BVEC</span><span class="p">,</span>
    <span class="n">TYPE_BVEC_BVAL</span><span class="p">,</span>
    <span class="n">TYPE_NII</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ImportProgress">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportProgress">[docs]</a>
<span class="k">class</span> <span class="nc">ImportProgress</span><span class="p">(</span><span class="n">QProgressDialog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays a progress bar for the import process.</span>

<span class="sd">    :param project (Project): The project object being imported.</span>

<span class="sd">    Methods:</span>
<span class="sd">        - onProgress: Updates the progress bar value.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ImportProgress.__init__">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportProgress.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;Please wait while the paths are being imported...&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Importing the paths&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">Window</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowTitleHint</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CustomizeWindowHint</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumDuration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Required for macOS compatibility:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">ImportWorker</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onProgress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="ImportProgress.onProgress">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportProgress.onProgress">[docs]</a>
    <span class="k">def</span> <span class="nf">onProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the progress bar value.</span>

<span class="sd">        :param value (int): The current progress value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ImportWorker">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportWorker">[docs]</a>
<span class="k">class</span> <span class="nc">ImportWorker</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Worker thread for importing scans into the project database.</span>

<span class="sd">    This class manages the import process, reading from export logs,</span>
<span class="sd">    processing scan files, and updating the database accordingly.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        project: A Project object</span>
<span class="sd">        progress: An ImportProgress object</span>
<span class="sd">        notifyProgress: Signal emitted to update the progress bar</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - run : override the QThread run method.</span>
<span class="sd">        - scans_added: get a copy of the scans_added list in a thread-safe</span>
<span class="sd">                       manner.</span>
<span class="sd">        - _add_tag_to_database: add a new tag to the database</span>
<span class="sd">        - _apply_default_values: apply default values for user-defined tags</span>
<span class="sd">        - _convert_datetime_values: convert string values to datetime objects</span>
<span class="sd">        - _ensure_associated_file_tag_exists: ensure the associated file tag</span>
<span class="sd">                                              exists in the database</span>
<span class="sd">        - _extract_tag_info: extract tag information from properties</span>
<span class="sd">        - _get_export_logs: get the export logs from the raw data folder</span>
<span class="sd">        - _process_associated_file: process an associated file</span>
<span class="sd">        - _process_associated_files: process associated bvec/bval files</span>
<span class="sd">        - _process_datetime_format: process datetime format strings</span>
<span class="sd">        - _process_file_tags: process tags from a file</span>
<span class="sd">        - _process_fsl_format_files: process FSL format bvec/bval files</span>
<span class="sd">        - _process_list_values: process list values</span>
<span class="sd">        - _process_log_entries: process each log entry to import scans</span>
<span class="sd">        - _process_mrtrix_format_file: process MRtrix format bvec/bval file</span>
<span class="sd">        - _process_scan_file: process a single scan file and its associated</span>
<span class="sd">                              files</span>
<span class="sd">        - _update_database: update the database with the processed documents.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Signal to update the progress bar</span>
    <span class="n">notifyProgress</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<div class="viewcode-block" id="ImportWorker.__init__">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportWorker.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="c1"># Track scans added during the import process. scans_added should</span>
        <span class="c1"># always be accessed through the lock, and copied before releasing</span>
        <span class="c1"># the lock, because its value will change inside the thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scans_added</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="ImportWorker.run">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportWorker.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the import process.</span>

<span class="sd">        This method overrides the QThread run method and is executed when</span>
<span class="sd">        the worker is started. It processes the export logs, imports scans,</span>
<span class="sd">        and updates the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">time_time</span><span class="p">()</span>
        <span class="n">raw_data_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_data&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Process export logs from MRIManager</span>
        <span class="n">list_dict_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_export_logs</span><span class="p">(</span><span class="n">raw_data_folder</span><span class="p">)</span>
        <span class="c1"># For history tracking</span>
        <span class="n">historyMaker</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;add_scans&quot;</span><span class="p">]</span>

        <span class="c1"># Reset scans_added at the start of a new import</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scans_added</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">documents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">values_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tags_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tags_names_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Process each log entry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_log_entries</span><span class="p">(</span>
            <span class="n">list_dict_log</span><span class="p">,</span>
            <span class="n">raw_data_folder</span><span class="p">,</span>
            <span class="n">documents</span><span class="p">,</span>
            <span class="n">values_added</span><span class="p">,</span>
            <span class="n">tags_added</span><span class="p">,</span>
            <span class="n">tags_names_added</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Apply default values for user-defined tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_default_values</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">values_added</span><span class="p">)</span>
        <span class="c1"># Update the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_database</span><span class="p">(</span>
            <span class="n">documents</span><span class="p">,</span> <span class="n">tags_added</span><span class="p">,</span> <span class="n">values_added</span><span class="p">,</span> <span class="n">historyMaker</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Data export duration in the database: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">time_time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">begin</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> s&quot;</span>
        <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scans_added</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a copy of the scans_added list in a thread-safe manner.&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scans_added</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_tag_to_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_info</span><span class="p">,</span> <span class="n">tags_added</span><span class="p">,</span> <span class="n">tags_names_added</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new tag to the database.</span>

<span class="sd">        :param tag_info (dict): Tag information dictionary</span>
<span class="sd">        :param tags_added (list): List to track added tags</span>
<span class="sd">        :param tags_names_added (list): List to track added tag names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag_definition</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;collection_name&quot;</span><span class="p">:</span> <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
            <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
            <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">TAG_ORIGIN_BUILTIN</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
            <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Add to current and initial collections</span>
        <span class="n">tags_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_definition</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">tag_definition</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTION_INITIAL</span>
        <span class="n">tags_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_definition</span><span class="p">)</span>
        <span class="n">tags_names_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_apply_default_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">documents</span><span class="p">,</span> <span class="n">values_added</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply default values for user-defined tags.</span>

<span class="sd">        :param documents (dict): Dictionary containing document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TAG_ORIGIN_USER</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_added</span><span class="p">:</span>

                    <span class="c1"># Skip if tag has no default value</span>
                    <span class="c1"># or document already has a value</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="ow">or</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># Add default value to document and history</span>
                    <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">scan</span><span class="p">,</span>
                            <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
                            <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">documents</span><span class="p">[</span><span class="n">scan</span><span class="p">][</span><span class="n">tag</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span>
                        <span class="s2">&quot;default_value&quot;</span>
                    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_convert_datetime_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert string values to datetime objects.</span>

<span class="sd">        :param tag_info (dict): Tag information dictionary</span>

<span class="sd">        :return (dict): Updated tag information dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_TIME</span><span class="p">:</span>
                    <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_value</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_DATE</span><span class="p">:</span>
                    <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_value</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_value</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="c1"># Keep original value if conversion fails</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">tag_info</span>

    <span class="k">def</span> <span class="nf">_ensure_associated_file_tag_exists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">database_data</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tags_added</span><span class="p">,</span> <span class="n">tags_names_added</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure the associated file tag exists in the database.</span>

<span class="sd">        :param database_data: Context-Managed database</span>
<span class="sd">        :param tag_name (str): Name of the tag</span>
<span class="sd">        :param tags_added (list): List to track added tags</span>
<span class="sd">        :param tags_names_added (list): List to track added tag names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>
            <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">tag_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags_names_added</span>
        <span class="p">):</span>
            <span class="n">tag_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tag_name</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Associated NIfTI file&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tag_to_database</span><span class="p">(</span><span class="n">tag_info</span><span class="p">,</span> <span class="n">tags_added</span><span class="p">,</span> <span class="n">tags_names_added</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_tag_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract tag information from properties.</span>

<span class="sd">        :param tag_name (str): Name of the tag</span>
<span class="sd">        :param properties (any): Properties of the tag</span>

<span class="sd">        :return (dict): Dictionary containing tag information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tag_name</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Extract properties based on type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span>

        <span class="c1"># Handle datetime formats</span>
        <span class="k">if</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]:</span>
            <span class="n">tag_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_datetime_format</span><span class="p">(</span><span class="n">tag_info</span><span class="p">)</span>

        <span class="c1"># Process list (or iterable object) values</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="nb">str</span>
        <span class="p">):</span>
            <span class="n">tag_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_list_values</span><span class="p">(</span><span class="n">tag_info</span><span class="p">)</span>

        <span class="c1"># Convert datetime values</span>
        <span class="k">if</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">FIELD_TYPE_DATETIME</span><span class="p">,</span>
            <span class="n">FIELD_TYPE_DATE</span><span class="p">,</span>
            <span class="n">FIELD_TYPE_TIME</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">tag_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_datetime_values</span><span class="p">(</span><span class="n">tag_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tag_info</span>

    <span class="k">def</span> <span class="nf">_get_export_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the export logs from the raw data folder.</span>

<span class="sd">        :param raw_data_folder (str): Path to the raw data folder</span>

<span class="sd">        Return (list): Log entries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find all export logs</span>
        <span class="n">list_logs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_data_folder</span><span class="p">,</span> <span class="s2">&quot;logExport*.json&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_logs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Read the most recent log</span>
        <span class="n">log_to_read</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">list_logs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_to_read</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_associated_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database_data</span><span class="p">,</span>
        <span class="n">file_database_path</span><span class="p">,</span>
        <span class="n">checksum</span><span class="p">,</span>
        <span class="n">file_type</span><span class="p">,</span>
        <span class="n">associated_file_path</span><span class="p">,</span>
        <span class="n">tag_name</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">,</span>
        <span class="n">values_added</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an associated file.</span>

<span class="sd">        :param database_data: Context-Managed database</span>
<span class="sd">        :param file_database_path (str): Relative path of the file</span>
<span class="sd">        :param checksum (str): MD5 checksum of the file</span>
<span class="sd">        :param file_type (Type): Type of the file</span>
<span class="sd">        :param associated_file_path (str): Path of the associated main file</span>
<span class="sd">        :param tag_name (str): Name of the association tag</span>
<span class="sd">        :param documents (dict): Dictionary to store document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">document_not_existing</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
            <span class="n">primary_key</span><span class="o">=</span><span class="n">file_database_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scans_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_database_path</span><span class="p">)</span>

        <span class="c1"># Initialize document</span>
        <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TAG_FILENAME</span><span class="p">:</span> <span class="n">file_database_path</span><span class="p">,</span>
            <span class="n">TAG_CHECKSUM</span><span class="p">:</span> <span class="n">checksum</span><span class="p">,</span>
            <span class="n">TAG_TYPE</span><span class="p">:</span> <span class="n">file_type</span><span class="p">,</span>
            <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">associated_file_path</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Add values for history if document is new</span>
        <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>
            <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">file_database_path</span><span class="p">,</span> <span class="n">TAG_CHECKSUM</span><span class="p">,</span> <span class="n">checksum</span><span class="p">,</span> <span class="n">checksum</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">file_database_path</span><span class="p">,</span> <span class="n">TAG_TYPE</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">file_type</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">file_database_path</span><span class="p">,</span>
                    <span class="n">tag_name</span><span class="p">,</span>
                    <span class="n">associated_file_path</span><span class="p">,</span>
                    <span class="n">associated_file_path</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_associated_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database_data</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">,</span>
        <span class="n">raw_data_folder</span><span class="p">,</span>
        <span class="n">file_database_path</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">,</span>
        <span class="n">values_added</span><span class="p">,</span>
        <span class="n">tags_added</span><span class="p">,</span>
        <span class="n">tags_names_added</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process associated bvec/bval files.</span>

<span class="sd">        :param database_data: Context-Managed database</span>
<span class="sd">        :param file_name (str): Base name of the file</span>
<span class="sd">        :param raw_data_folder (str): Path to the raw data folder</span>
<span class="sd">        :param file_database_path (str): Relative path of the main file</span>
<span class="sd">        :param documents (dict): Dictionary to store document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        :param tags_added (list): List to track added tags</span>
<span class="sd">        :param tags_names_added (list): List to track added tag names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define paths for FSL and MRtrix format files</span>
        <span class="n">bvec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_data_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.bvec&quot;</span><span class="p">)</span>
        <span class="n">bval_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_data_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.bval&quot;</span><span class="p">)</span>
        <span class="n">bvec_bval_mrtrix_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">raw_data_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">-bvecs-bvals-MRtrix.txt&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Ensure associated file tag exists</span>
        <span class="n">tag_name</span> <span class="o">=</span> <span class="s2">&quot;AssociatedNIfTIFile&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_associated_file_tag_exists</span><span class="p">(</span>
            <span class="n">database_data</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tags_added</span><span class="p">,</span> <span class="n">tags_names_added</span>
        <span class="p">)</span>

        <span class="c1"># Process FSL format files</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bvec_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bval_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_fsl_format_files</span><span class="p">(</span>
                <span class="n">database_data</span><span class="p">,</span>
                <span class="n">bvec_path</span><span class="p">,</span>
                <span class="n">bval_path</span><span class="p">,</span>
                <span class="n">file_database_path</span><span class="p">,</span>
                <span class="n">tag_name</span><span class="p">,</span>
                <span class="n">documents</span><span class="p">,</span>
                <span class="n">values_added</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Process MRtrix format file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bvec_bval_mrtrix_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_mrtrix_format_file</span><span class="p">(</span>
                <span class="n">database_data</span><span class="p">,</span>
                <span class="n">bvec_bval_mrtrix_path</span><span class="p">,</span>
                <span class="n">file_database_path</span><span class="p">,</span>
                <span class="n">tag_name</span><span class="p">,</span>
                <span class="n">documents</span><span class="p">,</span>
                <span class="n">values_added</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_datetime_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process datetime format strings.</span>

<span class="sd">        :param tag_info (dict): Tag information dictionary</span>

<span class="sd">        :return (dict): Updated tag information dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">format_str</span> <span class="o">=</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>
        <span class="c1"># Convert from display format to Python datetime format</span>
        <span class="n">format_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;yyyy&quot;</span><span class="p">:</span> <span class="s2">&quot;%Y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MM&quot;</span><span class="p">:</span> <span class="s2">&quot;%m&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dd&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HH&quot;</span><span class="p">:</span> <span class="s2">&quot;%H&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mm&quot;</span><span class="p">:</span> <span class="s2">&quot;%M&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ss&quot;</span><span class="p">:</span> <span class="s2">&quot;%S&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SSS&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">display_fmt</span><span class="p">,</span> <span class="n">py_fmt</span> <span class="ow">in</span> <span class="n">format_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">format_str</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">display_fmt</span><span class="p">,</span> <span class="n">py_fmt</span><span class="p">)</span>

        <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_str</span>

        <span class="c1"># Determine datetime type based on format components</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">format_str</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span> <span class="s2">&quot;%m&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;%H&quot;</span><span class="p">,</span> <span class="s2">&quot;%M&quot;</span><span class="p">,</span> <span class="s2">&quot;%S&quot;</span><span class="p">]):</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_DATETIME</span>

        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">format_str</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span> <span class="s2">&quot;%m&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">]):</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_DATE</span>

        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">format_str</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;%H&quot;</span><span class="p">,</span> <span class="s2">&quot;%M&quot;</span><span class="p">,</span> <span class="s2">&quot;%S&quot;</span><span class="p">]):</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_TIME</span>

        <span class="k">return</span> <span class="n">tag_info</span>

    <span class="k">def</span> <span class="nf">_process_file_tags</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database_data</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">,</span>
        <span class="n">path_name</span><span class="p">,</span>
        <span class="n">file_database_path</span><span class="p">,</span>
        <span class="n">document_not_existing</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">,</span>
        <span class="n">values_added</span><span class="p">,</span>
        <span class="n">tags_added</span><span class="p">,</span>
        <span class="n">tags_names_added</span><span class="p">,</span>
        <span class="n">tags_to_exclude</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process tags from a file.</span>

<span class="sd">        :param database_data: Context-Managed database</span>
<span class="sd">        :param file_name (str): Base name of the file</span>
<span class="sd">        :param path_name (str): Path to the file directory</span>
<span class="sd">        :param file_database_path (str): Relative path in the database</span>
<span class="sd">        :param document_not_existing (bool): Whether the document is new</span>
<span class="sd">        :param documents (dict): Dictionary to store document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        :param tags_added (list): List to track added tags</span>
<span class="sd">        :param tags_names_added (list): List to track added tag names</span>
<span class="sd">        :param tags_to_exclude (list): List of tags to exclude</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Process each tag from the file</span>
        <span class="k">for</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">properties</span> <span class="ow">in</span> <span class="n">tags_from_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">path_name</span><span class="p">):</span>

            <span class="c1"># Skip excluded tags</span>
            <span class="k">if</span> <span class="n">tag_name</span> <span class="ow">in</span> <span class="n">tags_to_exclude</span> <span class="ow">or</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s2">&quot;Json_Version&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Extract tag information</span>
            <span class="n">tag_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tag_info</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>

            <span class="c1"># Skip if no value</span>
            <span class="k">if</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Add tag to database if it doesn&#39;t exist</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                <span class="p">)</span>
                <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">tag_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags_names_added</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_tag_to_database</span><span class="p">(</span>
                    <span class="n">tag_info</span><span class="p">,</span> <span class="n">tags_added</span><span class="p">,</span> <span class="n">tags_names_added</span>
                <span class="p">)</span>

            <span class="c1"># Add value to document and history if document is new</span>
            <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>
                <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">file_database_path</span><span class="p">,</span>
                        <span class="n">tag_name</span><span class="p">,</span>
                        <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
                        <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">][</span><span class="n">tag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_process_fsl_format_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database_data</span><span class="p">,</span>
        <span class="n">bvec_path</span><span class="p">,</span>
        <span class="n">bval_path</span><span class="p">,</span>
        <span class="n">file_database_path</span><span class="p">,</span>
        <span class="n">tag_name</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">,</span>
        <span class="n">values_added</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process FSL format bvec/bval files.</span>

<span class="sd">        :param database_data: Context-Managed database</span>
<span class="sd">        :param bvec_path (str): Path to the bvec file</span>
<span class="sd">        :param bval_path (str): Path to the bval file</span>
<span class="sd">        :param file_database_path (str): Relative path of the main file</span>
<span class="sd">        :param tag_name (str): Name of the association tag</span>
<span class="sd">        :param documents (dict): Dictionary to store document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Process bvec file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bvec_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bvec_file</span><span class="p">:</span>
            <span class="n">original_md5_bvec</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">bvec_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="n">bvec_database_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">bvec_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_associated_file</span><span class="p">(</span>
            <span class="n">database_data</span><span class="p">,</span>
            <span class="n">bvec_database_path</span><span class="p">,</span>
            <span class="n">original_md5_bvec</span><span class="p">,</span>
            <span class="n">TYPE_BVEC</span><span class="p">,</span>
            <span class="n">file_database_path</span><span class="p">,</span>
            <span class="n">tag_name</span><span class="p">,</span>
            <span class="n">documents</span><span class="p">,</span>
            <span class="n">values_added</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Process bval file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bval_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bval_file</span><span class="p">:</span>
            <span class="n">original_md5_bval</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">bval_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="n">bval_database_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">bval_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_associated_file</span><span class="p">(</span>
            <span class="n">database_data</span><span class="p">,</span>
            <span class="n">bval_database_path</span><span class="p">,</span>
            <span class="n">original_md5_bval</span><span class="p">,</span>
            <span class="n">TYPE_BVAL</span><span class="p">,</span>
            <span class="n">file_database_path</span><span class="p">,</span>
            <span class="n">tag_name</span><span class="p">,</span>
            <span class="n">documents</span><span class="p">,</span>
            <span class="n">values_added</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_list_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process list values.</span>

<span class="sd">        :param tag_info (dict): Tag information dictionary</span>

<span class="sd">        return (dict): Updated tag information dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Convert type to list type</span>
            <span class="k">if</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">:</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_STRING</span>

            <span class="k">elif</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_INTEGER</span><span class="p">:</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_INTEGER</span>

            <span class="k">elif</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_FLOAT</span><span class="p">:</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_FLOAT</span>

            <span class="k">elif</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_BOOLEAN</span><span class="p">:</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_BOOLEAN</span>

            <span class="k">elif</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_DATE</span><span class="p">:</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_DATE</span>

            <span class="k">elif</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_DATETIME</span><span class="p">:</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_DATETIME</span>

            <span class="k">elif</span> <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIELD_TYPE_TIME</span><span class="p">:</span>
                <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_TIME</span>

        <span class="c1"># Extract value from list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">tag_info</span>

    <span class="k">def</span> <span class="nf">_process_log_entries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">list_dict_log</span><span class="p">,</span>
        <span class="n">raw_data_folder</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">,</span>
        <span class="n">values_added</span><span class="p">,</span>
        <span class="n">tags_added</span><span class="p">,</span>
        <span class="n">tags_names_added</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process each log entry to import scans.</span>

<span class="sd">        :param list_dict_log (list): Log entries</span>
<span class="sd">        :param raw_data_folder (str): Path to the raw data folder</span>
<span class="sd">        :param documents (dict): Dictionary to store document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        :param tags_added (list): List to track added tags</span>
<span class="sd">        :param tags_names_added (list): List to track added tag names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># List of tags to exclude</span>
        <span class="n">tags_to_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Dataset data file&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset header file&quot;</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">dict_log</span> <span class="ow">in</span> <span class="n">list_dict_log</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">dict_log</span><span class="p">[</span><span class="s2">&quot;StatusExport&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Export ok&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Process the main scan file</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">dict_log</span><span class="p">[</span><span class="s2">&quot;NameFile&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_scan_file</span><span class="p">(</span>
                    <span class="n">database_data</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="p">,</span>
                    <span class="n">raw_data_folder</span><span class="p">,</span>
                    <span class="n">dict_log</span><span class="p">,</span>
                    <span class="n">documents</span><span class="p">,</span>
                    <span class="n">values_added</span><span class="p">,</span>
                    <span class="n">tags_added</span><span class="p">,</span>
                    <span class="n">tags_names_added</span><span class="p">,</span>
                    <span class="n">tags_to_exclude</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_mrtrix_format_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database_data</span><span class="p">,</span>
        <span class="n">bvec_bval_path</span><span class="p">,</span>
        <span class="n">file_database_path</span><span class="p">,</span>
        <span class="n">tag_name</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">,</span>
        <span class="n">values_added</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process MRtrix format bvec/bval file.</span>

<span class="sd">        :param database_data: Context-Managed database</span>
<span class="sd">        :param bvec_bval_path (str): Path to the MRtrix format file</span>
<span class="sd">        :param file_database_path (str): Relative path of the main file</span>
<span class="sd">        :param tag_name (str): Name of the association tag</span>
<span class="sd">        :param documents (dict): Dictionary to store document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bvec_bval_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bval_bvec_file</span><span class="p">:</span>
            <span class="n">original_md5_bvec_bval</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
                <span class="n">bval_bvec_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="n">bvec_bval_database_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
            <span class="n">bvec_bval_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_associated_file</span><span class="p">(</span>
            <span class="n">database_data</span><span class="p">,</span>
            <span class="n">bvec_bval_database_path</span><span class="p">,</span>
            <span class="n">original_md5_bvec_bval</span><span class="p">,</span>
            <span class="n">TYPE_BVEC_BVAL</span><span class="p">,</span>
            <span class="n">file_database_path</span><span class="p">,</span>
            <span class="n">tag_name</span><span class="p">,</span>
            <span class="n">documents</span><span class="p">,</span>
            <span class="n">values_added</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_scan_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database_data</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">,</span>
        <span class="n">raw_data_folder</span><span class="p">,</span>
        <span class="n">dict_log</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">,</span>
        <span class="n">values_added</span><span class="p">,</span>
        <span class="n">tags_added</span><span class="p">,</span>
        <span class="n">tags_names_added</span><span class="p">,</span>
        <span class="n">tags_to_exclude</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a single scan file and its associated files.:</span>

<span class="sd">        :param database_data: Context-Managed database</span>
<span class="sd">        :param file_name (str): Base name of the scan file</span>
<span class="sd">        :param raw_data_folder (str): Path to the raw data folder</span>
<span class="sd">        :param dict_log (dict): Log entry for this scan</span>
<span class="sd">        :param documents (dict): Dictionary to store document information</span>
<span class="sd">        :param values_added (list): List to track added values</span>
<span class="sd">        :param tags_added (list): List to track added tags</span>
<span class="sd">        :param tags_names_added (list): List to track added tag names</span>
<span class="sd">        :param tags_to_exclude (list): List of tags to exclude</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Process main NIfTI file</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_data_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.nii&quot;</span><span class="p">)</span>
        <span class="n">file_database_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>

        <span class="c1"># Calculate checksum</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scan_file</span><span class="p">:</span>
            <span class="n">original_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">scan_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="c1"># Check if document already exists</span>
        <span class="n">document_not_existing</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
            <span class="n">primary_key</span><span class="o">=</span><span class="n">file_database_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scans_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_database_path</span><span class="p">)</span>

        <span class="c1"># Initialize document</span>
        <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TAG_FILENAME</span><span class="p">:</span> <span class="n">file_database_path</span><span class="p">,</span>
            <span class="n">TAG_CHECKSUM</span><span class="p">:</span> <span class="n">original_md5</span><span class="p">,</span>
            <span class="n">TAG_TYPE</span><span class="p">:</span> <span class="n">TYPE_NII</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Process tags from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_file_tags</span><span class="p">(</span>
            <span class="n">database_data</span><span class="p">,</span>
            <span class="n">file_name</span><span class="p">,</span>
            <span class="n">raw_data_folder</span><span class="p">,</span>
            <span class="n">file_database_path</span><span class="p">,</span>
            <span class="n">document_not_existing</span><span class="p">,</span>
            <span class="n">documents</span><span class="p">,</span>
            <span class="n">values_added</span><span class="p">,</span>
            <span class="n">tags_added</span><span class="p">,</span>
            <span class="n">tags_names_added</span><span class="p">,</span>
            <span class="n">tags_to_exclude</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add standard values if document is new</span>
        <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>
            <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">file_database_path</span><span class="p">,</span> <span class="n">TAG_CHECKSUM</span><span class="p">,</span> <span class="n">original_md5</span><span class="p">,</span> <span class="n">original_md5</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">file_database_path</span><span class="p">,</span> <span class="n">TAG_TYPE</span><span class="p">,</span> <span class="n">TYPE_NII</span><span class="p">,</span> <span class="n">TYPE_NII</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Process associated bvec/bval files if they exist</span>
        <span class="k">if</span> <span class="n">dict_log</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Bvec_bval&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_associated_files</span><span class="p">(</span>
                <span class="n">database_data</span><span class="p">,</span>
                <span class="n">file_name</span><span class="p">,</span>
                <span class="n">raw_data_folder</span><span class="p">,</span>
                <span class="n">file_database_path</span><span class="p">,</span>
                <span class="n">documents</span><span class="p">,</span>
                <span class="n">values_added</span><span class="p">,</span>
                <span class="n">tags_added</span><span class="p">,</span>
                <span class="n">tags_names_added</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">documents</span><span class="p">,</span> <span class="n">tags_added</span><span class="p">,</span> <span class="n">values_added</span><span class="p">,</span> <span class="n">historyMaker</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the database with the processed documents.</span>

<span class="sd">        :param documents (dict): Dictionary containing document information</span>
<span class="sd">        :param tags_added (list): List of tags to add</span>
<span class="sd">        :param values_added (list): List of values to add</span>
<span class="sd">        :param historyMaker (list): List for history tracking</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Emit progress updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_schema</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">database_schema</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                <span class="c1"># Add fields</span>
                <span class="n">database_schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">tags_added</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="c1"># Remove existing documents to avoid conflicts</span>
                <span class="n">current_paths</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">current_paths</span><span class="p">:</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>

                <span class="c1"># Add document to current and initial collections</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">document</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">documents</span><span class="p">[</span><span class="n">document</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">document</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">documents</span><span class="p">[</span><span class="n">document</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Update history</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">historyMaker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans_added</span><span class="p">)</span>

        <span class="n">historyMaker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values_added</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historyMaker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>



<div class="viewcode-block" id="read_log">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.read_log">[docs]</a>
<span class="k">def</span> <span class="nf">read_log</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">main_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a progress bar for data loading and return loaded file paths.</span>

<span class="sd">    This function shows the evolution of the progress bar while loading data</span>
<span class="sd">    files and returns a list of paths to each data file that was successfully</span>
<span class="sd">    loaded.</span>

<span class="sd">    :param project (Project): The current project instance in the software</span>
<span class="sd">    :param main_window (MainWindow): The software&#39;s main window instance used</span>
<span class="sd">                                     to display the progress bar.</span>
<span class="sd">    :return (list):  A list of paths to the data files (scans) that were</span>
<span class="sd">                      successfully added.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">ImportProgress</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="n">scans_added</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">scans_added</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scans_added</span></div>



<div class="viewcode-block" id="tags_from_file">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.tags_from_file">[docs]</a>
<span class="k">def</span> <span class="nf">tags_from_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of [tag, value] pairs from a JSON file.</span>

<span class="sd">    :param file_path (str): File path of the Json file (without the extension)</span>
<span class="sd">    :param path (str): Project path</span>
<span class="sd">    :return (List[List[Union[str, dict]]]: A list of the Json tags of the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">json_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">.json&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c1"># We don&#39;t want spaces in PatientName (used by Mia to define</span>
        <span class="c1"># subfolders when writing calculation results)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="p">):</span>
            <span class="n">value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">json_tags</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">json_tags</span></div>



<div class="viewcode-block" id="verify_scans">
<a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.verify_scans">[docs]</a>
<span class="k">def</span> <span class="nf">verify_scans</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the project&#39;s scans have been modified.</span>

<span class="sd">    :param project (Project): Current project in the software</span>
<span class="sd">    :return (List[str]): The list of scans that have been modified</span>
<span class="sd">                          or are missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Returning the files that are problematic</span>
    <span class="n">modified_scans</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">scan</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>

                <span class="c1"># If the file exists, we do the checksum</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scan_file</span><span class="p">:</span>
                        <span class="n">actual_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">scan_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error reading file: &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">actual_md5</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">initial_checksum</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">TAG_CHECKSUM</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">initial_checksum</span> <span class="ow">and</span> <span class="n">actual_md5</span> <span class="o">!=</span> <span class="n">initial_checksum</span><span class="p">:</span>
                    <span class="n">modified_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add missing file directly to the list</span>
                <span class="n">modified_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">modified_scans</span></div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>