<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>populse_mia.main &#8212; populse_mia 3.0.0-dev+881d2af6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=f63d8bfa" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css?v=dfa0e015" />
    <script src="../../_static/documentation_options.js?v=a73ba755"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>populse_mia 3.0.0-dev+881d2af6 documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.main</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for populse_mia.main</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The first module used at the mia runtime.</span>

<span class="sd">Basically, this module is dedicated to the initialisation of the basic</span>
<span class="sd">parameters and the various checks necessary for a successful launch of the</span>
<span class="sd">mia&#39;s GUI.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Function:</span>
<span class="sd">        - add_to_sys_path</span>
<span class="sd">        - check_package</span>
<span class="sd">        - main</span>
<span class="sd">        - qt_message_handler</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">###############################################################################</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># PyQt5 imports</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QCoreApplication</span><span class="p">,</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">qInstallMessageHandler</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QMessageBox</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="add_to_sys_path">
<a class="viewcode-back" href="../../populse_mia.html#populse_mia.main.add_to_sys_path">[docs]</a>
<span class="k">def</span> <span class="nf">add_to_sys_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the specified path to the system path if it&#39;s a valid directory.</span>

<span class="sd">    :param path (pathlib.Path): The directory path to be added to the</span>
<span class="sd">                                system path.</span>
<span class="sd">    :param name (str): The name of the package being added.</span>
<span class="sd">    :param index (int, optional): The index at which to insert the path</span>
<span class="sd">                                  into sys.path. Defaults to 0.</span>
<span class="sd">    :return (bool): True if the path is a valid directory and was added</span>
<span class="sd">                    to sys.path, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  . Using </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> package from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> package was not found from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="check_package">
<a class="viewcode-back" href="../../populse_mia.html#populse_mia.main.check_package">[docs]</a>
<span class="k">def</span> <span class="nf">check_package</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to import a package by its name, logs the location of the</span>
<span class="sd">    package if successful, and logs an error if the package is missing.</span>

<span class="sd">    :param name (str): The name of the package to be imported.</span>

<span class="sd">    :return (bool): True if the package is imported successfully;</span>
<span class="sd">                    False if the package is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">mod_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  . Using </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> package from </span><span class="si">{</span><span class="n">mod_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to import </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> package!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> package has no __file__ attribute!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../populse_mia.html#populse_mia.main.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make basic configuration check, then actual launch of Mia.</span>

<span class="sd">    Checks if Mia is called from the site/dist packages (`user mode`) or from a</span>
<span class="sd">    cloned git repository (`developer mode`).</span>

<span class="sd">    ~/.populse_mia/configuration_path.yml is mandatory, if it doesn&#39;t exist</span>
<span class="sd">    or is corrupted, try to create one with a valid properties path.</span>

<span class="sd">    - If launched from a cloned git repository (`developer mode`):</span>
<span class="sd">        - the properties_path is the &quot;properties_dev_path&quot; parameter in</span>
<span class="sd">          ~/.populse_mia/configuration_path.yml</span>
<span class="sd">    - If launched from the site/dist packages (`user mode`):</span>
<span class="sd">        - the properties_path is the &quot;properties_user_path&quot; parameter in</span>
<span class="sd">          ~/.populse_mia/configuration_path.yml</span>

<span class="sd">    Launches the verify_processes() function, then the launch_mia() function</span>
<span class="sd">    (Mia&#39;s real launch).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pypath</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">package_not_found</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Disables any etelemetry check.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;NO_ET&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;NIPYPE_NO_ET&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="c1"># Trying to fix High DPI Display issue</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;QT_AUTO_SCREEN_SCALE_FACTOR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
    <span class="c1"># General QApplication class instantiation</span>
    <span class="n">QCoreApplication</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AA_ShareOpenGLContexts</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">QApplication</span><span class="o">.</span><span class="n">setOverrideCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WaitCursor</span><span class="p">)</span>

    <span class="c1"># Adding the populse projects path to sys.path, if in developer mode</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="c1"># &quot;developer&quot; mode</span>
        <span class="n">DEV_MODE</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MIA_DEV_MODE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="c1"># Determine the root development directory</span>
        <span class="n">root_dev_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">populse_bdir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">capsul_bdir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">soma_bdir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">root_dev_dir</span> <span class="o">/</span> <span class="s2">&quot;populse_mia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="c1"># Different sources layout - try casa_distro mode</span>
            <span class="c1"># TODO: At the moment, my casa_distro isn&#39;t working, and I don&#39;t</span>
            <span class="c1">#       understand this part. I&#39;ll check later when I&#39;ve got</span>
            <span class="c1">#       casa_distro back.</span>
            <span class="c1"># TODO start</span>
            <span class="n">root_dev_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">root_dev_dir</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;populse&quot;</span><span class="p">:</span>
                <span class="n">root_dev_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root_dev_dir</span><span class="p">)</span>
                <span class="n">populse_bdir</span> <span class="o">=</span> <span class="s2">&quot;populse&quot;</span>
                <span class="n">soma_bdir</span> <span class="o">=</span> <span class="s2">&quot;soma&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;root_dev_dir: </span><span class="si">{</span><span class="n">root_dev_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;branch: </span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># TODO stop</span>

        <span class="c1"># populse packages</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;populse_mia&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">root_dev_dir</span> <span class="o">/</span> <span class="n">populse_bdir</span> <span class="o">/</span> <span class="s2">&quot;populse_mia&quot;</span> <span class="o">/</span> <span class="n">branch</span>
                <span class="p">)</span>
            <span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;capsul&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">root_dev_dir</span> <span class="o">/</span> <span class="n">capsul_bdir</span> <span class="o">/</span> <span class="s2">&quot;capsul&quot;</span> <span class="o">/</span> <span class="n">branch</span><span class="p">)},</span>
            <span class="p">{</span>
                <span class="s2">&quot;soma&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">root_dev_dir</span> <span class="o">/</span> <span class="n">soma_bdir</span> <span class="o">/</span> <span class="s2">&quot;soma-base&quot;</span> <span class="o">/</span> <span class="n">branch</span> <span class="o">/</span> <span class="s2">&quot;python&quot;</span>
                <span class="p">)</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;soma_workflow&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">root_dev_dir</span>
                    <span class="o">/</span> <span class="n">soma_bdir</span>
                    <span class="o">/</span> <span class="s2">&quot;soma-workflow&quot;</span>
                    <span class="o">/</span> <span class="n">branch</span>
                    <span class="o">/</span> <span class="s2">&quot;python&quot;</span>
                <span class="p">)</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;populse_db&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">root_dev_dir</span>
                    <span class="o">/</span> <span class="n">populse_bdir</span>
                    <span class="o">/</span> <span class="s2">&quot;populse_db&quot;</span>
                    <span class="o">/</span> <span class="n">branch</span>
                    <span class="o">/</span> <span class="s2">&quot;python&quot;</span>
                <span class="p">)</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;mia_processes&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">root_dev_dir</span> <span class="o">/</span> <span class="n">populse_bdir</span> <span class="o">/</span> <span class="s2">&quot;mia_processes&quot;</span> <span class="o">/</span> <span class="n">branch</span>
                <span class="p">)</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="c1"># Adding populse packages in sys.path</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Mia in &#39;developer&#39; mode&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev_path</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">add_to_sys_path</span><span class="p">(</span><span class="n">dev_path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="n">pypath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev_path</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="ow">not</span> <span class="n">check_package</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">package_not_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> version: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="c1"># version is not found</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">package_not_found</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">package_not_found</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;populse_mia - ImportError&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Missing packages:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">Please reinstall them.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># TODO: Same as the first todo above, I don&#39;t understand the lines below,</span>
    <span class="c1">#       so I&#39;ll comment on them for now.</span>
    <span class="c1"># elif &quot;CASA_DISTRO&quot; in os.environ:</span>
    <span class="c1">#     # If the casa distro development environment is detected,</span>
    <span class="c1">#     # developer mode is activated.</span>
    <span class="c1">#     os.environ[&quot;MIA_DEV_MODE&quot;] = &quot;1&quot;</span>
    <span class="c1">#     DEV_MODE = True</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># &quot;user&quot; mode</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MIA_DEV_MODE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">DEV_MODE</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Mia in &#39;user&#39; mode&quot;</span><span class="p">)</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;populse_mia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capsul&quot;</span><span class="p">,</span>
            <span class="s2">&quot;soma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;soma_workflow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;populse_db&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mia_processes&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  . Using </span><span class="si">{</span><span class="n">mod</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> package &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">mod</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> ...&quot;</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">mod</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> version: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="c1"># version is not found</span>
                <span class="k">pass</span>

    <span class="c1"># Check if nipype is available on the station.</span>
    <span class="c1"># If not available ask the user to install it.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;nipype&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MIA warning </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;populse_mia -  warning: ImportError!&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
            <span class="s2">&quot;An issue has been detected with &quot;</span>
            <span class="s2">&quot;the nipype package. Please (re)install this &quot;</span>
            <span class="s2">&quot;package and/or fix the issues displayed in the standard &quot;</span>
            <span class="s2">&quot;output. Then, start again Mia ...&quot;</span>
        <span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Now that populse projects paths have been set in sys.path, if necessary,</span>
    <span class="c1"># we can import from these projects:</span>
    <span class="c1"># Populse_mia imports</span>
    <span class="kn">from</span> <span class="nn">populse_mia.utils</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># noqa E402</span>
        <span class="n">check_python_version</span><span class="p">,</span>
        <span class="n">launch_mia</span><span class="p">,</span>
        <span class="n">verify_processes</span><span class="p">,</span>
        <span class="n">verify_setup</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">verify_setup</span><span class="p">(</span><span class="n">dev_mode</span><span class="o">=</span><span class="n">DEV_MODE</span><span class="p">,</span> <span class="n">pypath</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pypath</span><span class="p">)))</span>
    <span class="n">verify_processes</span><span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;nipype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;mia_processes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;capsul&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">check_python_version</span><span class="p">()</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_work_dir</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">temp_work_dir</span><span class="p">)</span>
        <span class="n">launch_mia</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>



<div class="viewcode-block" id="qt_message_handler">
<a class="viewcode-back" href="../../populse_mia.html#populse_mia.main.qt_message_handler">[docs]</a>
<span class="k">def</span> <span class="nf">qt_message_handler</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom Qt message handler to filter out specific unwanted messages and</span>
<span class="sd">    output the remaining ones.</span>

<span class="sd">    :param message (str): The message to be handled, potentially filtered and</span>
<span class="sd">                          then output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">unwanted_message</span> <span class="ow">in</span> <span class="n">unwanted_messages</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">unwanted_message</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">unwanted_message</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="c1"># Remove the unwanted message but keep the rest of the line</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">unwanted_message</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Output the remaining message (if any)</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Populse Mia Application Entry Point.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--multi_instance&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the value of multi_instance.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="c1"># Print the multi_instance argument value</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--multi_instance is set to: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">multi_instance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># This will only be executed when this module is run directly</span>
    <span class="c1"># list of unwanted messages to filter out in stdout</span>
    <span class="n">unwanted_messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;QPixmap::scaleHeight: Pixmap is a null pixmap&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c1"># Install the custom Qt message handler</span>
    <span class="n">qInstallMessageHandler</span><span class="p">(</span><span class="n">qt_message_handler</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>