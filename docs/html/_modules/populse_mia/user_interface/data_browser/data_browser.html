<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>populse_mia.user_interface.data_browser.data_browser &#8212; populse_mia 3.0.0-dev+9d1e1aff documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=47202671" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/haiku.css?v=fce32b03" />
    <script src="../../../../_static/documentation_options.js?v=4774077a"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";





const initStyles = () => {
    const defaultStyle = document.createElement('style');
    defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}`;
    document.head.appendChild(defaultStyle);

    const fullscreenStyle = document.createElement('style');
    fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
    document.head.appendChild(fullscreenStyle);
}

// Detect if page has dark background
const isDarkTheme = () => {
    // We use a set of heuristics:
    // 1. Check for common dark mode classes or attributes
    // 2. Check computed background color brightness
    if (document.documentElement.classList.contains('dark') ||
        document.documentElement.getAttribute('data-theme') === 'dark' ||
        document.body.classList.contains('dark') ||
        document.body.getAttribute('data-theme') === 'dark') {
        // console.log("Dark theme detected via class/attribute");
        return true;
    }
    if (document.documentElement.classList.contains('light') ||
        document.documentElement.getAttribute('data-theme') === 'light' ||
        document.body.classList.contains('light') ||
        document.body.getAttribute('data-theme') === 'light') {
        // console.log("Light theme detected via class/attribute");
        return false;
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // console.log("Dark theme detected via prefers-color-scheme");
        return true;
    }
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        // console.log("Background color brightness:", brightness);
        return brightness < 128;
    }
    // console.log("No dark or light theme detected, defaulting to light theme");
    return false;
};

let darkTheme = isDarkTheme();
let modal = null;
let modalContent = null;
let previousScrollOffset = [window.scrollX, window.scrollY];

const runMermaid = async (rerun) => {
    console.log("Running mermaid diagrams, rerun =", rerun);
    // clear all existing mermaid charts
    let all_mermaids = document.querySelectorAll(".mermaid");

    if (rerun) {
        all_mermaids.forEach((el) => {
            if(!el.hasAttribute("data-original-code")) {
                // store original code
                // console.log(`Storing original code for first run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
            if(el.getAttribute("data-processed") === "true") {
                // remove and restore original
                el.removeAttribute("data-processed");
                // console.log(`Restoring original code for re-run: `, el.getAttribute('data-original-code'));
                el.innerHTML = el.getAttribute('data-original-code');
            } else {
                // store original code
                // console.log(`Storing original code for re-run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
        });
        await mermaid.run();
    }

    all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(() => runMermaid(false), 200);
        return;
    }

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    if (modal !== null ) {
        // Destroy existing modal
        modal.remove();
        modal = null;
        modalContent = null;
    }

    modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            // Already processed, adjust button class if needed
            const existingBtn = mermaidDiv.parentNode.querySelector('.mermaid-fullscreen-btn');
            if (existingBtn) {
                existingBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
            }
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        container.appendChild(fullscreenBtn);
    });
};

const load = async () => {
    initStyles();

    await runMermaid(true);

    const reRunIfThemeChanges = async () => {
        const newDarkTheme = isDarkTheme();
        if (newDarkTheme !== darkTheme) {
            darkTheme = newDarkTheme;
            console.log("Theme change detected, re-running mermaid with", darkTheme ? "dark" : "default", "theme");
            await mermaid.initialize(
                {...JSON.parse(
                    `{"startOnLoad": false}`
                ),
                ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
                }
            );
            await runMermaid(true);
        }
    };

    // Update theme classes when theme changes
    const themeObserver = new MutationObserver(reRunIfThemeChanges);
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    themeObserver.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
};





console.log("Initializing mermaid with", darkTheme ? "dark" : "default", "theme");
mermaid.initialize(
    {...JSON.parse(
        `{"startOnLoad": false}`
    ),
    ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
    }
);

window.addEventListener("load", load);</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>populse_mia 3.0.0-dev+9d1e1aff documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.user_interface.data_browser.data_browser</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for populse_mia.user_interface.data_browser.data_browser</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to define data browser tab appearance, settings and methods.</span>

<span class="sd">Contains:</span>
<span class="sd">    Class:</span>
<span class="sd">        - DataBrowser</span>
<span class="sd">        - DateFormatDelegate</span>
<span class="sd">        - DateTimeFormatDelegate</span>
<span class="sd">        - NumberFormatDelegate</span>
<span class="sd">        - TableDataBrowser</span>
<span class="sd">        - TimeFormatDelegate</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bisect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_origin</span>

<span class="c1"># PyQt5 imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QVariant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QPixmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">QAbstractItemView</span><span class="p">,</span>
    <span class="n">QAction</span><span class="p">,</span>
    <span class="n">QApplication</span><span class="p">,</span>
    <span class="n">QDateEdit</span><span class="p">,</span>
    <span class="n">QDateTimeEdit</span><span class="p">,</span>
    <span class="n">QDoubleSpinBox</span><span class="p">,</span>
    <span class="n">QFrame</span><span class="p">,</span>
    <span class="n">QGridLayout</span><span class="p">,</span>
    <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QItemDelegate</span><span class="p">,</span>
    <span class="n">QMenu</span><span class="p">,</span>
    <span class="n">QMessageBox</span><span class="p">,</span>
    <span class="n">QProgressDialog</span><span class="p">,</span>
    <span class="n">QPushButton</span><span class="p">,</span>
    <span class="n">QSplitter</span><span class="p">,</span>
    <span class="n">QTableWidget</span><span class="p">,</span>
    <span class="n">QTableWidgetItem</span><span class="p">,</span>
    <span class="n">QTimeEdit</span><span class="p">,</span>
    <span class="n">QToolBar</span><span class="p">,</span>
    <span class="n">QToolButton</span><span class="p">,</span>
    <span class="n">QVBoxLayout</span><span class="p">,</span>
    <span class="n">QWidget</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.data_manager</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BRICK_INPUTS</span><span class="p">,</span>
    <span class="n">BRICK_NAME</span><span class="p">,</span>
    <span class="n">BRICK_OUTPUTS</span><span class="p">,</span>
    <span class="n">COLLECTION_BRICK</span><span class="p">,</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_DATE</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_DATETIME</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_FLOAT</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_BOOLEAN</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_DATE</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_DATETIME</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_FLOAT</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_INTEGER</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_JSON</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_STRING</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_TIME</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_STRING</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_TIME</span><span class="p">,</span>
    <span class="n">NOT_DEFINED_VALUE</span><span class="p">,</span>
    <span class="n">TAG_BRICKS</span><span class="p">,</span>
    <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
    <span class="n">TAG_FILENAME</span><span class="p">,</span>
    <span class="n">TAG_HISTORY</span><span class="p">,</span>
    <span class="n">TAG_ORIGIN_BUILTIN</span><span class="p">,</span>
    <span class="n">TAG_ORIGIN_USER</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.software_properties</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.data_browser.advanced_search</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AdvancedSearch</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.data_browser.count_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">CountTable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.data_browser.mini_viewer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MiniViewer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.data_browser.modify_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModifyTable</span>

<span class="c1"># Populse_MIA imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.data_browser.rapid_search</span><span class="w"> </span><span class="kn">import</span> <span class="n">RapidSearch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.pop_ups</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ClickableLabel</span><span class="p">,</span>
    <span class="n">PopUpAddPath</span><span class="p">,</span>
    <span class="n">PopUpAddTag</span><span class="p">,</span>
    <span class="n">PopUpCloneTag</span><span class="p">,</span>
    <span class="n">PopUpDataBrowserCurrentSelection</span><span class="p">,</span>
    <span class="n">PopUpMultipleSort</span><span class="p">,</span>
    <span class="n">PopUpProperties</span><span class="p">,</span>
    <span class="n">PopUpRemoveScan</span><span class="p">,</span>
    <span class="n">PopUpRemoveTag</span><span class="p">,</span>
    <span class="n">PopUpSelectFilter</span><span class="p">,</span>
    <span class="n">PopUpShowHistory</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="DataBrowser">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataBrowser</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget that manages and displays the contents of the **Data Browser** tab.</span>

<span class="sd">    The Data Browser provides an interface for viewing, filtering, tagging,</span>
<span class="sd">    and sending documents to the pipeline manager. It integrates tools for</span>
<span class="sd">    advanced search, tag management, and visual inspection of loaded data.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - add_tag_infos: Add the tag after add tag pop-up</span>
<span class="sd">        - add_tag_pop_up: Display the add tag pop-up</span>
<span class="sd">        - clone_tag_infos: Clone the tag after the clone tag pop-up</span>
<span class="sd">        - connect_actions: Connect actions method to views</span>
<span class="sd">        - connect_mini_viewer: Display the selected documents in the viewer</span>
<span class="sd">        - connect_toolbar: Connect toolbar views to methods</span>
<span class="sd">        - count_table_pop_up: Open the count table</span>
<span class="sd">        - create_layout: Create the layout of the data browser</span>
<span class="sd">        - create_toolbar_view: Create the toolbar views</span>
<span class="sd">        - move_splitter: Check if the viewer&#39;s splitter is at its lowest</span>
<span class="sd">                         position</span>
<span class="sd">        - open_filter: Open a project filter that has already been saved</span>
<span class="sd">        - open_filter_infos: Apply the current filter</span>
<span class="sd">        - remove_tag_infos: Remove user tags after the pop-up</span>
<span class="sd">        - remove_tag_pop_up: Display the pop-up to remove user tags</span>
<span class="sd">        - reset_search_bar: Reset the rapid search bar</span>
<span class="sd">        - search_str: Search a string in the table and updates the</span>
<span class="sd">                      visualized documents</span>
<span class="sd">        - send_documents_to_pipeline: Send the current list of scans to the</span>
<span class="sd">                                      Pipeline Manager</span>
<span class="sd">        - show_clone_tag_popup: Display the clone tag pop-up</span>
<span class="sd">        - toggle_advanced_search: Toggle the visibility of the advanced search</span>
<span class="sd">                                  interface</span>
<span class="sd">        - update_database: Update the database in the software</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DataBrowser.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">main_window</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization of the data_browser class.</span>

<span class="sd">        :param project: Current project in the software</span>
<span class="sd">        :param main_window: Main window of the software</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Store references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="n">main_window</span>
        <span class="c1"># Flag (bool) indicating if data has been sent to pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sent</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Initialize core components</span>
        <span class="c1"># Create and configure menu/toolbar actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tag_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Add tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;Ctrl+A&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clone_tag_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Clone tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_tag_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Remove tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;Ctrl+R&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_filter_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Save current filter&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_filter_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="s2">&quot;Open filter&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;Ctrl+F&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Initialize core MIA functional components</span>
        <span class="c1"># Quick search functionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span> <span class="o">=</span> <span class="n">RapidSearch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Compact data viewer component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span> <span class="o">=</span> <span class="n">MiniViewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="c1"># Advanced search interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span> <span class="o">=</span> <span class="n">AdvancedSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Create and configure UI widgets</span>
        <span class="c1"># Labels and clickable elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addRowLabel</span> <span class="o">=</span> <span class="n">ClickableLabel</span><span class="p">()</span>
        <span class="c1"># Frames for organization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_table_data</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_visualization</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_test</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
        <span class="c1"># Buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_documents_to_pipeline_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span>
            <span class="s2">&quot;Send documents to the Pipeline Manager&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualized_tags_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_table_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_cross</span> <span class="o">=</span> <span class="n">QToolButton</span><span class="p">()</span>
        <span class="c1"># Layout components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span> <span class="o">=</span> <span class="n">QToolBar</span><span class="p">()</span>
        <span class="c1"># Create and configure the main data table</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">shown_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>

        <span class="c1"># Main data table display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span> <span class="o">=</span> <span class="n">TableDataBrowser</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shown_tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;table_data&quot;</span><span class="p">)</span>
        <span class="c1"># Setup layout and connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_toolbar_view</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_layout</span><span class="p">()</span>
        <span class="c1"># Image viewer updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_toolbar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_actions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_mini_viewer</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.add_tag_infos">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.add_tag_infos">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_tag_infos</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">new_tag_name</span><span class="p">,</span>
        <span class="n">new_default_value</span><span class="p">,</span>
        <span class="n">tag_type</span><span class="p">,</span>
        <span class="n">new_tag_description</span><span class="p">,</span>
        <span class="n">new_tag_unit</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new tag to both current and initial database collections.</span>

<span class="sd">        This method creates a new tag field in the database schema and</span>
<span class="sd">        populates it with default values for all existing scans. The operation</span>
<span class="sd">        is tracked in the project&#39;s undo/redo history.</span>

<span class="sd">        :param new_tag_name (str): Name of the new tag to create</span>
<span class="sd">        :param new_default_value: Default value to assign to all existing scans</span>
<span class="sd">        :param tag_type (str): Data type of the tag</span>
<span class="sd">                               (e.g., FIELD_TYPE_STRING, FIELD_TYPE_FLOAT)</span>
<span class="sd">        :param new_tag_description (str): Human-readable description of the tag</span>
<span class="sd">        :param new_tag_unit (str): Unit of measurement for the tag value</span>

<span class="sd">        Note:</span>
<span class="sd">            - Marks the project as having unsaved modifications</span>
<span class="sd">            - Adds the operation to the undo history</span>
<span class="sd">            - Updates the UI table with the new column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import table_to_database only here to prevent circular import issue</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">table_to_database</span>

        <span class="c1"># Prepare field configuration (DRY principle)</span>
        <span class="n">field_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">new_tag_name</span><span class="p">,</span>
            <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="n">tag_type</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">new_tag_description</span><span class="p">,</span>
            <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">TAG_ORIGIN_USER</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">new_tag_unit</span><span class="p">,</span>
            <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="n">new_default_value</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">converted_default</span> <span class="o">=</span> <span class="n">table_to_database</span><span class="p">(</span><span class="n">new_default_value</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">)</span>

        <span class="c1"># Add field to database schema for both collections</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_schema</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">):</span>
                <span class="n">database_schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                    <span class="p">{</span><span class="o">**</span><span class="n">field_config</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># Populate existing scans with default values</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">scans</span><span class="p">:</span>  <span class="c1"># Only mark as modified if there are scans to update</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">unsavedModifications</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">]</span>
                <span class="n">update_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">new_tag_name</span><span class="p">:</span> <span class="n">converted_default</span><span class="p">}</span>

                <span class="c1"># Update both collections</span>
                <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">):</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                        <span class="n">values_dict</span><span class="o">=</span><span class="n">update_dict</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># Track for history</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">filename</span><span class="p">,</span>
                        <span class="n">new_tag_name</span><span class="p">,</span>
                        <span class="n">converted_default</span><span class="p">,</span>  <span class="c1"># current_value</span>
                        <span class="n">converted_default</span><span class="p">,</span>  <span class="c1"># initial_value</span>
                    <span class="p">]</span>
                <span class="p">)</span>

        <span class="c1"># Update undo/redo history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;add_tag&quot;</span><span class="p">,</span>
                <span class="n">new_tag_name</span><span class="p">,</span>
                <span class="n">tag_type</span><span class="p">,</span>
                <span class="n">new_tag_unit</span><span class="p">,</span>
                <span class="n">new_default_value</span><span class="p">,</span>
                <span class="n">new_tag_description</span><span class="p">,</span>
                <span class="n">values</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Update UI table</span>
        <span class="n">column_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">get_index_insertion</span><span class="p">(</span><span class="n">new_tag_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">column_index</span><span class="p">,</span> <span class="n">new_tag_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.add_tag_pop_up">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.add_tag_pop_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_tag_pop_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a popup window for adding a new tag to the project.</span>

<span class="sd">        This method initializes and shows a `PopUpAddTag` dialog, allowing the</span>
<span class="sd">        user to add a new tag to the current project. The popup is modal and</span>
<span class="sd">        tied to the current project context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_add_tag</span> <span class="o">=</span> <span class="n">PopUpAddTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_add_tag</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.clone_tag_infos">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.clone_tag_infos">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clone_tag_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_to_clone</span><span class="p">,</span> <span class="n">new_tag_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clone a tag and its associated data, creating a new tag with the same</span>
<span class="sd">        attributes and values.</span>

<span class="sd">        This method clones the specified tag, including its schema and data,</span>
<span class="sd">        into a new tag. The new tag is added to both the current and initial</span>
<span class="sd">        collections, and all existing values for the original tag are copied</span>
<span class="sd">        to the new tag. The operation is recorded in the project&#39;s undo</span>
<span class="sd">        history.</span>

<span class="sd">        :param tag_to_clone (str): Name of the tag to clone</span>
<span class="sd">        :param new_tag_name (str): Name of the new tag to create</span>

<span class="sd">         Notes:</span>
<span class="sd">            - The new tag is added to the database schema and data for both</span>
<span class="sd">              COLLECTION_CURRENT amd COLLECTION_INITIAL collections.</span>
<span class="sd">            - The project&#39;s unsaved modifications flag is set to True.</span>
<span class="sd">            - The operation is recorded in the project&#39;s undo history.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Fetch the attributes of the tag to clone from both collections</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">tag_cloned_curr</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_to_clone</span>
            <span class="p">)</span>
            <span class="n">tag_cloned_init</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">tag_to_clone</span>
            <span class="p">)</span>

        <span class="c1"># Add the new tag to the schema for both collections</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_schema</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">):</span>
                <span class="n">tag_cloned</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">tag_cloned_curr</span>
                    <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="n">COLLECTION_CURRENT</span>
                    <span class="k">else</span> <span class="n">tag_cloned_init</span>
                <span class="p">)</span>
                <span class="n">database_schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;collection_name&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="p">,</span>
                        <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">new_tag_name</span><span class="p">,</span>
                        <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="n">tag_cloned</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tag_cloned</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">TAG_ORIGIN_USER</span><span class="p">,</span>
                        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">tag_cloned</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="n">tag_cloned</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">unsavedModifications</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Clone the values for each scan in the current collection</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span>
            <span class="p">):</span>
                <span class="c1"># If the tag to clone has a value, we add this value with the</span>
                <span class="c1"># new tag name in the Database</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">):</span>
                    <span class="n">cloned_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag_to_clone</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">cloned_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                            <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">new_tag_name</span><span class="p">:</span> <span class="n">cloned_value</span><span class="p">},</span>
                        <span class="p">)</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">filename</span><span class="p">,</span> <span class="n">new_tag_name</span><span class="p">,</span> <span class="n">cloned_value</span><span class="p">])</span>

        <span class="c1"># Record the operation in the project&#39;s undo history</span>
        <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;add_tag&quot;</span><span class="p">,</span>
            <span class="n">new_tag_name</span><span class="p">,</span>
            <span class="n">tag_cloned_curr</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
            <span class="n">tag_cloned_curr</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
            <span class="n">tag_cloned_curr</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
            <span class="n">tag_cloned_curr</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
            <span class="n">values</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Add the new tag to the table</span>
        <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">get_index_insertion</span><span class="p">(</span><span class="n">new_tag_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">new_tag_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.connect_actions">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.connect_actions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect UI actions to their corresponding methods.</span>

<span class="sd">        Binds each action&#39;s triggered signal to the appropriate slot method,</span>
<span class="sd">        enabling interactive functionality for tag management and filter</span>
<span class="sd">        operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tag_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_tag_pop_up</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clone_tag_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_clone_tag_popup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_tag_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_tag_pop_up</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_filter_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">save_current_filter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">get_filters</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_filter_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_filter</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.connect_mini_viewer">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.connect_mini_viewer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_mini_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the selected documents in the viewer.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">sizes</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">minimumHeight</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">setHidden</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">setHidden</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">()</span>
            <span class="n">full_names</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">full_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">):</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="n">full_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">full_name</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">full_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">full_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">full_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full_names</span><span class="p">:</span>
                        <span class="n">full_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">verify_slices</span><span class="p">(</span><span class="n">full_names</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.connect_toolbar">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.connect_toolbar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_toolbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect methods to toolbar.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">search_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_cross</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_search_bar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_advanced_search</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_table_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_table_pop_up</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualized_tags_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">visualized_tags_pop_up</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.count_table_pop_up">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.count_table_pop_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_table_pop_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the count table pop-up.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_table_pop_up</span> <span class="o">=</span> <span class="n">CountTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_table_pop_up</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.create_layout">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.create_layout">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the layouts of the tab.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_table_data</span><span class="o">.</span><span class="n">setFrameShape</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_table_data</span><span class="o">.</span><span class="n">setFrameShadow</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Raised</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_table_data</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;frame_table_data&quot;</span><span class="p">)</span>
        <span class="n">vbox_table</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">vbox_table</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="p">)</span>
        <span class="c1"># Add path button under the table</span>
        <span class="n">hbox_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addRowLabel</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;plus&quot;</span><span class="p">)</span>
        <span class="n">add_row_picture</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;green_plus.png&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">add_row_picture</span> <span class="o">=</span> <span class="n">add_row_picture</span><span class="o">.</span><span class="n">scaledToHeight</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addRowLabel</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">add_row_picture</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addRowLabel</span><span class="o">.</span><span class="n">setFixedWidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addRowLabel</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
            <span class="s2">&quot;Add data without using the MRI converter tool (File&gt;Import)&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addRowLabel</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">add_path</span><span class="p">)</span>
        <span class="n">hbox_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addRowLabel</span><span class="p">)</span>
        <span class="n">hbox_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_documents_to_pipeline_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_documents_to_pipeline</span>
        <span class="p">)</span>
        <span class="n">hbox_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_documents_to_pipeline_button</span><span class="p">)</span>
        <span class="n">vbox_table</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">hbox_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_table_data</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">vbox_table</span><span class="p">)</span>
        <span class="c1"># Visualization:</span>
        <span class="c1"># Visualization frame, label and text edit (bot.0tom left of the</span>
        <span class="c1"># screen in the application)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_visualization</span><span class="o">.</span><span class="n">setFrameShape</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_visualization</span><span class="o">.</span><span class="n">setFrameShadow</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Raised</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_visualization</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;frame_5&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;viewer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">adjustSize</span><span class="p">()</span>
        <span class="n">hbox_viewer</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">hbox_viewer</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_visualization</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">hbox_viewer</span><span class="p">)</span>
        <span class="c1"># Advanced search:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setFrameShape</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setFrameShadow</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Raised</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;frame_search&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setHidden</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">layout_search</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">()</span>
        <span class="n">layout_search</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout_search</span><span class="p">)</span>
        <span class="c1"># Splitter and layout:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_table_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_visualization</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">splitterMoved</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_splitter</span><span class="p">)</span>
        <span class="n">vbox_splitter</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">vbox_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="p">)</span>
        <span class="n">vbox_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">vbox_splitter</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.create_toolbar_view">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.create_toolbar_view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_toolbar_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the toolbar menu at the top of the tab&quot;&quot;&quot;</span>
        <span class="n">tags_tool_button</span> <span class="o">=</span> <span class="n">QToolButton</span><span class="p">()</span>
        <span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Tags&quot;</span><span class="p">)</span>
        <span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setPopupMode</span><span class="p">(</span><span class="n">QToolButton</span><span class="o">.</span><span class="n">MenuButtonPopup</span><span class="p">)</span>
        <span class="n">tags_menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">()</span>
        <span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_tag_action</span><span class="p">)</span>
        <span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clone_tag_action</span><span class="p">)</span>
        <span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_tag_action</span><span class="p">)</span>
        <span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setMenu</span><span class="p">(</span><span class="n">tags_menu</span><span class="p">)</span>
        <span class="n">filters_tool_button</span> <span class="o">=</span> <span class="n">QToolButton</span><span class="p">()</span>
        <span class="n">filters_tool_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Filters&quot;</span><span class="p">)</span>
        <span class="n">filters_tool_button</span><span class="o">.</span><span class="n">setPopupMode</span><span class="p">(</span><span class="n">QToolButton</span><span class="o">.</span><span class="n">MenuButtonPopup</span><span class="p">)</span>
        <span class="n">filters_menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">()</span>
        <span class="n">filters_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_filter_action</span><span class="p">)</span>
        <span class="n">filters_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_filter_action</span><span class="p">)</span>
        <span class="n">filters_tool_button</span><span class="o">.</span><span class="n">setMenu</span><span class="p">(</span><span class="n">filters_menu</span><span class="p">)</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_cross</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color:rgb(255, 255, 255);&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_cross</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;gray_cross.png&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">search_bar_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">search_bar_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">search_bar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="p">)</span>
        <span class="n">search_bar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_cross</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Advanced search&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_test</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">search_bar_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualized_tags_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Visualized tags&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_table_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Count table&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">tags_tool_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">filters_tool_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advanced_search_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visualized_tags_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_table_button</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.move_splitter">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.move_splitter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">move_splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect the mini viewer if the splitter is not at its minimum</span>
<span class="sd">        position.</span>

<span class="sd">        Checks whether the bottom pane of the vertical splitter is at its</span>
<span class="sd">        minimum height. If it&#39;s larger than the minimum, connects the mini</span>
<span class="sd">        viewer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bottom_pane_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">sizes</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">minimum_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter_vertical</span><span class="o">.</span><span class="n">minimumHeight</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bottom_pane_height</span> <span class="o">==</span> <span class="n">minimum_height</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connect_mini_viewer</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.open_filter">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.open_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a dialog for selecting and opening a saved project filter.</span>

<span class="sd">        Creates and shows a PopUpSelectFilter dialog, allowing the user to</span>
<span class="sd">        choose from previously saved filters associated with the current</span>
<span class="sd">        project. The dialog is stored as an instance attribute to maintain</span>
<span class="sd">        a reference during its lifetime.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popUp</span> <span class="o">=</span> <span class="n">PopUpSelectFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popUp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.open_filter_infos">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.open_filter_infos">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_filter_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the current project filter to the data table.</span>

<span class="sd">        Opens the advanced search interface if the filter contains exclusion</span>
<span class="sd">        criteria (nots), updates the search bar text, and refreshes the</span>
<span class="sd">        visualized scans to match the filtered document collection.</span>

<span class="sd">        The method:</span>
<span class="sd">            - Retrieves documents from the current collection</span>
<span class="sd">            - Updates scans_to_visualize and scans_to_search</span>
<span class="sd">            - Applies the filter&#39;s search bar text</span>
<span class="sd">            - Shows advanced search interface if exclusion filters exist</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filter_to_apply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">currentFilter</span>
        <span class="c1"># We open the advanced search + search_bar</span>
        <span class="n">old_scans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span>

        <span class="c1"># Retrieve documents from the current collection</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span> <span class="o">=</span> <span class="n">documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_search</span> <span class="o">=</span> <span class="n">documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_visualized_rows</span><span class="p">(</span><span class="n">old_scans</span><span class="p">)</span>
        <span class="c1"># Apply search bar filter text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">filter_to_apply</span><span class="o">.</span><span class="n">search_bar</span><span class="p">)</span>

        <span class="c1"># Show advanced search interface if exclusion filters exist</span>

        <span class="k">if</span> <span class="n">filter_to_apply</span><span class="o">.</span><span class="n">nots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setHidden</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">scans_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">show_search</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">apply_filter</span><span class="p">(</span><span class="n">filter_to_apply</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.remove_tag_infos">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.remove_tag_infos">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_tag_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_names_to_remove</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove specified tags from the database and update the UI.</span>

<span class="sd">        This method removes tags from both the current and initial</span>
<span class="sd">        collections, preserving tag attributes and values in the undo history.</span>
<span class="sd">        The table display is updated to reflect the changes.</span>

<span class="sd">        :param tag_names_to_remove: Iterable of tag names (str) to remove from</span>
<span class="sd">                                    the database and table display.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Marks project as having unsaved modifications</span>
<span class="sd">            - Adds removal operation to undo history</span>
<span class="sd">            - Clears redo history</span>
<span class="sd">            - Removes columns from table display</span>
<span class="sd">            - Temporarily disconnects and reconnects table selection signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Temporarily disable selection change signals during update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Prepare history entry for undo functionality</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                <span class="c1"># Collect attributes for tags being removed</span>
                <span class="n">tags_removed</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_names_to_remove</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">unsavedModifications</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_attrib</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag</span>
                    <span class="p">)</span>
                    <span class="n">tags_removed</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tag_attrib</span><span class="p">])</span>

                <span class="c1"># Collect current and initial values for all scans and tags</span>
                <span class="n">values_removed</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">scans</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_names_to_remove</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                        <span class="n">current_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">initial_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="c1"># Only store if at least one value exists</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">current_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">or</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="p">):</span>
                            <span class="n">values_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">scan</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">]</span>
                            <span class="p">)</span>

            <span class="n">history_entry</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;remove_tags&quot;</span><span class="p">,</span> <span class="n">tags_removed</span><span class="p">,</span> <span class="n">values_removed</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Remove tags from database schema and table columns</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_schema</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_names_to_remove</span><span class="p">:</span>
                    <span class="n">database_schema</span><span class="o">.</span><span class="n">remove_field</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
                    <span class="n">database_schema</span><span class="o">.</span><span class="n">remove_field</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">get_tag_column</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Update UI state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Ensure signal is reconnected even if an error occurs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">selection_changed</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.remove_tag_pop_up">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.remove_tag_pop_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_tag_pop_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a modal dialog for removing user tags from the project.</span>

<span class="sd">        Creates and shows a PopUpRemoveTag instance, allowing the user to</span>
<span class="sd">        select and remove tags associated with the current project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_remove_tag</span> <span class="o">=</span> <span class="n">PopUpRemoveTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_remove_tag</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.reset_search_bar">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.reset_search_bar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_search_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the search bar input field.</span>

<span class="sd">        This method resets the search bar to an empty state by clearing</span>
<span class="sd">        any existing text content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.search_str">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.search_str">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">search_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">str_search</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search and filter documents in the table based on a search string.</span>

<span class="sd">        Updates the table&#39;s visualized documents based on the search criteria.</span>
<span class="sd">        An empty string shows all searchable scans. The special value</span>
<span class="sd">        NOT_DEFINED_VALUE filters for documents with undefined field values.</span>

<span class="sd">        :param str_search: The search string to filter documents. Empty string</span>
<span class="sd">                           returns all searchable scans. NOT_DEFINED_VALUE</span>
<span class="sd">                           returns scans with undefined values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_scan_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span>

        <span class="c1"># Handle empty search - return all searchable scans</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">str_search</span><span class="p">:</span>
            <span class="n">filtered_scans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_search</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="n">shown_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>

                <span class="c1"># Prepare filter based on search type</span>
                <span class="k">if</span> <span class="n">str_search</span> <span class="o">==</span> <span class="n">NOT_DEFINED_VALUE</span><span class="p">:</span>
                    <span class="n">filter_criteria</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">prepare_not_defined_filter</span><span class="p">(</span><span class="n">shown_tags</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filter_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">prepare_filter</span><span class="p">(</span>
                        <span class="n">str_search</span><span class="p">,</span>
                        <span class="n">shown_tags</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_search</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Apply filter and extract filenames</span>
                <span class="n">filtered_documents</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">filter_criteria</span>
                <span class="p">)</span>
                <span class="n">filtered_scans</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">scan</span><span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">]</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">filtered_documents</span>
                <span class="p">]</span>

        <span class="c1"># Update table state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span> <span class="o">=</span> <span class="n">filtered_scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_visualized_rows</span><span class="p">(</span><span class="n">old_scan_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">currentFilter</span><span class="o">.</span><span class="n">search_bar</span> <span class="o">=</span> <span class="n">str_search</span></div>


<div class="viewcode-block" id="DataBrowser.send_documents_to_pipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.send_documents_to_pipeline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_documents_to_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a popup dialog for sending filtered scans to the Pipeline</span>
<span class="sd">        Manager.</span>

<span class="sd">        Retrieves the currently filtered scans from the table data and</span>
<span class="sd">        presents them in a selection popup, allowing the user to confirm</span>
<span class="sd">        which scans to send to the pipeline.</span>

<span class="sd">        The popup is shown modally and references the main window as its</span>
<span class="sd">        parent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_scans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">get_current_filter</span><span class="p">()</span>
        <span class="c1"># Displays a popup with the list of scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_selection</span> <span class="o">=</span> <span class="n">PopUpDataBrowserCurrentSelection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">current_scans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_selection</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.show_clone_tag_popup">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.show_clone_tag_popup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_clone_tag_popup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a popup dialog for cloning a tag.</span>

<span class="sd">        This method initializes and shows a popup dialog (`PopUpCloneTag`)</span>
<span class="sd">        to allow the user to clone a tag within the current project context.</span>

<span class="sd">        The popup is stored as an instance variable for later reference if</span>
<span class="sd">        needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_clone_tag</span> <span class="o">=</span> <span class="n">PopUpCloneTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_clone_tag</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataBrowser.toggle_advanced_search">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.toggle_advanced_search">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_advanced_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Toggle the visibility of the advanced search interface.</span>

<span class="sd">        If the advanced search is hidden, it resets and displays the search</span>
<span class="sd">        interface, updating the scans list to the current visualized scans.</span>
<span class="sd">        If the advanced search is visible, it hides the interface, resets the</span>
<span class="sd">        search state, and restores the original scans list to the data browser.</span>

<span class="sd">        This method ensures the UI and data state are synchronized with the</span>
<span class="sd">        visibility of the advanced search.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">isHidden</span><span class="p">():</span>
            <span class="c1"># Display the advanced search interface and reset its state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">scans_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setHidden</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">show_search</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Hide the advanced search interface and restore the original</span>
            <span class="c1"># scans list</span>
            <span class="n">old_scans_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setHidden</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_visualize</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">scans_list</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">scans_to_search</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Reset the current filter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">currentFilter</span><span class="o">.</span><span class="n">nots</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">currentFilter</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">currentFilter</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">currentFilter</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">currentFilter</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_visualized_rows</span><span class="p">(</span><span class="n">old_scans_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataBrowser.update_database">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DataBrowser.update_database">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the project database and reset UI state.</span>

<span class="sd">        This method propagates the database instance to all components that</span>
<span class="sd">        need it and resets UI elements to their default state. It&#39;s called</span>
<span class="sd">        during project lifecycle events (new, open, save as).</span>

<span class="sd">        :param database: The new Database instance to use across the</span>
<span class="sd">                         application.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Propagate database to all dependent components</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advanced_search</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">component</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">database</span>

        <span class="c1"># Reset UI state for new project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">setHidden</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DateFormatDelegate">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DateFormatDelegate">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DateFormatDelegate</span><span class="p">(</span><span class="n">QItemDelegate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom delegate for handling date editing in table views.</span>

<span class="sd">    This delegate provides a QDateEdit widget for editing date values in table</span>
<span class="sd">    cells, with dates formatted as DD/MM/YYYY. It replaces the default text</span>
<span class="sd">    editor with a calendar-based date picker for improved user experience and</span>
<span class="sd">    data validation.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - createEditor: Create and return a QDateEdit widget for editing dates</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DateFormatDelegate.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DateFormatDelegate.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the DateFormatDelegate.</span>

<span class="sd">        :param parent: Optional parent QObject. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span></div>


<div class="viewcode-block" id="DateFormatDelegate.createEditor">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DateFormatDelegate.createEditor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and return a QDateEdit widget for editing dates.</span>

<span class="sd">        This method is called by the view when a cell needs to be edited.</span>
<span class="sd">        It creates a date editor with DD/MM/YYYY format.</span>

<span class="sd">        :param parent: The parent widget for the editor.</span>
<span class="sd">        :param option: Style options for rendering the item.</span>
<span class="sd">        :param index: The model index of the item being edited.</span>

<span class="sd">        :return (QDateEdit): A configured date editor widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">QDateEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setDisplayFormat</span><span class="p">(</span><span class="s2">&quot;dd/MM/yyyy&quot;</span><span class="p">)</span>
        <span class="c1"># Enable calendar popup for better user experience with a visual</span>
        <span class="c1"># calendar picker</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setCalendarPopup</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span></div>
</div>



<div class="viewcode-block" id="DateTimeFormatDelegate">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DateTimeFormatDelegate">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DateTimeFormatDelegate</span><span class="p">(</span><span class="n">QItemDelegate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom delegate for displaying and editing datetime values in table views.</span>

<span class="sd">    This delegate provides a QDateTimeEdit widget for editing datetime cells,</span>
<span class="sd">    formatted as DD/MM/YYYY HH:MM:SS.mmm (day/month/year with milliseconds).</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - createEditor: Create and return a QDateTimeEdit widget for editing</span>
<span class="sd">                        datetimes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DATETIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;dd/MM/yyyy hh:mm:ss.zzz&quot;</span>

<div class="viewcode-block" id="DateTimeFormatDelegate.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DateTimeFormatDelegate.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the datetime delegate.</span>

<span class="sd">        :param parent: Optional parent QWidget. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span></div>


<div class="viewcode-block" id="DateTimeFormatDelegate.createEditor">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.DateTimeFormatDelegate.createEditor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Create and configure a datetime editor widget.</span>

<span class="sd">        :param parent: Parent widget for the editor.</span>
<span class="sd">        :param option: Style options for the item.</span>
<span class="sd">        :param index: Model index of the item being edited.</span>

<span class="sd">        :return (QDateTimeEdit): Configured datetime editor widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">QDateTimeEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setDisplayFormat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span></div>
</div>



<div class="viewcode-block" id="NumberFormatDelegate">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.NumberFormatDelegate">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NumberFormatDelegate</span><span class="p">(</span><span class="n">QItemDelegate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delegate for handling numeric input in table cells.</span>

<span class="sd">    The number of decimal places is automatically inferred from the</span>
<span class="sd">    existing cell value, ensuring consistent formatting of numeric inputs.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - createEditor: Create and return a QDoubleSpinBox widget for editing</span>
<span class="sd">                        numbers</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NumberFormatDelegate.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.NumberFormatDelegate.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the NumberFormatDelegate.</span>

<span class="sd">        :param parent (QWidget): The parent widget. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span></div>


<div class="viewcode-block" id="NumberFormatDelegate.createEditor">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.NumberFormatDelegate.createEditor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and configure a QDoubleSpinBox editor for numeric input.</span>

<span class="sd">        The number of decimal places is determined by examining the current</span>
<span class="sd">        cell value.</span>

<span class="sd">        :param parent: Parent widget for the editor.</span>
<span class="sd">        :param option: Style options for the item.</span>
<span class="sd">        :paramindex: Model index of the item being edited.</span>

<span class="sd">        :return (QDoubleSpinBox): A spin box editor configured with the</span>
<span class="sd">                                  appropriate decimal precision.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">editor</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span>
        <span class="c1"># Determine decimal places from the current value</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">EditRole</span><span class="p">)</span>
        <span class="c1"># Extract the number of decimal places from a numeric string</span>
        <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">decimal_places</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="n">decimal_places</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span></div>
</div>



<div class="viewcode-block" id="TableDataBrowser">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TableDataBrowser</span><span class="p">(</span><span class="n">QTableWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Table widget that displays the documents contained in the database and</span>
<span class="sd">    their associated tags.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - _safe_disconnect: Safely disconnect the itemChanged signal</span>
<span class="sd">        - _safe_reconnect: Safely reconnect the itemChanged signal</span>
<span class="sd">        - add_column: Add a column to the table</span>
<span class="sd">        - add_columns: Add columns to the table</span>
<span class="sd">        - add_path: Call a pop-up to add any document to the project</span>
<span class="sd">        - add_rows: Insert rows if they are not already in the table</span>
<span class="sd">        - clear_cell: Clear the selected cells</span>
<span class="sd">        - context_menu_table: Create the context menu of the table</span>
<span class="sd">        - delete_from_brick: Delete a document from its brick id</span>
<span class="sd">        - display_file: Tries to display a file in the user&#39;s preferred</span>
<span class="sd">                        application</span>
<span class="sd">        - display_unreset_values: Display an error message when trying to</span>
<span class="sd">                                  reset user tags</span>
<span class="sd">        - edit_table_data_values: Change values in DataBrowser</span>
<span class="sd">        - fill_cells_update_table: Initialize and fills the cells of the table</span>
<span class="sd">        - fill_headers: Initialize and fill the headers of the table</span>
<span class="sd">        - get_current_filter: Get the current data browser selection</span>
<span class="sd">        - get_index_insertion: Get index insertion of a new column</span>
<span class="sd">        - get_scan_row: Return the row index of the scan</span>
<span class="sd">        - get_tag_column: Return the column index of the tag</span>
<span class="sd">        - mouseReleaseEvent: Called when clicking released on cells</span>
<span class="sd">        - multiple_sort_infos: Sort the table according to the tags specify</span>
<span class="sd">                               in list_tags</span>
<span class="sd">        - multiple_sort_pop_up: Display the multiple sort pop-up</span>
<span class="sd">        - on_cell_changed: Changes the background color and the value of</span>
<span class="sd">                           cells when edited by the user</span>
<span class="sd">        - remove_scan: Remove documents from table and project</span>
<span class="sd">        - reset_cell: Reset the selected cells to their original values</span>
<span class="sd">        - reset_column: Reset the selected columns to their original values</span>
<span class="sd">        - reset_row: Reset the selected rows to their original values</span>
<span class="sd">        - section_moved: Called when the columns of the data_browser are moved</span>
<span class="sd">        - select_all_column: Called when single clicking on the column header</span>
<span class="sd">                             to select the whole column</span>
<span class="sd">        - select_all_columns: Called from context menu to select the columns</span>
<span class="sd">        - selection_changed: Called when the selection is changed</span>
<span class="sd">        - show_brick_history: Show brick history pop-up</span>
<span class="sd">        - sort_column: Sort the current column</span>
<span class="sd">        - sort_updated: Called when the button advanced search is called</span>
<span class="sd">        - update_colors: Update the background of all the cells</span>
<span class="sd">        - update_selection: Called after searches to update the selection</span>
<span class="sd">        - update_table: Fill the table with the project&#39;s data</span>
<span class="sd">        - update_visualized_columns: Update the visualized tags</span>
<span class="sd">        - update_visualized_rows: Update the list of documents (scans) in</span>
<span class="sd">                                  the table</span>
<span class="sd">        - visualized_tags_pop_up: Display the visualized tags pop-up</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TableDataBrowser.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project</span><span class="p">,</span>
        <span class="n">data_browser</span><span class="p">,</span>
        <span class="n">tags_to_display</span><span class="p">,</span>
        <span class="n">update_values</span><span class="p">,</span>
        <span class="n">activate_selection</span><span class="p">,</span>
        <span class="n">link_viewer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the data table widget with project data and browser</span>
<span class="sd">        context.</span>

<span class="sd">        :param project (Project): The current project instance containing data</span>
<span class="sd">                                  and configuration.</span>
<span class="sd">        :param data_browser (DataBrowser): Parent DataBrowser widget that</span>
<span class="sd">                                           contains this table.</span>
<span class="sd">        :param tags_to_display (list[str]): List of metadata tags to show as</span>
<span class="sd">                                            table columns.</span>
<span class="sd">        :param update_values (bool): If True, enables cell editing;</span>
<span class="sd">                                     if False, table is read-only.</span>
<span class="sd">        :param activate_selection (dict | bool): Dictionary with process</span>
<span class="sd">                                                 execution metadata for</span>
<span class="sd">                                                 document generation, or False</span>
<span class="sd">                                                 to disable selection</span>
<span class="sd">                                                 functionality.</span>
<span class="sd">        :param link_viewer(bool): If True, links table selection to external</span>
<span class="sd">                                  viewer widget. Defaults to True.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Column sorting and reordering are enabled by default</span>
<span class="sd">              (except first column).</span>
<span class="sd">            - Extended selection mode is used unless ``activate_selection``</span>
<span class="sd">              is falsy.</span>
<span class="sd">            - A custom context menu is available only when both</span>
<span class="sd">              ``activate_selection`` and ``link_viewer`` are True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Store instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span> <span class="o">=</span> <span class="n">data_browser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_to_display</span> <span class="o">=</span> <span class="n">tags_to_display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_values</span> <span class="o">=</span> <span class="n">update_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span> <span class="o">=</span> <span class="n">activate_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_viewer</span> <span class="o">=</span> <span class="n">link_viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Configure table behavior</span>
        <span class="c1"># Configure selection mode based on activate_selection setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span>
            <span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">ExtendedSelection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span>
            <span class="k">else</span> <span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">NoSelection</span>
        <span class="p">)</span>
        <span class="c1"># Configure header behavior</span>
        <span class="n">horizontal_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span>
        <span class="c1"># Allows to move the columns (except the first column name)</span>
        <span class="n">horizontal_header</span><span class="o">.</span><span class="n">setSectionsMovable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Allows the automatic sort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setMinimumSectionSize</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># Disable editing if update_values is False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEditTriggers</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">NoEditTriggers</span><span class="p">)</span>

        <span class="c1"># Set up context menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setContextMenuPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">CustomContextMenu</span><span class="p">)</span>

        <span class="c1"># Connect Qt signals to their respective slot handlers</span>
        <span class="c1"># Only connect context menu handler when selection is active and</span>
        <span class="c1"># linked to viewer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_viewer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">customContextMenuRequested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_menu_table</span><span class="p">)</span>

        <span class="c1"># Item changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cell_changed</span><span class="p">)</span>

        <span class="c1"># Selection changes (only when selection is active)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_changed</span><span class="p">)</span>

        <span class="c1"># Header interactions</span>
        <span class="n">horizontal_header</span><span class="o">.</span><span class="n">sortIndicatorChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_updated</span><span class="p">)</span>
        <span class="n">horizontal_header</span><span class="o">.</span><span class="n">sectionDoubleClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_all_column</span><span class="p">)</span>
        <span class="n">horizontal_header</span><span class="o">.</span><span class="n">sectionMoved</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section_moved</span><span class="p">)</span>
        <span class="c1"># Initialize table content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_table</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_safe_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safely disconnect the ``itemChanged`` signal from the</span>
<span class="sd">        ``on_cell_changed`` slot.</span>

<span class="sd">        This helper ensures that calling ``disconnect`` does not raise a</span>
<span class="sd">        ``TypeError`` if the slot was not previously connected. It</span>
<span class="sd">        effectively prevents errors when attempting to disconnect</span>
<span class="sd">        redundantly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cell_changed</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_safe_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safely reconnect the ``itemChanged`` signal to the</span>
<span class="sd">        ``on_cell_changed`` slot.</span>

<span class="sd">        This helper first ensures that any previous connection is removed</span>
<span class="sd">        by calling ``_safe_disconnect()``, preventing duplicate</span>
<span class="sd">        connections. After that, it connects ``itemChanged`` to</span>
<span class="sd">        ``on_cell_changed``, guaranteeing that the slot is connected</span>
<span class="sd">        exactly once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cell_changed</span><span class="p">)</span>

<div class="viewcode-block" id="TableDataBrowser.add_column">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.add_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new column to the table with the specified tag.</span>

<span class="sd">        Inserts a column at the given index, configures its header with</span>
<span class="sd">        metadata from the database, sets the appropriate delegate based on</span>
<span class="sd">        field type, and populates cells with current values from the database.</span>

<span class="sd">        :param column (int): Zero-based index where the column should be</span>
<span class="sd">                             inserted.</span>
<span class="sd">        :param tag (str): Tag name identifying the field to add from the</span>
<span class="sd">                          database.</span>

<span class="sd">        Note:</span>
<span class="sd">            Temporarily disconnects item change signals during insertion to</span>
<span class="sd">            prevent unwanted event triggers, then reconnects them after</span>
<span class="sd">            completion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import locally to avoid circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="c1"># Temporarily disconnect signals during bulk operations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Insert column and configure header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="n">header_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setHorizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">header_item</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="n">tag_attrib</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag</span>
                <span class="p">)</span>
                <span class="n">field_type</span> <span class="o">=</span> <span class="n">tag_attrib</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                <span class="c1"># Configure header with tag metadata</span>
                <span class="n">header_item</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">header_item</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Unit: </span><span class="si">{</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Type: </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Map field types to their corresponding delegates</span>
                <span class="n">delegate_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">FIELD_TYPE_FLOAT</span><span class="p">:</span> <span class="n">NumberFormatDelegate</span><span class="p">,</span>
                    <span class="n">FIELD_TYPE_DATETIME</span><span class="p">:</span> <span class="n">DateTimeFormatDelegate</span><span class="p">,</span>
                    <span class="n">FIELD_TYPE_DATE</span><span class="p">:</span> <span class="n">DateFormatDelegate</span><span class="p">,</span>
                    <span class="n">FIELD_TYPE_TIME</span><span class="p">:</span> <span class="n">TimeFormatDelegate</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="c1"># Set appropriate delegate for column based on field type</span>
                <span class="n">delegate_class</span> <span class="o">=</span> <span class="n">delegate_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>
                <span class="n">delegate</span> <span class="o">=</span> <span class="n">delegate_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">delegate_class</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setItemDelegateForColumn</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">delegate</span><span class="p">)</span>

                <span class="c1"># Populate column cells with values from database</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">cur_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">cur_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cur_value</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Style undefined values with italic bold font</span>
                        <span class="n">set_item_data</span><span class="p">(</span>
                            <span class="n">item</span><span class="p">,</span> <span class="n">NOT_DEFINED_VALUE</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span>
                        <span class="p">)</span>
                        <span class="n">font</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
                        <span class="n">font</span><span class="o">.</span><span class="n">setItalic</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>

            <span class="c1"># Update UI state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always reconnect signals, even if an exception occurred</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_changed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.add_columns">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.add_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and update table columns based on database fields.</span>

<span class="sd">         This method synchronizes the table&#39;s columns with the current database</span>
<span class="sd">         schema by:</span>
<span class="sd">             - Adding columns for new database fields that don&#39;t exist in the</span>
<span class="sd">               table</span>
<span class="sd">             - Populating new columns with values from the database</span>
<span class="sd">             - Removing columns that no longer exist in the database</span>
<span class="sd">             - Applying appropriate formatting delegates based on field types</span>
<span class="sd">             - Maintaining column visibility settings</span>

<span class="sd">         The method temporarily disconnects item change signals during</span>
<span class="sd">         operation to prevent unwanted events, then reconnects them after</span>
<span class="sd">         completion.</span>

<span class="sd">         Note:</span>
<span class="sd">             - The TAG_FILENAME column is always placed first</span>
<span class="sd">             - Columns are sorted alphabetically (except TAG_FILENAME)</span>
<span class="sd">             - System tags (TAG_CHECKSUM, TAG_HISTORY) are excluded</span>
<span class="sd">             - Undefined values are displayed in italic bold text</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import locally to prevent circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="c1"># Temporarily disconnect signals to prevent cascading updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="c1"># Prepare tag list: exclude system tags, sort, and place</span>
                <span class="c1"># filename first</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">))</span>
                <span class="n">tags</span> <span class="o">-=</span> <span class="p">{</span><span class="n">TAG_CHECKSUM</span><span class="p">,</span> <span class="n">TAG_HISTORY</span><span class="p">}</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span> <span class="o">-</span> <span class="p">{</span><span class="n">TAG_FILENAME</span><span class="p">})</span>
                <span class="n">visible_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>

                <span class="c1"># Add missing columns</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tag_column</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">column_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_insertion</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">(</span><span class="n">column_index</span><span class="p">)</span>

                    <span class="c1"># Set up column header</span>
                    <span class="n">header_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setHorizontalHeaderItem</span><span class="p">(</span><span class="n">column_index</span><span class="p">,</span> <span class="n">header_item</span><span class="p">)</span>
                    <span class="n">tag_attrib</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_attrib</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">type_name</span>

                        <span class="n">field_type</span> <span class="o">=</span> <span class="n">tag_attrib</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                        <span class="n">tooltip</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Unit: </span><span class="si">{</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Type: </span><span class="si">{</span><span class="n">type_name</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">header_item</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
                        <span class="c1"># Apply field-type specific delegate</span>
                        <span class="n">delegate_map</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">FIELD_TYPE_FLOAT</span><span class="p">:</span> <span class="n">NumberFormatDelegate</span><span class="p">,</span>
                            <span class="n">FIELD_TYPE_DATETIME</span><span class="p">:</span> <span class="n">DateTimeFormatDelegate</span><span class="p">,</span>
                            <span class="n">FIELD_TYPE_DATE</span><span class="p">:</span> <span class="n">DateFormatDelegate</span><span class="p">,</span>
                            <span class="n">FIELD_TYPE_TIME</span><span class="p">:</span> <span class="n">TimeFormatDelegate</span><span class="p">,</span>
                        <span class="p">}</span>

                        <span class="n">delegate_class</span> <span class="o">=</span> <span class="n">delegate_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">delegate_class</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">setItemDelegateForColumn</span><span class="p">(</span>
                                <span class="n">column_index</span><span class="p">,</span> <span class="n">delegate_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="c1"># Set visibility</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="n">column_index</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visible_tags</span><span class="p">)</span>

                    <span class="c1"># Populate column with data</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column_index</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

                        <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_item_data</span><span class="p">(</span>
                                <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tag_attrib</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                            <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Style undefined values distinctly</span>
                            <span class="n">set_item_data</span><span class="p">(</span>
                                <span class="n">item</span><span class="p">,</span> <span class="n">NOT_DEFINED_VALUE</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span>
                            <span class="p">)</span>
                            <span class="n">font</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
                            <span class="n">font</span><span class="o">.</span><span class="n">setItalic</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>

                <span class="c1"># Remove obsolete columns</span>
                <span class="n">current_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">current_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TAG_FILENAME</span><span class="p">)</span>

                <span class="c1"># Collect columns to remove (iterate in reverse to avoid index</span>
                <span class="c1"># shifting)</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">())):</span>
                    <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">tag_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_fields</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

            <span class="c1"># Update UI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_changed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.add_path">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.add_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a dialog to add documents to the current project.</span>

<span class="sd">        Creates and displays a PopUpAddPath dialog that allows users to select</span>
<span class="sd">        and add document paths to the project&#39;s data browser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_add_path</span> <span class="o">=</span> <span class="n">PopUpAddPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up_add_path</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.add_rows">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.add_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert rows into the table if they don&#39;t already exist.</span>

<span class="sd">        This method adds new scans to the table, populating each column with</span>
<span class="sd">        data from the database. It displays a progress dialog during the</span>
<span class="sd">        operation and handles special cases like the TAG_BRICKS column with</span>
<span class="sd">        custom widgets.</span>

<span class="sd">        :param rows: An iterable of scan identifiers to be added to the table.</span>

<span class="sd">        Note:</span>
<span class="sd">            - Duplicate scans (already present in the table) are automatically</span>
<span class="sd">              skipped</span>
<span class="sd">            - Sorting is temporarily disabled during the insertion process</span>
<span class="sd">            - The first column (name) is set as non-editable</span>
<span class="sd">            - TAG_BRICKS columns receive custom button widgets for interaction</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Import set_item_data here to prevent circular import issue</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="c1"># Temporarily disable sorting and disconnect signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>
        <span class="c1"># Initialize and configure progress dialog</span>
        <span class="n">cells_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span>
            <span class="s2">&quot;Please wait while the paths are being added...&quot;</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">cells_number</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setMinimumDuration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>  <span class="c1"># For mac OS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Adding the paths&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">Window</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowTitleHint</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CustomizeWindowHint</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setModal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_DeleteOnClose</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Add rows with database context</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>

                <span class="c1"># Skip if scan already exists in table</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_row</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">row_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>

                <span class="c1"># Populate columns for the new row</span>
                <span class="k">for</span> <span class="n">column_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()):</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column_index</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">column_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># First column: name tag (non-editable)</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span><span class="p">)</span>
                        <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Retrieve value from database</span>
                        <span class="n">cur_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">cur_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_BRICKS</span><span class="p">:</span>
                                <span class="c1"># Tag bricks, display list with buttons</span>
                                <span class="n">widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
                                <span class="n">widget</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span>
                                    <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span>
                                <span class="p">)</span>
                                <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
                                <span class="n">brick_uuid</span> <span class="o">=</span> <span class="n">cur_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">brick_name</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                                    <span class="n">primary_key</span><span class="o">=</span><span class="n">brick_uuid</span><span class="p">,</span>
                                    <span class="n">field</span><span class="o">=</span><span class="n">BRICK_NAME</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="n">brick_name_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">brick_name</span><span class="p">)</span>
                                <span class="n">brick_name_button</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span>
                                    <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span>
                                <span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="p">[</span><span class="n">brick_name_button</span><span class="p">]</span> <span class="o">=</span> <span class="n">brick_uuid</span>

                                <span class="k">if</span> <span class="n">TAG_FILENAME</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">:</span>
                                    <span class="n">brick_name_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                        <span class="n">partial</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">show_brick_history</span><span class="p">,</span>
                                            <span class="n">scan</span><span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">],</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>

                                <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">brick_name_button</span><span class="p">)</span>
                                <span class="n">widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
                                    <span class="n">row_index</span><span class="p">,</span> <span class="n">column_index</span><span class="p">,</span> <span class="n">widget</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Standard cell with database value</span>
                                <span class="n">field_type</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag</span>
                                    <span class="p">)[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                                <span class="p">)</span>
                                <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cur_value</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Handle undefined values</span>

                            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_BRICKS</span><span class="p">:</span>
                                <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">)</span>
                                <span class="c1"># bricks not editable</span>
                                <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span>
                                    <span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">set_item_data</span><span class="p">(</span>
                                    <span class="n">item</span><span class="p">,</span> <span class="n">NOT_DEFINED_VALUE</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span>
                                <span class="p">)</span>
                                <span class="n">font</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
                                <span class="n">font</span><span class="o">.</span><span class="n">setItalic</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">item</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_index</span><span class="p">,</span> <span class="n">column_index</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="c1"># Restore table state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resizeRowsToContents</span><span class="p">()</span>
        <span class="c1"># Selection updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>
        <span class="c1"># Reconnect signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>
        <span class="c1"># Clean up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.clear_cell">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.clear_cell">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear values from selected cells in the table.</span>

<span class="sd">        This method removes data from the currently selected cells in the</span>
<span class="sd">        database and updates the UI to reflect the cleared state. The</span>
<span class="sd">        operation is recorded in the project&#39;s undo history for potential</span>
<span class="sd">        reversal.</span>

<span class="sd">        The method performs the following actions for each selected cell:</span>
<span class="sd">            - Retrieves the current value from the database</span>
<span class="sd">            - Removes the value from the database</span>
<span class="sd">            - Updates the cell&#39;s visual appearance (italic + bold)</span>
<span class="sd">            - Records the change for undo/redo functionality</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Modifies database values in COLLECTION_CURRENT</span>
<span class="sd">            - Updates table cell formatting</span>
<span class="sd">            - Appends operation to project.undos</span>
<span class="sd">            - Clears project.redos</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import here to prevent circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="c1"># Track modifications for undo/redo functionality</span>
        <span class="n">modified_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">():</span>
                <span class="c1"># Extract cell coordinates and identifiers</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">cell_index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">cell_index</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
                <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">scan_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="c1"># Retrieve current value before clearing</span>
                <span class="n">current_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Record change for history (scan, tag, old_value, new_value)</span>
                <span class="n">modified_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">scan_name</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Clear value from database</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">scan_name</span><span class="p">,</span> <span class="n">tag_name</span>
                <span class="p">)</span>
                <span class="c1"># Update cell appearance to indicate cleared state</span>
                <span class="n">cell_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                <span class="n">set_item_data</span><span class="p">(</span><span class="n">cell_item</span><span class="p">,</span> <span class="n">NOT_DEFINED_VALUE</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">)</span>
                <span class="c1"># Apply italic and bold formatting to cleared cells</span>
                <span class="n">font</span> <span class="o">=</span> <span class="n">cell_item</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
                <span class="n">font</span><span class="o">.</span><span class="n">setItalic</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cell_item</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>

        <span class="c1"># Register operation in undo history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;modified_values&quot;</span><span class="p">,</span> <span class="n">modified_values</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.context_menu_table">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.context_menu_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">context_menu_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and display the context menu for the table, and perform</span>
<span class="sd">        the corresponding action based on the user&#39;s selection.</span>

<span class="sd">        :param position (QPoint): The mouse cursor position relative to the</span>
<span class="sd">                                  widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_confirm_action</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="nb">callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Display a warning message box with an OK/Cancel choice and connect</span>
<span class="sd">            the OK button to a callback function.</span>

<span class="sd">            The dialog shows a warning icon and the provided message. If the</span>
<span class="sd">            user confirms the action by clicking OK, the specified callback is</span>
<span class="sd">            invoked. Cancel simply closes the dialog without side effects.</span>

<span class="sd">            :param text (str): The warning message text to display in the</span>
<span class="sd">                                dialog.</span>
<span class="sd">            :param callback (callable): The function to execute if the user</span>
<span class="sd">                                        clicks OK.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Warning&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">)</span>
            <span class="n">ok_button</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
            <span class="n">ok_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_do_add_document</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Safely add a new document to the table without triggering the</span>
<span class="sd">            ``itemChanged`` signal.</span>

<span class="sd">            This helper temporarily disconnects the ``itemChanged`` signal from</span>
<span class="sd">            ``on_cell_changed`` to prevent unwanted callbacks while adding a</span>
<span class="sd">            new document. After that, it calls ``add_path()`` to perform the</span>
<span class="sd">            actual addition.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_path</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

        <span class="c1"># -- Build menu actions ---------------------------------</span>
        <span class="n">confirm_actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Reset cell(s)&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;You are about to reset cells.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_cell</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;Reset column(s)&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;You are about to reset columns.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_column</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;Reset row(s)&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;You are about to reset rows.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_row</span><span class="p">),</span>
            <span class="s2">&quot;Clear cell(s)&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;You are about to clear cells.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_cell</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;Remove document(s)&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;You are about to remove a scan from the project.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Be careful! This action is definitive and cannot be undone &quot;</span>
                <span class="s2">&quot;(the data will be completely deleted).&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_scan</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="n">direct_actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Add document&quot;</span><span class="p">:</span> <span class="n">_do_add_document</span><span class="p">,</span>
            <span class="s2">&quot;Sort column&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_column</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;Sort column (descending)&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_column</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;Visualized tags&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualized_tags_pop_up</span><span class="p">,</span>
            <span class="s2">&quot;Select column(s)&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_all_columns</span><span class="p">,</span>
            <span class="s2">&quot;Multiple sort&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_sort_pop_up</span><span class="p">,</span>
            <span class="s2">&quot;Send documents to the Pipeline Manager&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">send_documents_to_pipeline</span>
            <span class="p">),</span>
            <span class="s2">&quot;Tries to read a file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_file</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># -- Execute --------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">action_objects</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="ow">in</span> <span class="n">confirm_actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">action_objects</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">t</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="n">callback</span><span class="p">:</span> <span class="n">_confirm_action</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">direct_actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">action_objects</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>

            <span class="n">selected_action</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapToGlobal</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">selected_action</span> <span class="ow">in</span> <span class="n">action_objects</span><span class="p">:</span>
                <span class="n">action_objects</span><span class="p">[</span><span class="n">selected_action</span><span class="p">]()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.delete_from_brick">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.delete_from_brick">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_from_brick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brick_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a brick and its associated documents from the database.</span>

<span class="sd">        This method cleans up the database when a pipeline (composed of</span>
<span class="sd">        multiple bricks) is initialized but not executed before another</span>
<span class="sd">        pipeline is started or the software is closed. It removes the brick</span>
<span class="sd">        and any orphaned output documents that are not used as inputs</span>
<span class="sd">        elsewhere.</span>

<span class="sd">        :param brick_id (str): The unique identifier of the brick to be</span>
<span class="sd">                               deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="c1"># Fetch the brick document</span>
            <span class="n">brick_doc</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span> <span class="n">primary_keys</span><span class="o">=</span><span class="n">brick_id</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">brick_doc</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># Extract all input and output document IDs</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">extract_document_ids</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Extracts all string values from a nested dictionary structure.</span>

<span class="sd">                This function traverses the values of the input dictionary.</span>
<span class="sd">                If a value is:</span>
<span class="sd">                    - a string: it is added to the resulting set of</span>
<span class="sd">                                document IDs.</span>
<span class="sd">                    - a list: its elements are recursively traversed and</span>
<span class="sd">                              processed. Non-string, non-list values are</span>
<span class="sd">                              ignored.</span>

<span class="sd">                :param data (dict): Dictionary that may contain nested strings</span>
<span class="sd">                                    or lists as values.</span>

<span class="sd">                :returns (set[str]): A set containing all unique string values</span>
<span class="sd">                                     found within the dictionary.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">document_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

                <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">document_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">document_ids</span>

            <span class="n">inputs</span> <span class="o">=</span> <span class="n">extract_document_ids</span><span class="p">(</span><span class="n">brick_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">BRICK_INPUTS</span><span class="p">])</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">extract_document_ids</span><span class="p">(</span><span class="n">brick_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">BRICK_OUTPUTS</span><span class="p">])</span>

            <span class="c1"># Remove orphaned outputs</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span> <span class="ow">or</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
                <span class="n">scan_object</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_keys</span><span class="o">=</span><span class="n">relative_path</span><span class="p">,</span>
                    <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">,</span> <span class="n">TAG_BRICKS</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">scan_object</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">bricks</span> <span class="o">=</span> <span class="n">scan_object</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">TAG_BRICKS</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">bricks</span> <span class="ow">and</span> <span class="n">brick_id</span> <span class="ow">in</span> <span class="n">bricks</span><span class="p">:</span>
                    <span class="n">bricks</span> <span class="o">=</span> <span class="p">[</span><span class="n">brick</span> <span class="k">for</span> <span class="n">brick</span> <span class="ow">in</span> <span class="n">bricks</span> <span class="k">if</span> <span class="n">brick</span> <span class="o">!=</span> <span class="n">brick_id</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">bricks</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_row</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span>
                            <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">relative_path</span>
                        <span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">database_data</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span>
                                <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">relative_path</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">relative_path</span><span class="p">,</span>
                        <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">TAG_BRICKS</span><span class="p">:</span> <span class="n">bricks</span><span class="p">},</span>
                    <span class="p">)</span>

            <span class="c1"># Remove the brick itself</span>
            <span class="n">database_data</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span> <span class="n">brick_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.display_file">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.display_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the selected file(s) in the user&#39;s default application.</span>

<span class="sd">        Iterates over all selected items in the view, resolves their absolute</span>
<span class="sd">        paths, and opens each file using the platform&#39;s default application.</span>

<span class="sd">        Supported platforms: Linux, macOS, and Windows.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">():</span>
            <span class="n">scan_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">scan_path</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Platform-specific file opening logic</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Linux&quot;</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;xdg-open&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">],</span> <span class="n">start_new_session</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="c1"># FIXME: test the following part of the code for windows and macos!</span>
            <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsupported platform: </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.display_unreset_values">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.display_unreset_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_unreset_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays a warning dialog listing values that cannot be reset.</span>

<span class="sd">        This method shows a QMessageBox warning when certain values (such as</span>
<span class="sd">        user tags, FileName, or undefined cells) cannot be reset because they</span>
<span class="sd">        lack a raw value. The dialog includes a descriptive message and an OK</span>
<span class="sd">        button for dismissal.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">warning_dialog</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
        <span class="n">warning_dialog</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
        <span class="n">warning_dialog</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Reset Warning&quot;</span><span class="p">)</span>
        <span class="n">warning_dialog</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Some values cannot be reset.&quot;</span><span class="p">)</span>
        <span class="n">warning_dialog</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span>
            <span class="s2">&quot;Some values were not reset because they lack a raw value.</span><span class="se">\n</span><span class="s2">It is &quot;</span>
            <span class="s2">&quot;the case for the user tags, FileName and Undefined cells.&quot;</span>
        <span class="p">)</span>
        <span class="n">warning_dialog</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">warning_dialog</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">warning_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">warning_dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.edit_table_data_values">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.edit_table_data_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">edit_table_data_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Edit and update selected cell values in the DataBrowser table.</span>

<span class="sd">        This method handles the selection of cells, validation of list</span>
<span class="sd">        lengths, and updating of values in both the table and the database.</span>
<span class="sd">        It supports list-type fields and ensures data consistency across</span>
<span class="sd">        selections.</span>

<span class="sd">        Steps:</span>
<span class="sd">            1. Collects selected cells and their metadata</span>
<span class="sd">               (coordinates, types, lengths, etc.).</span>
<span class="sd">            2. Validates list lengths for compatibility.</span>
<span class="sd">            3. Opens a dialog for value modification if valid.</span>
<span class="sd">            4. Updates the table and database, and records changes for</span>
<span class="sd">               undo/redo history.</span>

<span class="sd">        Note:</span>
<span class="sd">            - Exits early if the selected tag is &#39;TAG_BRICKS&#39; or if the field</span>
<span class="sd">              type is not a list.</span>
<span class="sd">            - Disconnects and reconnects the `itemChanged` signal to prevent</span>
<span class="sd">              recursive updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># import set_item_data only here to prevent circular import issue</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setMouseTracking</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Coordinates of selected cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_database_values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Old database values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_table_values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Old table values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Unique types</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Unique lengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of table scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of table tags</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">():</span>
                    <span class="n">column</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">column</span><span class="p">(),</span> <span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">])</span>
                    <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">tag_attrib</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                    <span class="p">)</span>
                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">tag_attrib</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                    <span class="n">scan_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="n">TAG_BRICKS</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">setMouseTracking</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">return</span>

                    <span class="c1"># Scan, tag, type added</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag_type</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">tag_type</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">setMouseTracking</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">return</span>

                    <span class="c1"># Fetch and store old values</span>
                    <span class="n">database_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">old_database_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">database_value</span><span class="p">)</span>
                    <span class="n">table_value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">EditRole</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">table_value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">table_value</span><span class="p">)</span>

                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
                        <span class="n">table_value</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">old_table_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_value</span><span class="p">)</span>

                    <span class="c1"># Store length if valid</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lengths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">database_value</span><span class="p">))</span>

                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">lengths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Error if lists of different lengths</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lengths</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">lengths</span><span class="p">:</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Incompatible list lengths&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span><span class="s2">&quot;The lists can&#39;t have several lengths&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Warning&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setMouseTracking</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_table_values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setMouseTracking</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Prepare initial value for dialog</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_table_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Open dialog for value modification</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">popup</span> <span class="o">=</span> <span class="n">ModifyTable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">popup</span><span class="o">.</span><span class="n">exec_</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">popup</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">popup</span>

            <span class="c1"># Record changes for history</span>
            <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;modified_values&quot;</span><span class="p">,</span> <span class="p">[]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">new_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
                    <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_database_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">new_cur_value</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="ow">or</span> <span class="n">NOT_DEFINED_VALUE</span>
                    <span class="p">)</span>
                    <span class="n">history_maker</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">scan</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_cur_value</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">set_item_data</span><span class="p">(</span>
                        <span class="n">new_item</span><span class="p">,</span>
                        <span class="n">new_cur_value</span><span class="p">,</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                            <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag</span>
                        <span class="p">)[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">new_item</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># For history</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMouseTracking</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeRowsToContents</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.fill_cells_update_table">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.fill_cells_update_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fill_cells_update_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize and populate table cells with scan data from the database.</span>

<span class="sd">        This method performs the following operations:</span>
<span class="sd">            1. Creates a progress dialog to track cell population</span>
<span class="sd">            2. Retrieves scan documents matching scans_to_visualize from the</span>
<span class="sd">               database</span>
<span class="sd">            3. Populates each cell with appropriate data based on column type</span>
<span class="sd">            4. Handles special cases (name column, bricks column)</span>
<span class="sd">            5. Applies saved sorting preferences</span>
<span class="sd">            6. Resizes rows and columns to fit content</span>

<span class="sd">        Special column handling:</span>
<span class="sd">            - Column 0 (name): Read-only, always displays as string</span>
<span class="sd">            - Bricks column: Displays clickable buttons for brick history</span>
<span class="sd">            - Other columns: Editable, type-specific formatting</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Displays a modal progress dialog during population</span>
<span class="sd">            - Temporarily hides the table during updates for performance</span>
<span class="sd">            - Connects cell change signals after population completes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Lazy import to prevent circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="c1"># Initialize progress dialog</span>
        <span class="n">cells_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span>
            <span class="s2">&quot;Please wait while the cells are being filled...&quot;</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">cells_count</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setMinimumDuration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>  <span class="c1"># For mac OS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Filling the cells&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">Window</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowTitleHint</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CustomizeWindowHint</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setModal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_DeleteOnClose</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cell_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="n">primary_key</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_primary_key_name</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span>
                <span class="p">)</span>

                <span class="c1"># Fetch scans from database</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">:</span>
                    <span class="n">escaped_scans</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">scan</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span>
                    <span class="p">]</span>
                    <span class="n">joined_scans</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">escaped_scans</span>
                    <span class="p">)</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">primary_key</span><span class="si">}</span><span class="s2"> IN [</span><span class="si">{</span><span class="n">joined_scans</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="n">scans</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">query</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Extract column tags and their types</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()))</span>
                <span class="p">]</span>
                <span class="n">field_names</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
                <span class="n">tag_type_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">field_name</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                            <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">field_name</span>
                        <span class="p">)</span>
                        <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span>
                <span class="p">}</span>
                <span class="n">tag_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag_type_map</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>

                <span class="c1"># Populate table cells</span>
                <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">scan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scans</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                        <span class="n">cell_index</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Name column: read-only</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span><span class="p">)</span>
                            <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">scan</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current_value</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                            <span class="n">col_type</span> <span class="o">=</span> <span class="n">tag_types</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>

                            <span class="k">if</span> <span class="n">current_value</span><span class="p">:</span>

                                <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">TAG_BRICKS</span><span class="p">:</span>
                                    <span class="n">set_item_data</span><span class="p">(</span>
                                        <span class="n">item</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">col_type</span>
                                    <span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Bricks column: create widget with button</span>
                                    <span class="n">widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
                                    <span class="n">widget</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span>
                                        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span>
                                    <span class="p">)</span>
                                    <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

                                    <span class="n">brick_uuid</span> <span class="o">=</span> <span class="n">current_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">brick_name</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                                        <span class="n">primary_key</span><span class="o">=</span><span class="n">brick_uuid</span><span class="p">,</span>
                                        <span class="n">field</span><span class="o">=</span><span class="n">BRICK_NAME</span><span class="p">,</span>
                                    <span class="p">)</span>

                                    <span class="k">if</span> <span class="n">brick_name</span><span class="p">:</span>
                                        <span class="n">button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">brick_name</span><span class="p">)</span>
                                        <span class="n">button</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span>
                                            <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span>
                                        <span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="p">[</span><span class="n">button</span><span class="p">]</span> <span class="o">=</span> <span class="n">brick_uuid</span>
                                        <span class="n">button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                            <span class="n">partial</span><span class="p">(</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">show_brick_history</span><span class="p">,</span>
                                                <span class="n">scan</span><span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">],</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">button</span><span class="p">)</span>

                                    <span class="n">widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">widget</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="c1"># Handle undefined values</span>
                                <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">TAG_BRICKS</span><span class="p">:</span>
                                    <span class="n">set_item_data</span><span class="p">(</span>
                                        <span class="n">item</span><span class="p">,</span>
                                        <span class="n">NOT_DEFINED_VALUE</span><span class="p">,</span>
                                        <span class="n">FIELD_TYPE_STRING</span><span class="p">,</span>
                                    <span class="p">)</span>
                                    <span class="n">font</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
                                    <span class="n">font</span><span class="o">.</span><span class="n">setItalic</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="n">font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="n">item</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># No brick: clear widget and mark</span>
                                    <span class="c1"># non-editable</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">)</span>
                                    <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span>
                                        <span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span>
                                    <span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

            <span class="c1"># Apply saved sorting preferences</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tag_to_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getSortedTag</span><span class="p">()</span>
            <span class="n">column_to_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tag_column</span><span class="p">(</span><span class="n">tag_to_sort</span><span class="p">)</span>
            <span class="n">sort_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getSortOrder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">column_to_sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSortIndicator</span><span class="p">(</span>
                    <span class="n">column_to_sort</span><span class="p">,</span> <span class="n">sort_order</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSortIndicator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">resizeRowsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.fill_headers">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.fill_headers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fill_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">take_tags_to_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize and populate table headers with field metadata.</span>

<span class="sd">        Sets up table columns based on database fields, configuring each with:</span>
<span class="sd">            - Appropriate tooltips showing description, unit, and type</span>
<span class="sd">            - Specialized delegates for numeric and temporal data types</span>
<span class="sd">            - Visibility based on display settings or field attributes</span>

<span class="sd">        :param take_tags_to_update: If True, use tags_to_display for</span>
<span class="sd">                                    visibility. If False, use field visibility</span>
<span class="sd">                                    attributes. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get field names and prepare sorted list with FileName first</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>

        <span class="c1"># Remove internal fields and sort, keeping TAG_FILENAME at position 0</span>
        <span class="k">for</span> <span class="n">internal_tag</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TAG_CHECKSUM</span><span class="p">,</span> <span class="n">TAG_FILENAME</span><span class="p">,</span> <span class="n">TAG_HISTORY</span><span class="p">):</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">internal_tag</span><span class="p">)</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
        <span class="c1"># Mapping of field types to their corresponding delegates</span>
        <span class="n">DELEGATE_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">FIELD_TYPE_FLOAT</span><span class="p">:</span> <span class="n">NumberFormatDelegate</span><span class="p">,</span>
            <span class="n">FIELD_TYPE_DATETIME</span><span class="p">:</span> <span class="n">DateTimeFormatDelegate</span><span class="p">,</span>
            <span class="n">FIELD_TYPE_DATE</span><span class="p">:</span> <span class="n">DateFormatDelegate</span><span class="p">,</span>
            <span class="n">FIELD_TYPE_TIME</span><span class="p">:</span> <span class="n">TimeFormatDelegate</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">tag_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                <span class="n">tag_attrib</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">tag_attrib</span><span class="p">:</span>
                    <span class="c1"># Set tooltip with field metadata</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">type_name</span>

                    <span class="n">item</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Unit: </span><span class="si">{</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Type: </span><span class="si">{</span><span class="n">type_name</span><span class="p">(</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Apply specialized delegate based on field type</span>
                    <span class="n">delegate_class</span> <span class="o">=</span> <span class="n">DELEGATE_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag_attrib</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">delegate_class</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">setItemDelegateForColumn</span><span class="p">(</span>
                            <span class="n">column</span><span class="p">,</span> <span class="n">delegate_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Determine column visibility</span>
                    <span class="n">is_visible</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">tag_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags_to_display</span>
                        <span class="k">if</span> <span class="n">take_tags_to_update</span>
                        <span class="k">else</span> <span class="n">tag_attrib</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="ow">not</span> <span class="n">is_visible</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">setHorizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.get_current_filter">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.get_current_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current data browser selection.</span>

<span class="sd">        Returns the list of selected scan paths if a selection is active,</span>
<span class="sd">        otherwise returns all visible scan paths in the data browser.</span>

<span class="sd">        :return (list): List of scan paths from either the current selection</span>
<span class="sd">                        or all visible scans in the data browser.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span></div>


<div class="viewcode-block" id="TableDataBrowser.get_index_insertion">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.get_index_insertion">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_index_insertion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_insert</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the insertion index for a new column to maintain alphabetical</span>
<span class="sd">        order.</span>

<span class="sd">        Uses binary search to efficiently locate the correct position for</span>
<span class="sd">        inserting a column header while preserving the existing alphabetical</span>
<span class="sd">        sort order.</span>

<span class="sd">        :param to_insert (str): The column header text to insert.</span>

<span class="sd">        :return (int): The column index where the new column should be</span>
<span class="sd">                       inserted. Returns columnCount() if it should be</span>
<span class="sd">                       appended at the end.</span>

<span class="sd">        Note: Assumes that column 0 is reserved (TAG_FILENAME must always be</span>
<span class="sd">              the first tag on the left) and start the search from column 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract column headers starting from index 1</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="c1"># Find insertion point using binary search</span>
        <span class="n">insertion_index</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">to_insert</span><span class="p">)</span>

        <span class="c1"># Adjust for skipped column 0</span>
        <span class="k">return</span> <span class="n">insertion_index</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="TableDataBrowser.get_scan_row">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.get_scan_row">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_scan_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the row index for a given scan filename.</span>

<span class="sd">        :param scan: The scan filename to search for.</span>

<span class="sd">        :return(int): The zero-based row index if the scan is found, None</span>
<span class="sd">                      otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">row</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="n">scan</span>
            <span class="p">),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.get_tag_column">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.get_tag_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tag_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the column index for a given tag name.</span>

<span class="sd">        Searches through the table&#39;s horizontal headers to locate the column</span>
<span class="sd">        corresponding to the specified tag.</span>

<span class="sd">        :param tag (str): The name of the tag to search for.</span>

<span class="sd">        :return (int): The zero-based column index if the tag is found,</span>
<span class="sd">                       None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()):</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">item</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">column</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TableDataBrowser.mouseReleaseEvent">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.mouseReleaseEvent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle mouse release event and update table data.</span>

<span class="sd">        This method is called when a mouse button is released over the widget.</span>
<span class="sd">        It delegates to the parent class handler and then updates the table</span>
<span class="sd">        data values.</span>

<span class="sd">        :param event (QMouseEvent): The mouse event containing information</span>
<span class="sd">                                    about the button released, position, and</span>
<span class="sd">                                    modifiers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">mouseReleaseEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_table_data_values</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.multiple_sort_infos">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.multiple_sort_infos">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiple_sort_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_tags</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort table rows by multiple tag values.</span>

<span class="sd">        Sorts the visualized scans based on the values of specified tags, then</span>
<span class="sd">        reorganizes the table rows to reflect the new order. Handles both</span>
<span class="sd">        regular items and special brick widgets during the reordering.</span>

<span class="sd">        :param list_tags(list): List of tag names to sort by (primary to</span>
<span class="sd">                                secondary).</span>
<span class="sd">        :param order (str): Sort direction, either &quot;Ascending&quot; or &quot;Descending&quot;.</span>

<span class="sd">        Note:</span>
<span class="sd">            Temporarily disables item change signals during sorting to prevent</span>
<span class="sd">            triggering update handlers. The sort is stable and preserves the</span>
<span class="sd">            relative order of items with equal sort keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import locally to avoid circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_clear_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Clears the specified cell and sets an optional non-editable item.</span>

<span class="sd">            :param row (int): The row index of the cell to clear.</span>
<span class="sd">            :param column (int): The column index of the cell to clear.</span>
<span class="sd">            :param item (QTableWidgetItem) The item to set in the cleared cell.</span>
<span class="sd">                                           If None, the cell remains empty.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">)</span>
                <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_brick_widget</span><span class="p">(</span>
            <span class="n">row</span><span class="p">,</span>
            <span class="n">column</span><span class="p">,</span>
            <span class="n">scan</span><span class="p">,</span>
            <span class="n">database_data</span><span class="p">,</span>
            <span class="n">old_widget</span><span class="p">,</span>
            <span class="n">item</span><span class="p">,</span>
            <span class="n">clicked_scan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create and set a brick widget for the specified table cell.</span>

<span class="sd">            The brick name is fetched from the database and displayed as a</span>
<span class="sd">            clickable button. Clicking the button shows the brick&#39;s history.</span>
<span class="sd">            Existing brick references are updated if necessary.</span>

<span class="sd">            :param row (int): Row index of the cell to fill.</span>
<span class="sd">            :param column (int): Column index of the cell to fill.</span>
<span class="sd">            :param scan (str): Primary key of the scan linked to the brick.</span>
<span class="sd">            :param db (Database): Active database connection.</span>
<span class="sd">            :param old_widget (QWidget): Existing widget previously in the</span>
<span class="sd">                                         same cell (if any).</span>
<span class="sd">            :param item (QTableWidgetItem): The table item for this cell.</span>
<span class="sd">            :param clicked_scan (str): The scan ID to use when connecting the</span>
<span class="sd">                                       brick button’s clicked signal. If None,</span>
<span class="sd">                                       defaults to `scan`.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">app_thread</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="n">app_thread</span><span class="p">)</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
            <span class="n">cur_val</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="n">TAG_BRICKS</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cur_val</span><span class="p">:</span>
                <span class="n">_clear_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">brick_uuid</span> <span class="o">=</span> <span class="n">cur_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">brick_name</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                <span class="n">primary_key</span><span class="o">=</span><span class="n">brick_uuid</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="n">BRICK_NAME</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">brick_name</span><span class="p">:</span>
                <span class="n">_clear_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">brick_name_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">brick_name</span><span class="p">)</span>
            <span class="n">brick_name_button</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="n">app_thread</span><span class="p">)</span>
            <span class="c1"># Replace the old brick reference if needed</span>
            <span class="n">old_button</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">old_widget</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">)</span> <span class="k">if</span> <span class="n">old_widget</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">brick_uuid</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="n">old_button</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="p">[</span><span class="n">brick_name_button</span><span class="p">]</span> <span class="o">=</span> <span class="n">brick_uuid</span>
                    <span class="k">break</span>

            <span class="c1"># Use the appropriate scan for the clicked signal</span>
            <span class="n">target_scan</span> <span class="o">=</span> <span class="n">clicked_scan</span> <span class="ow">or</span> <span class="n">scan</span>
            <span class="n">brick_name_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_brick_history</span><span class="p">,</span> <span class="n">target_scan</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">brick_name_button</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">widget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
                <span class="c1"># Fetch tag field attributes</span>
                <span class="n">tag_attributes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tag_name</span> <span class="ow">in</span> <span class="n">list_tags</span>
                <span class="p">]</span>
                <span class="c1"># Build sort keys for each scan</span>
                <span class="n">sort_keys</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_attributes</span><span class="p">:</span>
                        <span class="n">field_name</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="n">NOT_DEFINED_VALUE</span>
                        <span class="p">)</span>

                    <span class="n">sort_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="c1"># Sort scans by the computed keys</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;Descending&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">scan</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">scan</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">sort_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">),</span>
                        <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
                <span class="c1"># Reorder table rows to match sorted scans</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">scan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">):</span>
                    <span class="n">old_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_row</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">old_row</span> <span class="o">==</span> <span class="n">row</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Swap all columns between current_row and target_row</span>
                    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()):</span>
                        <span class="n">header_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">header_text</span> <span class="o">==</span> <span class="n">TAG_BRICKS</span><span class="p">:</span>
                            <span class="c1"># Handle brick widget cells</span>
                            <span class="n">widget_to_move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">old_row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                            <span class="n">item_to_move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">takeItem</span><span class="p">(</span><span class="n">old_row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                            <span class="n">widget_wrong_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                            <span class="n">item_wrong_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">takeItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>

                            <span class="c1"># Move widget_to_move to row</span>
                            <span class="k">if</span> <span class="n">widget_to_move</span><span class="p">:</span>
                                <span class="n">_create_brick_widget</span><span class="p">(</span>
                                    <span class="n">row</span><span class="p">,</span>
                                    <span class="n">column</span><span class="p">,</span>
                                    <span class="n">scan</span><span class="p">,</span>
                                    <span class="n">db</span><span class="p">,</span>
                                    <span class="n">widget_to_move</span><span class="p">,</span>
                                    <span class="n">item_to_move</span><span class="p">,</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">_clear_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item_to_move</span><span class="p">)</span>

                            <span class="c1"># widget_wrong_row to old_row</span>
                            <span class="k">if</span> <span class="n">widget_wrong_row</span><span class="p">:</span>
                                <span class="n">old_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">old_row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                                <span class="n">_create_brick_widget</span><span class="p">(</span>
                                    <span class="n">old_row</span><span class="p">,</span>
                                    <span class="n">column</span><span class="p">,</span>
                                    <span class="n">old_scan</span><span class="p">,</span>
                                    <span class="n">db</span><span class="p">,</span>
                                    <span class="n">widget_wrong_row</span><span class="p">,</span>
                                    <span class="n">item_wrong_row</span><span class="p">,</span>
                                    <span class="n">clicked_scan</span><span class="o">=</span><span class="n">old_scan</span><span class="p">,</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">_clear_cell</span><span class="p">(</span><span class="n">old_row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item_wrong_row</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">item_to_move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">takeItem</span><span class="p">(</span><span class="n">old_row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                            <span class="n">item_wrong_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">takeItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item_to_move</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">old_row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">item_wrong_row</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Re-enable sorting and reconnect signals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSortIndicator</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeRowsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.multiple_sort_pop_up">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.multiple_sort_pop_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiple_sort_pop_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the multiple sort configuration dialog.</span>

<span class="sd">        Creates and shows a modal dialog that allows users to configure</span>
<span class="sd">        multiple sorting criteria for the current project data.</span>

<span class="sd">        Note:</span>
<span class="sd">            The dialog instance is stored in `self.pop_up`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up</span> <span class="o">=</span> <span class="n">PopUpMultipleSort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.on_cell_changed">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.on_cell_changed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_cell_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_origin</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update cell values and appearance when edited by the user.</span>

<span class="sd">        This method handles both single and multi-cell selection, validating</span>
<span class="sd">        type compatibility across all selected cells before applying changes.</span>
<span class="sd">        It performs the following operations:</span>
<span class="sd">            1. Validates that all selected cells have compatible types</span>
<span class="sd">            2. Verifies the new value matches the expected type(s)</span>
<span class="sd">            3. Updates the database with validated values</span>
<span class="sd">            4. Maintains undo/redo history for all modifications</span>
<span class="sd">            5. Refreshes cell colors and formatting</span>

<span class="sd">        Special handling:</span>
<span class="sd">        - PatientName: Removes spaces (used for subfolder naming in</span>
<span class="sd">                       calculations)</span>
<span class="sd">        - TAG_BRICKS/TAG_FILENAME: Read-only fields, changes are rejected</span>
<span class="sd">        - List types: Prevents mixed type selections but allows homogeneous</span>
<span class="sd">                      lists</span>

<span class="sd">        :param item_origin: QTableWidgetItem from which the edit originated</span>

<span class="sd">        Side effects:</span>
<span class="sd">            - Modifies database values for selected cells</span>
<span class="sd">            - Updates cell appearance (colors, fonts)</span>
<span class="sd">            - Adds entry to project undo history</span>
<span class="sd">            - Clears redo history</span>
<span class="sd">            - Resizes columns to fit content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import locally to prevent circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">check_value_type</span><span class="p">,</span>
            <span class="n">set_item_data</span><span class="p">,</span>
            <span class="n">table_to_database</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_show_error_and_revert</span><span class="p">(</span>
            <span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">selected_items</span><span class="p">,</span> <span class="n">database_data</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Display error dialog and revert selected cells to their original</span>
<span class="sd">            values.</span>

<span class="sd">            :param title: Dialog title text</span>
<span class="sd">            :param message: Dialog message text</span>
<span class="sd">            :param selected_items: List of QTableWidgetItem objects to revert</span>
<span class="sd">            :param database_data: Database context for retrieving original</span>
<span class="sd">                                  values</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Warning&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

            <span class="c1"># Revert all selected cells to their database values</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">selected_items</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
                <span class="n">scan_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_path</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">field_type</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                <span class="p">)[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                <span class="n">set_item_data</span><span class="p">(</span>
                    <span class="n">item</span><span class="p">,</span>
                    <span class="n">old_value</span> <span class="k">if</span> <span class="n">old_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;*Not Defined*&quot;</span><span class="p">,</span>
                    <span class="n">field_type</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Temporarily disconnect to prevent recursive calls during updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">item_origin</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">EditRole</span><span class="p">)</span>
        <span class="n">selected_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="c1"># Collect unique field types from all selected cells</span>
            <span class="n">cells_types</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># For each item selected, we check the validity of the types</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">selected_items</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
                <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                <span class="c1"># Remove spaces from PatientName (used for subfolder naming)</span>
                <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s2">&quot;PatientName&quot;</span><span class="p">:</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Read-only fields - reject changes immediately</span>
                <span class="k">if</span> <span class="n">tag_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TAG_BRICKS</span><span class="p">,</span> <span class="n">TAG_FILENAME</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>
                    <span class="k">return</span>

                <span class="n">tag_attrib</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                <span class="p">)</span>
                <span class="n">tag_type</span> <span class="o">=</span> <span class="n">tag_attrib</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">tag_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells_types</span><span class="p">:</span>
                    <span class="n">cells_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_type</span><span class="p">)</span>

            <span class="c1"># Define all list types known in data_manager</span>
            <span class="n">list_types</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">FIELD_TYPE_LIST_DATE</span><span class="p">,</span>
                <span class="n">FIELD_TYPE_LIST_DATETIME</span><span class="p">,</span>
                <span class="n">FIELD_TYPE_LIST_TIME</span><span class="p">,</span>
                <span class="n">FIELD_TYPE_LIST_INTEGER</span><span class="p">,</span>
                <span class="n">FIELD_TYPE_LIST_STRING</span><span class="p">,</span>
                <span class="n">FIELD_TYPE_LIST_FLOAT</span><span class="p">,</span>
                <span class="n">FIELD_TYPE_LIST_BOOLEAN</span><span class="p">,</span>
                <span class="n">FIELD_TYPE_LIST_JSON</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">has_list_type</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cells_types</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">list_types</span><span class="p">)</span>

            <span class="c1"># Error: Mixed types including list types</span>
            <span class="k">if</span> <span class="n">has_list_type</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_show_error_and_revert</span><span class="p">(</span>
                    <span class="s2">&quot;Incompatible types&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;The following types in the selection are not &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;compatible: </span><span class="si">{</span><span class="n">cells_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">selected_items</span><span class="p">,</span>
                    <span class="n">database_data</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># Skip validation for homogeneous list types</span>
            <span class="k">if</span> <span class="n">has_list_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># Validate value compatibility with all selected cell types</span>
            <span class="n">type_problem</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">cell_type</span>
                    <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cells_types</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_value_type</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">type_problem</span><span class="p">:</span>
                <span class="n">_show_error_and_revert</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid value&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;The value </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2"> is invalid with the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;type </span><span class="si">{</span><span class="n">type_problem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">selected_items</span><span class="p">,</span>
                    <span class="n">database_data</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># All validations passed - update database and cells</span>
            <span class="n">modified_values</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">selected_items</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
                <span class="n">scan_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                <span class="c1"># Skip filename tag (read-only)</span>
                <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="n">TAG_FILENAME</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">field_type</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                <span class="p">)[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                <span class="n">database_value</span> <span class="o">=</span> <span class="n">table_to_database</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_path</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Record change for history (whether updating or adding)</span>
                <span class="n">modified_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">scan_path</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">database_value</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Update database</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_path</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">tag_name</span><span class="p">:</span> <span class="n">database_value</span><span class="p">},</span>
                <span class="p">)</span>

                <span class="c1"># Reset font if this was a previously undefined cell</span>
                <span class="k">if</span> <span class="n">old_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">font</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
                    <span class="n">font</span><span class="o">.</span><span class="n">setItalic</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>

                <span class="c1"># Update cell display</span>
                <span class="n">set_item_data</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>

            <span class="c1"># Record in undo history</span>
            <span class="k">if</span> <span class="n">modified_values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;modified_values&quot;</span><span class="p">,</span> <span class="n">modified_values</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.remove_scan">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.remove_scan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove selected scans from the database and file system.</span>

<span class="sd">        This method handles the removal of scan documents from both the</span>
<span class="sd">        current and initial collections in the project database. It performs</span>
<span class="sd">        the following:</span>
<span class="sd">            - Prompts user for confirmation if scans are in the active scan</span>
<span class="sd">              list</span>
<span class="sd">            - Preserves modification history for removed scan values</span>
<span class="sd">            - Deletes associated files (.nii and .json) from the file system</span>
<span class="sd">            - Updates the UI table to reflect removals</span>

<span class="sd">        The removal process can be cancelled by the user when prompted. If</span>
<span class="sd">        multiple scans are selected, the user can choose to apply their</span>
<span class="sd">        decision to all remaining scans.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            - Modifies database by removing documents from COLLECTION_CURRENT</span>
<span class="sd">              and COLLECTION_INITIAL</span>
<span class="sd">            - Deletes scan files from the project folder</span>
<span class="sd">            - Updates UI table rows and marks project as having unsaved</span>
<span class="sd">              modifications</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_points</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">scans_removed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values_removed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scan_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">scan_list</span>
        <span class="c1"># Track user preferences across multiple deletions</span>
        <span class="n">suppress_dialog</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">user_cancelled</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">selected_points</span><span class="p">:</span>
                <span class="n">scan_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">scan_object</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_keys</span><span class="o">=</span><span class="n">scan_path</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">scan_object</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Confirm removal if scan is in active pipeline</span>
                <span class="n">is_in_pipeline</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">scan_path</span> <span class="ow">in</span> <span class="n">scan_list</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">data_sent</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">is_in_pipeline</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_dialog</span><span class="p">:</span>
                        <span class="n">popup</span> <span class="o">=</span> <span class="n">PopUpRemoveScan</span><span class="p">(</span>
                            <span class="n">scan_path</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_points</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">popup</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                        <span class="n">user_cancelled</span> <span class="o">=</span> <span class="n">popup</span><span class="o">.</span><span class="n">stop</span>
                        <span class="n">suppress_dialog</span> <span class="o">=</span> <span class="n">popup</span><span class="o">.</span><span class="n">repeat</span>

                    <span class="k">if</span> <span class="n">user_cancelled</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="c1"># Preserve modification history for all fields except filename</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_FILENAME</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">current_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_path</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">initial_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_path</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Only archive if at least one value exists</span>
                    <span class="k">if</span> <span class="n">current_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">values_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">scan_path</span><span class="p">,</span>
                                <span class="n">tag</span><span class="p">,</span>
                                <span class="n">current_value</span><span class="p">,</span>
                                <span class="n">initial_value</span><span class="p">,</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

                <span class="c1"># Remove from database collections</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">scan_path</span><span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">scan_path</span><span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">scan_path</span><span class="p">)</span>
                <span class="c1"># Remove associated files from file system</span>
                <span class="n">full_scan_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">scan_path</span><span class="p">)</span>
                <span class="n">files_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">full_scan_path</span><span class="p">]</span>

                <span class="c1"># Include associated JSON for NIfTI files</span>
                <span class="k">if</span> <span class="n">scan_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">):</span>
                    <span class="n">files_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_scan_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_to_remove</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

                <span class="n">scans_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_object</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Update UI table</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans_removed</span><span class="p">:</span>
            <span class="n">scan_name</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">TAG_FILENAME</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_scan_row</span><span class="p">(</span><span class="n">scan_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">scans_removed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">unsavedModifications</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.reset_cell">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.reset_cell">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset selected cells to their original values from the initial</span>
<span class="sd">        collection.</span>

<span class="sd">        This method restores the values of all selected cells to their</span>
<span class="sd">        original state by retrieving values from COLLECTION_INITIAL and</span>
<span class="sd">        updating COLLECTION_CURRENT. If any cells lack initial values</span>
<span class="sd">        (e.g., user-created tags), a warning is displayed. The operation is</span>
<span class="sd">        recorded in the project history for undo/redo functionality.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            - Updates database values in COLLECTION_CURRENT</span>
<span class="sd">            - Updates table cell display values</span>
<span class="sd">            - Appends operation to project.undos</span>
<span class="sd">            - Clears project.redos</span>
<span class="sd">            - May display a warning dialog for unreset values</span>
<span class="sd">            - Resizes table columns to fit content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import set_item_data locally to prevent circular import</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">points</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">modified_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># To know if some values do not have raw values (user tags)</span>
        <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">point</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
                <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="c1"># We get the FileName of the scan from the first row</span>
                <span class="n">scan_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                <span class="n">current_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">initial_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                        <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">tag_name</span><span class="p">:</span> <span class="n">initial_value</span><span class="p">},</span>
                    <span class="p">)</span>

                    <span class="n">field_type</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                    <span class="p">)[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>

                    <span class="n">set_item_data</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">initial_value</span><span class="p">,</span> <span class="n">field_type</span>
                    <span class="p">)</span>

                    <span class="n">modified_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">scan_name</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Record operation in history for undo/redo</span>
        <span class="k">if</span> <span class="n">modified_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;modified_values&quot;</span><span class="p">,</span> <span class="n">modified_values</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Warning message if unreset values</span>
        <span class="k">if</span> <span class="n">has_unreset_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_unreset_values</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.reset_column">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.reset_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset selected columns to their original values.</span>

<span class="sd">        Restores values in selected cells to their initial state from the</span>
<span class="sd">        database. If a cell&#39;s initial value doesn&#39;t exist (e.g., user-added</span>
<span class="sd">        tags), it cannot be reset and a warning will be displayed.</span>

<span class="sd">        The operation is recorded in the project&#39;s undo history. Any existing</span>
<span class="sd">        redo history is cleared after this operation.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            - Updates database values in COLLECTION_CURRENT</span>
<span class="sd">            - Updates table cell displays</span>
<span class="sd">            - Appends to project.undos</span>
<span class="sd">            - Clears project.redos</span>
<span class="sd">            - Resizes columns to fit content</span>
<span class="sd">            - May display warning dialog for unreset values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import locally to prevent circular import</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="n">modified_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># To know if some values do not have raw values (user tags)</span>
        <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">selected_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_points</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">selected_points</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
                <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">field_type</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span>
                <span class="p">)[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">)):</span>
                    <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">initial_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>

                    <span class="n">current_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag_name</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                            <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">tag_name</span><span class="p">:</span> <span class="n">initial_value</span><span class="p">},</span>
                        <span class="p">)</span>
                        <span class="n">set_item_data</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span>
                            <span class="n">initial_value</span><span class="p">,</span>
                            <span class="n">field_type</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">modified_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">scan</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Record operation in undo history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;modified_values&quot;</span><span class="p">,</span> <span class="n">modified_values</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">has_unreset_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_unreset_values</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.reset_row">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.reset_row">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset selected cells to their original values from the initial</span>
<span class="sd">        collection.</span>

<span class="sd">        Restores the values of all cells in selected rows to their initial</span>
<span class="sd">        state by copying values from COLLECTION_INITIAL to COLLECTION_CURRENT.</span>
<span class="sd">        Only cells with available initial values are reset. User-defined tags</span>
<span class="sd">        without initial values are skipped and trigger a warning dialog.</span>

<span class="sd">        The operation is recorded in the project&#39;s undo/redo history, allowing</span>
<span class="sd">        users to revert the reset if needed. After resetting, columns are</span>
<span class="sd">        automatically resized to fit their contents.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Updates database values in COLLECTION_CURRENT</span>
<span class="sd">            - Updates table cell display values</span>
<span class="sd">            - Appends operation to project.undos</span>
<span class="sd">            - Clears project.redos</span>
<span class="sd">            - Shows warning dialog if any values couldn&#39;t be reset</span>
<span class="sd">            - Resizes table columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import here to prevent circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_item_data</span>

        <span class="c1"># Early return if nothing selected</span>
        <span class="n">selected_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_indices</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Track modifications for undo history</span>
        <span class="n">modified_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># To know if some values do not have raw values (user tags)</span>
        <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Get unique rows from selection</span>
        <span class="n">selected_rows</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">selected_indices</span><span class="p">}</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">selected_rows</span><span class="p">:</span>
                <span class="c1"># FileName is always first column</span>
                <span class="n">scan_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">())):</span>
                    <span class="c1"># We get the tag name from the header</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="c1"># Fetch current and initial values</span>
                    <span class="n">current_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">initial_value</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Skip if no initial value exists (e.g., user-defined tags)</span>
                    <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>

                    <span class="c1"># Attempt to reset the value</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">scan_name</span><span class="p">,</span>
                            <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">initial_value</span><span class="p">},</span>
                        <span class="p">)</span>
                        <span class="c1"># Update table cell display</span>
                        <span class="n">field_type</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                            <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag</span>
                        <span class="p">)[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span>
                        <span class="n">set_item_data</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">),</span> <span class="n">initial_value</span><span class="p">,</span> <span class="n">field_type</span>
                        <span class="p">)</span>
                        <span class="c1"># Record change for history</span>
                        <span class="n">modified_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">scan_name</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">has_unreset_values</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Record operation in undo history</span>
        <span class="k">if</span> <span class="n">modified_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;modified_values&quot;</span><span class="p">,</span> <span class="n">modified_values</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Notify user if some values couldn&#39;t be reset</span>
        <span class="k">if</span> <span class="n">has_unreset_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_unreset_values</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.section_moved">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.section_moved">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">section_moved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_index</span><span class="p">,</span> <span class="n">old_index</span><span class="p">,</span> <span class="n">new_index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle section movement to keep the FileName column fixed at</span>
<span class="sd">        position 0.</span>

<span class="sd">        This slot is triggered when a user attempts to reorder table columns.</span>
<span class="sd">        It ensures the FileName column (logical index 0) always remains at the</span>
<span class="sd">        leftmost visual position, regardless of user drag-and-drop actions.</span>

<span class="sd">        :param logical_index: The logical index of the moved column (unused).</span>
<span class="sd">        :param old_index: The previous visual position of the column (unused).</span>
<span class="sd">        :param new_index: The new visual position of the column (unused).</span>

<span class="sd">        Note:</span>
<span class="sd">            Parameters are required by the Qt signal signature but not used in</span>
<span class="sd">            the implementation. Uses a guard flag to prevent recursive calls</span>
<span class="sd">            when programmatically repositioning the FileName column.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Prevent recursive calls when we programmatically move sections</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ignore_section_move&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_section_move</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span>
            <span class="n">file_name_visual_index</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">visualIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># If FileName column has moved, restore it to position 0</span>
            <span class="k">if</span> <span class="n">file_name_visual_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">header</span><span class="o">.</span><span class="n">moveSection</span><span class="p">(</span><span class="n">file_name_visual_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_section_move</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="TableDataBrowser.select_all_column">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.select_all_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_all_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select all cells in a column when its header is double-clicked.</span>

<span class="sd">        This method clears any existing selection before selecting the entire</span>
<span class="sd">        column, ensuring only the specified column is highlighted.</span>

<span class="sd">        :param col (int): The zero-based index of the column to select.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearSelection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectColumn</span><span class="p">(</span><span class="n">col</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.select_all_columns">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.select_all_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_all_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select all columns containing currently selected cells.</span>

<span class="sd">        Expands the current cell selection to include entire columns. If cells</span>
<span class="sd">        from multiple columns are selected, all corresponding columns will be</span>
<span class="sd">        selected. This method is typically invoked from the context menu.</span>

<span class="sd">        Note:</span>
<span class="sd">            Temporarily switches selection mode to MultiSelection during</span>
<span class="sd">            operation, then restores ExtendedSelection mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">MultiSelection</span><span class="p">)</span>
        <span class="c1"># Get unique column indices from selected cells</span>
        <span class="n">selected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="o">.</span><span class="n">column</span><span class="p">()</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearSelection</span><span class="p">()</span>

        <span class="c1"># Select each unique column</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">selected_columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selectColumn</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">ExtendedSelection</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.selection_changed">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.selection_changed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">selection_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the tab view when the table selection changes.</span>

<span class="sd">        Rebuilds the internal scans list based on currently selected items,</span>
<span class="sd">        grouping tag names by scan name. If link_viewer is enabled, updates</span>
<span class="sd">        the connected mini viewer display.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            - Clears and repopulates self.scans with [scan_name, [tag_names]]</span>
<span class="sd">              pairs</span>
<span class="sd">            - Calls data_browser.connect_mini_viewer() if self.link_viewer</span>
<span class="sd">              is True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rebuild scans list from selected items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">scan_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">():</span>
            <span class="n">scan_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">column</span><span class="p">())</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="c1"># Group tags by scan name using a dictionary</span>
            <span class="n">scan_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">scan_name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>

        <span class="c1"># Convert dictionary to list format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="n">scan_name</span><span class="p">,</span> <span class="n">tags</span><span class="p">]</span> <span class="k">for</span> <span class="n">scan_name</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">scan_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Update image viewer if linked</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_viewer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">connect_mini_viewer</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.show_brick_history">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.show_brick_history">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_brick_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a popup window showing the history of a brick.</span>

<span class="sd">        This method retrieves the brick UUID associated with the triggering</span>
<span class="sd">        sender, creates a history popup dialog, and displays it to the user.</span>

<span class="sd">        :param scan: The scan data to display in the history popup.</span>

<span class="sd">        Note:</span>
<span class="sd">            The sender (typically a UI widget) must be registered in</span>
<span class="sd">            self.bricks to retrieve the corresponding brick UUID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">brick_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brick_history_popup</span> <span class="o">=</span> <span class="n">PopUpShowHistory</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="n">brick_uuid</span><span class="o">=</span><span class="n">brick_uuid</span><span class="p">,</span>
            <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
            <span class="n">databrowser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="p">,</span>
            <span class="n">main_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brick_history_popup</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.sort_column">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.sort_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sort_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort the currently selected column.</span>

<span class="sd">        :param order (Qt.SortOrder or int): Sort order to apply.</span>
<span class="sd">            - Qt.AscendingOrder (0): Sort from lowest to highest</span>
<span class="sd">            - Qt.DescendingOrder (1): Sort from highest to lowest</span>

<span class="sd">        Note:</span>
<span class="sd">            Temporarily disconnects signals during sorting to prevent</span>
<span class="sd">            unwanted side effects, then reconnects them afterward.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentItem</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">current_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSortIndicator</span><span class="p">(</span>
                <span class="n">current_item</span><span class="o">.</span><span class="n">column</span><span class="p">(),</span> <span class="n">order</span>
            <span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.sort_updated">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.sort_updated">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sort_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update project state and apply sorting to the table.</span>

<span class="sd">        Temporarily disconnects signals, updates the project&#39;s sort</span>
<span class="sd">        configuration, applies the sort to table items, refreshes visual</span>
<span class="sd">        elements, and reconnects signals.</span>

<span class="sd">        :param column: The column index to sort by. Use -1 to indicate no</span>
<span class="sd">                       sorting.</span>
<span class="sd">        :param order: The sort order (Qt.AscendingOrder or Qt.DescendingOrder).</span>

<span class="sd">        Note:</span>
<span class="sd">            This method is a no-op when column is -1, allowing safe calls with</span>
<span class="sd">            invalid column indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">setSortOrder</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">setSortedTag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sortItems</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeRowsToContents</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.update_colors">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.update_colors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update cell background colors based on data state and visibility.</span>

<span class="sd">        Colors indicate:</span>
<span class="sd">            - White/Grey: Unmodified builtin tags (alternating for visible</span>
<span class="sd">                          rows)</span>
<span class="sd">            - Cyan/Blue: Modified builtin tags (alternating for visible rows)</span>
<span class="sd">            - Pink/Red: User-defined tags or null values (alternating for</span>
<span class="sd">                        visible rows)</span>

<span class="sd">        Note: This method assumes the itemChanged signal is disconnected.</span>
<span class="sd">        Automatically saves modifications if auto-save is enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># itemChanged signal is always disconnected when calling this method</span>
        <span class="c1"># Extract headers and scan identifiers</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())</span>
        <span class="p">]</span>

        <span class="c1"># Fetch database documents and field metadata</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">primary_key</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_primary_key_name</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">scans</span><span class="p">:</span>
                <span class="n">escaped_scans</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">scan</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span>
                <span class="p">]</span>
                <span class="n">joined_scans</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">escaped_scans</span><span class="p">)</span>
                <span class="n">req</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">primary_key</span><span class="si">}</span><span class="s2"> IN [</span><span class="si">{</span><span class="n">joined_scans</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="n">documents_curr</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">req</span>
                <span class="p">)</span>
                <span class="n">documents_init</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span>
                    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">req</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">documents_curr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">documents_init</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">field_name</span><span class="p">:</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_attributes</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">field_name</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span>
                <span class="p">)</span>
            <span class="p">}</span>

        <span class="c1"># Build lookup tables for efficient access</span>
        <span class="n">table_scans</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">():</span> <span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="n">table_tags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">horizontalHeaderItem</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">():</span> <span class="n">column</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="n">column_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">table_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="c1"># Precompute even/odd status for visible rows</span>
        <span class="n">row_parity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_even</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="n">row_parity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_even</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRowHidden</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">is_even</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_even</span>

        <span class="c1"># Color mapping for different states</span>
        <span class="n">COLORS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># White</span>
            <span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">230</span><span class="p">),</span>  <span class="c1"># Grey</span>
            <span class="p">(</span><span class="s2">&quot;modified&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">245</span><span class="p">),</span>  <span class="c1"># Cyan</span>
            <span class="p">(</span><span class="s2">&quot;modified&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">230</span><span class="p">),</span>  <span class="c1"># Blue</span>
            <span class="p">(</span><span class="s2">&quot;user_or_null&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">215</span><span class="p">),</span>  <span class="c1"># Pink</span>
            <span class="p">(</span><span class="s2">&quot;user_or_null&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">175</span><span class="p">),</span>  <span class="c1"># Red</span>
        <span class="p">}</span>

        <span class="c1"># Update cell colors</span>
        <span class="k">for</span> <span class="n">scan_curr</span><span class="p">,</span> <span class="n">scan_init</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">documents_curr</span><span class="p">,</span> <span class="n">documents_init</span><span class="p">):</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">table_scans</span><span class="p">[</span><span class="n">scan_curr</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>

            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Unexpected exception while updating DataBrowser colors. &quot;</span>
                    <span class="s2">&quot;Display may be in degraded state.&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRowHidden</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">is_even</span> <span class="o">=</span> <span class="n">row_parity</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">column_indices</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isColumnHidden</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>

                <span class="c1"># Determine the appropriate color key for a cell</span>
                <span class="c1"># First column always uses default white/grey</span>
                <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">color_key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">is_even</span><span class="p">)</span>

                <span class="c1"># Null values get user_or_null coloring</span>
                <span class="k">elif</span> <span class="n">scan_curr</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">color_key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;user_or_null&quot;</span><span class="p">,</span> <span class="n">is_even</span><span class="p">)</span>

                <span class="c1"># Builtin tags: check if modified</span>
                <span class="k">elif</span> <span class="n">fields</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">TAG_ORIGIN_BUILTIN</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">scan_curr</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">!=</span> <span class="n">scan_init</span><span class="p">[</span><span class="n">tag</span><span class="p">]:</span>
                        <span class="n">color_key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;modified&quot;</span><span class="p">,</span> <span class="n">is_even</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color_key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">is_even</span><span class="p">)</span>

                <span class="c1"># User-defined tags</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">color_key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;user_or_null&quot;</span><span class="p">,</span> <span class="n">is_even</span><span class="p">)</span>

                <span class="n">color</span> <span class="o">=</span> <span class="n">QColor</span><span class="p">(</span><span class="o">*</span><span class="n">COLORS</span><span class="p">[</span><span class="n">color_key</span><span class="p">])</span>
                <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">,</span> <span class="n">QVariant</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>

        <span class="c1"># Auto-save if enabled</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">isAutoSave</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">saveModifications</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.update_selection">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.update_selection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update table selection based on current scan results.</span>

<span class="sd">        Clears existing selection and selects cells corresponding to tags</span>
<span class="sd">        found in the current scan results. For each scan, selects the cells at</span>
<span class="sd">        the intersection of the scan&#39;s row and its associated tag columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Selection updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearSelection</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">scan_id</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_row</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tag_column</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableDataBrowser.update_table">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.update_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">take_tags_to_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh the table with current project data.</span>

<span class="sd">        Completely resets and repopulates the table when switching projects.</span>
<span class="sd">        This involves clearing selections, fetching current scan documents,</span>
<span class="sd">        refilling headers and cells, resizing columns/rows, and updating</span>
<span class="sd">        the visual appearance.</span>

<span class="sd">        :param take_tags_to_update: If True, updates tags during the header</span>
<span class="sd">                                    fill operation. Defaults to False.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Clears current table selection</span>
<span class="sd">            - Resets scans_to_visualize and scans_to_search attributes</span>
<span class="sd">            - Clears selected scans list if selection is active</span>
<span class="sd">            - Disconnects and reconnects table signals</span>
<span class="sd">            - Modifies table dimensions and visual styling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearSelection</span><span class="p">()</span>  <span class="c1"># Selection cleared when switching project</span>

        <span class="c1"># Fetch current scans from database</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scans_to_search</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">)</span>

        <span class="c1"># Reset selected scans if selection mode is active</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Update table structure with signals temporarily disconnected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">))</span>
            <span class="c1"># Sort visual management</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_headers</span><span class="p">(</span><span class="n">take_tags_to_update</span><span class="p">)</span>
            <span class="c1"># Cells filled</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_cells_update_table</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>
            <span class="c1"># Adjust dimensions and styling</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeRowsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Ensure signals are reconnected even if an error occurs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.update_visualized_columns">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.update_visualized_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_visualized_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_tags</span><span class="p">,</span> <span class="n">showed</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update column visibility based on tag selection changes.</span>

<span class="sd">        Synchronizes the table&#39;s visible columns with the provided tag list</span>
<span class="sd">        by:</span>
<span class="sd">            - Hiding columns for tags that are no longer displayed</span>
<span class="sd">            - Showing columns for newly displayed tags</span>
<span class="sd">            - Updating advanced search dropdowns if the search panel is open</span>
<span class="sd">            - Refreshing column sizing and colors</span>

<span class="sd">        :param old_tags (list): Previously visualized tags.</span>
<span class="sd">        :param showed (list): Tags to currently display in the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert to sets for efficient difference operations</span>
            <span class="n">old_set</span><span class="p">,</span> <span class="n">new_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_tags</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">showed</span><span class="p">)</span>

            <span class="c1"># Hide columns for removed tags</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">old_set</span> <span class="o">-</span> <span class="n">new_set</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tag_column</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Show columns for added/visible tags</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">new_set</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tag_column</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="p">,</span> <span class="s2">&quot;frame_advanced_search&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">frame_advanced_search</span><span class="o">.</span><span class="n">isHidden</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">return</span>

            <span class="c1"># Update advanced search dropdowns if visible</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">advanced_search</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">showed</span><span class="p">)</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="s2">&quot;All visualized tags&quot;</span><span class="p">)</span>

            <span class="c1"># Refresh table appearance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>

            <span class="c1"># Restore selection handling</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_changed</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.update_visualized_rows">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.update_visualized_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_visualized_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_scans</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update table row visibility based on current scan visualization state.</span>

<span class="sd">        Temporarily disconnects selection signals, hides rows for scans no</span>
<span class="sd">        longer in the visualization list, shows rows for newly visualized</span>
<span class="sd">        scans, and updates the table appearance.</span>

<span class="sd">        :param old_scans: Collection of scans from the previous state, used to</span>
<span class="sd">                          determine which rows need to be hidden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_disconnect</span><span class="p">()</span>

        <span class="c1"># Temporarily disable selection change signals during update</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="c1"># Hide rows for scans removed from visualization</span>
        <span class="n">old_scan_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_scans</span><span class="p">)</span>
        <span class="n">current_scan_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_to_visualize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">old_scan_set</span> <span class="o">-</span> <span class="n">current_scan_set</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_row</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setRowHidden</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Show rows for scans added to visualization</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">current_scan_set</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_row</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setRowHidden</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Update table appearance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resizeColumnsToContents</span><span class="p">()</span>

        <span class="c1"># Update selection and colors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_colors</span><span class="p">()</span>

        <span class="c1"># Re-enable selection change signals</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_changed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_reconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="TableDataBrowser.visualized_tags_pop_up">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TableDataBrowser.visualized_tags_pop_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualized_tags_pop_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a modal dialog for configuring visualized tag columns.</span>

<span class="sd">        Opens a properties popup showing currently visible tags and allowing</span>
<span class="sd">        the user to modify which tags are displayed in the data browser. The</span>
<span class="sd">        popup is sized to 50% of screen width and 80% of screen height.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="c1"># Old list of columns</span>
            <span class="n">current_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up</span> <span class="o">=</span> <span class="n">PopUpProperties</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_browser</span><span class="p">,</span> <span class="n">current_tags</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Size popup relative to screen dimensions</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">desktop</span><span class="p">()</span><span class="o">.</span><span class="n">screenGeometry</span><span class="p">()</span>
        <span class="n">popup_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">popup_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">popup_width</span><span class="p">,</span> <span class="n">popup_height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_up</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="TimeFormatDelegate">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TimeFormatDelegate">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeFormatDelegate</span><span class="p">(</span><span class="n">QItemDelegate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delegate for handling time data display and editing in table views.</span>

<span class="sd">    This delegate creates a QTimeEdit widget with millisecond precision</span>
<span class="sd">    (hh:mm:ss.zzz format) for editing time values in a TableDataBrowser.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - createEditor: Create and return a QDateEdit widget for editing times</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeFormatDelegate.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TimeFormatDelegate.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the time format delegate.</span>

<span class="sd">        :param parent: Parent QWidget, if any. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimeFormatDelegate.createEditor">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.data_browser.html#populse_mia.user_interface.data_browser.data_browser.TimeFormatDelegate.createEditor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and configure the editor widget for time values.</span>

<span class="sd">        :param parent: Parent widget for the editor.</span>
<span class="sd">        :param option: Style options for the item (unused, required</span>
<span class="sd">                       by Qt API).</span>
<span class="sd">        :param index: Model index of the item being edited (unused, required</span>
<span class="sd">                      by Qt API).</span>

<span class="sd">        :return (QTimeEdit): Configured time editor widget with</span>
<span class="sd">                             hh:mm:ss.zzz format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">QTimeEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setDisplayFormat</span><span class="p">(</span><span class="s2">&quot;hh:mm:ss.zzz&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span></div>
</div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>