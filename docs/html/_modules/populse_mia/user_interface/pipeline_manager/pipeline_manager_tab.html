
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>populse_mia.user_interface.pipeline_manager.pipeline_manager_tab &#8212; populse_mia 2.4.1-dev+71342ce9 documentation</title>
    <link rel="stylesheet" href="../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script >mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>populse_mia 2.4.1-dev+71342ce9 documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.user_interface.pipeline_manager.pipeline_manager_tab</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for populse_mia.user_interface.pipeline_manager.pipeline_manager_tab</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to define pipeline manager tab appearance, settings and methods.</span>

<span class="sd">Contains:</span>
<span class="sd">    Class:</span>
<span class="sd">        - PipelineManagerTab</span>
<span class="sd">        - RunProgress</span>
<span class="sd">        - RunWorker</span>
<span class="sd">        - StatusWidget</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># Other imports</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="c1"># Soma_workflow import</span>
<span class="kn">import</span> <span class="nn">soma_workflow.constants</span> <span class="k">as</span> <span class="nn">swconstants</span>
<span class="kn">import</span> <span class="nn">traits.api</span> <span class="k">as</span> <span class="nn">traits</span>

<span class="c1"># Capsul imports</span>
<span class="kn">from</span> <span class="nn">capsul.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NipypeProcess</span><span class="p">,</span>
    <span class="n">Pipeline</span><span class="p">,</span>
    <span class="n">PipelineNode</span><span class="p">,</span>
    <span class="n">Process</span><span class="p">,</span>
    <span class="n">ProcessNode</span><span class="p">,</span>
    <span class="n">get_process_instance</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">capsul.attributes.completion_engine</span> <span class="kn">import</span> <span class="n">ProcessCompletionEngine</span>
<span class="kn">from</span> <span class="nn">capsul.engine</span> <span class="kn">import</span> <span class="n">WorkflowExecutionError</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline</span> <span class="kn">import</span> <span class="n">pipeline_tools</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.pipeline_workflow</span> <span class="kn">import</span> <span class="n">workflow_from_pipeline</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.process_iteration</span> <span class="kn">import</span> <span class="n">ProcessIteration</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.qt_compat</span> <span class="kn">import</span> <span class="n">QtWidgets</span>

<span class="c1"># PyQt5 imports</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">Signal</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QCursor</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QMovie</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">QAction</span><span class="p">,</span>
    <span class="n">QApplication</span><span class="p">,</span>
    <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QMenu</span><span class="p">,</span>
    <span class="n">QMessageBox</span><span class="p">,</span>
    <span class="n">QScrollArea</span><span class="p">,</span>
    <span class="n">QSplitter</span><span class="p">,</span>
    <span class="n">QToolBar</span><span class="p">,</span>
    <span class="n">QVBoxLayout</span><span class="p">,</span>
    <span class="n">QWidget</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Soma_base import</span>
<span class="kn">from</span> <span class="nn">soma.controller.trait_utils</span> <span class="kn">import</span> <span class="n">is_file_trait</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qtThread</span> <span class="kn">import</span> <span class="n">QtThreadCall</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">TraitListObject</span><span class="p">,</span> <span class="n">Undefined</span>

<span class="c1"># Populse_MIA imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.project</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BRICK_EXEC</span><span class="p">,</span>
    <span class="n">BRICK_EXEC_TIME</span><span class="p">,</span>
    <span class="n">BRICK_INIT</span><span class="p">,</span>
    <span class="n">BRICK_INIT_TIME</span><span class="p">,</span>
    <span class="n">BRICK_INPUTS</span><span class="p">,</span>
    <span class="n">BRICK_NAME</span><span class="p">,</span>
    <span class="n">BRICK_OUTPUTS</span><span class="p">,</span>
    <span class="n">COLLECTION_BRICK</span><span class="p">,</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
    <span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
    <span class="n">HISTORY_BRICKS</span><span class="p">,</span>
    <span class="n">HISTORY_PIPELINE</span><span class="p">,</span>
    <span class="n">TAG_BRICKS</span><span class="p">,</span>
    <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
    <span class="n">TAG_FILENAME</span><span class="p">,</span>
    <span class="n">TAG_HISTORY</span><span class="p">,</span>
    <span class="n">TAG_TYPE</span><span class="p">,</span>
    <span class="n">TYPE_MAT</span><span class="p">,</span>
    <span class="n">TYPE_NII</span><span class="p">,</span>
    <span class="n">TYPE_TXT</span><span class="p">,</span>
    <span class="n">TYPE_UNKNOWN</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.software_properties</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.iteration_table</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IterationTable</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.node_controller</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CapsulNodeController</span><span class="p">,</span>
    <span class="n">NodeController</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.pipeline_editor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PipelineEditorTabs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_library</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProcessLibraryWidget</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pop_ups</span> <span class="kn">import</span> <span class="n">PopUpInheritanceDict</span>


<div class="viewcode-block" id="PipelineManagerTab"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab">[docs]</a><span class="k">class</span> <span class="nc">PipelineManagerTab</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget that handles the Pipeline Manager tab.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - _register_node_io_in_database: bla bla bla</span>
<span class="sd">        - _set_anim_frame: Callback which sets the animated icon frame to</span>
<span class="sd">          the status action icon</span>
<span class="sd">        - _show_preview:</span>
<span class="sd">        - add_plug_value_to_database: add the plug value to the database.</span>
<span class="sd">        - add_process_to_preview: add a process to the pipeline</span>
<span class="sd">        - build_iterated_pipeline: build a new pipeline with an iteration node</span>
<span class="sd">        - check_requirements: return the configuration of a pipeline</span>
<span class="sd">          as required</span>
<span class="sd">        - cleanup_older_init: remove non-existent entries from the databrowser</span>
<span class="sd">        - complete_pipeline_parameters:</span>
<span class="sd">        - controller_value_changed: update history when a pipeline node is</span>
<span class="sd">          changed</span>
<span class="sd">        - displayNodeParameters: display the node controller when a node is</span>
<span class="sd">          clicked</span>
<span class="sd">        - find_process:</span>
<span class="sd">        - finish_execution:</span>
<span class="sd">        - garbage_collect:</span>
<span class="sd">        - get_capsul_engine:</span>
<span class="sd">        - get_missing_mandatory_parameters: check on missing parameters for</span>
<span class="sd">          each job</span>
<span class="sd">        - get_pipeline_or_process:</span>
<span class="sd">        - initialize: clean previous initialization then initialize the current</span>
<span class="sd">          pipeline</span>
<span class="sd">        - init_pipeline: initialize the current pipeline of the pipeline</span>
<span class="sd">          editor</span>
<span class="sd">        - layout_view : initialize layout for the pipeline manager</span>
<span class="sd">        - loadParameters: load pipeline parameters to the current pipeline of</span>
<span class="sd">          the pipeline editor</span>
<span class="sd">        - loadPipeline: load a pipeline to the pipeline editor</span>
<span class="sd">        - postprocess_pipeline_execution:</span>
<span class="sd">        - redo: redo the last undone action on the current pipeline editor</span>
<span class="sd">        - register_completion_attributes:</span>
<span class="sd">        - runPipeline: run the current pipeline of the pipeline editor</span>
<span class="sd">        - saveParameters: save the pipeline parameters of the the current</span>
<span class="sd">          pipeline of the pipeline editor</span>
<span class="sd">        - savePipeline: save the current pipeline of the pipeline editor</span>
<span class="sd">        - savePipelineAs: save the current pipeline of the pipeline editor</span>
<span class="sd">          under another name</span>
<span class="sd">        - show_status:</span>
<span class="sd">        - stop_execution:</span>
<span class="sd">        - undo: undo the last action made on the current pipeline editor</span>
<span class="sd">        - update_auto_inheritance:</span>
<span class="sd">        - update_node_list: update the list of nodes in workflow</span>
<span class="sd">        - updateProcessLibrary: update the library of processes when a</span>
<span class="sd">          pipeline is saved</span>
<span class="sd">        - update_project: update the project attribute of several objects</span>
<span class="sd">        - update_scans_list: update the user-selected list of scans</span>
<span class="sd">        - update_user_buttons_states: Update the visibility of initialize/</span>
<span class="sd">          run/save actions according to pipeline state</span>
<span class="sd">        - update_user_mode: update the visibility of widgets/actions</span>
<span class="sd">          depending of the chosen mode</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">item_library_clicked</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="PipelineManagerTab.__init__"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">scan_list</span><span class="p">,</span> <span class="n">main_window</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization of the Pipeline Manager tab</span>

<span class="sd">        :param project: current project in the software</span>
<span class="sd">        :param scan_list: list of the selected database files</span>
<span class="sd">        :param main_window: main window of the software</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">isControlV1</span><span class="p">():</span>
            <span class="n">Node_Controller</span> <span class="o">=</span> <span class="n">CapsulNodeController</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">Node_Controller</span> <span class="o">=</span> <span class="n">NodeController</span>

        <span class="c1"># Necessary for using MIA bricks</span>
        <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_documents_names</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="n">scan_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="n">main_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_progress_bar</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># This list is the list of scans contained in the iteration table</span>
        <span class="c1"># If it is empty, the scan list in the Pipeline Manager is the scan</span>
        <span class="c1"># list from the data_browser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Used for the inheritance dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">QWidget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span> <span class="o">=</span> <span class="n">ProcessLibraryWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">process_library</span><span class="o">.</span><span class="n">item_library_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_library_clicked</span>
        <span class="p">)</span>
        <span class="c1"># self.item_library_clicked.connect(self._show_preview)</span>

        <span class="c1"># self.diagramScene = DiagramScene(self)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span> <span class="o">=</span> <span class="n">PipelineEditorTabs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">node_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">process_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">switch_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">pipeline_saved</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateProcessLibrary</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span> <span class="o">=</span> <span class="n">Node_Controller</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">visibles_tags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span> <span class="o">=</span> <span class="n">IterationTable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">iteration_table_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_scans_list</span>
        <span class="p">)</span>

        <span class="c1"># self.previewBlock = PipelineDeveloperView(</span>
        <span class="c1">#    pipeline=None, allow_open_controller=False,</span>
        <span class="c1">#    show_sub_pipelines=True, enable_edition=False)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">startedConnection</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Load pipeline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadPipeline</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Save pipeline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savePipeline</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Save pipeline as&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savePipelineAs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="s2">&quot;Load pipeline parameters&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadParameters</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="s2">&quot;Save pipeline parameters&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveParameters</span>
        <span class="p">)</span>

        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="c1"># commented on January, 4th 2020</span>
        <span class="c1"># initialization button was deleted to avoid issues of indexation</span>
        <span class="c1"># into the database.</span>
        <span class="c1"># initialization is now performed just befor run in run_pipeline_action</span>
        <span class="c1"># self.init_pipeline_action = QAction(</span>
        <span class="c1">#     QIcon(os.path.join(sources_images_dir, &#39;init32.png&#39;)),</span>
        <span class="c1">#     &quot;Initialize pipeline&quot;, self)</span>
        <span class="c1"># self.init_pipeline_action.triggered.connect(self.initialize)</span>
        <span class="c1"># End - commented on January, 4th 2020</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;run32.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Run pipeline&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runPipeline</span><span class="p">)</span>
        <span class="c1"># commented on January, 4th 2020</span>
        <span class="c1"># self.run_pipeline_action.setDisabled(True)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;stop32.png&quot;</span><span class="p">)),</span> <span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_execution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;gray_cross.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Status&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_status</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;garbage_collect.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Cleanup&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
            <span class="s2">&quot;cleanup obsolete items in the database (pipeline inits, &quot;</span>
            <span class="s2">&quot;obsolete data...). Not needed in normal situations, but useful &quot;</span>
            <span class="s2">&quot;after a reconnection (client/server) or application crash.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># if config.get_user_mode() == True:</span>
        <span class="c1">#     self.save_pipeline_action.setDisabled(True)</span>
        <span class="c1">#     self.save_pipeline_as_action.setDisabled(True)</span>
        <span class="c1">#     self.processLibrary.setHidden(True)</span>
        <span class="c1">#     self.previewBlock.setHidden(True)</span>

        <span class="c1"># Initialize toolbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span> <span class="o">=</span> <span class="n">QToolBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QToolButton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span> <span class="o">=</span> <span class="n">QScrollArea</span><span class="p">()</span>

        <span class="c1"># Initialize Qt layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout_view</span><span class="p">()</span>

        <span class="c1"># To undo/redo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">value_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller_value_changed</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_register_node_io_in_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">history_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bla bla bla&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_serialize_tmp</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

            <span class="kn">import</span> <span class="nn">soma_workflow.client</span> <span class="k">as</span> <span class="nn">swc</span>

            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Undefined</span><span class="p">,</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]):</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">swc</span><span class="o">.</span><span class="n">TemporaryPath</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;temp&gt;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">TypeError</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">PipelineNode</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)):</span>
            <span class="c1"># only leaf processes produce output data</span>
            <span class="k">return</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>
            <span class="c1"># ProcessMIA / Process_Mia specific</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;list_outputs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span>
            <span class="p">):</span>
                <span class="c1"># normally same as outputs, but it may contain an additional</span>
                <span class="c1"># &quot;notInDb&quot; key.</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>

        <span class="c1"># Fill inputs and outputs values with job</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                        <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                        <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># also get completion attributes</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">()</span>

        <span class="c1"># Adding I/O to database history</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="c1"># filter Undefined / temp</span>
            <span class="c1"># this is an overhead since we convert to/from json, and it will</span>
            <span class="c1"># be converted again in the database. But the &quot;default&quot; function</span>
            <span class="c1"># for json is not in the database API.</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">_serialize_tmp</span><span class="p">)</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="c1"># filter Undefined / temp</span>
            <span class="c1"># this is an overhead since we convert to/from json, and it will</span>
            <span class="c1"># be converted again in the database.</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">_serialize_tmp</span><span class="p">)</span>
            <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="n">node_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Updating the database with output values obtained from</span>
        <span class="c1"># initialisation. If a plug name is in</span>
        <span class="c1"># outputs[&#39;notInDb&#39;], then the corresponding</span>
        <span class="c1"># output value is not added to the database.</span>
        <span class="n">notInDb</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notInDb&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug_value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">plug_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">traits</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">plug_value</span> <span class="o">!=</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plug_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notInDb</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pipeline_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">full_name</span> <span class="o">=</span> <span class="n">pipeline_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">node_name</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">full_name</span> <span class="o">=</span> <span class="n">node_name</span>

                    <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plug_value_to_database</span><span class="p">(</span>
                        <span class="n">plug_value</span><span class="p">,</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                        <span class="n">history_id</span><span class="p">,</span>
                        <span class="n">node_name</span><span class="p">,</span>
                        <span class="n">plug_name</span><span class="p">,</span>
                        <span class="n">full_name</span><span class="p">,</span>
                        <span class="n">job</span><span class="p">,</span>
                        <span class="n">trait</span><span class="p">,</span>
                        <span class="n">inputs</span><span class="p">,</span>
                        <span class="n">attributes</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Adding I/O to database history</span>
        <span class="c1"># Setting brick init state if init finished correctly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
            <span class="n">COLLECTION_BRICK</span><span class="p">,</span>
            <span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
            <span class="p">{</span><span class="n">BRICK_INPUTS</span><span class="p">:</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">BRICK_OUTPUTS</span><span class="p">:</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">BRICK_INIT</span><span class="p">:</span> <span class="s2">&quot;Done&quot;</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_anim_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback which sets the animated icon frame to the status action icon</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">currentPixmap</span><span class="p">())</span>
        <span class="p">)</span>

    <span class="c1"># def _show_preview(self, name_item):</span>
    <span class="c1">#</span>
    <span class="c1">#    self.previewBlock.centerOn(0, 0)</span>
    <span class="c1">#    self.find_process(name_item)</span>

<div class="viewcode-block" id="PipelineManagerTab.add_plug_value_to_database"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.add_plug_value_to_database">[docs]</a>    <span class="k">def</span> <span class="nf">add_plug_value_to_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p_value</span><span class="p">,</span>
        <span class="n">brick_id</span><span class="p">,</span>
        <span class="n">history_id</span><span class="p">,</span>
        <span class="n">node_name</span><span class="p">,</span>
        <span class="n">plug_name</span><span class="p">,</span>
        <span class="n">full_name</span><span class="p">,</span>
        <span class="n">job</span><span class="p">,</span>
        <span class="n">trait</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">,</span>
        <span class="n">attributes</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the plug value to the database.</span>

<span class="sd">        :param p_value: plug value, a file name or a list of file names (any)</span>
<span class="sd">        :param brick_id: brick uuid in the database (str)</span>
<span class="sd">        :param history_id: history uuid in the database (str)</span>
<span class="sd">        :param node_name: name of the node (str)</span>
<span class="sd">        :param plug_name: name of the plug (str)</span>
<span class="sd">        :param full_name: full name of the node, including parent</span>
<span class="sd">                          brick(s) (str). If there is no parent brick,</span>
<span class="sd">                          full_name = node_name.</span>
<span class="sd">        :param job: job containing the plug (Job)</span>
<span class="sd">        :param trait: handler of the plug trait, or sub-trait if the plug is</span>
<span class="sd">                      a list (Trait). It will be used to check the value type</span>
<span class="sd">                      (file or not).</span>
<span class="sd">        :param inputs: input values for the process/node (dict)</span>
<span class="sd">        :param attributes: attributes set coming from Capsul completion engine</span>
<span class="sd">                           to be set on all outputs of the node (dict)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">)):</span>
            <span class="n">inner_trait</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_value</span><span class="p">):</span>
                <span class="n">new_attributes</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                            <span class="n">new_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_plug_value_to_database</span><span class="p">(</span>
                    <span class="n">elt</span><span class="p">,</span>
                    <span class="n">brick_id</span><span class="p">,</span>
                    <span class="n">history_id</span><span class="p">,</span>
                    <span class="n">node_name</span><span class="p">,</span>
                    <span class="n">plug_name</span><span class="p">,</span>
                    <span class="n">full_name</span><span class="p">,</span>
                    <span class="n">job</span><span class="p">,</span>
                    <span class="n">inner_trait</span><span class="p">,</span>
                    <span class="n">inputs</span><span class="p">,</span>
                    <span class="n">new_attributes</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">allow_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p_value</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
            <span class="n">Undefined</span><span class="p">,</span>
            <span class="p">[</span><span class="n">Undefined</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="c1"># This means that the value is not a filename</span>
            <span class="k">return</span>

        <span class="c1"># Deleting the project&#39;s folder in the file name so it can</span>
        <span class="c1"># fit to the database&#39;s syntax</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="n">p_value</span>
        <span class="c1"># p_value = p_value.replace(self.project.folder, &quot;&quot;)</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p_value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="c1"># file name is outside the project folder: don&#39;t index it in the</span>
            <span class="c1"># database</span>
            <span class="k">return</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="n">p_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="ow">and</span> <span class="n">p_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">p_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># If the file name is already in the database,</span>
        <span class="c1"># no exception is raised</span>
        <span class="c1"># but the user is warned</span>
        <span class="n">already_in_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">p_value</span><span class="p">):</span>
            <span class="n">already_in_db</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">{0}</span><span class="s2"> already in database.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>

        <span class="c1"># Adding the new brick to the output files</span>
        <span class="n">bricks</span> <span class="o">=</span> <span class="p">[</span><span class="n">brick_id</span><span class="p">]</span>

        <span class="c1"># Type tag</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_UNKNOWN</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;.mnc&quot;</span><span class="p">,</span> <span class="s2">&quot;.ima&quot;</span><span class="p">,</span> <span class="s2">&quot;.img&quot;</span><span class="p">):</span>
            <span class="c1"># (not all nifti but all volumes, image &quot;scans&quot;)</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_NII</span>
        <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.mat&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_MAT</span>
        <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.txt&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_TXT</span>

        <span class="c1"># determine which value the output should inherit its database tags</span>
        <span class="c1"># from.</span>
        <span class="c1"># Each process may have an &quot;inheritance_dict&quot; (prepared using</span>
        <span class="c1"># list_outputs() during completion, if it has this method).</span>
        <span class="c1"># If not, or if the parameter value is not found there, we also have</span>
        <span class="c1"># an &quot;auto_inheritance_dict&quot; which automatically maps outputs to</span>
        <span class="c1"># inputs. If there is no ambiguity, we can process automatically.</span>
        <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;auto_inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">parent_files</span> <span class="o">=</span> <span class="n">inheritance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span>
        <span class="n">own_tags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tags2del</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># the dicts may have several shapes. Keys are output filenames</span>
        <span class="c1"># Values may be</span>
        <span class="c1"># - an input filename: get the tags from it</span>
        <span class="c1"># - in inheritance_dict only: a dict</span>
        <span class="c1">#   {   &#39;parent&#39;: input_filename,</span>
        <span class="c1">#       &#39;own_tags&#39;: list of dict of additional forced tags</span>
        <span class="c1">#       &#39;tags2del&#39;: list of tags (str) whose value will be deleted</span>
        <span class="c1">#   }</span>
        <span class="c1"># - in auto_inheritance_dict only: a dict</span>
        <span class="c1">#   {   &#39;param_name&#39;: input_filename, ... }</span>
        <span class="c1">#   when there are ambiguities</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">own_tags</span> <span class="o">=</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;own_tags&quot;</span><span class="p">)</span>
            <span class="n">tags2del</span> <span class="o">=</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags2del&quot;</span><span class="p">)</span>
            <span class="n">parent_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent_files</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">parent_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent_files</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">parent_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent_files</span> <span class="o">=</span> <span class="n">auto_inheritance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_value</span><span class="p">,</span> <span class="p">{})</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">parent_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent_files</span><span class="p">}</span>

        <span class="n">db_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
        <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># get all tags values for inputs</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">parent_file</span> <span class="ow">in</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># database_parent_file = None</span>
            <span class="c1"># fmt: off</span>
            <span class="n">relfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">parent_file</span><span class="p">)</span>
                                      <span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">db_dir</span><span class="p">):]</span>
            <span class="c1"># fmt: on</span>

            <span class="k">if</span> <span class="n">relfile</span> <span class="o">==</span> <span class="n">p_value</span><span class="p">:</span>
                <span class="c1"># output is one of the inputs: OK nothing to be done.</span>
                <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">break</span>

            <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">relfile</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">scan</span><span class="p">:</span>
                <span class="c1"># database_parent_file = scan</span>
                <span class="c1"># banished_tags = set([TAG_TYPE, TAG_EXP_TYPE, TAG_BRICKS,</span>
                <span class="c1">#                TAG_CHECKSUM, TAG_FILENAME])</span>
                <span class="n">banished_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">TAG_TYPE</span><span class="p">,</span>
                        <span class="n">TAG_BRICKS</span><span class="p">,</span>
                        <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
                        <span class="n">TAG_FILENAME</span><span class="p">,</span>
                        <span class="n">TAG_HISTORY</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">cvalues</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">field</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">banished_tags</span>
                <span class="p">}</span>
                <span class="n">iscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">relfile</span>
                <span class="p">)</span>
                <span class="n">ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">iscan</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cvalues</span><span class="p">}</span>
                <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">cvalues</span>
                <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivalues</span>

        <span class="c1"># If there are several possible inputs: there is more work</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cvalues</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">node_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">node_name</span> <span class="o">+</span> <span class="n">plug_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># if all inputs have the same tags set: then pick either of them,</span>
            <span class="c1"># they are all the same, there is no ambiguity</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">cvalues</span> <span class="ow">in</span> <span class="n">all_cvalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">cvalues</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">eq</span> <span class="o">=</span> <span class="n">cvalues</span> <span class="o">==</span> <span class="n">first</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">eq</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">ivalues</span> <span class="ow">in</span> <span class="n">all_ivalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="n">ivalues</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">eq</span> <span class="o">=</span> <span class="n">ivalues</span> <span class="o">==</span> <span class="n">first</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">if</span> <span class="n">eq</span><span class="p">:</span>
                <span class="c1"># all values equal, no ambiguity</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ambiguous inputs -&gt; output</span>
                <span class="c1"># ask the user, or use previously setup answers.</span>

                <span class="c1"># FIXME: There is a GUI dialog here, involving user</span>
                <span class="c1">#        interaction. This should probably be avoided here in</span>
                <span class="c1">#        a processing loop. Some pipelines, especially with</span>
                <span class="c1">#        iterations, may ask many many questions to users.</span>
                <span class="c1">#        These should be worked on earlier.</span>

                <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">parent_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                    <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">old_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                    <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                <span class="k">elif</span> <span class="n">node_name</span> <span class="o">+</span> <span class="n">plug_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span> <span class="o">+</span> <span class="n">plug_name</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">parent_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                    <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">old_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                    <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_in_db</span><span class="p">:</span>
                    <span class="c1"># (if there are attributes from completion, use them</span>
                    <span class="c1"># without asking)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;no attributes for:&quot;</span><span class="p">,</span>
                        <span class="n">node_name</span><span class="p">,</span>
                        <span class="n">plug_name</span><span class="p">,</span>
                        <span class="n">full_name</span><span class="p">,</span>
                        <span class="n">p_value</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">pop_up</span> <span class="o">=</span> <span class="n">PopUpInheritanceDict</span><span class="p">(</span>
                        <span class="n">parent_files</span><span class="p">,</span>
                        <span class="n">full_name</span><span class="p">,</span>
                        <span class="n">plug_name</span><span class="p">,</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span><span class="o">.</span><span class="n">isChecked</span><span class="p">)(),</span>
                    <span class="p">)</span>
                    <span class="n">pop_up</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">everything</span>
                    <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                        <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="n">node_name</span> <span class="o">+</span> <span class="n">plug_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span> <span class="o">+</span> <span class="n">plug_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>
                        <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">old_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]}</span>
                        <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]}</span>

        <span class="n">cvalues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TAG_TYPE</span><span class="p">:</span> <span class="n">ptype</span><span class="p">,</span>
            <span class="n">TAG_BRICKS</span><span class="p">:</span> <span class="n">bricks</span><span class="p">,</span>
            <span class="n">TAG_HISTORY</span><span class="p">:</span> <span class="n">history_id</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ivalues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TAG_TYPE</span><span class="p">:</span> <span class="n">ptype</span><span class="p">,</span>
            <span class="n">TAG_BRICKS</span><span class="p">:</span> <span class="n">bricks</span><span class="p">,</span>
            <span class="n">TAG_HISTORY</span><span class="p">:</span> <span class="n">history_id</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># from here if we still have several tags sets, we do not assign them</span>
        <span class="c1"># at all. Otherwise, set them.</span>

        <span class="c1"># Adding inherited tags</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cvalues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ivalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
            <span class="n">cvalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="c1"># use also completion attributes values</span>
        <span class="n">cvalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">ivalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">own_tags</span><span class="p">:</span>
            <span class="c1"># own_tags may insert new fields in the database</span>
            <span class="k">for</span> <span class="n">tag_to_add</span> <span class="ow">in</span> <span class="n">own_tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_field</span><span class="p">)(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span>
                <span class="p">)(</span><span class="n">COLLECTION_INITIAL</span><span class="p">):</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_field</span><span class="p">)(</span>
                        <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
                    <span class="p">)</span>

                <span class="n">cvalues</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="n">ivalues</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">cvalues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">ivalues</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tags2del</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag_to_del</span> <span class="ow">in</span> <span class="n">tags2del</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">tag_to_del</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># The collection does not exist</span>
                    <span class="c1"># or the field does not exist</span>
                    <span class="c1"># or the document does not exist</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                        <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">tag_to_del</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># The collection does not exist</span>
                    <span class="c1"># or the field does not exist</span>
                    <span class="c1"># or the document does not exist</span>
                    <span class="k">pass</span></div>

    <span class="c1"># def add_process_to_preview(self, class_process, node_name=None):</span>
    <span class="c1">#    &quot;&quot;&quot;Add a process to the pipeline.</span>
    <span class="c1">#</span>
    <span class="c1">#    :param class_process: process class&#39;s name (str)</span>
    <span class="c1">#    :param node_name: name of the corresponding node</span>
    <span class="c1">#       (using when undo/redo) (str)</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#    # pipeline = self.previewBlock.scene.pipeline</span>
    <span class="c1">#    pipeline = Pipeline()</span>
    <span class="c1">#    if not node_name:</span>
    <span class="c1">#        class_name = class_process.__name__</span>
    <span class="c1">#        i = 1</span>
    <span class="c1">#</span>
    <span class="c1">#        node_name = class_name.lower() + str(i)</span>
    <span class="c1">#</span>
    <span class="c1">#        while node_name in pipeline.nodes and i &lt; 100:</span>
    <span class="c1">#            i += 1</span>
    <span class="c1">#            node_name = class_name.lower() + str(i)</span>
    <span class="c1">#</span>
    <span class="c1">#        process_to_use = class_process()</span>
    <span class="c1">#</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        process_to_use = class_process</span>
    <span class="c1">#</span>
    <span class="c1">#    try:</span>
    <span class="c1">#        process = get_process_instance(</span>
    <span class="c1">#            process_to_use)</span>
    <span class="c1">#    except Exception as e:</span>
    <span class="c1">#        return</span>

    <span class="c1">#    pipeline.add_process(node_name, process)</span>
    <span class="c1">#    self.previewBlock.set_pipeline(pipeline)</span>

    <span class="c1">#    # Capsul update</span>
    <span class="c1">#    node = pipeline.nodes[node_name]</span>
    <span class="c1">#    # gnode = self.scene.add_node(node_name, node)</span>

    <span class="c1">#    return node, node_name</span>

<div class="viewcode-block" id="PipelineManagerTab.ask_iterated_pipeline_plugs"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.ask_iterated_pipeline_plugs">[docs]</a>    <span class="k">def</span> <span class="nf">ask_iterated_pipeline_plugs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens a dialog to ask for each pipeline plug, if an iteration should</span>
<span class="sd">        iterate over it, or if it should not be iterated, or if it should be</span>
<span class="sd">        connected to a database filter (input_filter node)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_db_compat</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">plug</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">iter_clicked</span><span class="p">(</span><span class="n">param_btns</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">param_btns</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_btns</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">db_clicked</span><span class="p">(</span><span class="n">param_btns</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">param_btns</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">dialog</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
        <span class="n">buttonbox</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Cancel</span>
        <span class="p">)</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Iterate over parameters:&quot;</span><span class="p">)</span>
        <span class="n">pblayout</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">pblayout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">scroll</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">()</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">scroll</span><span class="o">.</span><span class="n">NoFrame</span><span class="p">)</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setViewportMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pblayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">scroll</span><span class="p">)</span>
        <span class="n">param_lay</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">()</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">wid</span><span class="p">)</span>
        <span class="n">wid</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_lay</span><span class="p">)</span>
        <span class="n">param_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">pblayout</span><span class="p">)</span>

        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">buttonbox</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>

        <span class="n">buttonbox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">buttonbox</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>

        <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;iter. / database:&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;iter.:&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="n">param_btns</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>  <span class="c1"># inputs, outputs</span>
        <span class="n">forbidden</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;nodes_activation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;selection_changed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pipeline_steps&quot;</span><span class="p">,</span>
                <span class="s2">&quot;visible_groups&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">forbidden</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">it_btn</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">()</span>
                <span class="n">db_btn</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">db_btn</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">()</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_db_compat</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">plug</span><span class="p">):</span>
                        <span class="n">db_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="mi">4</span>

                <span class="n">it_btn</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">iter_clicked</span><span class="p">,</span> <span class="n">param_btns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">it_btn</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">db_btn</span><span class="p">:</span>
                    <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">db_btn</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">db_btn</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">db_clicked</span><span class="p">,</span> <span class="n">param_btns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">plug</span><span class="p">),</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">param_btns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">plug</span><span class="p">,</span> <span class="n">it_btn</span><span class="p">,</span> <span class="n">db_btn</span><span class="p">])</span>
                <span class="n">it_btn</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">param_lay</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">Accepted</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">iterated_plugs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">database_plugs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">iterated_plugs</span><span class="p">,</span> <span class="n">database_plugs</span></div>

<div class="viewcode-block" id="PipelineManagerTab.build_iterated_pipeline"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.build_iterated_pipeline">[docs]</a>    <span class="k">def</span> <span class="nf">build_iterated_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a new pipeline with an iteration node, iterating over the current</span>
<span class="sd">        pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>
        <span class="n">pipeline_name</span> <span class="o">=</span> <span class="s2">&quot;Iteration_pipeline&quot;</span>
        <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;Pipeline&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">):</span>
            <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span>
            <span class="k">if</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
                <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># get interactively iterated plugs and plugs that should be connected</span>
        <span class="c1"># to an input_filter node</span>

        <span class="n">iterated_plugs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_iterated_pipeline_plugs</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iterated_plugs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># abort</span>
        <span class="n">iterated_plugs</span><span class="p">,</span> <span class="n">database_plugs</span> <span class="o">=</span> <span class="n">iterated_plugs</span>

        <span class="c1"># if the pipeline is an unconnected inner node, fix it</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;parent_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">parent_pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">parent_pipeline</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;update_nodes_and_plugs_activation&quot;</span><span class="p">):</span>
                <span class="c1"># only if it is a pipeline - a single node does not have it</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>

        <span class="c1"># input_filer node outputs a single list. Some processes (before</span>
        <span class="c1"># iteration) already take a list as input, which will end up with a</span>
        <span class="c1"># double list (list of list) in the iteration pipeline. To overcome</span>
        <span class="c1"># this, we use a single input for each iteration (list of one element)</span>
        <span class="c1"># before actually building the iterative pipeline. In other words,</span>
        <span class="c1"># we insert Reduce nodes before list inputs which will be</span>
        <span class="c1"># connected to the database inputs</span>
        <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">database_plugs</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;pipeline_node&quot;</span><span class="p">):</span>
                <span class="c1"># propagate non-completion status</span>
                <span class="c1"># (TODO: needs something better)</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">plug</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">:</span>
                    <span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_trait</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                <span class="c1"># &quot;pipeline&quot; is actually a single process (or should, if it</span>
                <span class="c1"># is not a # pipeline). Get it into a pipeline (with a</span>
                <span class="c1"># single node) to  make the workflow.</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span>
                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">set_study_config</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">study_config</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;.&quot;</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                <span class="p">):</span>
                    <span class="n">old_node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                            <span class="s2">&quot;.&quot;</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">old_node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>

                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">old_node_name</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>
                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">autoexport_nodes_parameters</span><span class="p">(</span><span class="n">include_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">new_pipeline</span>
                <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">old_node_name</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;un_list_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">plug</span>
                <span class="n">ftol</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">add_custom_node</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span>
                    <span class="s2">&quot;capsul.pipeline.custom_nodes.reduce_node.ReduceNode&quot;</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;input_types&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;File&quot;</span><span class="p">]},</span>
                <span class="p">)</span>
                <span class="n">ftol</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># reconnect all former connection from this plug to their</span>
                <span class="c1"># destination, from the output of the ftol node</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">plug</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">):</span>
                    <span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.outputs-&gt;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>

                <span class="c1"># then remove the former pipeline plug, and re-create it by</span>
                <span class="c1"># exporting the input of the ftol node</span>
                <span class="c1"># keep traits order</span>
                <span class="n">old_traits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">remove_trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">export_parameter</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="s2">&quot;input_0&quot;</span><span class="p">,</span> <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">plug</span>
                <span class="p">)</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">reorder_traits</span><span class="p">(</span><span class="n">old_traits</span><span class="p">)</span>

        <span class="c1"># now replace the pipeline with an iterative node</span>
        <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;iterated_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">iteration_name</span>
        <span class="n">it_pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_iteration_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">iteration_name</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="p">,</span>
            <span class="n">iterative_plugs</span><span class="o">=</span><span class="n">iterated_plugs</span><span class="p">,</span>
            <span class="n">do_not_export</span><span class="o">=</span><span class="n">database_plugs</span><span class="p">,</span>
            <span class="n">make_optional</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># plugs which should be connected to a database filter: add some</span>
        <span class="c1"># Input_Filter nodes for them, and connect them to the special</span>
        <span class="c1"># database_scans input</span>
        <span class="n">in_filter_not_found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">database_plugs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">in_filter</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes.bricks.tools.Input_Filter&quot;</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">in_filter_not_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input filter not found in library.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_filter&quot;</span> <span class="o">%</span> <span class="n">plug</span>
            <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">in_filter</span><span class="p">)</span>
            <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.output-&gt;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span> <span class="n">plug</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># If database_scans is already a pipeline global input, the plug</span>
            <span class="c1"># cannot be exported. A link as to be added between database_scans</span>
            <span class="c1"># and the input of the filter.</span>
            <span class="k">if</span> <span class="s2">&quot;database_scans&quot;</span> <span class="ow">in</span> <span class="n">it_pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="s2">&quot;database_scans-&gt;</span><span class="si">%s</span><span class="s2">.input&quot;</span> <span class="o">%</span> <span class="n">node_name</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_traits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it_pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">export_parameter</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">pipeline_parameter</span><span class="o">=</span><span class="s2">&quot;database_scans&quot;</span>
                <span class="p">)</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">reorder_traits</span><span class="p">([</span><span class="s2">&quot;database_scans&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">old_traits</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_filter_not_found</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">iterated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># compl = ProcessCompletionEngine.get_completion_engine(it_pipeline)</span>
        <span class="k">return</span> <span class="n">it_pipeline</span></div>

<div class="viewcode-block" id="PipelineManagerTab.check_requirements"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.check_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">check_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="s2">&quot;global&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the configuration of a pipeline as required.&quot;&quot;&quot;</span>

        <span class="n">config_pipeline</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">requirements</span><span class="p">()</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span>
            <span class="n">config_pipeline</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="n">req</span><span class="p">)}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">config_pipeline</span></div>

<div class="viewcode-block" id="PipelineManagerTab.cleanup_older_init"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.cleanup_older_init">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_older_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove non-existent entries from the databrowser.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">brick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cleanup brick&quot;</span><span class="p">,</span> <span class="n">brick</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">delete_from_brick</span><span class="p">(</span><span class="n">brick</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">QtThreadCall</span><span class="p">()</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PipelineManagerTab.complete_pipeline_parameters"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.complete_pipeline_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">complete_pipeline_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete pipeline parameters using Capsul&#39;s completion engine</span>
<span class="sd">        mechanism.</span>
<span class="sd">        This engine works using a set of attributes which can be retreived from</span>
<span class="sd">        the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># FIXME: It seems that the following line is only used for UTs (test.</span>
        <span class="c1">#        testMIAPipelineManageTab.test_complete_pipeline_parameters).</span>
        <span class="c1">#        I think we could find a cleaner way ...</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>

        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
            <span class="n">completion</span><span class="o">.</span><span class="n">complete_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.controller_value_changed"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.controller_value_changed">[docs]</a>    <span class="k">def</span> <span class="nf">controller_value_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update history when a pipeline node is changed</span>

<span class="sd">        :param signal_list: list of the needed parameters to update history.</span>
<span class="sd">                            [&quot;plug_value&quot; or &quot;node_name&quot;, node_name, old_value,</span>
<span class="sd">                            plug_name, plug_name_type, new_value]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">case</span> <span class="o">=</span> <span class="n">signal_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># For history</span>
        <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="s2">&quot;node_name&quot;</span><span class="p">:</span>
            <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;update_node_name&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">signal_list</span><span class="p">:</span>
                <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="c1"># update pipeline view</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">()</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">setTransform</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="s2">&quot;plug_value&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">signal_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;protected_parameters&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;protected_parameters_items&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;selection_changed&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;trait_added&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;user_traits_changed&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="ow">or</span> <span class="n">signal_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">signal_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">signal_list</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span>

            <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;update_plug_value&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">signal_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">]:</span>
                    <span class="n">element</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="c1"># For history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span></div>
        <span class="c1"># self.pipelineEditorTabs.redos[</span>
        <span class="c1">#    self.pipelineEditorTabs.get_current_editor()].clear()</span>
        <span class="c1"># commented on January, 4th 2020</span>
        <span class="c1"># self.run_pipeline_action.setDisabled(True)</span>

        <span class="c1"># Cause a segmentation fault</span>
        <span class="c1"># from capsul.qt_gui.widgets.pipeline_developer_view import NodeGWidget</span>
        <span class="c1"># for item in self.pipelineEditorTabs.get_current_editor(</span>
        <span class="c1">#                                                      ).scene.items():</span>
        <span class="c1">#     if isinstance(item, NodeGWidget):</span>
        <span class="c1">#         self.pipelineEditorTabs.get_current_editor(</span>
        <span class="c1">#</span>
        <span class="c1">#         ).scene.process_clicked.emit(item.name, item.process)</span>

<div class="viewcode-block" id="PipelineManagerTab.displayNodeParameters"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.displayNodeParameters">[docs]</a>    <span class="k">def</span> <span class="nf">displayNodeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the node controller when a node is clicked</span>

<span class="sd">        :param node_name: name of the node to display parameters</span>
<span class="sd">        :param process: process instance of the corresponding node</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        config = Config()</span>

<span class="sd">        if not config.isControlV1():</span>
<span class="sd">            Node_Controller = CapsulNodeController</span>

<span class="sd">        else:</span>
<span class="sd">            Node_Controller = NodeController</span>

<span class="sd">        self.nodeController = Node_Controller(</span>
<span class="sd">            self.project, self.scan_list, self, self.main_window)</span>
<span class="sd">        self.nodeController.visibles_tags = \</span>
<span class="sd">            self.project.session.get_shown_tags()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">display_parameters</span><span class="p">(</span>
            <span class="n">node_name</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="p">)</span></div>

    <span class="c1"># def find_process(self, path):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Find the dropped process in the system&#39;s paths</span>
    <span class="c1">#</span>
    <span class="c1">#    :param path: class&#39;s path (e.g. &quot;nipype.interfaces.spm.Smooth&quot;) (str)</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#    package_name, process_name = os.path.splitext(path)</span>
    <span class="c1">#    process_name = process_name[1:]</span>
    <span class="c1">#    __import__(package_name)</span>
    <span class="c1">#    pkg = sys.modules[package_name]</span>
    <span class="c1">#    for name, instance in sorted(list(pkg.__dict__.items())):</span>
    <span class="c1">#        if name == process_name and inspect.isclass(instance):</span>
    <span class="c1">#            try:</span>
    <span class="c1">#                process = get_process_instance(instance)</span>
    <span class="c1">#            except Exception as e:</span>
    <span class="c1">#                print(e)</span>
    <span class="c1">#                return</span>
    <span class="c1">#            else:</span>
    <span class="c1">#                node, node_name = self.add_process_to_preview(instance)</span>
    <span class="c1">#                gnode = self.previewBlock.scene.gnodes[node_name]</span>
    <span class="c1">#                gnode.setPos(0, 0)</span>
    <span class="c1">#                gnode.updateInfoActived(True)</span>
    <span class="c1">#                # gnode.active = True</span>
    <span class="c1">#                # gnode.update_node()</span>
    <span class="c1">#                rect = gnode.sceneBoundingRect()</span>
    <span class="c1">#                self.previewBlock.scene.setSceneRect(rect)</span>
    <span class="c1">#                self.previewBlock.fitInView(</span>
    <span class="c1">#                    rect.x(), rect.y(), rect.width() * 1.2,</span>
    <span class="c1">#                                        rect.height() * 1.2,</span>
    <span class="c1">#                    Qt.Qt.KeepAspectRatio)</span>
    <span class="c1">#                self.previewBlock.setAlignment(Qt.Qt.AlignCenter)</span>

<div class="viewcode-block" id="PipelineManagerTab.finish_execution"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.finish_execution">[docs]</a>    <span class="k">def</span> <span class="nf">finish_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback called after a pipeline execution ends (in any way)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">soma_workflow</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">swconstants</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish_execution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_run_pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;exec_id&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Execution aborted before running&quot;</span><span class="p">)</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">WorkflowExecutionError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> When the pipeline was launched, the following &quot;</span>
                <span class="s2">&quot;exception was raised: </span><span class="si">{0}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">e</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s1">&#39;Pipeline &quot;</span><span class="si">{0}</span><span class="s1">&quot; has not been correctly run.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s1">&#39;Pipeline &quot;</span><span class="si">{0}</span><span class="s1">&quot; has been correctly run.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_DONE</span><span class="p">:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;green_v.png&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;red_cross32.png&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="n">icon</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span>
        <span class="n">Qt</span><span class="o">.</span><span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="PipelineManagerTab.remove_progress"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.remove_progress">[docs]</a>    <span class="k">def</span> <span class="nf">remove_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="c1"># self.hLayout.removeWidget(self.progress)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span></div>

<div class="viewcode-block" id="PipelineManagerTab.garbage_collect"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.garbage_collect">[docs]</a>    <span class="k">def</span> <span class="nf">garbage_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Index finished brick executions,</span>
<span class="sd">        Collect obsolete bricks and data and remove them from the database</span>

<span class="sd">        This performs a posptocessing on current and older pipelines, and</span>
<span class="sd">        cleans up the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">postprocess_pipeline_execution</span><span class="p">()</span>

        <span class="c1"># 2022/04/13: FIX #236</span>
        <span class="c1"># 1. Now that we reconstruct all history of a file through</span>
        <span class="c1"># bricks, we cannot remove bricks on the only basis that they</span>
        <span class="c1"># are not referenced in files of CURRENT_COLLECTION, they may</span>
        <span class="c1"># be part of a history pipeline. Then, we use instead</span>
        <span class="c1"># clean_up_orphan_history function that will delete history</span>
        <span class="c1"># (and inner bricks) that are not referenced in any file</span>
        <span class="c1"># 2. update_data_history seems to be useless since</span>
        <span class="c1"># brick tag should now always contain one brick (history is</span>
        <span class="c1"># kept in a separate collection)</span>
        <span class="c1"># obsolete = self.project.update_data_history(outputs)</span>
        <span class="c1"># self.project.cleanup_orphan_bricks()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_history</span><span class="p">()</span>
        <span class="c1"># 2022/04/13: FIX #236 - End</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">(),</span> <span class="s2">&quot;initialized&quot;</span>
            <span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">initialized</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_user_buttons_states</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.get_capsul_engine"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_capsul_engine">[docs]</a>    <span class="k">def</span> <span class="nf">get_capsul_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a CapsulEngine object from the edited pipeline, and set it up from</span>
<span class="sd">        MIA config object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.get_pipeline_or_process"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_pipeline_or_process">[docs]</a>    <span class="k">def</span> <span class="nf">get_pipeline_or_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get either the input pipeline (in the editor GUI), or its unique child</span>
<span class="sd">        process, if it only has one unconnected child. It allows to use a</span>
<span class="sd">        single process node from the GUI as a pipeline to iterate or run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
        <span class="k">return</span> <span class="n">pipeline</span></div>

<div class="viewcode-block" id="PipelineManagerTab.get_missing_mandatory_parameters"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_missing_mandatory_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_missing_mandatory_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check on missing parameters for</span>
<span class="sd">        each job&quot;&quot;&quot;</span>

        <span class="n">missing_mandatory_param</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
            <span class="p">):</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get_missing_mandatory_parameters</span><span class="p">():</span>
                <span class="c1"># we must also check that the parameter is not a temporary</span>
                <span class="c1"># in the workflow</span>
                <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">j</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">process</span><span class="p">()</span> <span class="ow">is</span> <span class="n">node</span>
                    <span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="c1"># gets a non-null value in the workflow</span>
                            <span class="k">continue</span>
                <span class="c1"># fmt: off</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">node</span> <span class="ow">is</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span>
                        <span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">pipeline_node</span>
                <span class="p">):</span>
                    <span class="n">item_name</span> <span class="o">=</span> <span class="n">item</span>
                <span class="c1"># fmt: on</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

                <span class="n">missing_mandatory_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">missing_mandatory_param</span></div>

<div class="viewcode-block" id="PipelineManagerTab.initialize"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean previous initialization then initialize the current</span>
<span class="sd">        pipeline.&quot;&quot;&quot;</span>

        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">setOverrideCursor</span><span class="p">(</span><span class="n">QCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WaitCursor</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_older_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_pipeline</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
                <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error during initialisation of the &quot;</span><span class="si">{0}</span><span class="s1">&quot; pipeline &#39;</span>
                <span class="s2">&quot;...!</span><span class="se">\n</span><span class="s2">Traceback:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s1">&#39;Pipeline &quot;</span><span class="si">{0}</span><span class="s1">&quot; was not initialised successfully.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># If the initialization fail, the run pipeline action is disabled</span>
        <span class="c1"># The run pipeline action is enabled only when an initialization is</span>
        <span class="c1"># successful</span>
        <span class="c1"># commented on January, 4th 2020</span>
        <span class="c1"># self.run_pipeline_action.setDisabled(True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_current_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">node_parameters</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">())</span><span class="o">.</span><span class="n">node_parameters_tmp</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_current_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.init_pipeline"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.init_pipeline">[docs]</a>    <span class="k">def</span> <span class="nf">init_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the current pipeline of the pipeline editor</span>

<span class="sd">        :param pipeline: not None if this method call a sub-pipeline</span>
<span class="sd">        :param pipeline_name: name of the parent pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Pipeline initialising ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="c1"># If the initialisation is launch for the main pipeline</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">get_process_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">())</span>
            <span class="n">main_pipeline</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_pipeline</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="s1">&#39;Pipeline &quot;</span><span class="si">{0}</span><span class="s1">&quot; is getting initialized. &#39;</span>
            <span class="s2">&quot;Please wait.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># complete config for completion</span>
        <span class="n">study_config</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
        <span class="n">study_config</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">req_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">init_messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># completion / retrieve workflow</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Workflow generation / completion for the &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> pipeline...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow_from_pipeline</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">check_requirements</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">complete_parameters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Workflow done!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Error when building the workflow for the </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;pipeline:</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">  </span><span class="si">{2}</span><span class="s2">: </span><span class="si">{3}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)),</span>
                    <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">e</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># retrieve node list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_node_list</span><span class="p">(</span><span class="n">brick</span><span class="o">=</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="c1"># check missing mandatory parameters</span>
            <span class="n">missing_mandat_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_mandatory_parameters</span><span class="p">()</span>
            <span class="c1"># check requirements</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_requirements</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing_mandat_param</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_mandat_param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Missing mandatory parameters in pipeline </span><span class="si">{0}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">  &quot;</span>
                <span class="s2">&quot;</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_mandat_param</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">requirements</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">check_requirements</span><span class="p">(</span><span class="n">message_list</span><span class="o">=</span><span class="n">req_messages</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pipeline requirements are not met:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_messages</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current configuration:&quot;</span><span class="p">)</span>
            <span class="c1"># print(study_config.engine.settings.select_configurations(</span>
            <span class="c1">#     &quot;global&quot;))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">study_config</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">export_config_dict</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">))</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">req_messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Please see the standard output for more &quot;</span> <span class="s2">&quot;information.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># FIXME: Would it be better to write a general method for</span>
            <span class="c1">#        testing all modules (currently each module test is</span>
            <span class="c1">#        hard coded below)?</span>
            <span class="c1"># FIXME: Are these tests compatible with remote run?</span>
            <span class="c1"># FIXME: Make a requirement check for FreeSurfer:</span>
            <span class="k">for</span> <span class="n">req_node</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;.&quot;</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                <span class="p">):</span>
                    <span class="n">req_node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                            <span class="s2">&quot;.&quot;</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">req_node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>

                <span class="c1"># FreeSurfer</span>

                <span class="c1"># FSL:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.fsl&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need FSL</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.fsl&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.fsl&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires FSL &quot;</span>
                                <span class="s2">&quot;but it seems FSL is not &quot;</span>
                                <span class="s2">&quot;configured in mia &quot;</span>
                                <span class="s2">&quot;preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires FSL but it &quot;</span>
                            <span class="s2">&quot;seems FSL is not configured in &quot;</span>
                            <span class="s2">&quot;mia preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                        <span class="p">)</span>

                <span class="c1"># AFNI:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.afni&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need AFNI</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.afni&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.afni&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires AFNI &quot;</span>
                                <span class="s2">&quot;but it seems AFNI is not &quot;</span>
                                <span class="s2">&quot;configured in mia &quot;</span>
                                <span class="s2">&quot;preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires AFNI but it &quot;</span>
                            <span class="s2">&quot;seems AFNI is not configured in &quot;</span>
                            <span class="s2">&quot;mia preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                        <span class="p">)</span>

                <span class="c1"># ANTS:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.ants&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need ANTS</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.ants&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.ants&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires ANTS &quot;</span>
                                <span class="s2">&quot;but it seems ANTS is not &quot;</span>
                                <span class="s2">&quot;configured in mia &quot;</span>
                                <span class="s2">&quot;preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires ANTS but it &quot;</span>
                            <span class="s2">&quot;seems ANTS is not configured in &quot;</span>
                            <span class="s2">&quot;mia preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                        <span class="p">)</span>

                <span class="c1"># Matlab:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.matlab&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                        <span class="c1"># or Config().get_use_spm_standalone()</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need matlab</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.matlab&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_spm</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span>
                            <span class="n">req_node</span>
                        <span class="p">][</span><span class="s2">&quot;capsul.engine.module.matlab&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;executable&quot;</span><span class="p">,</span> <span class="kc">False</span>
                        <span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires Matlab&quot;</span>
                                <span class="s2">&quot;but it seems Matlab is not &quot;</span>
                                <span class="s2">&quot;configured in mia &quot;</span>
                                <span class="s2">&quot;preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_spm_standalone</span><span class="p">()</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                                <span class="s2">&quot;capsul.engine.module.matlab&quot;</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mcr_directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires Matlab MCR&quot;</span>
                                <span class="s2">&quot;but it seems Matlab MCR is not &quot;</span>
                                <span class="s2">&quot;configured in mia &quot;</span>
                                <span class="s2">&quot;preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires Matlab but &quot;</span>
                            <span class="s2">&quot;it seems Matlab is not &quot;</span>
                            <span class="s2">&quot;configured in mia preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">req_node_name</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                <span class="c1"># SPM</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.spm&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need spm</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.spm&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.spm&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires SPM &quot;</span>
                                <span class="s2">&quot;but it seems SPM is not &quot;</span>
                                <span class="s2">&quot;configured in mia &quot;</span>
                                <span class="s2">&quot;preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="k">elif</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.spm&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;standalone&quot;</span><span class="p">]:</span>
                            <span class="c1"># if Config().get_matlab_standalone_path() is None:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_matlab_standalone</span><span class="p">():</span>
                                <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires &quot;</span>
                                    <span class="s2">&quot;SPM but it seems that in &quot;</span>
                                    <span class="s2">&quot;mia preferences, SPM has &quot;</span>
                                    <span class="s2">&quot;been configured as &quot;</span>
                                    <span class="s2">&quot;standalone while matlab &quot;</span>
                                    <span class="s2">&quot;MCR is not &quot;</span>
                                    <span class="s2">&quot;configured.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                                <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                                    <span class="s2">&quot;capsul.engine.module.matlab&quot;</span>
                                <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executable&quot;</span><span class="p">)</span>

                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires &quot;</span>
                                    <span class="s2">&quot;SPM but it seems that in &quot;</span>
                                    <span class="s2">&quot;mia preferences, SPM has &quot;</span>
                                    <span class="s2">&quot;been configured as &quot;</span>
                                    <span class="s2">&quot;non-standalone while &quot;</span>
                                    <span class="s2">&quot;matlab with license is &quot;</span>
                                    <span class="s2">&quot;not configured.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                                <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> requires SPM but it &quot;</span>
                            <span class="s2">&quot;seems SPM is not configured in &quot;</span>
                            <span class="s2">&quot;mia preferences.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_name</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req_messages</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The pipeline requirements are not met for pipeline </span><span class="si">{0}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_messages</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="c1"># Check that completion for output parameters is fine (for each job)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">missing_out_param</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
                    <span class="n">output_names</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">output_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="n">output_name</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span>
                        <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">output_names</span>
                    <span class="p">):</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                <span class="s2">&quot;.&quot;</span>
                            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                        <span class="p">):</span>
                            <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                    <span class="s2">&quot;.&quot;</span>
                                <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                                <span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
                            <span class="p">)</span>

                        <span class="n">missing_out_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing_out_param</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_out_param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Missing mandatory output parameter(s) for the &quot;</span>
                <span class="s2">&quot;following brick(s) in the </span><span class="si">{0}</span><span class="s2"> pipeline:</span><span class="se">\n</span><span class="s2">  &quot;</span>
                <span class="s2">&quot;</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_out_param</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init_result</span><span class="p">:</span>
            <span class="c1"># add pipeline to the history collection</span>
            <span class="n">history_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_HISTORY</span><span class="p">,</span> <span class="n">history_id</span><span class="p">)</span>

            <span class="c1"># serialize pipeline</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Iteration_pipeline&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">list_process_in_pipeline</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">ProcessIteration</span><span class="p">):</span>
                        <span class="n">inner_pipeline</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">process</span>
                        <span class="k">break</span>
                <span class="n">pipeline_tools</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span>
                    <span class="n">inner_pipeline</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pipeline_tools</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span><span class="p">)</span>

            <span class="n">pipeline_xml</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                <span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
                <span class="n">history_id</span><span class="p">,</span>
                <span class="p">{</span><span class="n">HISTORY_PIPELINE</span><span class="p">:</span> <span class="n">pipeline_xml</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># add process characteristics in the database</span>
            <span class="c1"># if init is otherwise OK</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
                        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
                    <span class="c1"># trick to eliminate &quot;ReduceJob&quot; in jobs</span>
                    <span class="c1"># would it be better to test if process is a ReduceNode ?</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">):</span>
                        <span class="n">node_name</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">context_name</span>

                        <span class="k">if</span> <span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
                            <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">update_auto_inheritance</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_inheritance</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

                        <span class="c1"># Adding the brick to the bricks history</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">PipelineNode</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)):</span>
                            <span class="c1"># check if brick_id has already been assigned</span>
                            <span class="n">brick_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">brick_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">brick_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">brick_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">brick_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

                            <span class="c1"># set brick_id in process</span>
                            <span class="n">job</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">brick_id</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">brick_id</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
                                    <span class="n">COLLECTION_BRICK</span><span class="p">,</span> <span class="n">brick_id</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="c1"># id is not unique. It happens in iterations</span>
                                <span class="c1"># FIXME: we need a better way to handle</span>
                                <span class="c1">#        UUIDs in iterated processes</span>
                                <span class="c1"># brick_id = str(uuid.uuid4())</span>
                                <span class="c1"># job.uuid = brick_id</span>
                                <span class="c1"># self.brick_list[-1] = brick_id</span>
                                <span class="c1"># # then try again</span>
                                <span class="c1"># self.project.session.add_document(</span>
                                <span class="c1">#                          COLLECTION_BRICK,</span>
                                <span class="c1">#                          brick_id)</span>
                                <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="s2">&quot;Error while setting job uuid on &quot;</span>
                                    <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; brick.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>
                                <span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                                <span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                                <span class="n">brick_id</span><span class="p">,</span>
                                <span class="p">{</span>
                                    <span class="n">BRICK_NAME</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
                                    <span class="n">BRICK_INIT_TIME</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                                    <span class="n">BRICK_INIT</span><span class="p">:</span> <span class="s2">&quot;Not Done&quot;</span><span class="p">,</span>
                                    <span class="n">BRICK_EXEC</span><span class="p">:</span> <span class="s2">&quot;Not Done&quot;</span><span class="p">,</span>
                                <span class="p">},</span>
                            <span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">_register_node_io_in_database</span><span class="p">(</span>
                                <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="p">,</span> <span class="n">history_id</span>
                            <span class="p">)</span>

            <span class="c1"># add bricklist into history collection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                <span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
                <span class="n">history_id</span><span class="p">,</span>
                <span class="p">{</span><span class="n">HISTORY_BRICKS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_completion_attributes</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;init time:&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">saveModifications</span><span class="p">()</span>

        <span class="c1"># Updating the node controller</span>
        <span class="c1"># Display the updated parameters in right part of</span>
        <span class="c1"># the Pipeline Manager (controller)</span>
        <span class="k">if</span> <span class="n">main_pipeline</span><span class="p">:</span>
            <span class="n">node_controller_node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">node_name</span>

            <span class="c1"># Todo: Fix the problem of the controller that</span>
            <span class="c1">#       keeps the name of the old brick deleted until</span>
            <span class="c1">#       a click on the new one. This can cause a mia</span>
            <span class="c1">#       crash during the initialisation, for example.</span>

            <span class="k">if</span> <span class="n">node_controller_node_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">]:</span>
                <span class="n">node_controller_node_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">process</span> <span class="o">=</span> <span class="n">pipeline</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">node_controller_node_name</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span>
            <span class="p">):</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_controller_node_name</span><span class="p">]</span><span class="o">.</span><span class="n">process</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">display_parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">node_name</span><span class="p">,</span>
                <span class="n">process</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">init_result</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">init_messages</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The pipeline could not be initialized &quot;</span> <span class="s2">&quot;properly:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">mssg</span> <span class="ow">in</span> <span class="n">init_messages</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- &quot;</span> <span class="o">+</span> <span class="n">mssg</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The pipeline could not be initialized &quot;</span>
                        <span class="s2">&quot;correctly, for an unknown reason!&quot;</span>
                    <span class="p">)</span>

                <span class="n">lineCnt</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Pipeline initialization warning!&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lineCnt</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">scroll</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">()</span>
                    <span class="n">scroll</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
                    <span class="n">scroll</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">tmpLabel</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">tmpLabel</span><span class="o">.</span><span class="n">setTextInteractionFlags</span><span class="p">(</span>
                        <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextSelectableByMouse</span>
                    <span class="p">)</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">tmpLabel</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span>
                        <span class="n">scroll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
                        <span class="s2">&quot;QScrollArea{min-width:550 px; &quot;</span> <span class="s2">&quot;min-height: 300px}&quot;</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span><span class="p">)</span>

                <span class="n">yes_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
                    <span class="s2">&quot;Open MIA preferences&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesRole</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">yes_button</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">software_preferences_pop_up</span><span class="p">()</span>
                    <span class="c1"># fmt: off</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">pop_up_preferences</span><span class="o">.</span>
                        <span class="n">tab_widget</span><span class="o">.</span><span class="n">setCurrentIndex</span>
                    <span class="p">)(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># fmt: on</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="s1">&#39;Pipeline &quot;</span><span class="si">{0}</span><span class="s1">&quot; was not initialised successfully.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_editor_by_index</span><span class="p">(</span>
                        <span class="n">i</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="s1">&#39;Pipeline &quot;</span><span class="si">{0}</span><span class="s1">&quot; has been initialised.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">init_result</span></div>

<div class="viewcode-block" id="PipelineManagerTab.layout_view"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.layout_view">[docs]</a>    <span class="k">def</span> <span class="nf">layout_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize layout for the pipeline manager tab&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Diagram editor&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="p">)</span>

        <span class="c1"># Toolbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_mode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">False</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="c1"># commented on January, 4th 2020</span>
        <span class="c1"># self.tags_menu.addAction(self.init_pipeline_action)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Pipeline&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setPopupMode</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QToolButton</span><span class="o">.</span><span class="n">MenuButtonPopup</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="p">)</span>
        <span class="c1"># commented on January, 4th 2020</span>
        <span class="c1"># self.menu_toolbar.addAction(self.init_pipeline_action)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Fixed</span>
        <span class="p">)</span>

        <span class="c1"># Layouts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="p">)</span>
        <span class="c1"># self.hLayout.addWidget(self.init_button)</span>
        <span class="c1"># self.hLayout.addWidget(self.run_button)</span>
        <span class="c1"># self.hLayout.addWidget(self.stop_button)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>

        <span class="c1"># previewScene = QGraphicsScene()</span>
        <span class="c1"># previewScene.setSceneRect(QtCore.QRectF())</span>
        <span class="c1"># self.previewDiagram = QGraphicsView()</span>
        <span class="c1"># self.previewDiagram.setEnabled(False)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="p">)</span>
        <span class="c1"># self.splitter0.addWidget(self.previewBlock)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>

        <span class="c1"># self.splitter2 = QSplitter(Qt.Qt.Vertical)</span>
        <span class="c1"># self.splitter2.addWidget(self.splitter1)</span>
        <span class="c1"># self.splitter2.setSizes([800, 100])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="p">)</span></div>

<div class="viewcode-block" id="PipelineManagerTab.loadParameters"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.loadParameters">[docs]</a>    <span class="k">def</span> <span class="nf">loadParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load pipeline parameters to the current pipeline of the pipeline editor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">load_pipeline_parameters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.loadPipeline"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.loadPipeline">[docs]</a>    <span class="k">def</span> <span class="nf">loadPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a pipeline to the pipeline editor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">load_pipeline</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.postprocess_pipeline_execution"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.postprocess_pipeline_execution">[docs]</a>    <span class="k">def</span> <span class="nf">postprocess_pipeline_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Operations to be performed after a run has been completed.</span>
<span class="sd">        It can be called either within the run procedure (the user clicks on</span>
<span class="sd">        the &quot;run&quot; button and waits for the results), or after a disconnetion /</span>
<span class="sd">        reconnection of the client app: the user clicks on &quot;run&quot; with</span>
<span class="sd">        distributed/remote execution activated, then closes the client MIA.</span>
<span class="sd">        Processing takes place (possibly remotely) within a soma-workflow</span>
<span class="sd">        server. Then the user runs MIA again, and we have to collect the</span>
<span class="sd">        outputs of runs which happenned (finished) while we were disconnected.</span>

<span class="sd">        Such post-processing includes database indexing of output data, and</span>
<span class="sd">        should take into account not only the current pipeline, bu all past</span>
<span class="sd">        runs which have not been postprocessed yet.</span>

<span class="sd">        When called with a pipeline argument, it only deals with this one.</span>

<span class="sd">        The method can be called from within a worker run thread, thus has to</span>
<span class="sd">        be thread-safe.</span>

<span class="sd">        Question: do we have to postprocess failed runs (pipelines which</span>
<span class="sd">        started and failed) ? Probably yes because they may have produced some</span>
<span class="sd">        results during the first steps, and failed later.</span>

<span class="sd">        Question: how to decide which pipelines / runs have to be posptocessed</span>
<span class="sd">        now ? A pipeline may be started, then stopped or could have failed,</span>
<span class="sd">        then be postprocessed. But the user can still restart them in</span>
<span class="sd">        soma-workflow (or maybe mia one day), thus they should be postprocessed</span>
<span class="sd">        again then.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;last_run_pipeline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>

        <span class="c1"># print(&#39;postprocess pipeline:&#39;, pipeline)</span>

        <span class="n">to_upate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">finished_bricks</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">(),</span> <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">bricks</span> <span class="o">=</span> <span class="n">to_upate</span><span class="p">[</span><span class="s2">&quot;bricks&quot;</span><span class="p">]</span>

        <span class="c1"># set state of bricks: done + exec date</span>
        <span class="k">for</span> <span class="n">brid</span><span class="p">,</span> <span class="n">brick</span> <span class="ow">in</span> <span class="n">bricks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">swf_status</span> <span class="o">=</span> <span class="n">brick</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;swf_status&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">swf_status</span><span class="p">:</span>
                <span class="n">exec_date</span> <span class="o">=</span> <span class="n">swf_status</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no real info about exec time</span>
                <span class="n">exec_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;set exec status on:&quot;</span><span class="p">,</span> <span class="n">brid</span><span class="p">,</span> <span class="n">exec_date</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                <span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                <span class="n">brid</span><span class="p">,</span>
                <span class="p">{</span><span class="n">BRICK_EXEC</span><span class="p">:</span> <span class="s2">&quot;Done&quot;</span><span class="p">,</span> <span class="n">BRICK_EXEC_TIME</span><span class="p">:</span> <span class="n">exec_date</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># now cleanup earlier history of data</span>
        <span class="c1"># 2022/04/13: FIX #236</span>
        <span class="c1"># get obsolete bricks (done) referenced from current outputs</span>
        <span class="c1"># print(&#39;obsolete bricks:&#39;, obsolete)</span>
        <span class="c1"># self.project.cleanup_orphan_bricks(obsolete)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_history</span><span class="p">()</span>
        <span class="c1"># 2022/04/13: FIX #236 - End</span>
        <span class="n">QtThreadCall</span><span class="p">()</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">saveModifications</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.redo"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.redo">[docs]</a>    <span class="k">def</span> <span class="nf">redo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redo the last undone action on the current pipeline editor</span>

<span class="sd">        Actions that can be redone:</span>
<span class="sd">            - add_process</span>
<span class="sd">            - delete_process</span>
<span class="sd">            - export_plug</span>
<span class="sd">            - export_plugs</span>
<span class="sd">            - remove_plug</span>
<span class="sd">            - update_node_name</span>
<span class="sd">            - update_plug_value</span>
<span class="sd">            - add_link</span>
<span class="sd">            - delete_link</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>

        <span class="c1"># We can redo if we have an action to make again</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">redos</span><span class="p">[</span><span class="n">c_e</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_redo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">redos</span><span class="p">[</span><span class="n">c_e</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c1"># The first element of the list is the type of action made</span>
            <span class="c1"># by the user</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">class_process</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_named_process</span><span class="p">(</span>
                    <span class="n">class_process</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">del_node</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;export_plugs&quot;</span><span class="p">:</span>
                <span class="n">temp_plug_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">_remove_plug</span><span class="p">(</span>
                    <span class="n">_temp_plug_name</span><span class="o">=</span><span class="n">temp_plug_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove_plug&quot;</span><span class="p">:</span>
                <span class="n">tot_plug_names</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tot_pip_plug_name</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">tot_plug_name</span> <span class="ow">in</span> <span class="n">tot_plug_names</span><span class="p">:</span>
                    <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">node_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">optional</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tot_pip_plug_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">_export_plug</span><span class="p">(</span>
                        <span class="n">temp_plug_name</span><span class="o">=</span><span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">weak_link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span>
                        <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">multi_export</span><span class="o">=</span><span class="n">multi_export</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Connecting all the plugs that were connected</span>
                    <span class="c1"># to the original plugs.</span>

                    <span class="c1"># Checking if the original plug is a pipeline</span>
                    <span class="c1"># input or output to adapt the links to add.</span>
                    <span class="k">if</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Writing a string to represent the link</span>
                    <span class="n">source_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                    <span class="n">dest_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="s2">&quot;-&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">source_parameters</span><span class="p">,</span> <span class="n">dest_parameters</span><span class="p">))</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update_pipeline</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">multi_export</span><span class="p">:</span>
                    <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;export_plugs&quot;</span><span class="p">,</span>
                        <span class="n">tot_pip_plug_name</span><span class="p">,</span>
                        <span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">]</span>
                    <span class="n">c_e</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_node_name&quot;</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">old_node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_node_name</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span> <span class="n">new_node_name</span><span class="p">,</span> <span class="n">old_node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_plug_value&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">plug_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">value_type</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_plug_value</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_link&quot;</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">_del_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_link&quot;</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">active</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">weak</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># link = source[0] + &quot;.&quot; + source[1]</span>
                <span class="c1"># + &quot;-&gt;&quot; + dest[0] + &quot;.&quot; + dest[1]</span>

            <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.register_completion_attributes"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.register_completion_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">register_completion_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">completion</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">pl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">)</span>

        <span class="n">tag_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

            <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">todo</span> <span class="o">+=</span> <span class="n">item</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">apath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">apath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apath</span><span class="p">[</span><span class="n">pl</span><span class="p">:])</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attributes</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                        <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attributes</span>
                    <span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># outputs not used / inactivated</span></div>

<div class="viewcode-block" id="PipelineManagerTab.runPipeline"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.runPipeline">[docs]</a>    <span class="k">def</span> <span class="nf">runPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the current pipeline of the pipeline editor.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">soma_workflow</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">swconstants</span>

        <span class="c1"># Added on January, 4th 2020</span>
        <span class="c1"># Initialize the pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># End - added on January, 4th 2020</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;NoName&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s1">&#39;Pipeline &quot;</span><span class="si">{0}</span><span class="s1">&quot; is getting run. Please wait.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span> <span class="o">=</span> <span class="s2">&quot;NoName&quot;</span>

            <span class="c1"># if self.iterationTable.check_box_iterate.isChecked():</span>
            <span class="c1"># iterated_tag = self.iterationTable.iterated_tag</span>
            <span class="c1"># tag_values = self.iterationTable.tag_values_list</span>

            <span class="c1"># pipeline_progress = dict()</span>
            <span class="c1"># pipeline_progress[&#39;size&#39;] = len(tag_values)</span>
            <span class="c1"># pipeline_progress[&#39;counter&#39;] = 1</span>
            <span class="c1"># pipeline_progress[&#39;tag&#39;] = iterated_tag</span>
            <span class="c1"># for tag_value in tag_values:</span>
            <span class="c1"># self.brick_list = []</span>
            <span class="c1"># # Status bar update</span>
            <span class="c1"># pipeline_progress[&#39;tag_value&#39;] = tag_value</span>

            <span class="c1"># idx_combo_box = self.iterationTable.combo_box.findText(</span>
            <span class="c1"># tag_value)</span>
            <span class="c1"># self.iterationTable.combo_box.setCurrentIndex(</span>
            <span class="c1"># idx_combo_box)</span>
            <span class="c1"># self.iterationTable.update_table()</span>

            <span class="c1"># self.init_pipeline()</span>
            <span class="c1"># self.main_window.statusBar().showMessage(</span>
            <span class="c1"># &#39;Pipeline &quot;{0}&quot; is getting run for {1} {2}. &#39;</span>
            <span class="c1"># &#39;Please wait.&#39;.format(name, iterated_tag, tag_value))</span>
            <span class="c1"># QApplication.processEvents()</span>
            <span class="c1"># self.progress = RunProgress(self, pipeline_progress)</span>
            <span class="c1"># # self.progress.show()</span>
            <span class="c1"># # self.progress.exec()</span>
            <span class="c1"># pipeline_progress[&#39;counter&#39;] += 1</span>
            <span class="c1"># self.init_clicked = False</span>

            <span class="c1"># # self.init_pipeline(self.pipeline)</span>
            <span class="c1"># idx = self.progress.value()</span>
            <span class="c1"># idx += 1</span>
            <span class="c1"># self.progress.setValue(idx)</span>
            <span class="c1"># QApplication.processEvents()</span>

            <span class="c1"># self.main_window.statusBar().showMessage(</span>
            <span class="c1"># &#39;Pipeline &quot;{0}&quot; has been run for {1} {2}. Please wait.&#39;.format(</span>
            <span class="c1"># name, iterated_tag, tag_values))</span>

            <span class="c1"># else:</span>

            <span class="c1"># soma-workflow remote credentials</span>
            <span class="kn">from</span> <span class="nn">soma_workflow</span> <span class="kn">import</span> <span class="n">configuration</span>
            <span class="kn">from</span> <span class="nn">soma_workflow.gui.workflowGui</span> <span class="kn">import</span> <span class="n">ConnectionDialog</span>

            <span class="n">config_file</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">search_config_path</span><span class="p">()</span>
            <span class="n">resource_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_configured_resources</span><span class="p">(</span>
                    <span class="n">config_file</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">login_list</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_logins</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>
            <span class="n">swf_config</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
                <span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;somaworkflow&quot;</span><span class="p">:</span> <span class="s1">&#39;config_id==&quot;somaworkflow&quot;&#39;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">swf_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">cd</span> <span class="o">=</span> <span class="n">ConnectionDialog</span><span class="p">(</span><span class="n">login_list</span><span class="p">,</span> <span class="n">resource_list</span><span class="p">)</span>
                <span class="n">sel_resource</span> <span class="o">=</span> <span class="n">swf_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;computing_resource&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sel_resource</span> <span class="ow">and</span> <span class="n">sel_resource</span> <span class="ow">in</span> <span class="n">resource_list</span><span class="p">:</span>
                    <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">combo_resources</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="n">sel_resource</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">combo_resources</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
                <span class="c1"># login = cd.ui.lineEdit_login.text()</span>
                <span class="n">passwd</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lineEdit_password</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">rsa_key</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lineEdit_rsa_password</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">resource</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
                    <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_local_resource_id</span><span class="p">(),</span>
                <span class="p">):</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">study_config</span>
                    <span class="k">if</span> <span class="s2">&quot;SomaWorkflowConfig&quot;</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                        <span class="c1"># not sure this is needed...</span>
                        <span class="n">sc</span><span class="o">.</span><span class="n">somaworkflow_computing_resource</span> <span class="o">=</span> <span class="n">resource</span>
                        <span class="c1"># setattr(sc.somaworkflow_computing_resources_config,</span>
                        <span class="c1"># resource, {})</span>
                        <span class="n">swc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SomaWorkflowConfig&quot;</span><span class="p">]</span>
                        <span class="n">swc</span><span class="o">.</span><span class="n">set_computing_resource_password</span><span class="p">(</span>
                            <span class="n">resource</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">rsa_key</span>
                        <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CONNECT TO:&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">RunProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
                <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Fixed</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
            <span class="c1"># self.progress.show()</span>
            <span class="c1"># self.progress.exec()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
            <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>

            <span class="n">mmovie</span> <span class="o">=</span> <span class="n">QMovie</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;rotatingBrainVISA.gif&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span> <span class="o">=</span> <span class="n">mmovie</span>
            <span class="n">mmovie</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">mmovie</span><span class="o">.</span><span class="n">frameChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_anim_frame</span><span class="p">)</span>
            <span class="n">mmovie</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish_execution</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">False</span></div>
            <span class="c1"># Commented on January, 4th 2020</span>
            <span class="c1"># self.run_pipeline_action.setDisabled(True)</span>

<div class="viewcode-block" id="PipelineManagerTab.saveParameters"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.saveParameters">[docs]</a>    <span class="k">def</span> <span class="nf">saveParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the pipeline parameters of the the current pipeline of the</span>
<span class="sd">        pipeline editor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.savePipeline"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.savePipeline">[docs]</a>    <span class="k">def</span> <span class="nf">savePipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncheck</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current pipeline of the pipeline editor</span>

<span class="sd">        :param uncheck: a flag to warn (False) or not (True) if a pipeline is</span>
<span class="sd">                        going to be overwritten during saving operation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="s2">&quot;The pipeline is getting saved. Please wait.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># QApplication.processEvents()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>

        <span class="c1"># save</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">filename</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">uncheck</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;mia_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;mia_processes&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;populse_mia - Save pipeline Warning!&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="s2">&quot;The following module will be overwritten:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Do you agree?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span><span class="n">new_file_name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;</span><span class="si">{}</span><span class="s2">&#39; pipeline has been &quot;</span>
                    <span class="s2">&quot;saved.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;</span><span class="si">{}</span><span class="s2">&#39; pipeline was not &quot;</span>
                    <span class="s2">&quot;saved.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">filename</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;mia_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;mia_processes&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span><span class="n">new_file_name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;</span><span class="si">{}</span><span class="s2">&#39; pipeline has been &quot;</span>
                <span class="s2">&quot;saved.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># save as</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saveResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">saveResult</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;</span><span class="si">{}</span><span class="s2">&#39; pipeline has been saved.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">saveResult</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="s2">&quot;The pipeline was not saved.&quot;</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="PipelineManagerTab.savePipelineAs"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.savePipelineAs">[docs]</a>    <span class="k">def</span> <span class="nf">savePipelineAs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current pipeline of the pipeline editor under another name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="s2">&quot;The pipeline is getting saved. Please wait.&quot;</span>
        <span class="p">)</span>
        <span class="n">saveResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">saveResult</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;</span><span class="si">{}</span><span class="s2">&#39; pipeline has been saved.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">saveResult</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s2">&quot;The pipeline was not saved.&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="PipelineManagerTab.show_status"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.show_status">[docs]</a>    <span class="k">def</span> <span class="nf">show_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the last run status and execution info, errors etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;show_status&quot;</span><span class="p">)</span>
        <span class="n">status_widget</span> <span class="o">=</span> <span class="n">StatusWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">status_widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_widget</span> <span class="o">=</span> <span class="n">status_widget</span></div>

<div class="viewcode-block" id="PipelineManagerTab.stop_execution"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.stop_execution">[docs]</a>    <span class="k">def</span> <span class="nf">stop_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request interruption of pipeline execution</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stop_execution&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">stop_execution</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.undo"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.undo">[docs]</a>    <span class="k">def</span> <span class="nf">undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo the last action made on the current pipeline editor</span>

<span class="sd">        Actions that can be undone:</span>
<span class="sd">            - add_process</span>
<span class="sd">            - delete_process</span>
<span class="sd">            - export_plug</span>
<span class="sd">            - export_plugs</span>
<span class="sd">            - remove_plug</span>
<span class="sd">            - update_node_name</span>
<span class="sd">            - update_plug_value</span>
<span class="sd">            - add_link</span>
<span class="sd">            - delete_link</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>

        <span class="c1"># We can undo if we have an action to revert</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span><span class="n">c_e</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span><span class="n">c_e</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c1"># The first element of the list is the type of action made</span>
            <span class="c1"># by the user</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">del_node</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_named_process</span><span class="p">(</span>
                    <span class="n">class_name</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;export_plugs&quot;</span><span class="p">:</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">]</span>

                <span class="n">temp_plug_name</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">:</span>
                        <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>

                    <span class="n">temp_plug_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pip_plug_name</span><span class="p">)</span>

                <span class="n">c_e</span><span class="o">.</span><span class="n">_remove_plug</span><span class="p">(</span>
                    <span class="n">_temp_plug_name</span><span class="o">=</span><span class="n">temp_plug_name</span><span class="p">,</span>
                    <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">from_export_plugs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># self.main_window.statusBar().showMessage(</span>
                <span class="c1">#    &quot;Plugs {0} have been removed.&quot;.format(str(parameters)))</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove_plug&quot;</span><span class="p">:</span>
                <span class="n">tot_plug_names</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tot_pip_plug_name</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">tot_plug_name</span> <span class="ow">in</span> <span class="n">tot_plug_names</span><span class="p">:</span>
                    <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">node_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">optional</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tot_pip_plug_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">_export_plug</span><span class="p">(</span>
                        <span class="n">temp_plug_name</span><span class="o">=</span><span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">weak_link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span>
                        <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">multi_export</span><span class="o">=</span><span class="n">multi_export</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Connecting all the plugs that were connected</span>
                    <span class="c1"># to the original plugs.</span>

                    <span class="k">if</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="c1"># Checking if the original plug is a pipeline</span>
                        <span class="c1"># input or output to adapt the links to add.</span>
                        <span class="k">if</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                            <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">dest</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">source</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                        <span class="c1"># Writing a string to represent the link</span>
                        <span class="n">source_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                        <span class="n">dest_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="s2">&quot;-&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">source_parameters</span><span class="p">,</span> <span class="n">dest_parameters</span><span class="p">))</span>

                        <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update_pipeline</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">multi_export</span><span class="p">:</span>
                    <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;export_plugs&quot;</span><span class="p">,</span>
                        <span class="n">tot_pip_plug_name</span><span class="p">,</span>
                        <span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">]</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_node_name&quot;</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">old_node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_node_name</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span> <span class="n">new_node_name</span><span class="p">,</span> <span class="n">old_node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_plug_value&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">plug_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">value_type</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_plug_value</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_link&quot;</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">_del_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_link&quot;</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">active</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">weak</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span>
                    <span class="n">dest</span><span class="p">,</span>
                    <span class="n">active</span><span class="p">,</span>
                    <span class="n">weak</span><span class="p">,</span>
                    <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.update_auto_inheritance"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_auto_inheritance">[docs]</a>    <span class="k">def</span> <span class="nf">update_auto_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try (as best as possible) to assign output parameters to input ones,</span>
<span class="sd">        to get database tags for them.</span>

<span class="sd">        When a node has only one input with a value (filename) in the database,</span>
<span class="sd">        then output filenames are considered to inherit from it.</span>
<span class="sd">        When several input parameters have values in the database, then if they</span>
<span class="sd">        are all equal, we can fallback to the first case.</span>
<span class="sd">        When values are different, and have different database tags, then the</span>
<span class="sd">        ambiguity remains, and we keep track of the several possible inputs</span>
<span class="sd">        which can provide tags for outputs.</span>

<span class="sd">        The process attribute auto_inheritance_dict is filled with these</span>
<span class="sd">        values. It&#39;s a dict with the shape::</span>

<span class="sd">            {output_filename: &lt;input_spec&gt;}</span>

<span class="sd">        `output_filename` is the relative filename in the database</span>

<span class="sd">        `&lt;input_spec&gt;` can be:</span>

<span class="sd">        * a string: filename</span>
<span class="sd">        * a dict::</span>

<span class="sd">                {input_param: input_filename}</span>

<span class="sd">        `auto_inheritance_dict` is built automatically, ans is used as a</span>
<span class="sd">        fallback to :class:`ProcessMIA` `inheritance_dict`, built &quot;manually&quot;</span>
<span class="sd">        (specialized for each process) in the :meth:`ProcessMIA.list_outputs`</span>
<span class="sd">        when the latter does not exist, or does not specify what an output</span>
<span class="sd">        inherits from.</span>

<span class="sd">        If ambiguities still subsist, the MIA infrastructure will ask the user</span>
<span class="sd">        how to solve them, which is not very convenient, and error-prone, thus</span>
<span class="sd">        should be avoided.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(&#39;update_auto_inheritance:&#39;, node.name)</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="c1"># keep only leaf processes that actually produce outputs</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;auto_inheritance_dict&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">process</span><span class="o">.</span><span class="n">auto_inheritance_dict</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>

        <span class="n">project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">project</span><span class="p">:</span>
            <span class="c1"># no databasing, nothing to be done.</span>
            <span class="k">return</span>

        <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">pl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">)</span>

        <span class="c1"># retrieve inputs and outputs keys in process,</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>
            <span class="c1"># ProcessMIA / Process_Mia specific</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;list_outputs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span>
            <span class="p">):</span>
                <span class="c1"># normally same as outputs, but it may contain an additional</span>
                <span class="c1"># &quot;notInDb&quot; key.</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>

        <span class="c1"># Fill inputs and outputs values with job</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                        <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                        <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># if the process has a single input with a value in the database,</span>
        <span class="c1"># then we can deduce its output database tags/attributes from it</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                    <span class="n">rpath</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">pl</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">rpath</span><span class="p">):</span>
                        <span class="c1"># we&#39;d better use rpath, but inheritance_dict</span>
                        <span class="c1"># is using full paths.</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                        <span class="k">break</span>
                        <span class="c1"># TODO what if several path values are valid ?</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># zero inputs are registered in the database: we cannot</span>
            <span class="c1"># infer outputs tags automatically. OK we leave.</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">main_param</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">main_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">main_param</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># several inputs are registered in the database: we cannot</span>
            <span class="c1"># infer outputs tags automatically too, but we mark the ambiguity</span>
            <span class="c1"># to ask the user later</span>
            <span class="n">main_value</span> <span class="o">=</span> <span class="n">values</span>

        <span class="n">notInDb</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notInDb&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug_value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">plug_name</span> <span class="ow">in</span> <span class="n">notInDb</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">plug_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">plug_value</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">todo</span> <span class="o">+=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                        <span class="c1"># rpath = path[pl:]</span>
                        <span class="n">plug_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">plug_values</span><span class="p">:</span>
                <span class="n">auto_inheritance_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_value</span>

        <span class="k">if</span> <span class="n">auto_inheritance_dict</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="n">auto_inheritance_dict</span></div>
            <span class="c1"># print(&#39;auto_inheritance_dict for&#39;,</span>
            <span class="c1">#       node.name, &#39;:&#39;, auto_inheritance_dict)</span>

<div class="viewcode-block" id="PipelineManagerTab.update_inheritance"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_inheritance">[docs]</a>    <span class="k">def</span> <span class="nf">update_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the inheritance dictionary&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
        <span class="p">):</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">new_inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inherit_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">[</span>
                <span class="n">node_name</span>
            <span class="p">]:</span>
                <span class="n">dict_found</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">inheritance_dict_key</span> <span class="ow">in</span> <span class="n">inherit_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">param_key</span><span class="p">,</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">inheritance_dict_key</span> <span class="o">==</span> <span class="n">param_value</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">dict_found</span>
                        <span class="p">):</span>
                            <span class="n">new_inheritance_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inherit_dict</span><span class="p">)</span>
                            <span class="n">dict_found</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_inheritance_dict</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span>
            <span class="n">job</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="n">new_inheritance_dict</span></div>

<div class="viewcode-block" id="PipelineManagerTab.update_node_list"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_node_list">[docs]</a>    <span class="k">def</span> <span class="nf">update_node_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brick</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the list of nodes in workflow&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>
        <span class="c1"># elif brick is not None:</span>
        <span class="c1">#     if hasattr(brick, &quot;nodes&quot;):</span>
        <span class="c1">#         from capsul.pipeline import pipeline_tools</span>
        <span class="c1">#         for key, node in brick.nodes.items():</span>
        <span class="c1">#             print(key, &#39;-&gt;&#39;, node)</span>
        <span class="c1">#             if node is brick.pipeline_node:</span>
        <span class="c1">#                 continue</span>
        <span class="c1">#             if pipeline_tools.is_node_enabled(brick, key, node):</span>
        <span class="c1">#                 #if not isinstance(node, Pipeline):</span>
        <span class="c1">#                 #    if node not in self.node_list:</span>
        <span class="c1">#                 #        self.node_list.append(node)</span>
        <span class="c1">#                 self.update_node_list(brick=node)</span>
        <span class="c1">#     if hasattr(brick, &quot;process&quot;) and hasattr(brick.process, &quot;nodes&quot;):</span>
        <span class="c1">#         from capsul.pipeline import pipeline_tools</span>
        <span class="c1">#         for key, node in brick.process.nodes.items():</span>
        <span class="c1">#             print(key, &#39;-&gt;&#39;, node)</span>
        <span class="c1">#             if key == &#39;&#39;:</span>
        <span class="c1">#                 continue</span>
        <span class="c1">#             if pipeline_tools.is_node_enabled(brick.process,</span>
        <span class="c1">#                                               key, node):</span>
        <span class="c1">#                 if not isinstance(node, Pipeline):</span>
        <span class="c1">#                     if node not in self.node_list:</span>
        <span class="c1">#                         self.node_list.append(node)</span>

<div class="viewcode-block" id="PipelineManagerTab.updateProcessLibrary"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.updateProcessLibrary">[docs]</a>    <span class="k">def</span> <span class="nf">updateProcessLibrary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the library of processes when a pipeline is saved</span>

<span class="sd">        :param filename: file name of the pipeline that has been saved</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename_folder</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

        <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename_folder</span><span class="p">,</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s2">&quot;_tmp&quot;</span><span class="p">)</span>

        <span class="c1"># Changing the &quot;Pipeline&quot; class name to the name of file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;class &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;class </span><span class="si">{0}</span><span class="s2">(Pipeline):&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filename_folder</span><span class="p">)</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_mia_path</span><span class="p">(),</span> <span class="s2">&quot;processes&quot;</span><span class="p">,</span> <span class="s2">&quot;User_processes&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Updating __init__.py</span>
        <span class="n">init_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get_mia_path</span><span class="p">(),</span> <span class="s2">&quot;processes&quot;</span><span class="p">,</span> <span class="s2">&quot;User_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Checking that import line is not already in the file</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;from .</span><span class="si">{0}</span><span class="s2"> import </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">init_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">flines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flines</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">init_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;from .</span><span class="si">{0}</span><span class="s2"> import </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">),</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">package</span> <span class="o">=</span> <span class="s2">&quot;User_processes&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename_folder</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span>

        <span class="c1"># If the pipeline has already been saved</span>
        <span class="k">if</span> <span class="s2">&quot;User_processes.&quot;</span> <span class="o">+</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># removing the previous version of the module</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;User_processes.&quot;</span> <span class="o">+</span> <span class="n">module_name</span><span class="p">]</span>
            <span class="c1"># this adds the new module version to the sys.modules dictionary</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;User_processes&quot;</span><span class="p">)</span>

        <span class="c1"># Adding the module path to the system path</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">add_package</span><span class="p">(</span>
            <span class="n">package</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">init_package_tree</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.update_project"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_project">[docs]</a>    <span class="k">def</span> <span class="nf">update_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the project attribute of several objects</span>

<span class="sd">        :param project: current project in the software</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">visibles_tags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

        <span class="c1"># Necessary for using MIA bricks</span>
        <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span></div>

<div class="viewcode-block" id="PipelineManagerTab.update_scans_list"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_scans_list">[docs]</a>    <span class="k">def</span> <span class="nf">update_scans_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_list</span><span class="p">,</span> <span class="n">all_iterations_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the user-selected list of scans</span>

<span class="sd">        :param iteration_list: current list of scans in the iteration table</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_user_buttons_states</span><span class="p">()</span>

        <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
        <span class="n">has_iteration</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;iteration&quot;</span>
        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">sortedKeys</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;iterated_&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">has_iteration</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">key</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_iteration</span><span class="p">:</span>
                <span class="c1"># move to an iteration pipeline</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_iterated_pipeline</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">new_pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># abort</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span>
                        <span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">c_e</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">new_pipeline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">new_pipeline</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="n">all_iterations_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">all_iterations_list</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_iteration</span><span class="p">:</span>
                <span class="c1"># get the pipeline out from the iteration node</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">iteration_name</span><span class="p">]</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">process</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">new_pipeline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">new_pipeline</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span>
        <span class="c1"># print(&#39;update_scans_list:&#39;, sum(all_iterations_list, []))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_documents_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_scans_list</span><span class="p">()</span></div>

<div class="viewcode-block" id="PipelineManagerTab.update_user_buttons_states"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_user_buttons_states">[docs]</a>    <span class="k">def</span> <span class="nf">update_user_buttons_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the visibility of initialize/run/save actions according to</span>
<span class="sd">        pipeline state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Commented on January, 4th 2020</span>
        <span class="c1"># With disabling of init button, run button is always available</span>
        <span class="c1"># if (hasattr(self.pipelineEditorTabs.get_current_editor(),</span>
        <span class="c1">#             &#39;initialized&#39;) and</span>
        <span class="c1">#         self.pipelineEditorTabs.get_current_editor().initialized):</span>
        <span class="c1">#     self.run_pipeline_action.setDisabled(False)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.run_pipeline_action.setDisabled(True)</span>
        <span class="c1">#</span>
        <span class="c1"># self.init_pipeline_action.setDisabled(False)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_editor_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">editor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">editor</span><span class="o">.</span><span class="n">scene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">list_process_in_pipeline</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>
        <span class="c1"># End - Commented on January, 4th 2020</span>

        <span class="c1"># Uncomment below to not allow to save an iterated pipeline: ###</span>
        <span class="c1"># if (hasattr(self.pipelineEditorTabs.get_current_editor(),</span>
        <span class="c1">#            &#39;iterated&#39;) and</span>
        <span class="c1">#        self.pipelineEditorTabs.get_current_editor().iterated):</span>
        <span class="c1">#    self.save_pipeline_as_action.setDisabled(True)</span>
        <span class="c1">#    self.save_pipeline_action.setDisabled(True)</span>
        <span class="c1"># else:</span>
        <span class="c1">#    self.save_pipeline_as_action.setDisabled(False)</span>
        <span class="c1">#    self.save_pipeline_action.setDisabled(False)</span>
        <span class="c1"># End Comment ###</span>

<div class="viewcode-block" id="PipelineManagerTab.update_user_mode"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_user_mode">[docs]</a>    <span class="k">def</span> <span class="nf">update_user_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the visibility of widgets/actions depending of the chosen mode</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

        <span class="c1"># If the user mode is chosen, the process library is not available</span>
        <span class="c1"># and the user cannot save a pipeline</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_user_mode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">action_delete_project</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">action_delete_project</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">userlevel</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_user_level</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">userlevel</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">userlevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="n">userlevel</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">process_widget</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">process_widget</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="n">userlevel</span></div></div>

        <span class="c1"># If the user mode is chosen, the process library is not available</span>
        <span class="c1"># and the user cannot save a pipeline</span>
        <span class="c1"># if config.get_user_mode() == True:</span>
        <span class="c1">#     self.processLibrary.setHidden(True)</span>
        <span class="c1">#     self.previewBlock.setHidden(True)</span>
        <span class="c1">#     self.save_pipeline_action.setDisabled(True)</span>
        <span class="c1">#     self.save_pipeline_as_action.setDisabled(True)</span>
        <span class="c1"># else:</span>
        <span class="c1"># self.processLibrary.setHidden(False)</span>
        <span class="c1"># self.previewBlock.setHidden(False)</span>
        <span class="c1"># self.save_pipeline_action.setDisabled(False)</span>
        <span class="c1"># self.save_pipeline_as_action.setDisabled(False)</span>


<div class="viewcode-block" id="RunProgress"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress">[docs]</a><span class="k">class</span> <span class="nc">RunProgress</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the pipeline progress bar and launch the thread.</span>

<span class="sd">    The progress bar is closed when the thread finishes.</span>

<span class="sd">    :param pipeline_manager: A PipelineManagerTab</span>
<span class="sd">    :param settings: dictionary of settings when the pipeline is iterated</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RunProgress.__init__"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunProgress</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QProgressBar</span><span class="p">()</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>  <span class="c1"># For mac OS</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">RunWorker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_progress</span><span class="p">)</span></div>

    <span class="c1"># def __del__(self):</span>
    <span class="c1"># self.cleanup()</span>

<div class="viewcode-block" id="RunProgress.cleanup"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>  <span class="c1"># self.end_progress)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span></div>
        <span class="c1"># self.progressbar.deleteLater()</span>
        <span class="c1"># del self.progressbar</span>
        <span class="c1"># self.hide()</span>

<div class="viewcode-block" id="RunProgress.end_progress"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.end_progress">[docs]</a>    <span class="k">def</span> <span class="nf">end_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;exec_id&quot;</span><span class="p">):</span>
            <span class="n">mbox_icon</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span>
            <span class="n">mbox_title</span> <span class="o">=</span> <span class="s2">&quot;Failure&quot;</span>
            <span class="n">mbox_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Execution has failed before running.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Please see details using the status report button&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">WorkflowExecutionError</span><span class="p">:</span>
                <span class="n">mbox_icon</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span>
                <span class="n">mbox_title</span> <span class="o">=</span> <span class="s2">&quot;Failure&quot;</span>
                <span class="n">mbox_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Pipeline execution has failed:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Please see details using the status report button&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mbox_icon</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Information</span>
                <span class="n">mbox_title</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
                <span class="n">mbox_text</span> <span class="o">=</span> <span class="s2">&quot;Pipeline execution was OK.&quot;</span>
        <span class="n">mbox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="n">mbox_icon</span><span class="p">,</span> <span class="n">mbox_title</span><span class="p">,</span> <span class="n">mbox_text</span><span class="p">)</span>
        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">mbox</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">mbox</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunProgress.start"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>
        <span class="c1"># self.progressbar.setValue(20)</span>

<div class="viewcode-block" id="RunProgress.stop_execution"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.stop_execution">[docs]</a>    <span class="k">def</span> <span class="nf">stop_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** CANCEL ***&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">interrupt_request</span> <span class="o">=</span> <span class="kc">True</span></div></div>
        <span class="c1"># self.close()</span>


<div class="viewcode-block" id="RunWorker"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker">[docs]</a><span class="k">class</span> <span class="nc">RunWorker</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run the pipeline&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RunWorker.__init__"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="c1"># use this lock to modify the worker state from GUI/other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span>
        <span class="c1"># when interrupt_request is set (within a lock session from a different</span>
        <span class="c1"># thread), the worker will interrupt execution and leave the thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RunWorker.run"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_check_nipype_processes</span><span class="p">(</span><span class="n">pplne</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pplne</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pplne</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>  <span class="c1"># not a process node</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">node_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">_check_nipype_processes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">NipypeProcess</span><span class="p">):</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">activate_copy</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">NipypeProcess</span><span class="p">):</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">activate_copy</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="n">_check_nipype_processes</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">engine</span><span class="o">.</span><span class="n">study_config</span><span class="o">.</span><span class="n">reset_process_counter</span><span class="p">()</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Pipeline running ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">workflow</span>
        <span class="c1"># if we are running with file transfers / translations, then we must</span>
        <span class="c1"># rebuild the workflow, because it has not been made with them.</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connected_to</span><span class="p">()</span>
        <span class="n">resource_conf</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
            <span class="n">resource_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;somaworkflow&quot;</span><span class="p">:</span> <span class="s1">&#39;config_id==&quot;somaworkflow&quot;&#39;</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.somaworkflow&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">resource_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transfer_paths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resource_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;path_translations&quot;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rebuilding workflow for file transfers / translations...&quot;</span><span class="p">)</span>
            <span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow_from_pipeline</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">complete_parameters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">resource_id</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running now...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec_id</span><span class="p">,</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span>
                <span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span>
                <span class="n">get_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_id</span> <span class="o">=</span> <span class="n">exec_id</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span><span class="p">,</span>
                <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_IN_PROGRESS</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="c1"># print(self.status)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">exec_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                        <span class="n">engine</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">exec_id</span><span class="p">)</span>
                        <span class="c1"># break</span>

            <span class="c1"># postprocess each node to index outputs</span>
            <span class="c1"># if self.status == swconstants.WORKFLOW_DONE:</span>
            <span class="c1"># do it even in case of failure to get partial outputs and clean</span>
            <span class="c1"># the remainings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">postprocess_pipeline_execution</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> has not run correctly:</span><span class="se">\n</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span>
        <span class="c1"># restore current working directory in case it has been changed</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StatusWidget"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget">[docs]</a><span class="k">class</span> <span class="nc">StatusWidget</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Status widget: displays info about the current or last pipeline execution</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StatusWidget.__init__"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTextBrowser</span><span class="p">()</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline_manager</span><span class="p">,</span> <span class="s2">&quot;last_run_log&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

        <span class="n">status_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Status:&quot;</span><span class="p">)</span>
        <span class="n">slayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">status_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">slayout</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">pipeline_manager</span><span class="p">,</span> <span class="s2">&quot;last_status&quot;</span><span class="p">,</span> <span class="s2">&quot;No pipeline execution&quot;</span>
        <span class="p">)</span>
        <span class="n">slayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;status:&lt;/b&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">))</span>

        <span class="n">swf_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Soma-Workflow monitoring:&quot;</span><span class="p">)</span>
        <span class="n">wlayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">wlayout</span><span class="p">)</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span> <span class="o">=</span> <span class="n">swf_box</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_soma_workflow</span><span class="p">)</span>

        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">status_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">swf_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Execution log:&quot;</span><span class="p">))</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Execution status&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="StatusWidget.toggle_soma_workflow"><a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget.toggle_soma_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_soma_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checked</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">checked</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">checked</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">soma_workflow.gui.workflowGui</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">ApplicationModel</span><span class="p">,</span>
                <span class="n">MainWindow</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">ApplicationModel</span><span class="p">()</span>
            <span class="n">sw_widget</span> <span class="o">=</span> <span class="n">MainWindow</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="o">=</span> <span class="n">sw_widget</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sw_widget</span><span class="p">)</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>