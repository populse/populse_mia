<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>populse_mia.user_interface.pipeline_manager.pipeline_manager_tab &#8212; populse_mia 3.0.0-dev+9d1e1aff documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=47202671" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/haiku.css?v=fce32b03" />
    <script src="../../../../_static/documentation_options.js?v=4774077a"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";





const initStyles = () => {
    const defaultStyle = document.createElement('style');
    defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}`;
    document.head.appendChild(defaultStyle);

    const fullscreenStyle = document.createElement('style');
    fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
    document.head.appendChild(fullscreenStyle);
}

// Detect if page has dark background
const isDarkTheme = () => {
    // We use a set of heuristics:
    // 1. Check for common dark mode classes or attributes
    // 2. Check computed background color brightness
    if (document.documentElement.classList.contains('dark') ||
        document.documentElement.getAttribute('data-theme') === 'dark' ||
        document.body.classList.contains('dark') ||
        document.body.getAttribute('data-theme') === 'dark') {
        // console.log("Dark theme detected via class/attribute");
        return true;
    }
    if (document.documentElement.classList.contains('light') ||
        document.documentElement.getAttribute('data-theme') === 'light' ||
        document.body.classList.contains('light') ||
        document.body.getAttribute('data-theme') === 'light') {
        // console.log("Light theme detected via class/attribute");
        return false;
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // console.log("Dark theme detected via prefers-color-scheme");
        return true;
    }
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        // console.log("Background color brightness:", brightness);
        return brightness < 128;
    }
    // console.log("No dark or light theme detected, defaulting to light theme");
    return false;
};

let darkTheme = isDarkTheme();
let modal = null;
let modalContent = null;
let previousScrollOffset = [window.scrollX, window.scrollY];

const runMermaid = async (rerun) => {
    console.log("Running mermaid diagrams, rerun =", rerun);
    // clear all existing mermaid charts
    let all_mermaids = document.querySelectorAll(".mermaid");

    if (rerun) {
        all_mermaids.forEach((el) => {
            if(!el.hasAttribute("data-original-code")) {
                // store original code
                // console.log(`Storing original code for first run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
            if(el.getAttribute("data-processed") === "true") {
                // remove and restore original
                el.removeAttribute("data-processed");
                // console.log(`Restoring original code for re-run: `, el.getAttribute('data-original-code'));
                el.innerHTML = el.getAttribute('data-original-code');
            } else {
                // store original code
                // console.log(`Storing original code for re-run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
        });
        await mermaid.run();
    }

    all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(() => runMermaid(false), 200);
        return;
    }

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    if (modal !== null ) {
        // Destroy existing modal
        modal.remove();
        modal = null;
        modalContent = null;
    }

    modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            // Already processed, adjust button class if needed
            const existingBtn = mermaidDiv.parentNode.querySelector('.mermaid-fullscreen-btn');
            if (existingBtn) {
                existingBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
            }
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        container.appendChild(fullscreenBtn);
    });
};

const load = async () => {
    initStyles();

    await runMermaid(true);

    const reRunIfThemeChanges = async () => {
        const newDarkTheme = isDarkTheme();
        if (newDarkTheme !== darkTheme) {
            darkTheme = newDarkTheme;
            console.log("Theme change detected, re-running mermaid with", darkTheme ? "dark" : "default", "theme");
            await mermaid.initialize(
                {...JSON.parse(
                    `{"startOnLoad": false}`
                ),
                ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
                }
            );
            await runMermaid(true);
        }
    };

    // Update theme classes when theme changes
    const themeObserver = new MutationObserver(reRunIfThemeChanges);
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    themeObserver.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
};





console.log("Initializing mermaid with", darkTheme ? "dark" : "default", "theme");
mermaid.initialize(
    {...JSON.parse(
        `{"startOnLoad": false}`
    ),
    ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
    }
);

window.addEventListener("load", load);</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>populse_mia 3.0.0-dev+9d1e1aff documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.user_interface.pipeline_manager.pipeline_manager_tab</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for populse_mia.user_interface.pipeline_manager.pipeline_manager_tab</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to define pipeline manager tab appearance, settings and methods.</span>

<span class="sd">Contains:</span>
<span class="sd">    Class:</span>
<span class="sd">        - PipelineManagerTab</span>
<span class="sd">        - RunProgress</span>
<span class="sd">        - RunWorker</span>
<span class="sd">        - StatusWidget</span>
<span class="sd">    Function:</span>
<span class="sd">        - protected_logging</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># Other imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Soma_workflow import</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">soma_workflow.constants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">swconstants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traits.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">traits</span>

<span class="c1"># Capsul imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capsul.api</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">NipypeProcess</span><span class="p">,</span>
    <span class="n">Pipeline</span><span class="p">,</span>
    <span class="n">PipelineNode</span><span class="p">,</span>
    <span class="n">Process</span><span class="p">,</span>
    <span class="n">ProcessNode</span><span class="p">,</span>
    <span class="n">get_process_instance</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capsul.attributes.completion_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessCompletionEngine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capsul.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkflowExecutionError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capsul.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">pipeline_tools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capsul.pipeline.pipeline_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow_from_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capsul.pipeline.process_iteration</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessIteration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.qt_compat</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtWidgets</span>

<span class="c1"># PyQt5 imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QtCore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">pyqtSignal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">QCursor</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QMovie</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">QAction</span><span class="p">,</span>
    <span class="n">QApplication</span><span class="p">,</span>
    <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QMenu</span><span class="p">,</span>
    <span class="n">QMessageBox</span><span class="p">,</span>
    <span class="n">QScrollArea</span><span class="p">,</span>
    <span class="n">QSplitter</span><span class="p">,</span>
    <span class="n">QToolBar</span><span class="p">,</span>
    <span class="n">QVBoxLayout</span><span class="p">,</span>
    <span class="n">QWidget</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Soma_base import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.controller.trait_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_file_trait</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.qt_gui.qtThread</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtThreadCall</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">traits.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">TraitListObject</span><span class="p">,</span> <span class="n">Undefined</span>

<span class="c1"># Populse_mia imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.data_manager</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BRICK_EXEC</span><span class="p">,</span>
    <span class="n">BRICK_EXEC_TIME</span><span class="p">,</span>
    <span class="n">BRICK_INIT</span><span class="p">,</span>
    <span class="n">BRICK_INIT_TIME</span><span class="p">,</span>
    <span class="n">BRICK_INPUTS</span><span class="p">,</span>
    <span class="n">BRICK_NAME</span><span class="p">,</span>
    <span class="n">BRICK_OUTPUTS</span><span class="p">,</span>
    <span class="n">COLLECTION_BRICK</span><span class="p">,</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
    <span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
    <span class="n">HISTORY_BRICKS</span><span class="p">,</span>
    <span class="n">HISTORY_PIPELINE</span><span class="p">,</span>
    <span class="n">TAG_BRICKS</span><span class="p">,</span>
    <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
    <span class="n">TAG_FILENAME</span><span class="p">,</span>
    <span class="n">TAG_HISTORY</span><span class="p">,</span>
    <span class="n">TAG_TYPE</span><span class="p">,</span>
    <span class="n">TYPE_MAT</span><span class="p">,</span>
    <span class="n">TYPE_NII</span><span class="p">,</span>
    <span class="n">TYPE_TXT</span><span class="p">,</span>
    <span class="n">TYPE_UNKNOWN</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.software_properties</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.pipeline_manager.iteration_table</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">IterationTable</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.pipeline_manager.node_controller</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CapsulNodeController</span><span class="p">,</span>
    <span class="n">NodeController</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.pipeline_manager.pipeline_editor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PipelineEditorTabs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.pipeline_manager.process_library</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProcessLibraryWidget</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessMIA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">populse_mia.user_interface.pop_ups</span><span class="w"> </span><span class="kn">import</span> <span class="n">PopUpInheritanceDict</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="protected_logging">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.protected_logging">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">protected_logging</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that preserves logging configuration across soma-workflow</span>
<span class="sd">    interference.</span>

<span class="sd">    This context manager creates a snapshot of all logger configurations</span>
<span class="sd">    before execution and intelligently restores them afterwards. It preserves</span>
<span class="sd">    any new handlers or filters that were added during execution while</span>
<span class="sd">    ensuring original configurations are restored.</span>

<span class="sd">    The protection covers:</span>
<span class="sd">        - All named loggers in the logger hierarchy</span>
<span class="sd">        - The root logger</span>
<span class="sd">        - Handler and filter lists (with intelligent merging)</span>
<span class="sd">        - Logger levels, disabled state, and propagation settings</span>

<span class="sd">    Usage:</span>
<span class="sd">        with protected_logging():</span>
<span class="sd">            # Code that might interfere with logging</span>
<span class="sd">            some_workflow_operation()</span>
<span class="sd">            # Any new handlers/filters added here are preserved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a comprehensive backup of the logging state</span>
    <span class="n">loggers_backup</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Backup all named loggers</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">loggerDict</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">loggers_backup</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">),</span>  <span class="c1"># copy handler list</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">filters</span><span class="p">),</span>  <span class="c1"># copy filters</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
            <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">disabled</span><span class="p">,</span>
            <span class="s2">&quot;propagate&quot;</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Backup root logger separately</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">loggers_backup</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">),</span>
        <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">filters</span><span class="p">),</span>
        <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
        <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">disabled</span><span class="p">,</span>
        <span class="s2">&quot;propagate&quot;</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">propagate</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>

    <span class="k">finally</span><span class="p">:</span>

        <span class="c1"># Restore configs but merge handlers/filters</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">loggers_backup</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span>
                <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Merge handlers: keep existing, re-add missing originals</span>
            <span class="n">existing_handlers</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">h</span><span class="p">):</span> <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;handlers&quot;</span><span class="p">]:</span>

                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_handlers</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

            <span class="c1"># Merge filters the same way</span>
            <span class="n">existing_filters</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">filters</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;filters&quot;</span><span class="p">]:</span>

                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_filters</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="c1"># Restore scalar properties</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;disabled&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;propagate&quot;</span><span class="p">]</span></div>



<div class="viewcode-block" id="PipelineManagerTab">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PipelineManagerTab</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget that handles the Pipeline Manager tab.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - _register_node_io_in_database: Register node input and output values</span>
<span class="sd">                                         in the database</span>
<span class="sd">        - _set_anim_frame: Callback that updates the pipeline status action</span>
<span class="sd">                           icon</span>
<span class="sd">        - _should_register_plug: Determine if a plug should be registered</span>
<span class="sd">        - add_plug_value_to_database: Add the plug value to the database</span>
<span class="sd">        - ask_iterated_pipeline_plugs: Display a config dialog for pipeline</span>
<span class="sd">                                       plug iteration and database connections</span>
<span class="sd">        - build_iterated_pipeline: Build a new pipeline with an iteration node</span>
<span class="sd">        - check_requirements: Return the configuration of a pipeline as</span>
<span class="sd">                              required</span>
<span class="sd">        - cleanup_older_init: Remove non-existent entries from the databrowser</span>
<span class="sd">        - complete_pipeline_parameters: Complete pipeline parameters</span>
<span class="sd">        - controller_value_changed: Update history when a pipeline node is</span>
<span class="sd">                                    changed</span>
<span class="sd">        - displayNodeParameters: Display the node controller when a node is</span>
<span class="sd">                                 clicked</span>
<span class="sd">        - finish_execution: Handle pipeline execution completion and update UI</span>
<span class="sd">                            state</span>
<span class="sd">        - garbage_collect: Clean up obsolete data and maintain database</span>
<span class="sd">                           consistency</span>
<span class="sd">        - get_capsul_engine: Retrieve and configure a Capsul engine from the</span>
<span class="sd">                             pipeline editor</span>
<span class="sd">        - get_pipeline_or_process: Get the pipeline or its single unconnected</span>
<span class="sd">                                   process node</span>
<span class="sd">        - get_missing_mandatory_parameters: Check on missing parameters for</span>
<span class="sd">                                            each job</span>
<span class="sd">        - initialize: Clean previous initialization then initialize the current</span>
<span class="sd">                      pipeline</span>
<span class="sd">        - init_pipeline: Initialize the current pipeline of the pipeline</span>
<span class="sd">                         editor</span>
<span class="sd">        - layout_view : Initialize layout for the pipeline manager</span>
<span class="sd">        - loadParameters: Load pipeline parameters to the current pipeline of</span>
<span class="sd">                          the pipeline editor</span>
<span class="sd">        - loadPipeline: Load a pipeline to the pipeline editor</span>
<span class="sd">        - postprocess_pipeline_execution: Operations to be performed after a</span>
<span class="sd">                                          run has been completed</span>
<span class="sd">        - redo: Redo the last undone action on the current pipeline editor</span>
<span class="sd">        - register_completion_attributes: Register completion attributes for a</span>
<span class="sd">                                          given pipeline in the project</span>
<span class="sd">                                          database</span>
<span class="sd">        - remove_progress: Remove and clean up the progress widget</span>
<span class="sd">        - runPipeline: Run the current pipeline of the pipeline editor</span>
<span class="sd">        - saveParameters: Save the pipeline parameters of the the current</span>
<span class="sd">                          pipeline of the pipeline editor</span>
<span class="sd">        - savePipeline: Save the current pipeline of the pipeline editor</span>
<span class="sd">        - save_pipeline_as: Save the current pipeline of the pipeline editor</span>
<span class="sd">                            under another name</span>
<span class="sd">        - show_status: Display the execution status window with runtime</span>
<span class="sd">                       information.</span>
<span class="sd">        - stop_execution: Interrupt pipeline execution gracefully</span>
<span class="sd">        - undo: Undo the last action made on the current pipeline editor</span>
<span class="sd">        - update_auto_inheritance: Get database tags for output parameters</span>
<span class="sd">        - update_inheritance: Update the inheritance dictionary for a process</span>
<span class="sd">                              node in a pipeline execution</span>
<span class="sd">        - update_node_list: Update the list of nodes in workflow</span>
<span class="sd">        - updateProcessLibrary: Update the library of processes when a</span>
<span class="sd">                                pipeline is saved</span>
<span class="sd">        - update_project: Update the project attribute of several objects</span>
<span class="sd">        - update_scans_list: Update the user-selected list of scans</span>
<span class="sd">        - update_user_buttons_states: Update the visibility of</span>
<span class="sd">                                      initialize / run / save actions</span>
<span class="sd">                                      according to the pipeline state</span>
<span class="sd">        - update_user_mode: Update the visibility of widgets / actions</span>
<span class="sd">                            depending of the chosen mode</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">item_library_clicked</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="PipelineManagerTab.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">scan_list</span><span class="p">,</span> <span class="n">main_window</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Pipeline Manager tab.</span>

<span class="sd">        The Pipeline Manager provides a comprehensive interface for creating,</span>
<span class="sd">        editing, and executing data processing pipelines. It integrates</span>
<span class="sd">        process libraries, pipeline editors, node controllers, and iteration</span>
<span class="sd">        tables to manage complex data analysis workflows.</span>

<span class="sd">        :param project: The current project instance containing database and</span>
<span class="sd">                        configuration</span>
<span class="sd">        :param scan_list: List of selected database files to process. If None</span>
<span class="sd">                          or empty, defaults to all documents in the current</span>
<span class="sd">                          collection</span>
<span class="sd">        :param main_window: Main application window instance for UI integration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Initialize core attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="n">main_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Initialize state flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_progress_bar</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Initialize collections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># This list is the list of scans contained in the iteration table.</span>
        <span class="c1"># If it is empty, the scan list in the Pipeline Manager is the scan</span>
        <span class="c1"># list from the data_browser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Configure node controller based on version</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">node_controller_class</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">CapsulNodeController</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">isControlV1</span><span class="p">()</span>
            <span class="k">else</span> <span class="n">NodeController</span>
        <span class="p">)</span>
        <span class="c1"># Set up MIA processing project reference</span>
        <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

        <span class="c1"># Initialize the scan list from database or provided list</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">scan_list</span>
                <span class="k">if</span> <span class="n">scan_list</span>
                <span class="k">else</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Initialize main UI components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span> <span class="o">=</span> <span class="n">ProcessLibraryWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span> <span class="o">=</span> <span class="n">PipelineEditorTabs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>
        <span class="c1"># Iteration table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span> <span class="o">=</span> <span class="n">IterationTable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>
        <span class="c1"># Layout components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Initialize toolbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span> <span class="o">=</span> <span class="n">QToolBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QToolButton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span> <span class="o">=</span> <span class="n">QScrollArea</span><span class="p">()</span>
        <span class="c1"># Initialize Qt layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
        <span class="c1"># Initialize and configure the node controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span> <span class="o">=</span> <span class="n">node_controller_class</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">visibles_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>

        <span class="c1"># Setup actions and toolbar</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="c1"># Pipeline management actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Load pipeline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadPipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Save pipeline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savePipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Save pipeline as&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as</span><span class="p">)</span>
        <span class="c1"># Parameter management actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="s2">&quot;Load pipeline parameters&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadParameters</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="s2">&quot;Save pipeline parameters&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveParameters</span>
        <span class="p">)</span>
        <span class="c1"># Execution actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;run32.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Run pipeline&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runPipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;stop32.png&quot;</span><span class="p">)),</span> <span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_execution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;gray_cross.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Status&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;garbage_collect.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Cleanup&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
            <span class="s2">&quot;Cleanup obsolete items in the database (pipeline inits, &quot;</span>
            <span class="s2">&quot;obsolete data...). Not needed in normal situations, but useful &quot;</span>
            <span class="s2">&quot;after a reconnection (client/server) or application crash.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Initialize connection state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startedConnection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Initialize the layout structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_view</span><span class="p">()</span>
        <span class="c1"># Connect signals</span>
        <span class="c1"># Process library signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">process_library</span><span class="o">.</span><span class="n">item_library_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_library_clicked</span>
        <span class="p">)</span>
        <span class="c1"># Pipeline editor signals</span>
        <span class="n">signal_connections</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">node_clicked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">process_clicked</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">switch_clicked</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">pipeline_saved</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateProcessLibrary</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">signal</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">signal_connections</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>

        <span class="c1"># Iteration table signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">iteration_table_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_scans_list</span>
        <span class="p">)</span>
        <span class="c1"># To undo/redo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">value_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller_value_changed</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_register_node_io_in_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">history_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register node input and output values in the database.</span>

<span class="sd">        This method processes the inputs and outputs of a given node,</span>
<span class="sd">        associates them with a job, and updates the database with the</span>
<span class="sd">        appropriate values. It handles leaf processes, user-defined traits,</span>
<span class="sd">        and completion attributes, ensuring that initialization data is</span>
<span class="sd">        recorded correctly.</span>

<span class="sd">        :param job: Job object containing parameter values and unique</span>
<span class="sd">                    identifier (UUID).</span>
<span class="sd">        :param node: Node instance (Process, Pipeline, or custom node) to</span>
<span class="sd">                     register.</span>
<span class="sd">        :param pipeline_name (str, optional): Name of the containing pipeline,</span>
<span class="sd">                                              if any.</span>
<span class="sd">        :param history_id (str, optional): Database history entry identifier.</span>
<span class="sd">                                           Defaults to an empty string.</span>

<span class="sd">        Note:</span>
<span class="sd">            Pipeline and PipelineNode instances are skipped as only leaf</span>
<span class="sd">            processes produce meaningful output data.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_for_json</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Serialize objects to JSON-compatible format.</span>

<span class="sd">            Handles special types like Undefined values, temporary paths,</span>
<span class="sd">            datetime objects, and sets for safe JSON storage.</span>

<span class="sd">            :param item: The object to be serialized.</span>

<span class="sd">            :return: JSON-serializable representation of the item.</span>

<span class="sd">            :raises TypeError: If item type cannot be serialized.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="kn">import</span><span class="w"> </span><span class="nn">soma_workflow.client</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">swc</span>

            <span class="c1"># Handle special cases</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Undefined</span><span class="p">,</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]):</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">swc</span><span class="o">.</span><span class="n">TemporaryPath</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;temp&gt;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot serialize object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Skip pipeline nodes as they don&#39;t produce direct output</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">PipelineNode</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)):</span>
            <span class="c1"># only leaf processes produce output data</span>
            <span class="k">return</span>

        <span class="c1"># Extract the actual process</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>

            <span class="c1"># Handle ProcessMIA/Process_Mia specific outputs</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;list_outputs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span>
            <span class="p">):</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle custom nodes with user-defined traits</span>
            <span class="n">user_traits</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">user_traits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">user_traits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>

        <span class="c1"># Update I/O values from job parameters</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_update_values_from_job</span><span class="p">(</span><span class="n">values_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update values dictionary with job parameters.</span>

<span class="sd">            :param values_dict: Dictionary of input or output values to</span>
<span class="sd">                                update.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">job_value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_value</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                            <span class="n">values_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_value</span>

        <span class="n">_update_values_from_job</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">_update_values_from_job</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

        <span class="c1"># Get completion attributes</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">()</span>

        <span class="c1"># Serialize I/O values for database storage</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_dict_values</span><span class="p">(</span><span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Serialize all values in a dictionary for JSON compatibility.</span>

<span class="sd">            :param data_dict: Dictionary with values to serialize.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">serialized</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Use JSON roundtrip to ensure serialization works</span>
                    <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_serialize_for_json</span><span class="p">)</span>
                    <span class="n">serialized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Log warning and skip problematic values</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not serialize </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">serialized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;serialization_error&gt;&quot;</span>

            <span class="k">return</span> <span class="n">serialized</span>

        <span class="n">serialized_inputs</span> <span class="o">=</span> <span class="n">_serialize_dict_values</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">serialized_outputs</span> <span class="o">=</span> <span class="n">_serialize_dict_values</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

        <span class="c1"># Register output values in database</span>
        <span class="n">node_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Updating the database with output values obtained from</span>
        <span class="c1"># initialisation. If a plug name is in outputs[&#39;notInDb&#39;], then</span>
        <span class="c1"># the corresponding output value is not added to the database.</span>
        <span class="n">excluded_outputs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">serialized_outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notInDb&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug_value</span> <span class="ow">in</span> <span class="n">serialized_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># Skip if not a valid process trait or has high user level</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_register_plug</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Skip undefined values and excluded outputs</span>
            <span class="k">if</span> <span class="n">plug_value</span> <span class="o">==</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span> <span class="ow">or</span> <span class="n">plug_name</span> <span class="ow">in</span> <span class="n">excluded_outputs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Construct full node name</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">pipeline_name</span> <span class="k">else</span> <span class="n">node_name</span>
            <span class="p">)</span>

            <span class="c1"># Register plug value in database</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_plug_value_to_database</span><span class="p">(</span>
                <span class="n">p_value</span><span class="o">=</span><span class="n">plug_value</span><span class="p">,</span>
                <span class="n">brick_id</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">history_id</span><span class="o">=</span><span class="n">history_id</span><span class="p">,</span>
                <span class="n">node_name</span><span class="o">=</span><span class="n">node_name</span><span class="p">,</span>
                <span class="n">plug_name</span><span class="o">=</span><span class="n">plug_name</span><span class="p">,</span>
                <span class="n">full_name</span><span class="o">=</span><span class="n">full_name</span><span class="p">,</span>
                <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">trait</span><span class="p">,</span>
                <span class="n">inputs</span><span class="o">=</span><span class="n">serialized_inputs</span><span class="p">,</span>
                <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="c1"># Update brick initialization state in database.</span>
            <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                <span class="n">primary_key</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">BRICK_INPUTS</span><span class="p">:</span> <span class="n">serialized_inputs</span><span class="p">,</span>
                    <span class="n">BRICK_OUTPUTS</span><span class="p">:</span> <span class="n">serialized_outputs</span><span class="p">,</span>
                    <span class="n">BRICK_INIT</span><span class="p">:</span> <span class="s2">&quot;Done&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_anim_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the pipeline status action icon with the current animation</span>
<span class="sd">        frame.</span>

<span class="sd">        This method serves as a callback that synchronizes the animated movie&#39;s</span>
<span class="sd">        current frame with the status action&#39;s icon, creating a smooth animated</span>
<span class="sd">        icon effect in the UI.</span>

<span class="sd">        Note:</span>
<span class="sd">        This method is typically connected to QMovie&#39;s frameChanged signal</span>
<span class="sd">        to automatically update the icon as the animation progresses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_pixmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">currentPixmap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QIcon</span><span class="p">(</span><span class="n">current_pixmap</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_register_plug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if a plug should be registered in the database.</span>

<span class="sd">        :param process: Process instance</span>
<span class="sd">        :param plug_name (str): Name of the plug to check</span>

<span class="sd">        :return: True if plug should be registered, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plug_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">traits</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trait</span><span class="o">.</span><span class="n">userlevel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">trait</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">&lt;=</span> <span class="mi">0</span>

<div class="viewcode-block" id="PipelineManagerTab.add_plug_value_to_database">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.add_plug_value_to_database">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_plug_value_to_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p_value</span><span class="p">,</span>
        <span class="n">brick_id</span><span class="p">,</span>
        <span class="n">history_id</span><span class="p">,</span>
        <span class="n">node_name</span><span class="p">,</span>
        <span class="n">plug_name</span><span class="p">,</span>
        <span class="n">full_name</span><span class="p">,</span>
        <span class="n">job</span><span class="p">,</span>
        <span class="n">trait</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">,</span>
        <span class="n">attributes</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add plug value(s) to the database with proper metadata and</span>
<span class="sd">        inheritance.</span>

<span class="sd">        This method handles adding file-based plug values to a project</span>
<span class="sd">        database, managing inheritance of metadata tags from input files,</span>
<span class="sd">        and resolving ambiguities when multiple parent files exist.</span>

<span class="sd">        :param p_value: The plug value - either a single file path (str) or</span>
<span class="sd">                        list of file paths. Can also be special values like</span>
<span class="sd">                        &quot;&lt;undefined&gt;&quot; or Undefined.</span>
<span class="sd">        :param brick_id (str): UUID of the brick in the database.</span>
<span class="sd">        :param history_id (str): UUID of the processing history in the</span>
<span class="sd">                                 database.</span>
<span class="sd">        :param node_name (str): Name of the processing node.</span>
<span class="sd">        :param plug_name (str): Name of the specific plug/parameter.</span>
<span class="sd">        :param full_name (str): Full hierarchical name including parent</span>
<span class="sd">                                bricks. Equals node_name if no parent exists.</span>
<span class="sd">        :param job (Job): Job object containing the plug, may have</span>
<span class="sd">                          inheritance dictionaries.</span>
<span class="sd">        :param trait (Trait): Handler for the plug trait or sub-trait for list</span>
<span class="sd">                              elements. Used to validate value types (file vs</span>
<span class="sd">                              non-file).</span>
<span class="sd">        :param inputs (dict): Input parameter values for the process/node.</span>
<span class="sd">        :param attributes (dict): Completion engine attributes to be applied</span>
<span class="sd">                                  to all outputs.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Recursively processes list values by calling itself on each</span>
<span class="sd">              element</span>
<span class="sd">            - Only processes file-type traits within the project folder</span>
<span class="sd">            - Handles tag inheritance from parent files using inheritance_dict</span>
<span class="sd">              and auto_inheritance_dict from the job</span>
<span class="sd">            - May prompt user to resolve ambiguous inheritance scenarios</span>
<span class="sd">            - Automatically determines file types based on extensions</span>
<span class="sd">            - Updates both CURRENT and INITIAL database collections</span>

<span class="sd">        :raises: May raise database-related exceptions during document</span>
<span class="sd">                 operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Recursive case: list of values</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">)):</span>
            <span class="n">inner_trait</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_value</span><span class="p">):</span>
                <span class="n">distributed</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
                        <span class="c1"># Use element at index, or last element if index</span>
                        <span class="c1"># exceeds length</span>
                        <span class="n">distributed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">distributed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">add_plug_value_to_database</span><span class="p">(</span>
                    <span class="n">p_value</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
                    <span class="n">brick_id</span><span class="o">=</span><span class="n">brick_id</span><span class="p">,</span>
                    <span class="n">history_id</span><span class="o">=</span><span class="n">history_id</span><span class="p">,</span>
                    <span class="n">node_name</span><span class="o">=</span><span class="n">node_name</span><span class="p">,</span>
                    <span class="n">plug_name</span><span class="o">=</span><span class="n">plug_name</span><span class="p">,</span>
                    <span class="n">full_name</span><span class="o">=</span><span class="n">full_name</span><span class="p">,</span>
                    <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                    <span class="n">trait</span><span class="o">=</span><span class="n">inner_trait</span><span class="p">,</span>
                    <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
                    <span class="n">attributes</span><span class="o">=</span><span class="n">distributed</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">return</span>

        <span class="c1"># Skip non-file values or undefined values</span>
        <span class="n">invalid_values</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">allow_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">p_value</span> <span class="ow">in</span> <span class="n">invalid_values</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Process file path and validate it&#39;s within project</span>
        <span class="n">p_val</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">project_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p_val</span><span class="o">.</span><span class="n">is_relative_to</span><span class="p">(</span><span class="n">project_folder</span><span class="p">):</span>
            <span class="c1"># file name is outside the project folder: don&#39;t index it in the</span>
            <span class="c1"># database</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Path </span><span class="si">%s</span><span class="s2"> is outside the project folder: &quot;</span>
                <span class="s2">&quot;don&#39;t index it in the database!&quot;</span><span class="p">,</span>
                <span class="n">p_val</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Fit p_value to the database&#39;s syntax</span>
        <span class="n">processed_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_val</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">project_folder</span><span class="p">))</span>

        <span class="c1"># If the file name is already in the database,</span>
        <span class="c1"># no exception is raised, but the user is warned</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span> <span class="k">as</span> <span class="n">schema</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">schema</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="n">already_exists</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">processed_path</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">already_exists</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">%s</span><span class="s2"> already in database!&quot;</span><span class="p">,</span> <span class="n">processed_path</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">processed_path</span>
                    <span class="p">)</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
                        <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">processed_path</span>
                    <span class="p">)</span>

                <span class="c1"># Determine file type based on extension</span>
                <span class="n">name</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">processed_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">processed_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">processed_path</span>
                <span class="p">)</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">type_mapping</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;.mnc&quot;</span><span class="p">,</span> <span class="s2">&quot;.ima&quot;</span><span class="p">,</span> <span class="s2">&quot;.img&quot;</span><span class="p">):</span> <span class="n">TYPE_NII</span><span class="p">,</span>
                    <span class="p">(</span><span class="s2">&quot;.mat&quot;</span><span class="p">,):</span> <span class="n">TYPE_MAT</span><span class="p">,</span>
                    <span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">,):</span> <span class="n">TYPE_TXT</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">file_type</span> <span class="o">=</span> <span class="n">TYPE_UNKNOWN</span>

                <span class="k">for</span> <span class="n">extensions</span><span class="p">,</span> <span class="n">p_type</span> <span class="ow">in</span> <span class="n">type_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                        <span class="n">file_type</span> <span class="o">=</span> <span class="n">p_type</span>

                <span class="c1"># Determine from which value the output should inherit its</span>
                <span class="c1"># database tags. Each process may have an &quot;inheritance_dict&quot;</span>
                <span class="c1"># prepared using list_outputs() during completion, if this</span>
                <span class="c1"># method is available. If it is not present, or if the</span>
                <span class="c1"># parameter value is not found there, we can refer to the</span>
                <span class="c1"># &quot;auto_inheritance_dict,&quot; which automatically maps outputs</span>
                <span class="c1"># to inputs. If there is no ambiguity, we can proceed with</span>
                <span class="c1"># automatic processing.</span>
                <span class="c1"># Get inheritance dictionaries from job</span>
                <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">job</span><span class="p">,</span> <span class="s2">&quot;auto_inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">)</span>
                <span class="n">parent_files</span><span class="p">,</span> <span class="n">own_tags</span><span class="p">,</span> <span class="n">tags2del</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">inheritance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_value</span><span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># The inheritance_dict and auto_inheritance_dict dictionaries</span>
                <span class="c1"># can take several forms.</span>
                <span class="c1"># inheritance_dict:</span>
                <span class="c1"># Keys are output filenames (str).</span>
                <span class="c1"># Values may be:</span>
                <span class="c1"># - an input filename: get the tags from it (deprecated)</span>
                <span class="c1"># - or a dict</span>
                <span class="c1">#   {   &#39;own_tags&#39;: list of dict of additional / updated tags</span>
                <span class="c1">#       &#39;tags2del&#39;: list of tags (str) whose value will be</span>
                <span class="c1">#                   deleted</span>
                <span class="c1">#       &#39;parent&#39;: input_filename, (optional)</span>
                <span class="c1">#   }</span>
                <span class="c1"># auto_inheritance_dict:</span>
                <span class="c1"># - if there is no ambiguity :</span>
                <span class="c1">#    key: value of the output file (string)</span>
                <span class="c1">#    value: value of the input file (string)</span>
                <span class="c1"># - if ambiguous :</span>
                <span class="c1">#    key: output plug value (string)</span>
                <span class="c1">#    value: a dict: with key / value corresponding to each</span>
                <span class="c1">#                   possible input file</span>
                <span class="c1">#               =&gt; key: name of the input plug</span>
                <span class="c1">#               =&gt; value: value of the input plug</span>
                <span class="c1"># Handle different formats of inheritance_dict values</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">own_tags</span> <span class="o">=</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;own_tags&quot;</span><span class="p">)</span>
                    <span class="n">tags2del</span> <span class="o">=</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags2del&quot;</span><span class="p">)</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
                    <span class="n">parent_files</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent</span><span class="p">}</span> <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">parent_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent_files</span><span class="p">}</span>

                <span class="c1"># Fall back to auto_inheritance_dict if needed</span>
                <span class="k">if</span> <span class="n">parent_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">auto_parent</span> <span class="o">=</span> <span class="n">auto_inheritance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">parent_files</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">auto_parent</span><span class="p">}</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">auto_parent</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">auto_parent</span>
                    <span class="p">)</span>

                <span class="n">field_names</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
                <span class="n">all_cvalues</span><span class="p">,</span> <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

                <span class="c1"># get all tags values for inputs</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">parent_file</span> <span class="ow">in</span> <span class="p">(</span><span class="n">parent_files</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">parent_val</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parent_file</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rel_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_val</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">project_folder</span><span class="p">))</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># parent_file is outside the project folder</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">rel_path</span> <span class="o">==</span> <span class="n">processed_path</span><span class="p">:</span>
                        <span class="c1"># output is one of the inputs: OK nothing to be done.</span>
                        <span class="n">all_cvalues</span><span class="p">,</span> <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
                        <span class="k">break</span>

                    <span class="n">current_doc</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_keys</span><span class="o">=</span><span class="n">rel_path</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_doc</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">banished_tags</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">TAG_TYPE</span><span class="p">,</span>
                        <span class="n">TAG_BRICKS</span><span class="p">,</span>
                        <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
                        <span class="n">TAG_FILENAME</span><span class="p">,</span>
                        <span class="n">TAG_HISTORY</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">cvalues</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">field</span><span class="p">:</span> <span class="n">current_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">banished_tags</span>
                    <span class="p">}</span>
                    <span class="n">initial_doc</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                        <span class="n">primary_keys</span><span class="o">=</span><span class="n">rel_path</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">ivalues</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">field</span><span class="p">:</span> <span class="n">initial_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cvalues</span>
                    <span class="p">}</span>
                    <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">cvalues</span>
                    <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivalues</span>

                <span class="c1"># If there are several possible inputs: there is more work</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cvalues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">node_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="c1"># If all inputs have the same tags set: then pick either</span>
                    <span class="c1"># of them, they are all the same, there is no ambiguity</span>
                    <span class="n">eq</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="n">cv</span> <span class="o">==</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                        <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="n">eq</span> <span class="o">&amp;=</span> <span class="p">(</span>
                        <span class="nb">all</span><span class="p">(</span>
                            <span class="n">iv</span> <span class="o">==</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                            <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">eq</span>
                        <span class="k">else</span> <span class="kc">False</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">eq</span><span class="p">:</span>
                        <span class="c1"># all values equal, no ambiguity</span>
                        <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">items</span><span class="p">()))]</span>
                        <span class="p">}</span>
                        <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">items</span><span class="p">()))]</span>
                        <span class="p">}</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ambiguous inputs -&gt; output</span>
                        <span class="c1"># ask the user, or use previously setup answers.</span>

                        <span class="c1"># FIXME: There is a GUI dialog here, involving user</span>
                        <span class="c1">#        interaction. This should probably be avoided</span>
                        <span class="c1">#        here in a processing loop. Some pipelines,</span>
                        <span class="c1">#        especially with iterations, may ask many</span>
                        <span class="c1">#        many questions to users. These should be</span>
                        <span class="c1">#        worked on earlier.</span>

                        <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">parent_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                            <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">p_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                            <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>

                        <span class="k">elif</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">parent_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                            <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">p_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                            <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>

                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_exists</span><span class="p">:</span>
                            <span class="c1"># If there are attributes from completion, use</span>
                            <span class="c1"># them without asking.</span>
                            <span class="c1"># Using %s defers string formatting until needed.</span>
                            <span class="c1"># (better than f-string for logger)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;no attributes for: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">node_name</span><span class="p">,</span>
                                <span class="n">plug_name</span><span class="p">,</span>
                                <span class="n">full_name</span><span class="p">,</span>
                                <span class="n">p_value</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">pop_up</span> <span class="o">=</span> <span class="n">PopUpInheritanceDict</span><span class="p">(</span>
                                <span class="n">parent_files</span><span class="p">,</span>
                                <span class="n">full_name</span><span class="p">,</span>
                                <span class="n">plug_name</span><span class="p">,</span>
                                <span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span>
                                    <span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                            <span class="c1"># fmt: on</span>
                            <span class="n">pop_up</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">everything</span>

                            <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                                <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="kc">None</span>

                                <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="kc">True</span>
                                    <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">value</span>

                                <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>
                                    <span class="p">)</span>

                                <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">p_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
                                <span class="p">}</span>
                                <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
                                <span class="p">}</span>

                <span class="n">cvalues</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">TAG_TYPE</span><span class="p">:</span> <span class="n">file_type</span><span class="p">,</span>
                    <span class="n">TAG_BRICKS</span><span class="p">:</span> <span class="p">[</span><span class="n">brick_id</span><span class="p">],</span>
                    <span class="n">TAG_HISTORY</span><span class="p">:</span> <span class="n">history_id</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ivalues</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cvalues</span><span class="p">)</span>

                <span class="c1"># from here if we still have several tags sets,</span>
                <span class="c1"># we do not assign them at all. Otherwise, set them.</span>

                <span class="c1"># Adding inherited tags</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cvalues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ivalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
                    <span class="n">cvalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

                <span class="c1"># use also completion attributes values</span>
                <span class="n">cvalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">ivalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">own_tags</span><span class="p">:</span>

                    <span class="c1"># own_tags may insert new fields in the database</span>
                    <span class="k">for</span> <span class="n">tag_to_add</span> <span class="ow">in</span> <span class="n">own_tags</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">coll</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">):</span>
                            <span class="n">field_names</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                                <span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;collection_name&quot;</span><span class="p">:</span> <span class="n">coll</span><span class="p">,</span>
                                        <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="p">(</span>
                                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
                                        <span class="p">),</span>
                                        <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="p">(</span>
                                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span>
                                        <span class="p">),</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>

                        <span class="n">cvalues</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                        <span class="n">ivalues</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

                <span class="c1"># Apply changes to DB</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">processed_path</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">cvalues</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">processed_path</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">ivalues</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">tags2del</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">tag_to_del</span> <span class="ow">in</span> <span class="n">tags2del</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">coll</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">):</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">database_data</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                                    <span class="n">coll</span><span class="p">,</span> <span class="n">processed_path</span><span class="p">,</span> <span class="n">tag_to_del</span>
                                <span class="p">)</span>

                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="c1"># The collection does not exist</span>
                                <span class="c1"># or the field does not exist</span>
                                <span class="c1"># or the document does not exist</span>
                                <span class="k">pass</span></div>


<div class="viewcode-block" id="PipelineManagerTab.ask_iterated_pipeline_plugs">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.ask_iterated_pipeline_plugs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ask_iterated_pipeline_plugs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a configuration dialog for pipeline plug iteration and</span>
<span class="sd">        database connections.</span>

<span class="sd">        This method opens an interactive dialog that allows users to</span>
<span class="sd">        configure how pipeline plugs (inputs and outputs) should be handled</span>
<span class="sd">        during execution. Users can specify:</span>

<span class="sd">        - Which plugs should be iterated over during pipeline execution</span>
<span class="sd">        - Which input plugs should be connected to database filters</span>
<span class="sd">        - Interactive dependency management (database connection requires</span>
<span class="sd">          iteration)</span>

<span class="sd">        The dialog presents a grid layout with checkboxes for each available</span>
<span class="sd">        plug:</span>
<span class="sd">            - Iteration checkbox: Mark plug for iteration during execution</span>
<span class="sd">            - Database checkbox: Connect input plug to database filter</span>
<span class="sd">              (inputs only)</span>

<span class="sd">        Behavioral constraints:</span>
<span class="sd">            - Database connection automatically enables iteration</span>
<span class="sd">            - Disabling iteration automatically disables database connection</span>
<span class="sd">            - Only file-compatible plugs can connect to database filters</span>
<span class="sd">            - Certain system plugs are excluded from configuration</span>

<span class="sd">        :param pipeline: Pipeline object containing plugs to be configured</span>

<span class="sd">        :return:</span>
<span class="sd">            Optional[Tuple[List[str], List[str]]]: A tuple containing:</span>
<span class="sd">                - iterated_plugs: List of plug names marked for iteration</span>
<span class="sd">                - database_plugs: List of plug names connected to database</span>
<span class="sd">            None if the user cancels the dialog.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># System plugs that should not be configurable</span>
        <span class="n">FORBIDDEN_PLUGS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nodes_activation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selection_changed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pipeline_steps&quot;</span><span class="p">,</span>
            <span class="s2">&quot;visible_groups&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_database_compatible</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">plug</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if a pipeline plug is compatible with a database filter.</span>

<span class="sd">            This helper function verifies whether a plug can be connected to</span>
<span class="sd">            a database filter based on its trait type.</span>

<span class="sd">            :param process: The process or pipeline containing the plug.</span>
<span class="sd">            :param plug (str): The name of the plug to check.</span>

<span class="sd">            :return (bool): True if the plug is compatible with a database</span>
<span class="sd">                            filter, False otherwise.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">))</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">on_iteration_toggled</span><span class="p">(</span>
            <span class="n">param_buttons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span> <span class="n">param_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">checked</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Handle iteration checkbox toggle events.</span>

<span class="sd">            When iteration is disabled, automatically disable database</span>
<span class="sd">            connection since database connection requires iteration.</span>

<span class="sd">            :param param_buttons (list): List of parameter button</span>
<span class="sd">                                         configurations.</span>
<span class="sd">            :param param_idx (int): Index of the plug in the parameter list.</span>
<span class="sd">            :param checked (bool): The current state of the iteration</span>
<span class="sd">                                   checkbox.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">db_checkbox</span> <span class="o">=</span> <span class="n">param_buttons</span><span class="p">[</span><span class="n">param_idx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">checked</span> <span class="ow">and</span> <span class="n">db_checkbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">db_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">on_database_toggled</span><span class="p">(</span>
            <span class="n">param_buttons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span> <span class="n">param_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">checked</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Handle database checkbox toggle events.</span>

<span class="sd">            When database connection is enabled, automatically enable</span>
<span class="sd">            iteration since database connection requires iteration.</span>

<span class="sd">            Args:</span>
<span class="sd">                param_buttons (list): List of parameter button configurations.</span>
<span class="sd">                param_idx (int): Index of the plug in the parameter list.</span>
<span class="sd">                checked (bool): The current state of the database checkbox.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
                <span class="n">param_buttons</span><span class="p">[</span><span class="n">param_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">create_dialog_layout</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span><span class="n">Qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]]</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create and configure the main dialog window for pipeline</span>
<span class="sd">            configuration.</span>

<span class="sd">            This function builds a dialog with:</span>
<span class="sd">                - A scrollable parameter configuration section inside a group</span>
<span class="sd">                  box.</span>
<span class="sd">                - A grid layout for parameter input/output controls.</span>
<span class="sd">                - Standard OK/Cancel dialog buttons.</span>

<span class="sd">            :return (Tuple[Qt.QDialog, Qt.QGridLayout, List[List]]):</span>
<span class="sd">                A tuple containing:</span>
<span class="sd">                    - dialog (Qt.QDialog): The configured pipeline</span>
<span class="sd">                                           configuration dialog.</span>
<span class="sd">                    - param_grid (Qt.QGridLayout): The grid layout used to</span>
<span class="sd">                                                   arrange parameter widgets.</span>
<span class="sd">                    - param_buttons (List[List]): Two lists (inputs and</span>
<span class="sd">                                                  outputs) for storing</span>
<span class="sd">                                                  parameter-related button</span>
<span class="sd">                                                  widgets.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">dialog</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Pipeline Iteration Configuration&quot;</span><span class="p">)</span>

            <span class="c1"># Create main layout structure</span>
            <span class="n">main_layout</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>

            <span class="c1"># Parameter configuration section</span>
            <span class="n">param_group</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Iterate over parameters:&quot;</span><span class="p">)</span>
            <span class="n">param_layout</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
            <span class="n">param_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Scrollable area for parameters</span>
            <span class="n">scroll_area</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">()</span>
            <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">scroll_area</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">scroll_area</span><span class="o">.</span><span class="n">NoFrame</span><span class="p">)</span>
            <span class="n">scroll_area</span><span class="o">.</span><span class="n">setViewportMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Grid layout for parameter controls</span>
            <span class="n">grid_widget</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
            <span class="n">param_grid</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">()</span>
            <span class="n">grid_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_grid</span><span class="p">)</span>
            <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">grid_widget</span><span class="p">)</span>

            <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">scroll_area</span><span class="p">)</span>
            <span class="n">param_group</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_layout</span><span class="p">)</span>
            <span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>

            <span class="c1"># Dialog buttons</span>
            <span class="n">button_box</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="p">(</span>
                <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Cancel</span>
            <span class="p">)</span>
            <span class="n">button_box</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
            <span class="n">button_box</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
            <span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">button_box</span><span class="p">)</span>

            <span class="n">dialog</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">main_layout</span><span class="p">)</span>

            <span class="c1"># Setup grid headers</span>
            <span class="n">param_grid</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;iter. / database:&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">param_grid</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;iter.:&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">param_grid</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">param_grid</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">param_grid</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># [[], []]: param_buttons for [inputs, outputs]</span>
            <span class="k">return</span> <span class="n">dialog</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="p">[[],</span> <span class="p">[]]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add_parameter_controls</span><span class="p">(</span>
            <span class="n">grid</span><span class="p">:</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">,</span>
            <span class="n">plugs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">param_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">param_buttons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span>
            <span class="n">has_database_option</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Add iteration and optional database controls for plugs into the</span>
<span class="sd">            grid layout.</span>

<span class="sd">            This function creates checkboxes and labels for each plug,</span>
<span class="sd">            positions them in the provided grid layout, and stores references</span>
<span class="sd">            to the controls in `param_buttons` for later retrieval.</span>

<span class="sd">            :param grid (Qt.QGridLayout): The layout where parameter controls</span>
<span class="sd">                                          are added.</span>
<span class="sd">            :param plugs (list[str]): The list of plug names to create</span>
<span class="sd">                                      controls for.</span>
<span class="sd">            :param param_type (int): Indicator for the plug type:</span>
<span class="sd">                                     - 0: inputs</span>
<span class="sd">                                     - 1: outputs</span>
<span class="sd">            :param param_buttons (list[list]): A nested list that stores</span>
<span class="sd">                                               references to the created</span>
<span class="sd">                                               controls, organized by plug</span>
<span class="sd">                                               type.</span>
<span class="sd">            :param has_database_option (bool): Whether to include a database</span>
<span class="sd">                                               checkbox next to each plug.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">filtered_plugs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">plug</span> <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">plugs</span> <span class="k">if</span> <span class="n">plug</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FORBIDDEN_PLUGS</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">plug_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filtered_plugs</span><span class="p">):</span>
                <span class="c1"># Create checkboxes</span>
                <span class="n">iter_checkbox</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">()</span>
                <span class="n">iter_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Default enabled</span>
                <span class="n">db_checkbox</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">has_database_option</span><span class="p">:</span>
                    <span class="n">db_checkbox</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">()</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_database_compatible</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">):</span>
                        <span class="n">db_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Connect event handlers</span>
                <span class="n">iter_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                        <span class="n">on_iteration_toggled</span><span class="p">,</span>
                        <span class="n">param_buttons</span><span class="p">[</span><span class="n">param_type</span><span class="p">],</span>
                        <span class="n">row_idx</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">db_checkbox</span><span class="p">:</span>
                    <span class="n">db_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                            <span class="n">on_database_toggled</span><span class="p">,</span>
                            <span class="n">param_buttons</span><span class="p">[</span><span class="n">param_type</span><span class="p">],</span>
                            <span class="n">row_idx</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Position controls in grid</span>
                <span class="n">col_base</span> <span class="o">=</span> <span class="n">param_type</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="n">grid</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">iter_checkbox</span><span class="p">,</span> <span class="n">row_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col_base</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">db_checkbox</span><span class="p">:</span>
                    <span class="n">grid</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">db_checkbox</span><span class="p">,</span> <span class="n">row_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">label_col</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">4</span>
                <span class="n">grid</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">plug_name</span><span class="p">),</span> <span class="n">row_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">label_col</span><span class="p">)</span>
                <span class="c1"># Store references for later retrieval</span>
                <span class="n">param_buttons</span><span class="p">[</span><span class="n">param_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">plug_name</span><span class="p">,</span> <span class="n">iter_checkbox</span><span class="p">,</span> <span class="n">db_checkbox</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">extract_results</span><span class="p">(</span>
            <span class="n">param_buttons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extract the final plug configuration from the dialog controls.</span>

<span class="sd">            This function inspects the checkboxes stored in `param_buttons` to</span>
<span class="sd">            determine which plugs are selected for iteration and which are</span>
<span class="sd">            linked to the database option.</span>

<span class="sd">            :param param_buttons (list[list]): A nested list of plug</span>
<span class="sd">                                               configurations, where each</span>
<span class="sd">                                               entry is of the form:</span>
<span class="sd">                [plug_name (str), iter_checkbox (Qt.QCheckBox),</span>
<span class="sd">                db_checkbox (Optional[Qt.QCheckBox])].</span>

<span class="sd">            :return (tuple[list[str], list[str]]): A tuple containing:</span>
<span class="sd">                - iterated_plugs (list[str]): Names of plugs selected for</span>
<span class="sd">                                              iteration.</span>
<span class="sd">                - database_plugs (list[str]): Names of plugs with the database</span>
<span class="sd">                                              option enabled.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">all_controls</span> <span class="o">=</span> <span class="n">param_buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">param_buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">iterated_plugs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">all_controls</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
            <span class="p">]</span>

            <span class="n">database_plugs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">all_controls</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
            <span class="p">]</span>

            <span class="k">return</span> <span class="n">iterated_plugs</span><span class="p">,</span> <span class="n">database_plugs</span>

        <span class="c1"># Main execution flow</span>
        <span class="n">dialog</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">param_buttons</span> <span class="o">=</span> <span class="n">create_dialog_layout</span><span class="p">()</span>

        <span class="c1"># Get pipeline parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline missing required methods: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">add_parameter_controls</span><span class="p">(</span>
            <span class="n">param_grid</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">param_buttons</span><span class="p">,</span> <span class="n">has_database_option</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">add_parameter_controls</span><span class="p">(</span>
            <span class="n">param_grid</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">param_buttons</span><span class="p">,</span> <span class="n">has_database_option</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Set grid stretch for proper layout</span>
        <span class="n">max_param_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FORBIDDEN_PLUGS</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FORBIDDEN_PLUGS</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">max_param_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">param_grid</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="n">max_param_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Show dialog and return results</span>
        <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span> <span class="o">!=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">Accepted</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">extract_results</span><span class="p">(</span><span class="n">param_buttons</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.build_iterated_pipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.build_iterated_pipeline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_iterated_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an iteration pipeline wrapper around the current pipeline.</span>

<span class="sd">        This method creates a new pipeline that iterates over the current</span>
<span class="sd">        pipeline, allowing batch processing of multiple datasets. The</span>
<span class="sd">        process involves:</span>

<span class="sd">        1. Interactive selection of plugs to iterate over and database</span>
<span class="sd">           connections</span>
<span class="sd">        2. Preprocessing of list-type plugs with ReduceNode to handle</span>
<span class="sd">           nested lists</span>
<span class="sd">        3. Creation of an iterative pipeline using the CAPSUL engine</span>
<span class="sd">        4. Addition of Input_Filter nodes for database-connected plugs</span>
<span class="sd">        5. Proper linking of database_scans parameter across all filters</span>

<span class="sd">        The method handles both single processes and full pipelines,</span>
<span class="sd">        converting single processes into single-node pipelines when necessary.</span>

<span class="sd">        :return: Pipeline or None: The new iteration pipeline if successful,</span>
<span class="sd">                 None if aborted</span>

<span class="sd">        :raises ValueError: If Input_Filter process cannot be found in the</span>
<span class="sd">                            library.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Modifies pipeline completion settings for database plugs</span>
<span class="sd">            - Sets the editor&#39;s iterated flag to True upon successful</span>
<span class="sd">              completion</span>
<span class="sd">            - Handles context name parsing for proper iteration naming</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>

        <span class="c1"># Determine iteration and pipeline names</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">):</span>
            <span class="n">context_parts</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">iteration_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">context_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                <span class="k">else</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;Pipeline&quot;</span>

        <span class="n">pipeline_name</span> <span class="o">=</span> <span class="s2">&quot;Iteration_pipeline&quot;</span>

        <span class="c1"># Get user-selected plugs for iteration and database connection</span>
        <span class="n">iteration_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_iterated_pipeline_plugs</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iteration_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># User aborted</span>

        <span class="n">iterated_plugs</span><span class="p">,</span> <span class="n">database_plugs</span> <span class="o">=</span> <span class="n">iteration_data</span>

        <span class="c1"># Fix unconnected inner nodes if needed</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;parent_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">parent_pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">parent_pipeline</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;update_nodes_and_plugs_activation&quot;</span><span class="p">):</span>
                <span class="c1"># only if it is a pipeline - a single node does not have it</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>

        <span class="c1"># Process database plugs</span>
        <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">database_plugs</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
            <span class="n">trait</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Propagate non-completion status to linked plugs</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;pipeline_node&quot;</span><span class="p">):</span>

                <span class="c1"># (TODO: needs something better)</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">plug</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">:</span>
                    <span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_trait</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Convert single process to pipeline if necessary</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span>
                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">set_study_config</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">study_config</span><span class="p">)</span>

                <span class="c1"># Determine node name from context</span>
                <span class="n">context_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">context_parts</span> <span class="o">=</span> <span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">old_node_name</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">context_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                    <span class="k">else</span> <span class="n">context_name</span>
                <span class="p">)</span>
                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">old_node_name</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>
                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">autoexport_nodes_parameters</span><span class="p">(</span><span class="n">include_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">new_pipeline</span>
                <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">old_node_name</span>

            <span class="c1"># Add ReduceNode for list-type traits to prevent nested lists</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;un_list_</span><span class="si">{</span><span class="n">plug</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">reduce_node</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">add_custom_node</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span>
                    <span class="s2">&quot;capsul.pipeline.custom_nodes.reduce_node.ReduceNode&quot;</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;input_types&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;File&quot;</span><span class="p">]},</span>
                <span class="p">)</span>
                <span class="n">reduce_node</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Redirect existing connections through the ReduceNode</span>
                <span class="n">existing_links</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">plug</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">existing_links</span><span class="p">:</span>
                    <span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.outputs-&gt;</span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Replace pipeline plug with ReduceNode input export</span>
                <span class="n">old_traits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">remove_trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">export_parameter</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="s2">&quot;input_0&quot;</span><span class="p">,</span> <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">plug</span>
                <span class="p">)</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">reorder_traits</span><span class="p">(</span><span class="n">old_traits</span><span class="p">)</span>

        <span class="c1"># Create the iteration pipeline</span>
        <span class="n">iteration_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;iterated_</span><span class="si">{</span><span class="n">iteration_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">it_pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_iteration_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">iteration_name</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="p">,</span>
            <span class="n">iterative_plugs</span><span class="o">=</span><span class="n">iterated_plugs</span><span class="p">,</span>
            <span class="n">do_not_export</span><span class="o">=</span><span class="n">database_plugs</span><span class="p">,</span>
            <span class="n">make_optional</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add Input_Filter nodes for database-connected plugs</span>
        <span class="n">input_filter_success</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">database_plugs</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">input_filter</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes.bricks.tools.Input_Filter&quot;</span>
                <span class="p">)</span>
                <span class="n">input_filter</span><span class="o">.</span><span class="n">pipmantab</span> <span class="o">=</span> <span class="bp">self</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">input_filter_success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input filter not found in library.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># Add to pipeline and connect to iteration node</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plug</span><span class="si">}</span><span class="s2">_filter&quot;</span>
            <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">input_filter</span><span class="p">)</span>
            <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.output-&gt;</span><span class="si">{</span><span class="n">iteration_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">plug</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Handle database_scans connection - link existing</span>
            <span class="c1"># or create new parameter</span>
            <span class="k">if</span> <span class="s2">&quot;database_scans&quot;</span> <span class="ow">in</span> <span class="n">it_pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;database_scans-&gt;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.input&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_traits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it_pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">export_parameter</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">pipeline_parameter</span><span class="o">=</span><span class="s2">&quot;database_scans&quot;</span>
                <span class="p">)</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">reorder_traits</span><span class="p">([</span><span class="s2">&quot;database_scans&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">old_traits</span><span class="p">)</span>

        <span class="c1"># Set iteration flag if all filters were added successfully</span>
        <span class="k">if</span> <span class="n">input_filter_success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">iterated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">it_pipeline</span></div>


<div class="viewcode-block" id="PipelineManagerTab.check_requirements">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.check_requirements">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="s2">&quot;global&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check and return the configuration of a pipeline based on its</span>
<span class="sd">        requirements.</span>

<span class="sd">        This method iterates through the nodes in the pipeline, gathers their</span>
<span class="sd">        requirements, and determines the appropriate configuration for each</span>
<span class="sd">        node in the specified environment. It uses the settings from the study</span>
<span class="sd">        configuration engine to select configurations that match the</span>
<span class="sd">        requirements.</span>

<span class="sd">        :param environment (str): The target environment for checking</span>
<span class="sd">                                  configurations. Defaults to &quot;global&quot;.</span>

<span class="sd">        :return (dict): A dictionary mapping each pipeline node to its</span>
<span class="sd">                        selected configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">node</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">node</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
                    <span class="n">environment</span><span class="p">,</span>
                    <span class="n">uses</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">requirements</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PipelineManagerTab.cleanup_older_init">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.cleanup_older_init">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_older_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up data browser state and remove orphaned files.</span>

<span class="sd">        This method performs the following cleanup operations:</span>
<span class="sd">            1. Removes non-existent entries from the data browser for</span>
<span class="sd">               each brick</span>
<span class="sd">            2. Cleans up orphaned non-existing files from the project</span>
<span class="sd">            3. Clears the brick and node lists</span>
<span class="sd">            4. Updates the data browser table display</span>

<span class="sd">        Note:</span>
<span class="sd">        The table update is performed asynchronously using QtThreadCall</span>
<span class="sd">        to ensure UI responsiveness.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Process each brick and remove non-existent entries</span>
        <span class="k">for</span> <span class="n">brick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up brick: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">brick</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">delete_from_brick</span><span class="p">(</span><span class="n">brick</span><span class="p">)</span>

        <span class="c1"># Clean up project-level orphaned files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="c1"># Clear internal state lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Update UI asynchronously</span>
        <span class="n">QtThreadCall</span><span class="p">()</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.complete_pipeline_parameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.complete_pipeline_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">complete_pipeline_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete pipeline parameters using Capsul&#39;s completion engine.</span>

<span class="sd">        This method utilizes Capsul&#39;s completion engine to automatically</span>
<span class="sd">        populate the parameters of a pipeline based on a set of attributes.</span>
<span class="sd">        These attributes can be retrieved from an associated database. If no</span>
<span class="sd">        pipeline is specified, the current pipeline or process is used.</span>

<span class="sd">        :param pipeline (Pipeline): The pipeline object to be completed.</span>
<span class="sd">                                    If not provided, the method</span>
<span class="sd">                                    retrieves the current pipeline</span>
<span class="sd">                                    or process.</span>

<span class="sd">        Notes:</span>
<span class="sd">        The completion process relies on Capsul&#39;s ProcessCompletionEngine</span>
<span class="sd">        to automatically determine appropriate parameter values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>

        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
            <span class="n">completion</span><span class="o">.</span><span class="n">complete_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.controller_value_changed">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.controller_value_changed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">controller_value_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update history when a node or plug value changes.</span>

<span class="sd">        This method processes change signals from the pipeline editor and</span>
<span class="sd">        maintains an undo history for user actions. It handles two types</span>
<span class="sd">        of changes:</span>
<span class="sd">            - Node name updates: Updates the node name and refreshes the</span>
<span class="sd">                                 pipeline view while preserving the current</span>
<span class="sd">                                 view state.</span>
<span class="sd">            - Plug value updates: Records parameter changes while filtering</span>
<span class="sd">                                  out protected parameters, empty values, and</span>
<span class="sd">                                  system-generated changes to avoid cluttering</span>
<span class="sd">                                  the undo history.</span>

<span class="sd">        :param signal_list: A list containing change information with the</span>
<span class="sd">                            first element being the change type (&quot;node_name&quot;</span>
<span class="sd">                            or &quot;plug_value&quot;), followed by context-specific</span>
<span class="sd">                            data:</span>
<span class="sd">            - For &quot;node_name&quot;: [&quot;node_name&quot;, ProcessNode_object,</span>
<span class="sd">                                new_node_name, old_node_name]</span>
<span class="sd">            - For &quot;plug_value&quot;: [&quot;plug_value&quot;, node_name, old_value,</span>
<span class="sd">                                 plug_name, plug_type, new_value]]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">signal_list</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Constants for filtering</span>
        <span class="n">protected_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;protected_parameters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;protected_parameters_items&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selection_changed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trait_added&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user_traits_changed&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">filtered_plug_types</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">}</span>
        <span class="n">change_type</span> <span class="o">=</span> <span class="n">signal_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">change_type</span> <span class="o">==</span> <span class="s2">&quot;node_name&quot;</span><span class="p">:</span>
            <span class="c1"># Create history entry for node name change</span>
            <span class="n">history_entry</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;update_node_name&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">signal_list</span><span class="p">]</span>
            <span class="c1"># Refresh pipeline view while preserving current state</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
            <span class="c1"># Preserve current view state</span>
            <span class="n">current_rect</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">()</span>
            <span class="n">current_transform</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>
            <span class="c1"># Update pipeline and restore view state</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="n">current_rect</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">setTransform</span><span class="p">(</span><span class="n">current_transform</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">change_type</span> <span class="o">==</span> <span class="s2">&quot;plug_value&quot;</span><span class="p">:</span>

            <span class="c1"># Validate signal data length</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="p">(</span>
                <span class="n">_</span><span class="p">,</span>
                <span class="n">old_value</span><span class="p">,</span>
                <span class="n">plug_name</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>
                <span class="n">new_value</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">signal_list</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>

            <span class="c1"># Filter out changes we don&#39;t want to track</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">plug_name</span> <span class="ow">in</span> <span class="n">protected_parameters</span>
                <span class="ow">or</span> <span class="n">old_value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">old_value</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span>

            <span class="c1"># Clean signal data by filtering out unwanted plug types</span>
            <span class="n">cleaned_signal_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">filtered_plug_types</span>
                    <span class="k">else</span> <span class="n">element</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">signal_list</span>
            <span class="p">]</span>

            <span class="n">history_entry</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;update_plug_value&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cleaned_signal_list</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown change type, skip processing</span>
            <span class="k">return</span>

        <span class="c1"># Add entry to undo history</span>
        <span class="n">current_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span><span class="n">current_editor</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_entry</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.displayNodeParameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.displayNodeParameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">displayNodeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the node controller interface for the specified node.</span>

<span class="sd">        This method configures and shows the node parameter interface when</span>
<span class="sd">        a user clicks on a node in the pipeline editor. It updates the scroll</span>
<span class="sd">        area widget to display the node controller with the current pipeline</span>
<span class="sd">        context.</span>

<span class="sd">        :param node_name: The name/identifier of the selected node.</span>
<span class="sd">        :param process: The process instance associated with the selected</span>
<span class="sd">                        node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">display_parameters</span><span class="p">(</span>
            <span class="n">node_name</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">current_pipeline</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.finish_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.finish_execution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">finish_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle pipeline execution completion and update UI state.</span>

<span class="sd">        This callback is invoked after a pipeline execution completes,</span>
<span class="sd">        whether successfully or with errors. The method performs comprehensive</span>
<span class="sd">        cleanup and user feedback operations:</span>

<span class="sd">        - Disables pipeline control actions during cleanup</span>
<span class="sd">        - Disconnects progress worker signals to prevent memory leaks</span>
<span class="sd">        - Checks execution status and handles</span>
<span class="sd">          WorkflowExecutionError/RuntimeError</span>
<span class="sd">        - Updates status bar with clear success/failure messages</span>
<span class="sd">        - Sets appropriate visual status icon (green checkmark or red cross)</span>
<span class="sd">        - Cleans up progress indicators and re-enables pipeline actions</span>
<span class="sd">        - Updates node controller parameters for next execution</span>

<span class="sd">        The method ensures proper cleanup regardless of execution outcome and</span>
<span class="sd">        provides comprehensive user feedback through status messages and</span>
<span class="sd">        visual indicators.</span>

<span class="sd">        :raises:</span>
<span class="sd">            WorkflowExecutionError: When pipeline execution fails</span>
<span class="sd">            RuntimeError: When execution is aborted before running</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">soma_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">swconstants</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">status</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish_execution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="c1"># Check execution status and handle errors</span>
        <span class="n">execution_successful</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_run_pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span>

            <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Execution aborted before running&quot;</span><span class="p">)</span>

            <span class="n">engine</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">WorkflowExecutionError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">execution_successful</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="n">error_message</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Pipeline execution failed with exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">error_message</span>
            <span class="p">)</span>

        <span class="c1"># Update status bar with clear messaging</span>
        <span class="n">pipeline_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span>
        <span class="n">status_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">execution_successful</span><span class="p">:</span>
            <span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">&#39; pipeline completed successfully!&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">&#39; pipeline execution failed!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Set appropriate status icon</span>
        <span class="n">icon_filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;green_v.png&quot;</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_DONE</span>
            <span class="k">else</span> <span class="s2">&quot;red_cross32.png&quot;</span>
        <span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">())</span>
        <span class="n">icon_path</span> <span class="o">=</span> <span class="n">sources_images_dir</span> <span class="o">/</span> <span class="n">icon_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QIcon</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">icon_path</span><span class="p">)))</span>
        <span class="c1"># Cleanup progress indicators and re-enable actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span>
        <span class="n">Qt</span><span class="o">.</span><span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_progress</span><span class="p">)</span>
        <span class="c1"># Re-enable pipeline actions for next execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.garbage_collect">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.garbage_collect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">garbage_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up obsolete data and maintain database consistency.</span>

<span class="sd">        This method performs comprehensive cleanup operations including:</span>
<span class="sd">            - Processing finished pipeline executions with error protection</span>
<span class="sd">            - Removing orphaned files and historical data entries</span>
<span class="sd">            - Refreshing the data browser table display</span>
<span class="sd">            - Resetting pipeline editor initialization state if applicable</span>
<span class="sd">            - Updating UI button states to reflect current system status</span>

<span class="sd">        The cleanup operations ensure the application remains performant</span>
<span class="sd">        and maintains data integrity across user sessions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Process pipeline execution with logger protection</span>
        <span class="k">with</span> <span class="n">protected_logging</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postprocess_pipeline_execution</span><span class="p">()</span>

        <span class="c1"># Clean up orphaned project data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_history</span><span class="p">()</span>
        <span class="c1"># Refresh UI components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span><span class="p">()</span>
        <span class="n">current_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">current_editor</span><span class="p">,</span> <span class="s2">&quot;initialized&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">current_editor</span><span class="o">.</span><span class="n">initialized</span>
        <span class="p">):</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_user_buttons_states</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.get_capsul_engine">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_capsul_engine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_capsul_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve and configure a Capsul engine from the pipeline editor.</span>

<span class="sd">        This method obtains a CapsulEngine object from the current</span>
<span class="sd">        pipeline editor tabs and configures it using the Mia configuration</span>
<span class="sd">        settings.</span>

<span class="sd">        :return (CapsulEngine): A configured Capsul engine instance ready for</span>
<span class="sd">                                pipeline execution, with settings applied from</span>
<span class="sd">                                the Mia config object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.get_pipeline_or_process">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_pipeline_or_process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pipeline_or_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the pipeline or its single unconnected process node.</span>

<span class="sd">        When a pipeline contains only one process node with no connections,</span>
<span class="sd">        this method returns the process directly instead of the pipeline</span>
<span class="sd">        wrapper. This simplifies GUI workflows where single processes can</span>
<span class="sd">        act as pipelines.</span>

<span class="sd">        :param pipeline (Pipeline): Optional pipeline to evaluate. If None,</span>
<span class="sd">                                    uses the currently selected pipeline from</span>
<span class="sd">                                    the editor GUI.</span>

<span class="sd">        :return (Pipeline | Process): The process node if pipeline contains a</span>
<span class="sd">                                      single unconnected process, otherwise</span>
<span class="sd">                                      the pipeline itself.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">current_editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="c1"># Check if pipeline has only root node + one process node with no</span>
        <span class="c1"># connections</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Find and return the process node (skip empty names)</span>
            <span class="n">process_nodes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">node</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">process_nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">process_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">process</span>

        <span class="k">return</span> <span class="n">pipeline</span></div>


<div class="viewcode-block" id="PipelineManagerTab.get_missing_mandatory_parameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_missing_mandatory_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_missing_mandatory_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find missing mandatory parameters across all pipeline nodes.</span>

<span class="sd">        Checks each node in the pipeline for missing mandatory parameters,</span>
<span class="sd">        accounting for workflow job parameter overrides and temporary values.</span>

<span class="sd">        :return (list[str]): Parameter names that are missing, formatted as</span>
<span class="sd">                             either &#39;parameter_name&#39; for pipeline root or</span>
<span class="sd">                             &#39;node.parameter_name&#39; for other nodes.</span>

<span class="sd">        Note:</span>
<span class="sd">            Parameters with non-null values in the workflow job dictionary</span>
<span class="sd">            are not considered missing, even if undefined at the node level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_mandatory_param</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
            <span class="c1"># Extract display name, handling Pipeline prefix</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="c1"># Find workflow job for this node (cached per node)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get_missing_mandatory_parameters</span><span class="p">():</span>

                <span class="c1"># Lazy load job only when needed</span>
                <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">matching_jobs</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">j</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">process</span><span class="p">()</span> <span class="ow">is</span> <span class="n">node</span>
                    <span class="p">]</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">matching_jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">matching_jobs</span> <span class="k">else</span> <span class="kc">False</span>

                <span class="c1"># Skip parameters with values in workflow</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="c1"># gets a non-null value in the workflow</span>
                        <span class="k">continue</span>

                <span class="c1"># Format parameter name based on node type</span>
                <span class="n">current_pipeline</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="n">current_pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="p">:</span>
                    <span class="n">param_name</span> <span class="o">=</span> <span class="n">param</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">missing_mandatory_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">missing_mandatory_param</span></div>


<div class="viewcode-block" id="PipelineManagerTab.initialize">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the pipeline after cleaning up any previous initialization.</span>

<span class="sd">        This method performs the following operations:</span>
<span class="sd">            1. Sets a wait cursor to indicate processing</span>
<span class="sd">            2. Cleans up any previous initialization if needed</span>
<span class="sd">            3. Resets internal state variables</span>
<span class="sd">            4. Attempts to initialize the pipeline</span>
<span class="sd">            5. Updates the UI with the results</span>
<span class="sd">            6. Restores the normal cursor</span>

<span class="sd">        The method handles initialization errors gracefully by logging</span>
<span class="sd">        warnings and updating the status bar with error messages.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Modifies cursor appearance during execution</span>
<span class="sd">            - Updates pipeline editor tabs and node parameters</span>
<span class="sd">            - May display error messages in the status bar</span>
<span class="sd">            - Sets self.init_clicked to True upon completion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">setOverrideCursor</span><span class="p">(</span><span class="n">QCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WaitCursor</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Clean up previous initialization if this isn&#39;t the first run</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_older_init</span><span class="p">()</span>

            <span class="c1"># Reset internal state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Attempt pipeline initialization</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_pipeline</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Get pipeline name for error reporting</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
                <span class="n">pipeline_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_name</span><span class="p">:</span>
                    <span class="c1"># Fallback: get first non-empty node name</span>
                    <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
                    <span class="n">non_empty_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">name</span><span class="p">]</span>
                    <span class="c1"># TODO: This is suboptimal if multiple nodes exist!</span>
                    <span class="c1">#       Ex. a pipeline with two nodes: A and B consructed</span>
                    <span class="c1">#       just before to launch init_pipeline: in this case</span>
                    <span class="c1">#       we will always get A as pipeline name...</span>
                    <span class="n">pipeline_name</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">non_empty_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_empty_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="k">else</span> <span class="s2">&quot;Unknown&quot;</span>
                    <span class="p">)</span>

                <span class="n">pipeline_name</span> <span class="o">=</span> <span class="n">pipeline_name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error during initialization of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;the &#39;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">&#39; pipeline&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Pipeline &quot;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s1">&quot; was &#39;</span>
                    <span class="sa">f</span><span class="s2">&quot;not initialized successfully.&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

            <span class="c1"># Update UI state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_current_node</span><span class="p">()</span>
            <span class="c1"># Deep copy node parameters from temporary storage</span>
            <span class="n">current_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">node_parameters</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                <span class="n">current_editor</span><span class="o">.</span><span class="n">node_parameters_tmp</span>
            <span class="p">)</span>
            <span class="c1"># Update UI state again after parameter</span>
            <span class="c1"># changes (TODO: not sure if needed)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_current_node</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always restore cursor and set init_clicked, even if an</span>
            <span class="c1"># exception occurs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">app</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.init_pipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.init_pipeline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the current pipeline in the pipeline editor.</span>

<span class="sd">        This method:</span>
<span class="sd">            - Retrieves and configures the pipeline or sub-pipeline.</span>
<span class="sd">            - Generates and validates the workflow.</span>
<span class="sd">            - Checks requirements (FSL, AFNI, ANTS, Matlab, MRtrix, SPM).</span>
<span class="sd">            - Verifies that mandatory inputs/outputs are properly set.</span>
<span class="sd">            - Records initialization results in the project database.</span>
<span class="sd">            - Updates the status bar and displays warnings when needed.</span>

<span class="sd">        :param pipeline (Pipeline, Process): The pipeline or process instance</span>
<span class="sd">                                             to initialize. If None, the main</span>
<span class="sd">                                             pipeline is retrieved.</span>
<span class="sd">        :param pipeline_name (str): The name of the parent pipeline, if</span>
<span class="sd">                                    applicable.</span>

<span class="sd">        :return (bool): True if the pipeline was successfully initialized,</span>
<span class="sd">                        False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_duration</span><span class="p">(</span><span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the elapsed time since `t0`, rounded to the nearest</span>
<span class="sd">            significant digit of the fractional part of the duration.</span>

<span class="sd">            :param t0 (float): The starting time.</span>

<span class="sd">            :return (float): The elapsed duration since `t0`, rounded to the</span>
<span class="sd">                             nearest significant digit.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

                <span class="k">return</span> <span class="nb">round</span><span class="p">(</span>
                    <span class="n">duration</span><span class="p">,</span>
                    <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">modf</span><span class="p">(</span><span class="n">duration</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))))</span>
                    <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_node_name</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extracts a node&#39;s name, preferring ``context_name`` if available.</span>

<span class="sd">            If the node has a ``context_name`` attribute, it will be used;</span>
<span class="sd">            otherwise, the node&#39;s ``name`` attribute is used. If the resulting</span>
<span class="sd">            name starts with ``&quot;Pipeline.&quot;``, the prefix is stripped.</span>

<span class="sd">            :param node: The node object, expected to have at least a</span>
<span class="sd">                         ``name`` attribute, and optionally a ``context_name``</span>
<span class="sd">                         attribute.</span>
<span class="sd">            :return (str): The extracted node name with any leading</span>
<span class="sd">                           ``&quot;Pipeline.&quot;`` prefix removed.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="k">return</span> <span class="n">node_name</span>

        <span class="c1"># TODO: It seems pipeline and pipeline_name are always</span>
        <span class="c1">#       None and &quot;&quot;,respectively</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Pipeline initializing&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  *********************&quot;</span><span class="p">)</span>
        <span class="c1"># Initialize timing and state</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">init_result</span><span class="p">,</span> <span class="n">init_messages</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="c1"># Retrieve main pipeline if not provided</span>
        <span class="c1"># TODO: main_pipeline is always True (see TODO above)</span>
        <span class="n">main_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="ow">or</span> <span class="n">get_process_instance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Determine pipeline name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Process</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span>
        <span class="p">):</span>
            <span class="c1"># Special case: single brick</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_1&quot;</span>
            <span class="c1"># FIXME: launching a brick without exporting all plugs could have</span>
            <span class="c1">#        side effects?</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Special case: default pipeline with exactly 2 nodes</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">k</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

        <span class="c1"># Show status message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline is getting initialized. Please wait...&quot;</span>
        <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="c1"># complete config for completion</span>
        <span class="n">study_config</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
        <span class="n">study_config</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">init_messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Generate workflow from pipeline</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Workflow generation / completion for the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline...&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow_from_pipeline</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">check_requirements</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">complete_parameters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Workflow done!&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">traceback_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">))</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error when building the workflow for the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;pipeline:</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Fail if workflow is invalid</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">,</span> <span class="s2">&quot;jobs&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">init_result</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline was not successfully initialised...&quot;</span>
            <span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">_calculate_duration</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialisation phase completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">s!&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Pipeline initialization warning!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="s2">&quot;No bricks were detected when the workflow was &quot;</span>
                <span class="s2">&quot;generated...!</span><span class="se">\n</span><span class="s2">Please check that the pipeline has &quot;</span>
                <span class="s2">&quot;been correctly built and configured (have all the necessary &quot;</span>
                <span class="s2">&quot;plugs been exported? have all the input parameters been &quot;</span>
                <span class="s2">&quot;set?, etc.)&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span><span class="p">)</span>
            <span class="n">yes_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
                <span class="s2">&quot;Open MIA preferences&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesRole</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">yes_button</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">software_preferences_pop_up</span><span class="p">()</span>
                <span class="c1"># fmt: off</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">pop_up_preferences</span><span class="o">.</span>
                    <span class="n">tab_widget</span><span class="o">.</span><span class="n">setCurrentIndex</span>
                <span class="p">)(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># fmt: on</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline was not initialised successfully...&quot;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">err_mess</span> <span class="ow">in</span> <span class="n">init_messages</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err_mess</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># retrieve node list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_node_list</span><span class="p">(</span><span class="n">brick</span><span class="o">=</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="c1"># check missing mandatory parameters</span>
            <span class="n">missing_mandat_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_mandatory_parameters</span><span class="p">()</span>
            <span class="c1"># check requirements</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_requirements</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing_mandat_param</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">missing_mandat_param</span><span class="p">:</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_mandat_param</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing mandatory parameters in &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline:</span><span class="se">\n</span><span class="s2">    - &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">check_requirements</span><span class="p">(</span><span class="n">message_list</span><span class="o">=</span><span class="p">[])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pipeline requirements are not met:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current configuration:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">study_config</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">export_config_dict</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">req_messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Please see the standard output for more information.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># FIXME: Would it be better to write a general method for</span>
            <span class="c1">#        testing all modules (currently each module test is</span>
            <span class="c1">#        hard coded below)?</span>
            <span class="c1"># FIXME: Are these tests compatible with remote run?</span>
            <span class="c1"># FIXME: Make a requirement check for FreeSurfer:</span>
            <span class="n">req_messages</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">req_node</span><span class="p">,</span> <span class="n">reqs</span> <span class="ow">in</span> <span class="n">requirements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">_get_node_name</span><span class="p">(</span><span class="n">req_node</span><span class="p">)</span>

                <span class="c1"># Safely get the &quot;uses&quot; dictionary</span>
                <span class="n">uses</span> <span class="o">=</span> <span class="n">reqs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uses&quot;</span><span class="p">,</span> <span class="p">{})</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">uses</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># Skip if no &quot;uses&quot; section</span>

                <span class="c1"># TODO: # --- FreeSurfer ---</span>

                <span class="c1"># --- AFNI ---</span>
                <span class="k">if</span> <span class="n">uses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.afni&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reqs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.afni&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="p">):</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires AFNI but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems AFNI is not configured in &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Mia preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># --- ANTS ---</span>
                <span class="k">if</span> <span class="n">uses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.ants&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reqs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.ants&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="p">):</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires ANTS but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems ANTS is not configured in &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Mia preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># --- FSL ---</span>
                <span class="k">if</span> <span class="n">uses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.fsl&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reqs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.fsl&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="p">):</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires FSL but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems FSL is not configured in Mia preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># --- MRtrix ---</span>
                <span class="k">if</span> <span class="n">uses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.mrtrix&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reqs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.mrtrix&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="p">):</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires MRtrix but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems MRtrix is not configured in &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Mia preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># --- Matlab ---</span>
                <span class="k">if</span> <span class="n">uses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.matlab&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">matlab_config</span> <span class="o">=</span> <span class="n">reqs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.matlab&quot;</span><span class="p">,</span> <span class="p">{})</span>

                    <span class="k">if</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_spm</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">matlab_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;executable&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="p">):</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires Matlab but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems Matlab is not configured in &quot;</span>
                            <span class="s2">&quot;Mia preferences.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_spm_standalone</span><span class="p">()</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">matlab_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mcr_directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires Matlab MCR but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems Matlab MCR is not configured in &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Mia preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># --- SPM ---</span>
                <span class="k">if</span> <span class="n">uses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.spm&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.spm&quot;</span> <span class="ow">in</span> <span class="n">reqs</span><span class="p">:</span>
                        <span class="n">spm_config</span> <span class="o">=</span> <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;capsul.engine.module.spm&quot;</span><span class="p">]</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">spm_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires SPM but it &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;seems SPM is not configured in &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;Mia preferences.&quot;</span>
                            <span class="p">)</span>

                        <span class="k">elif</span> <span class="n">spm_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;standalone&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_matlab_standalone</span><span class="p">():</span>
                                <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires SPM but &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;it seems that in Mia preferences, SPM &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;has been configured as standalone &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;while Matlab MCR is not configured.&quot;</span>
                                <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Check for matlab executable using .get()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">reqs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;capsul.engine.module.matlab&quot;</span><span class="p">,</span> <span class="p">{}</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires SPM but it &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;seems that in Mia preferences, SPM has &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;been configured as non-standalone while &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;Matlab with license is not configured.&quot;</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> requires SPM but it seems &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;SPM is not configured in Mia preferences.&quot;</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="n">req_messages</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_messages</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The pipeline requirements are not met for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;pipeline:</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="c1"># Check that completion for output parameters is fine (for each job)</span>
        <span class="n">missing_mandat_out_param</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missing_all_out_param</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
                    <span class="n">node_name</span> <span class="o">=</span> <span class="n">_get_node_name</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="c1"># All output plugs (except spm_script_file),</span>
                    <span class="c1"># optional or not:</span>
                    <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">trait_name</span>
                        <span class="k">for</span> <span class="n">trait_name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">trait_name</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;spm_script_file&quot;</span><span class="p">,</span> <span class="s2">&quot;_spm_script_file&quot;</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="c1"># If none of the outputs have a value, there is a problem.</span>
                    <span class="c1"># Checked only for ProcessMIA bricks because it seems that</span>
                    <span class="c1"># for some nipype processes the output parameters are only</span>
                    <span class="c1"># generated at runtime (for example:</span>
                    <span class="c1"># nipype.interfaces.utility.base.Rename).</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">output_name</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span>
                        <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">output_names</span>
                    <span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessMIA</span><span class="p">):</span>
                        <span class="n">missing_all_out_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>

                    <span class="c1"># All output plugs (except spm_script_file), not optional</span>
                    <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">trait_name</span>
                        <span class="k">for</span> <span class="n">trait_name</span> <span class="ow">in</span> <span class="n">output_names</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span>
                    <span class="p">]</span>

                    <span class="c1"># If a non-optional output has no value, there&#39;s issue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="n">output_name</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span>
                        <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">output_names</span>
                    <span class="p">):</span>
                        <span class="n">missing_mandat_out_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;init_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;An issue has been detected when initializing &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;the &#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&#39; brick in the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;pipeline.</span><span class="se">\n</span><span class="s2">The pipeline cannot be launched &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;under these conditions...</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_mandat_out_param</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_mandat_out_param</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing mandatory output parameter(s) for the following &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;brick(s) in the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline:</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_all_out_param</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_all_out_param</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;None of the output parameters have been completed for the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;following brick(s) in the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline.</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please check the configuration and input parameters for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;these bricks...&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init_result</span><span class="p">:</span>
            <span class="c1"># --- Save pipeline to history and database ---</span>
            <span class="n">history_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_HISTORY</span><span class="p">,</span> <span class="n">history_id</span><span class="p">)</span>
                <span class="c1"># serialize pipeline</span>
                <span class="n">target_pipeline</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">next</span><span class="p">(</span>
                        <span class="n">proc</span><span class="o">.</span><span class="n">process</span>
                        <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">list_process_in_pipeline</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">ProcessIteration</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Iteration_pipeline&quot;</span>
                    <span class="k">else</span> <span class="n">pipeline</span>
                <span class="p">)</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                <span class="n">pipeline_tools</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span>
                    <span class="n">target_pipeline</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span>
                <span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">history_id</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">HISTORY_PIPELINE</span><span class="p">:</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()},</span>
                <span class="p">)</span>

            <span class="c1"># add process characteristics in the database</span>
            <span class="c1"># if init is otherwise OK</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span>
            <span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
                <span class="n">process</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">process</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">node_name</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">context_name</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">node_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Pipeline.&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">node_name</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_auto_inheritance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_inheritance</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

                <span class="c1"># Skip pipeline nodes</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">PipelineNode</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)):</span>
                    <span class="k">continue</span>

                <span class="c1"># Generate brick ID</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">brick_id</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">brick_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

                <span class="c1"># set brick_id in process</span>
                <span class="n">job</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">brick_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">brick_id</span><span class="p">)</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span> <span class="n">brick_id</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># ID is not unique. It happens in iterations</span>
                        <span class="c1"># FIXME: we need a better way to handle UUIDs in</span>
                        <span class="c1">#        iterated processes</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error while setting job uuid on &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&#39; brick.&quot;</span>
                        <span class="p">)</span>

                    <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="n">brick_id</span><span class="p">,</span>
                        <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span>
                            <span class="n">BRICK_NAME</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
                            <span class="n">BRICK_INIT_TIME</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
                            <span class="n">BRICK_INIT</span><span class="p">:</span> <span class="s2">&quot;Not Done&quot;</span><span class="p">,</span>
                            <span class="n">BRICK_EXEC</span><span class="p">:</span> <span class="s2">&quot;Not Done&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_register_node_io_in_database</span><span class="p">(</span>
                    <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="p">,</span> <span class="n">history_id</span>
                <span class="p">)</span>

            <span class="c1"># Save brick list to history</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">history_id</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">HISTORY_BRICKS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="p">},</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_completion_attributes</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">saveModifications</span><span class="p">()</span>

        <span class="c1"># Updating the node controller</span>
        <span class="c1"># Display the updated parameters in right part of</span>
        <span class="c1"># the Pipeline Manager (controller)</span>
        <span class="k">if</span> <span class="n">main_pipeline</span><span class="p">:</span>
            <span class="c1"># TODO: Fix the problem of the controller that</span>
            <span class="c1">#       keeps the name of the old brick deleted until</span>
            <span class="c1">#       a click on the new one. This can cause a Mia</span>
            <span class="c1">#       crash during the initialisation, for example.</span>
            <span class="n">node_controller_node_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">node_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">node_name</span>
            <span class="p">)</span>
            <span class="c1"># Determine process for controller</span>
            <span class="n">process</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_controller_node_name</span><span class="p">]</span><span class="o">.</span><span class="n">process</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">node_controller_node_name</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span>
                <span class="p">)</span>
                <span class="k">else</span> <span class="n">pipeline</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">display_parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">node_name</span><span class="p">,</span>
                <span class="n">process</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">init_result</span><span class="p">:</span>

                <span class="c1"># Format error message more elegantly</span>
                <span class="k">if</span> <span class="n">init_messages</span><span class="p">:</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">init_messages</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The pipeline could not be initialized properly:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">details</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The pipeline could not be initialized correctly, &quot;</span>
                        <span class="s2">&quot;for an unknown reason!&quot;</span>
                    <span class="p">)</span>

                <span class="n">lineCnt</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Pipeline initialization warning!&quot;</span><span class="p">)</span>

                <span class="c1"># Setup message display based on length</span>
                <span class="k">if</span> <span class="n">lineCnt</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">scroll</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">()</span>
                    <span class="n">scroll</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
                    <span class="n">scroll</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">label</span><span class="o">.</span><span class="n">setTextInteractionFlags</span><span class="p">(</span>
                        <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextSelectableByMouse</span>
                    <span class="p">)</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span>
                        <span class="n">scroll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
                        <span class="s2">&quot;QScrollArea{min-width:550 px; min-height: 300px}&quot;</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span><span class="p">)</span>

                <span class="n">yes_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
                    <span class="s2">&quot;Open MIA preferences&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesRole</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">yes_button</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">software_preferences_pop_up</span><span class="p">()</span>
                    <span class="c1"># fmt: off</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">pop_up_preferences</span><span class="o">.</span>
                        <span class="n">tab_widget</span><span class="o">.</span><span class="n">setCurrentIndex</span>
                    <span class="p">)(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># fmt: on</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline was not initialised successfully.&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&quot;</span><span class="si">%s</span><span class="s1">&quot; pipeline was not successfully initialised.&#39;</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">_calculate_duration</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Success case - update editors</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_editor_by_index</span><span class="p">(</span>
                        <span class="n">i</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline has been successfully initialised.&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&quot;</span><span class="si">%s</span><span class="s1">&quot; pipeline has been successfully initialised.&#39;</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">_calculate_duration</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">_calculate_duration</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
            <span class="c1"># FIXME: I don&#39;t understand when main_pipeline can be False.</span>
            <span class="c1">#        So in this case, we are instancing the duration here.</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialisation phase completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">s!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">init_result</span></div>


<div class="viewcode-block" id="PipelineManagerTab.layout_view">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.layout_view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">layout_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the layout and toolbar for the pipeline manager tab.</span>

<span class="sd">        This method sets up the main diagram editor window, configures the</span>
<span class="sd">        scroll area, builds the toolbar with pipeline actions, and arranges</span>
<span class="sd">        widgets in splitters and layouts for the pipeline editor interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Window setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Diagram editor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="p">)</span>
        <span class="c1"># Toolbar setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addActions</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_mode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Pipeline&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setPopupMode</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QToolButton</span><span class="o">.</span><span class="n">MenuButtonPopup</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addActions</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Fixed</span>
        <span class="p">)</span>
        <span class="c1"># Layouts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.loadParameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.loadParameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loadParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load pipeline parameters into the current pipeline of the editor.</span>

<span class="sd">        This method refreshes the pipeline editor by loading the stored</span>
<span class="sd">        parameters and then updates the node controller accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">load_pipeline_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.loadPipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.loadPipeline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loadPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a pipeline into the pipeline editor.</span>

<span class="sd">        This method initializes the pipeline editor with the selected</span>
<span class="sd">        pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">load_pipeline</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.postprocess_pipeline_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.postprocess_pipeline_execution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">postprocess_pipeline_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Operations to be performed after a run has been completed.</span>

<span class="sd">        It can be called either within the run procedure (the user clicks on</span>
<span class="sd">        the &quot;run&quot; button and waits for the results), or after a disconnetion /</span>
<span class="sd">        reconnection of the client app: the user clicks on &quot;run&quot; with</span>
<span class="sd">        distributed/remote execution activated, then closes the client Mia.</span>
<span class="sd">        Processing takes place (possibly remotely) within a soma-workflow</span>
<span class="sd">        server. Then the user runs Mia again, and we have to collect the</span>
<span class="sd">        outputs of runs which happened (finished) while we were disconnected.</span>

<span class="sd">        Such post-processing includes database indexing of output data, and</span>
<span class="sd">        should take into account not only the current pipeline, but all past</span>
<span class="sd">        runs which have not been postprocessed yet.</span>

<span class="sd">        When called with a pipeline argument, it only deals with this one.</span>

<span class="sd">        The method can be called from within a worker run thread, thus has to</span>
<span class="sd">        be thread-safe.</span>

<span class="sd">        :param pipeline (Pipeline): The pipeline to postprocess. If not</span>
<span class="sd">                                    provided, the method will use</span>
<span class="sd">                                    `self.last_run_pipeline` or fetch the</span>
<span class="sd">                                    currently selected pipeline from the</span>
<span class="sd">                                    pipeline editor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO:</span>
        <span class="c1"># Question 1: do we have to postprocess failed runs (pipelines which</span>
        <span class="c1"># started and failed) ? Probably yes because they may have produced</span>
        <span class="c1"># some results during the first steps, and failed later.</span>

        <span class="c1"># Question 2: how to decide which pipelines / runs have to be</span>
        <span class="c1"># posptocessed now ? A pipeline may be started, then stopped or could</span>
        <span class="c1"># have failed, then be postprocessed. But the user can still restart</span>
        <span class="c1"># them in soma-workflow (or maybe Mia one day), thus they should be</span>
        <span class="c1"># postprocessed again then.</span>

        <span class="c1"># Resolve the pipeline if not provided</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;last_run_pipeline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>

        <span class="n">bricks_to_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">finished_bricks</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">(),</span> <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bricks&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Update brick execution statuses in the database</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="c1"># set state of bricks: done + exec date</span>
            <span class="k">for</span> <span class="n">brick_id</span><span class="p">,</span> <span class="n">brick</span> <span class="ow">in</span> <span class="n">bricks_to_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">swf_status</span> <span class="o">=</span> <span class="n">brick</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;swf_status&quot;</span><span class="p">)</span>
                <span class="n">exec_date</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">swf_status</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">swf_status</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Setting execution status for brick </span><span class="si">{</span><span class="n">brick_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(executed at: </span><span class="si">{</span><span class="n">exec_date</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">brick_id</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">BRICK_EXEC</span><span class="p">:</span> <span class="s2">&quot;Done&quot;</span><span class="p">,</span>
                        <span class="n">BRICK_EXEC_TIME</span><span class="p">:</span> <span class="n">exec_date</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

        <span class="c1"># Clean up orphaned data and refresh the UI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_history</span><span class="p">()</span>
        <span class="n">QtThreadCall</span><span class="p">()</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">saveModifications</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.redo">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.redo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">redo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redo the last undone action on the current pipeline editor</span>

<span class="sd">        Supported redoable actions:</span>
<span class="sd">            - add_process</span>
<span class="sd">            - delete_process</span>
<span class="sd">            - export_plug</span>
<span class="sd">            - export_plugs</span>
<span class="sd">            - remove_plug</span>
<span class="sd">            - update_node_name</span>
<span class="sd">            - update_plug_value</span>
<span class="sd">            - add_link</span>
<span class="sd">            - delete_link</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="n">redos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">redos</span><span class="p">[</span><span class="n">editor</span><span class="p">]</span>

        <span class="c1"># We can redo if we have an action to redo!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">redos</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">action</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">redos</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_process&quot;</span><span class="p">:</span>
            <span class="n">node_name</span><span class="p">,</span> <span class="n">class_process</span><span class="p">,</span> <span class="n">links</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">add_named_process</span><span class="p">(</span>
                <span class="n">class_process</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_process&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">node_name</span><span class="p">,)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">del_node</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;export_plugs&quot;</span><span class="p">:</span>
            <span class="n">plug_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">_remove_plug</span><span class="p">(</span>
                <span class="n">plug_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">),</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove_plug&quot;</span><span class="p">:</span>
            <span class="n">plug_infos</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">multi_export</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plug_infos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="n">pip_plug_names</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">pip_plug</span><span class="p">,</span> <span class="n">node_plug</span><span class="p">,</span> <span class="n">optional</span> <span class="ow">in</span> <span class="n">plug_infos</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">multi_export</span><span class="p">:</span>
                    <span class="n">pip_plug_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pip_plug</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">editor</span><span class="o">.</span><span class="n">_export_plug</span><span class="p">(</span>
                    <span class="n">temp_plug_name</span><span class="o">=</span><span class="n">node_plug</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">weak_link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span>
                    <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">pip_plug</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">multi_export</span><span class="o">=</span><span class="n">multi_export</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Reconnect original plugs</span>
                <span class="k">if</span> <span class="n">pip_plug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                    <span class="n">source</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pip_plug</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">node_plug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">source</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">node_plug</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pip_plug</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update_pipeline</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">multi_export</span><span class="p">:</span>
                <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;export_plugs&quot;</span><span class="p">,</span> <span class="n">pip_plug_names</span><span class="p">,</span> <span class="n">node_plug</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">editor</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_node_name&quot;</span><span class="p">:</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">old_name</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">update_node_name</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_plug_value&quot;</span><span class="p">:</span>
            <span class="n">node_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">update_plug_value</span><span class="p">(</span>
                <span class="n">node_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_link&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">link</span><span class="p">,)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">_del_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_link&quot;</span><span class="p">:</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.register_completion_attributes">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.register_completion_attributes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_completion_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register completion attributes for a given pipeline in the</span>
<span class="sd">        project database.</span>

<span class="sd">        This method retrieves attribute values from the pipeline&#39;s completion</span>
<span class="sd">        engine and records them in the project database. Only attributes</span>
<span class="sd">        corresponding to existing fields (tags) in the database schema are</span>
<span class="sd">        stored. For each pipeline parameter that resolves to a file path</span>
<span class="sd">        within the project directory, the attributes are associated with both</span>
<span class="sd">        the *current* and *initial* collections.</span>

<span class="sd">        :param pipeline (Pipeline): The pipeline whose completion attributes</span>
<span class="sd">                                    should be registered. The pipeline must</span>
<span class="sd">                                    provide a completion engin capable of</span>
<span class="sd">                                    exporting its attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">completion</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">valid_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">))</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_tags</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="n">queue</span><span class="p">,</span> <span class="n">rel_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="p">[]</span>

                <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">apath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">proj_dir</span> <span class="ow">in</span> <span class="n">apath</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                            <span class="n">rel_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">apath</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">)))</span>

                <span class="k">for</span> <span class="n">rel_path</span> <span class="ow">in</span> <span class="n">rel_paths</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span>
                            <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                        <span class="p">):</span>
                            <span class="n">db</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                                <span class="n">collection_name</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                                <span class="n">primary_key</span><span class="o">=</span><span class="n">rel_path</span><span class="p">,</span>
                                <span class="n">values_dict</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># Skip outputs that are unused or inactivated</span>
                        <span class="k">continue</span></div>


<div class="viewcode-block" id="PipelineManagerTab.remove_progress">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.remove_progress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove and clean up the progress widget.</span>

<span class="sd">        Safely removes the progress widget from the UI and frees associated</span>
<span class="sd">        resources. This method handles the complete lifecycle cleanup of the</span>
<span class="sd">        progress widget, nsuring proper Qt object disposal and memory</span>
<span class="sd">        management.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method is idempotent - it can be safely called multiple times</span>
<span class="sd">            without side effects if the progress widget has already been</span>
<span class="sd">            removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;progress&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Ensure cleanup happens even if previous steps fail</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PipelineManagerTab.runPipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.runPipeline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">runPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the current pipeline in the pipeline editor.</span>

<span class="sd">        This method initializes and runs the active pipeline with the</span>
<span class="sd">        following steps:</span>
<span class="sd">            1. Initializes the pipeline and validates prerequisites</span>
<span class="sd">            2. Sets up pipeline metadata and UI state</span>
<span class="sd">            3. Configures soma-workflow connection (if enabled)</span>
<span class="sd">            4. Starts pipeline execution with progress tracking</span>

<span class="sd">        The method handles both local and remote execution via soma-workflow,</span>
<span class="sd">        displays progress animation, and manages UI state during execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">soma_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">configuration</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">soma_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">swconstants</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">soma_workflow.gui.workflowGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConnectionDialog</span>

        <span class="c1"># Initialize the pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">pipeline_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
            <span class="n">non_empty_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">name</span><span class="p">]</span>
            <span class="n">pipeline_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">non_empty_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_empty_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;Unknown&quot;</span>
            <span class="p">)</span>

        <span class="n">pipeline_name</span> <span class="o">=</span> <span class="n">pipeline_name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span>
        <span class="c1"># Set pipeline execution metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_run_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span> <span class="o">=</span> <span class="n">pipeline_name</span>
        <span class="c1"># Update UI status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">&#39; pipeline is getting run. Please wait.&quot;</span>
        <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="c1"># Configure soma-workflow if enabled</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>
        <span class="n">swf_config</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
            <span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;somaworkflow&quot;</span><span class="p">:</span> <span class="s1">&#39;config_id==&quot;somaworkflow&quot;&#39;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">swf_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># Get configuration files and show connection dialog</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">search_config_path</span><span class="p">()</span>
            <span class="n">resource_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_configured_resources</span><span class="p">(</span>
                    <span class="n">config_file</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">login_list</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_logins</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="n">dialog</span> <span class="o">=</span> <span class="n">ConnectionDialog</span><span class="p">(</span><span class="n">login_list</span><span class="p">,</span> <span class="n">resource_list</span><span class="p">)</span>
            <span class="c1"># Pre-select configured resource if available</span>
            <span class="n">selected_resource</span> <span class="o">=</span> <span class="n">swf_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;computing_resource&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">selected_resource</span> <span class="ow">and</span> <span class="n">selected_resource</span> <span class="ow">in</span> <span class="n">resource_list</span><span class="p">:</span>
                <span class="n">dialog</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">combo_resources</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="n">selected_resource</span><span class="p">)</span>

            <span class="c1"># Show dialog and handle user response</span>
            <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># User cancelled</span>
                <span class="k">return</span>

            <span class="c1"># Reset execution state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Extract connection details</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">combo_resources</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lineEdit_password</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="n">rsa_key</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lineEdit_rsa_password</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

            <span class="c1"># Connect to remote resource if not local</span>
            <span class="n">local_resources</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
                <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_local_resource_id</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">resource</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">local_resources</span><span class="p">:</span>
                <span class="n">study_config</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">study_config</span>

                <span class="k">if</span> <span class="s2">&quot;SomaWorkflowConfig&quot;</span> <span class="ow">in</span> <span class="n">study_config</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                    <span class="c1"># Configure the computing resource</span>
                    <span class="c1"># TODO: Not sure this is needed...)</span>
                    <span class="n">study_config</span><span class="o">.</span><span class="n">somaworkflow_computing_resource</span> <span class="o">=</span> <span class="n">resource</span>
                    <span class="n">swc</span> <span class="o">=</span> <span class="n">study_config</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SomaWorkflowConfig&quot;</span><span class="p">]</span>
                    <span class="n">swc</span><span class="o">.</span><span class="n">set_computing_resource_password</span><span class="p">(</span>
                        <span class="n">resource</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">rsa_key</span>
                    <span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting to resource: </span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>

        <span class="c1"># Setup progress widget and animation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">RunProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Fixed</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
        <span class="c1"># Setup rotating brain animation</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="n">animation_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;rotatingBrainVISA.gif&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span> <span class="o">=</span> <span class="n">QMovie</span><span class="p">(</span><span class="n">animation_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">frameChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_anim_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># Update UI state for execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Connect signals and start execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish_execution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.saveParameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.saveParameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">saveParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the parameters of the currently active pipeline in the pipeline</span>
<span class="sd">        editor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.savePipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.savePipeline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">savePipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_overwrite_warning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current pipeline in the pipeline editor.</span>

<span class="sd">        This method handles three scenarios:</span>
<span class="sd">            1. Save to existing file with overwrite confirmation</span>
<span class="sd">               (unless skipped)</span>
<span class="sd">            2. Save to existing file without confirmation when warning</span>
<span class="sd">               is skipped</span>
<span class="sd">            3. Save as new file when no filename exists or file is in</span>
<span class="sd">               protected directory</span>

<span class="sd">        :param skip_overwrite_warning (bool): If True, skip the overwrite</span>
<span class="sd">                                              confirmation dialog when saving</span>
<span class="sd">                                              to an existing file. Defaults to</span>
<span class="sd">                                              False.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Updates the main window status bar with save operation messages</span>
<span class="sd">            - May display a confirmation dialog for file overwriting</span>
<span class="sd">            - Saves the pipeline to disk via pipelineEditorTabs.save_pipeline()</span>

<span class="sd">        Note:</span>
<span class="sd">            Files in &quot;mia_processes/mia_processes&quot; directory are treated as</span>
<span class="sd">            protected and will trigger a &quot;save as&quot; operation regardless of</span>
<span class="sd">            other conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize status message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="s2">&quot;The pipeline is getting saved. Please wait.&quot;</span>
        <span class="p">)</span>
        <span class="n">current_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
        <span class="n">current_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
        <span class="n">pipeline_name</span> <span class="o">=</span> <span class="n">current_pipeline</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Check if file exists and is not in protected directory</span>
        <span class="n">is_existing_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">current_filename</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;mia_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;mia_processes&quot;</span><span class="p">)</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_filename</span>
        <span class="p">)</span>

        <span class="c1"># Handle existing file save with potential overwrite confirmation</span>
        <span class="k">if</span> <span class="n">is_existing_file</span><span class="p">:</span>
            <span class="n">should_save</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Show overwrite warning if not skipped</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_overwrite_warning</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;populse_mia - Save pipeline Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The following module will be overwritten:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">current_filename</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Do you agree?&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">should_save</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span>

            <span class="c1"># Execute save or show cancellation message</span>
            <span class="k">if</span> <span class="n">should_save</span><span class="p">:</span>
                <span class="n">pipeline_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span>
                    <span class="n">new_file_name</span><span class="o">=</span><span class="n">current_filename</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">&#39; pipeline has been saved.&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">&#39; pipeline was not saved.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Handle save as new file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">()</span>
            <span class="n">status_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">save_result</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;pipeline has been saved.&quot;</span>
                <span class="k">if</span> <span class="n">save_result</span>
                <span class="k">else</span> <span class="s2">&quot;The pipeline was not saved.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">status_message</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.save_pipeline_as">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.save_pipeline_as">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_pipeline_as</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current pipeline under a new name via &#39;Save As&#39; dialog.</span>

<span class="sd">        This method displays a status message during the save operation and</span>
<span class="sd">        provides user feedback based on the save result. The pipeline name in</span>
<span class="sd">        the success message is capitalized and stripped of its file extension</span>
<span class="sd">        for display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span>
        <span class="c1"># Show progress message</span>
        <span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s2">&quot;The pipeline is getting saved. Please wait.&quot;</span><span class="p">)</span>
        <span class="c1"># Attempt to save the pipeline</span>
        <span class="n">save_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">()</span>

        <span class="c1"># Display appropriate status message based on result</span>
        <span class="k">if</span> <span class="n">save_result</span><span class="p">:</span>
            <span class="n">pipeline_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_result</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">&#39; pipeline has been saved.&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s2">&quot;The pipeline was not saved.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.show_status">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.show_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the execution status window with runtime information.</span>

<span class="sd">        Opens a new status widget window that shows the last execution run</span>
<span class="sd">        details, including runtime statistics, error messages, and other</span>
<span class="sd">        diagnostic information. The widget is stored as an instance attribute</span>
<span class="sd">        for potential future reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Open Execution Status Window&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_widget</span> <span class="o">=</span> <span class="n">StatusWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.stop_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.stop_execution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interrupt pipeline execution gracefully.</span>

<span class="sd">        This method signals the pipeline to stop its current execution flow.</span>
<span class="sd">        The interruption is handled asynchronously through the progress</span>
<span class="sd">        tracker, allowing any in-flight operations to complete safely before</span>
<span class="sd">        termination.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pipeline execution interrupted&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">stop_execution</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.undo">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.undo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo the last action performed on the current pipeline editor.</span>

<span class="sd">        This method reverts the most recent undoable action by popping it</span>
<span class="sd">        from the undo stack and performing the inverse operation. The method</span>
<span class="sd">        handles all reversible operations in the pipeline editor interface.</span>

<span class="sd">        Supported undoable actions:</span>
<span class="sd">            - add_process: Remove the added process node</span>
<span class="sd">            - delete_process: Restore the deleted process node with its links</span>
<span class="sd">            - export_plug/export_plugs: Remove the exported pipeline plug(s)</span>
<span class="sd">            - remove_plug: Restore the removed plug(s) and reconnect links</span>
<span class="sd">            - update_node_name: Revert node name change</span>
<span class="sd">            - update_plug_value: Restore previous plug value</span>
<span class="sd">            - add_link: Remove the added connection</span>
<span class="sd">            - delete_link: Restore the deleted connection</span>

<span class="sd">        The method automatically updates the pipeline state and node</span>
<span class="sd">        parameters after performing the undo operation.</span>

<span class="sd">        Note:</span>
<span class="sd">            Does nothing if no undoable actions are available in the stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="n">undo_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span><span class="n">current_editor</span><span class="p">]</span>

        <span class="c1"># Early return if no actions to undo</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">undo_stack</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Pop the most recent action and extract components</span>
        <span class="n">action_data</span> <span class="o">=</span> <span class="n">undo_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c1"># action_type is the action to undo</span>
        <span class="c1"># action_args are the arguments needed to undo the action</span>
        <span class="n">action_type</span><span class="p">,</span> <span class="o">*</span><span class="n">action_args</span> <span class="o">=</span> <span class="n">action_data</span>

        <span class="c1"># Handle each action type</span>
        <span class="k">if</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;add_process&quot;</span><span class="p">:</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="n">action_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">del_node</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;delete_process&quot;</span><span class="p">:</span>
            <span class="n">node_name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">links</span> <span class="o">=</span> <span class="n">action_args</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">add_named_process</span><span class="p">(</span>
                <span class="n">class_name</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;export_plugs&quot;</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">,</span> <span class="n">node_name</span> <span class="o">=</span> <span class="n">action_args</span>
            <span class="c1"># Ensure parameters is a list for consistent handling</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">parameters</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">parameters</span>
            <span class="p">)</span>
            <span class="c1"># Determine plug types and build removal list</span>
            <span class="n">plugs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="n">is_input</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">current_editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">links_to</span>
                <span class="p">)</span>
                <span class="n">plug_type</span> <span class="o">=</span> <span class="s2">&quot;inputs&quot;</span> <span class="k">if</span> <span class="n">is_input</span> <span class="k">else</span> <span class="s2">&quot;outputs&quot;</span>
                <span class="n">plugs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plug_type</span><span class="p">,</span> <span class="n">parameter</span><span class="p">))</span>

            <span class="n">current_editor</span><span class="o">.</span><span class="n">_remove_plug</span><span class="p">(</span>
                <span class="n">plug_names</span><span class="o">=</span><span class="n">plugs_to_remove</span><span class="p">,</span>
                <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">from_export_plugs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;remove_plug&quot;</span><span class="p">:</span>
            <span class="n">tot_plug_names</span> <span class="o">=</span> <span class="n">action_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">is_multi_export</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">is_multi_export</span><span class="p">:</span>
                <span class="n">tot_pip_plug_name</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">pip_plug_name</span><span class="p">,</span> <span class="n">node_plug_name</span><span class="p">,</span> <span class="n">optional</span> <span class="ow">in</span> <span class="n">tot_plug_names</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">is_multi_export</span><span class="p">:</span>
                    <span class="n">tot_pip_plug_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># Re-export the plug</span>
                <span class="n">current_editor</span><span class="o">.</span><span class="n">_export_plug</span><span class="p">(</span>
                    <span class="n">temp_plug_name</span><span class="o">=</span><span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">weak_link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span>
                    <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">multi_export</span><span class="o">=</span><span class="n">is_multi_export</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Reconnect original links if they existed</span>
                <span class="k">if</span> <span class="n">node_plug_name</span> <span class="ow">and</span> <span class="n">pip_plug_name</span><span class="p">:</span>

                    <span class="c1"># Determine source and destination based on plug direction</span>
                    <span class="k">if</span> <span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Create and add the link</span>
                    <span class="n">link_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">current_editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                        <span class="n">link_string</span><span class="p">,</span> <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

            <span class="n">current_editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update_pipeline</span><span class="p">()</span>

            <span class="c1"># Handle multi-export history</span>
            <span class="k">if</span> <span class="n">is_multi_export</span><span class="p">:</span>
                <span class="n">history_entry</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;export_plugs&quot;</span><span class="p">,</span>
                    <span class="n">tot_pip_plug_name</span><span class="p">,</span>
                    <span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">]</span>
                <span class="n">current_editor</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_entry</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;update_node_name&quot;</span><span class="p">:</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">new_node_name</span><span class="p">,</span> <span class="n">old_node_name</span> <span class="o">=</span> <span class="n">action_args</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">update_node_name</span><span class="p">(</span>
                <span class="n">node</span><span class="p">,</span> <span class="n">new_node_name</span><span class="p">,</span> <span class="n">old_node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;update_plug_value&quot;</span><span class="p">:</span>
            <span class="n">node_name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">action_args</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">update_plug_value</span><span class="p">(</span>
                <span class="n">node_name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;add_link&quot;</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">action_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">_del_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;delete_link&quot;</span><span class="p">:</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span> <span class="o">=</span> <span class="n">action_args</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Log warning for unknown action types</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Unknown undo action type: </span><span class="si">{</span><span class="n">action_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Update pipeline state after successful undo operation</span>
        <span class="n">current_editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_auto_inheritance">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_auto_inheritance">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_auto_inheritance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically infer database tags for output parameters from input</span>
<span class="sd">        parameters.</span>

<span class="sd">        1. **Single input case**: When only one input parameter has a database</span>
<span class="sd">           value, all outputs inherit from this input.</span>
<span class="sd">        2. **Multiple inputs with same value**: When multiple inputs exist but</span>
<span class="sd">            have identical database values, fallback to single input behavior.</span>
<span class="sd">        3. **Ambiguous case**: When multiple inputs have different database</span>
<span class="sd">           values, track all possible inheritance sources for user resolution.</span>

<span class="sd">        The process attribute auto_inheritance_dict is filled with these</span>
<span class="sd">        values. It&#39;s a dict with the shape::</span>

<span class="sd">            {output_filename: &lt;input_spec&gt;}</span>

<span class="sd">        `output_filename` is the relative filename in the database</span>

<span class="sd">        `&lt;input_spec&gt;` can be:</span>

<span class="sd">        * a string: filename</span>
<span class="sd">        * a dict::</span>

<span class="sd">                {input_param: input_filename}</span>

<span class="sd">        `auto_inheritance_dict` is built automatically, and is used as a</span>
<span class="sd">        fallback to :class:`ProcessMIA` `inheritance_dict`, built &quot;manually&quot;</span>
<span class="sd">        (specialized for each process) in the :meth:`ProcessMIA.list_outputs`</span>
<span class="sd">        when the latter does not exist, or does not specify what an output</span>
<span class="sd">        inherits from.</span>

<span class="sd">        If ambiguities still subsist, the Mia infrastructure will ask the user</span>
<span class="sd">        how to solve them, which is not very convenient, and error-prone, thus</span>
<span class="sd">        should be avoided.</span>

<span class="sd">        :param node: The node (typically a process or process node) whose</span>
<span class="sd">                     inputs and outputs are analyzed for tag inheritance.</span>
<span class="sd">        :param job: An optional job object containing parameter values to</span>
<span class="sd">                    override or populate the node&#39;s inputs and outputs.</span>
<span class="sd">                    Defaults to None.</span>

<span class="sd">        :return (dict or None): Auto-inheritance mapping if successful and no</span>
<span class="sd">                                job provided, None if no inheritance can be</span>
<span class="sd">                                determined or job is provided (in which case</span>
<span class="sd">                                the job object is updated in-place).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract process from node if needed</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="c1"># Keep only leaf processes that actually produce outputs</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Clean up any existing auto_inheritance_dict</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;auto_inheritance_dict&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">process</span><span class="o">.</span><span class="n">auto_inheritance_dict</span>

        <span class="c1"># Validate study configuration and project</span>
        <span class="n">study_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">study_config</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">project</span><span class="p">:</span>
            <span class="c1"># No databasing, nothing to be done.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="c1"># Extract inputs and outputs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>

            <span class="c1"># Handle ProcessMIA specific outputs</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;list_outputs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span>
            <span class="p">):</span>
                <span class="c1"># Normally same as outputs, but it may contain an additional</span>
                <span class="c1"># &quot;notInDb&quot; key.</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">traits</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>

        <span class="c1"># Apply job parameter overrides if provided</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">param_dict</span> <span class="ow">in</span> <span class="p">[</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">]:</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                        <span class="n">job_value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                            <span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span>
                        <span class="p">):</span>

                            <span class="c1"># Update list elements</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_value</span><span class="p">):</span>

                                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                                    <span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_value</span>

                    <span class="k">elif</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                        <span class="c1"># Remove undefined values</span>
                        <span class="k">del</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove undefined values</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span><span class="p">}</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span><span class="p">}</span>

        <span class="n">database_inputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># Handle both single values and lists</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="k">else</span> <span class="p">(</span>
                        <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">[]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                    <span class="n">resolved_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">resolved_path</span><span class="o">.</span><span class="n">is_relative_to</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">resolved_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">),</span>
                        <span class="p">):</span>
                            <span class="c1"># inheritance_dict is using full paths.</span>
                            <span class="n">database_inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                            <span class="k">break</span>
                            <span class="c1"># TODO: What if several path values are valid ?</span>
                            <span class="c1">#       Currently we keep only the first element of</span>
                            <span class="c1">#       the plug parameters</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">database_inputs</span><span class="p">:</span>
            <span class="c1"># Zero inputs are registered in the database: We cannot</span>
            <span class="c1"># infer outputs tags automatically. OK we leave.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">database_inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If the process has a single input with a value in the database,</span>
            <span class="c1"># then we can deduce its output database tags/attributes from it.</span>
            <span class="n">inheritance_source</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">database_inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Several inputs are registered in the database: We cannot</span>
            <span class="c1"># infer outputs tags automatically too, but we mark the ambiguity</span>
            <span class="c1"># to ask the user later</span>
            <span class="n">unique_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">database_inputs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">inheritance_source</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">unique_values</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">database_inputs</span>
            <span class="p">)</span>

        <span class="c1"># Build auto inheritance dictionary</span>
        <span class="n">not_in_db</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notInDb&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug_value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># Skip special parameters and high-level user parameters</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">plug_name</span> <span class="o">==</span> <span class="s2">&quot;notInDb&quot;</span>
                <span class="ow">or</span> <span class="n">plug_name</span> <span class="ow">in</span> <span class="n">not_in_db</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Extract all valid file paths from plug value</span>
            <span class="c1"># (handles nested lists)</span>
            <span class="n">valid_paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">plug_value</span><span class="p">]</span>

            <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">resolved_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">current</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">resolved_path</span><span class="o">.</span><span class="n">is_relative_to</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                        <span class="n">valid_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">valid_paths</span><span class="p">:</span>
                <span class="n">auto_inheritance_dict</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">inheritance_source</span>

        <span class="k">if</span> <span class="n">auto_inheritance_dict</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="n">auto_inheritance_dict</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">auto_inheritance_dict</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_inheritance">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_inheritance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the inheritance dictionary for a process node in a pipeline</span>
<span class="sd">        execution.</span>

<span class="sd">        This method manages metadata inheritance by updating a job&#39;s</span>
<span class="sd">        inheritance_dict based on the node&#39;s execution context and the</span>
<span class="sd">        project&#39;s inheritance history. The inheritance dictionary defines</span>
<span class="sd">        relationships between input and output parameters, enabling</span>
<span class="sd">        propagation of database tags and other metadata properties through the</span>
<span class="sd">        pipeline.</span>

<span class="sd">        The method follows this precedence order:</span>
<span class="sd">            1. Project-specific inheritance history (if matching parameters</span>
<span class="sd">               are found)</span>
<span class="sd">            2. Process-level inheritance dictionary (fallback)</span>

<span class="sd">        :param job: Job execution object containing param_dict</span>
<span class="sd">                    (parameter name-&gt;value mapping) and inheritance_dict</span>
<span class="sd">                    (will be updated by this method)</span>
<span class="sd">        :param node: Process node being evaluated (ProcessNode or Process</span>
<span class="sd">                     object). Used to determine inheritance rules via</span>
<span class="sd">                     context_name or name attribute.</span>

<span class="sd">        Note: For Pipeline nodes, the method strips the &quot;Pipeline.&quot; prefix</span>
<span class="sd">              from the context_name to match against inheritance history keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the effective node name, handling Pipeline prefixes</span>
        <span class="n">context_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">node_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
            <span class="k">else</span> <span class="n">context_name</span>
        <span class="p">)</span>
        <span class="c1"># Try to find matching inheritance from project history</span>
        <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">:</span>
            <span class="n">param_values</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">inherit_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">[</span>
                <span class="n">node_name</span>
            <span class="p">]:</span>

                <span class="c1"># Check if any inheritance dict key matches any parameter value</span>
                <span class="k">if</span> <span class="n">param_values</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">inherit_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="n">inherit_dict</span>
                    <span class="k">break</span>

        <span class="c1"># Fall back to process-level inheritance if no history match found</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inheritance_dict</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span>
            <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">job</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="n">inheritance_dict</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_node_list">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_node_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_node_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brick</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the node list with unique nodes from workflow jobs.</span>

<span class="sd">        Iterates through all jobs in the current workflow and adds their</span>
<span class="sd">        associated process nodes to the node list, ensuring no duplicates.</span>
<span class="sd">        Only jobs with a &#39;process&#39; attribute are considered.</span>

<span class="sd">        :param brick: Reserved for future use. Currently unused parameter that</span>
<span class="sd">                      could be used for filtering or extending functionality.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method modifies self.node_list in-place by extending it with</span>
<span class="sd">            new unique nodes. Jobs without a &#39;process&#39; attribute are silently</span>
<span class="sd">            skipped.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get nodes from jobs that have a process attribute</span>
        <span class="n">new_nodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Use set difference for efficient duplicate filtering</span>
        <span class="n">existing_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">)</span>
        <span class="n">unique_new_nodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">new_nodes</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_nodes</span>
        <span class="p">]</span>
        <span class="c1"># Extend the list with unique new nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unique_new_nodes</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.updateProcessLibrary">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.updateProcessLibrary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">updateProcessLibrary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the library of processes when a pipeline is saved.</span>

<span class="sd">        This method performs the following operations:</span>
<span class="sd">            1. Renames the Pipeline class in the saved file to match the</span>
<span class="sd">               filename</span>
<span class="sd">            2. Updates the __init__.py file to include the new import</span>
<span class="sd">            3. Refreshes the module in sys.modules if it already exists</span>
<span class="sd">            4. Adds the module to the process library</span>

<span class="sd">        :param filename: Path to the pipeline file that has been saved</span>

<span class="sd">        Note:</span>
<span class="sd">            Only processes saved in the User_processes directory are added to</span>
<span class="sd">            the library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">stem</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="c1"># Update class name in the pipeline file using atomic replacement</span>
        <span class="n">temp_file</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;_tmp&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="p">(</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">,</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp</span><span class="p">,</span>
            <span class="p">):</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;class &quot;</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;class </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(Pipeline):&quot;</span>

                    <span class="n">temp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">temp_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">temp_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Check if file is in User_processes directory</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">user_processes_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_properties_path</span><span class="p">())</span> <span class="o">/</span> <span class="s2">&quot;processes&quot;</span> <span class="o">/</span> <span class="s2">&quot;User_processes&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">user_processes_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># File not in User_processes directory</span>

        <span class="c1"># Update __init__.py with new import if not already present</span>
        <span class="n">init_file</span> <span class="o">=</span> <span class="n">user_processes_dir</span> <span class="o">/</span> <span class="s2">&quot;__init__.py&quot;</span>
        <span class="n">import_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from .</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">existing_lines</span> <span class="o">=</span> <span class="n">init_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span>
                <span class="n">keepends</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">existing_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">import_line</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_lines</span><span class="p">:</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">init_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">import_line</span><span class="p">)</span>

        <span class="c1"># Refresh module if it exists in sys.modules</span>
        <span class="n">module_full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User_processes.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">module_full_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_full_name</span><span class="p">]</span>
            <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;User_processes&quot;</span><span class="p">)</span>

        <span class="c1"># Add to system path and update process library</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_processes_dir</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">add_package</span><span class="p">(</span>
            <span class="s2">&quot;User_processes&quot;</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">init_package_tree</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">base_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_project">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_project">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the project reference across all relevant components.</span>

<span class="sd">        This method propagates the project instance to all components that</span>
<span class="sd">        require access to project data, ensuring consistency across the</span>
<span class="sd">        application state. It also updates the node controller&#39;s visible tags</span>
<span class="sd">        from the project database.</span>

<span class="sd">        :param project: The current project instance containing application</span>
<span class="sd">                        data and database connections.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method has the side effect of setting ProcessMIA.project as a</span>
<span class="sd">            class attribute, which is required for Mia brick functionality.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Components that need direct project access</span>
        <span class="n">components_requiring_project</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="p">,</span>
            <span class="n">ProcessMIA</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Update project reference for all components</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components_requiring_project</span><span class="p">:</span>
            <span class="n">component</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

        <span class="c1"># Update visible tags from project database</span>
        <span class="k">with</span> <span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">visibles_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_scans_list">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_scans_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_scans_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_list</span><span class="p">,</span> <span class="n">all_iterations_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the user-selected list of scans based on iteration settings.</span>

<span class="sd">        This method handles the transition between regular and iterated</span>
<span class="sd">        pipeline modes, updating the scan list accordingly. When iteration</span>
<span class="sd">        mode is enabled, it builds an iterated pipeline and uses the full</span>
<span class="sd">        iterations list. When disabled, it extracts the pipeline from the</span>
<span class="sd">        iteration node and reverts to the original scan list.</span>

<span class="sd">        :param iteration_list: Current list of scans in the iteration table</span>
<span class="sd">                               (unused in current implementation)</span>
<span class="sd">        :param all_iterations_list: Complete list of all iteration scan lists</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Updates UI button states</span>
<span class="sd">            - May modify the current pipeline (switch between regular/iterated)</span>
<span class="sd">            - Updates scan lists for both iteration table and pipeline editor</span>
<span class="sd">            - May update node parameters display</span>
<span class="sd">            - Falls back to database scan list if pipeline scan list is empty</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_user_buttons_states</span><span class="p">()</span>
        <span class="n">current_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
        <span class="c1"># Find iteration node if it exists</span>
        <span class="n">iteration_node_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">sortedKeys</span><span class="p">:</span>

                <span class="k">if</span> <span class="s2">&quot;iterated_&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">iteration_node_name</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="k">break</span>

        <span class="n">has_iteration</span> <span class="o">=</span> <span class="n">iteration_node_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>

            <span class="c1"># Enable iteration mode</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_iteration</span><span class="p">:</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_iterated_pipeline</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">new_pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Abort and uncheck the iteration checkbox</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span>
                        <span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">current_editor</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">new_pipeline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">new_pipeline</span><span class="p">)</span>

            <span class="c1"># Update scan lists for iteration mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="n">all_iterations_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">scan</span>
                <span class="k">for</span> <span class="n">iteration_list</span> <span class="ow">in</span> <span class="n">all_iterations_list</span>
                <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">iteration_list</span>
            <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Disable iteration mode</span>
            <span class="k">if</span> <span class="n">has_iteration</span><span class="p">:</span>
                <span class="c1"># Extract the original pipeline from the iteration node</span>
                <span class="n">original_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span>
                    <span class="n">iteration_node_name</span>
                <span class="p">]</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">process</span>
                <span class="n">current_editor</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">original_pipeline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">original_pipeline</span><span class="p">)</span>

            <span class="c1"># Reset scan lists to non-iteration mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span>

        <span class="c1"># Fallback to database scan list if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_scans_list</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_user_buttons_states">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_user_buttons_states">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_user_buttons_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the visibility and state of pipeline-related UI actions.</span>

<span class="sd">        Updates the enabled/disabled state of pipeline actions (Run, Save,</span>
<span class="sd">        Save As) based on the current pipeline state. The method evaluates</span>
<span class="sd">        the pipeline associated with either the specified editor or the</span>
<span class="sd">        current active editor.</span>

<span class="sd">        Button states updated:</span>
<span class="sd">            - Run Pipeline: Disabled when pipeline is empty or None</span>
<span class="sd">            - Save Pipeline &amp; Save As: Enabled only when pipeline is not</span>
<span class="sd">              iterated</span>

<span class="sd">        :param index (int): Index of the specific editor to check. If -1</span>
<span class="sd">                            (default), uses the currently active editor.</span>

<span class="sd">        Note:</span>
<span class="sd">            If the specified editor doesn&#39;t exist or has no scene, the</span>
<span class="sd">            pipeline is treated as None and buttons are disabled accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_editor_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="s2">&quot;scene&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>

        <span class="c1"># Update run button state based on pipeline content</span>
        <span class="n">has_processes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">list_process_in_pipeline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">has_processes</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_user_mode">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_user_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_user_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update widget/action visibility and functionality based on user mode</span>
<span class="sd">        configuration.</span>

<span class="sd">        In user mode:</span>
<span class="sd">            - Disables pipeline saving (process library unavailable)</span>
<span class="sd">            - Disables pipeline overwriting</span>
<span class="sd">            - Disables project deletion</span>

<span class="sd">        Also synchronizes user level across pipeline editor and node</span>
<span class="sd">        controller components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">user_mode</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_user_mode</span><span class="p">()</span>
        <span class="c1"># Configure actions based on user mode</span>
        <span class="n">actions_enabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">user_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">actions_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">action_delete_project</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">actions_enabled</span><span class="p">)</span>
        <span class="c1"># Configure current editor</span>
        <span class="n">current_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="n">current_editor</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="n">user_mode</span>

        <span class="c1"># Update user level if changed</span>
        <span class="n">user_level</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_user_level</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">user_level</span> <span class="o">!=</span> <span class="n">current_editor</span><span class="o">.</span><span class="n">userlevel</span><span class="p">:</span>
            <span class="n">current_editor</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="n">user_level</span>

            <span class="c1"># Update process widget if it exists</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">process_widget</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">process_widget</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="n">user_level</span></div>
</div>



<div class="viewcode-block" id="RunProgress">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RunProgress</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Qt widget for displaying and managing pipeline execution progress.</span>

<span class="sd">    This widget provides a visual progress indicator and manages the lifecycle</span>
<span class="sd">    of pipeline execution through a worker thread. It handles user feedback,</span>
<span class="sd">    error reporting, and resource cleanup.</span>

<span class="sd">    The widget integrates with a PipelineManagerTab to control pipeline</span>
<span class="sd">    execution, providing real-time feedback and graceful error handling.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - _determine_completion_message: Analyze execution results and</span>
<span class="sd">                                         determine appropriate user message</span>
<span class="sd">        - _setup_ui: Set up the user interface for the widget</span>
<span class="sd">        - _show_completion_message: Display execution completion message</span>
<span class="sd">        - cleanup: Clean up resources and prepare for widget destruction</span>
<span class="sd">        - end_progress: Handle completion of pipeline execution and show</span>
<span class="sd">                        results</span>
<span class="sd">        - start: Starts the worker thread to begin the pipeline execution</span>
<span class="sd">                 process</span>
<span class="sd">        - stop_execution: Stops the execution of the pipeline by signaling the</span>
<span class="sd">                          worker to interrupt</span>

<span class="sd">    Notes:</span>
<span class="sd">        pipeline_manager (PipelineManagerTab):</span>
<span class="sd">            The pipeline manager instance that handles the pipeline operations.</span>
<span class="sd">        progressbar (QProgressBar):</span>
<span class="sd">            The progress bar widget to show execution progress.</span>
<span class="sd">        worker (RunWorker):</span>
<span class="sd">            The worker thread that runs the pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># UI Constants</span>
    <span class="n">MIN_PROGRESS_WIDTH</span> <span class="o">=</span> <span class="mi">350</span>  <span class="c1"># Minimum width for progress bar (for macOS)</span>
    <span class="n">AUTO_CLOSE_DELAY_MS</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Delay before auto-closing message box</span>

<div class="viewcode-block" id="RunProgress.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the RunProgress widget with a progress bar and worker</span>
<span class="sd">        thread.</span>

<span class="sd">        :param pipeline_manager (PipelineManagerTab): A `PipelineManagerTab`</span>
<span class="sd">                                                      instance responsible for</span>
<span class="sd">                                                      managing the pipeline.</span>
<span class="sd">        :param settings (dict): A dictionary of settings to customize pipeline</span>
<span class="sd">                                iteration, default is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">RunWorker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_progress</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_completion_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze execution results and determine appropriate user message.</span>

<span class="sd">        :return: Dictionary containing message box configuration with keys:</span>
<span class="sd">                 &#39;icon&#39;, &#39;title&#39;, and &#39;text&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Execution Failed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="s2">&quot;Pipeline execution failed to start.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Please check the status report for details.&quot;</span>
                <span class="p">),</span>
            <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Information</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Execution Successful&quot;</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Pipeline execution completed successfully.&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="n">WorkflowExecutionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Execution Failed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="s2">&quot;Pipeline execution encountered an error.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Please check the status report for details.&quot;</span>
                <span class="p">),</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the user interface for the widget.</span>

<span class="sd">        This method initializes an indeterminate progress bar with a</span>
<span class="sd">        predefined minimum width and places it inside a horizontal</span>
<span class="sd">        box layout, which is then assigned to the widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QProgressBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Indeterminate progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MIN_PROGRESS_WIDTH</span><span class="p">)</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_show_completion_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">icon</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display execution completion message with auto-close timer.</span>

<span class="sd">        :param icon (QMessageBox.Icon): Message box icon type.</span>
<span class="sd">        :param title (str): Dialog window title.</span>
<span class="sd">        :param text (str): Message content to display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message_box</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Auto-close timer</span>
        <span class="n">close_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">()</span>
        <span class="n">close_timer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTO_CLOSE_DELAY_MS</span><span class="p">,</span> <span class="n">message_box</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">message_box</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

<div class="viewcode-block" id="RunProgress.cleanup">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.cleanup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up resources and prepare for widget destruction.</span>

<span class="sd">        Ensures the worker thread completes, disconnects signals,</span>
<span class="sd">        and releases resources. Should be called before widget destruction.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method blocks until the worker thread finishes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleaning up RunProgress resources...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span></div>


<div class="viewcode-block" id="RunProgress.end_progress">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.end_progress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">end_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle completion of pipeline execution and show results.</span>

<span class="sd">        Called automatically when the worker thread finishes. Restores</span>
<span class="sd">        the application cursor, evaluates execution status, and displays</span>
<span class="sd">        an appropriate message to the user.</span>

<span class="sd">        The message dialog automatically closes after a brief delay.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span>
        <span class="n">message_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_completion_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_completion_message</span><span class="p">(</span><span class="o">**</span><span class="n">message_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="RunProgress.start">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the worker thread to begin the pipeline execution process.</span>

<span class="sd">        This method initiates the worker thread by calling its `start` method,</span>
<span class="sd">        which in turn triggers the execution of the pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting pipeline execution&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="RunProgress.stop_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.stop_execution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the execution of the pipeline by signaling the worker to</span>
<span class="sd">        interrupt.</span>

<span class="sd">        This method sets the `interrupt_request` flag to `True` within the</span>
<span class="sd">        worker thread&#39;s lock, which tells the worker to stop its execution.</span>
<span class="sd">        The method can be used to cancel the pipeline execution at any point</span>
<span class="sd">        during its run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Requesting pipeline execution cancellation&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">interrupt_request</span> <span class="o">=</span> <span class="kc">True</span></div>
</div>



<div class="viewcode-block" id="RunWorker">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RunWorker</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Worker thread for executing a pipeline in the background.</span>

<span class="sd">    This class runs a pipeline or process using a separate thread to avoid</span>
<span class="sd">    blocking the GUI. Execution can be interrupted at any time by setting</span>
<span class="sd">    the :attr:`interrupt_request` flag while holding :attr:`lock`.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - _check_interrupt: Check whether an interrupt has been requested</span>
<span class="sd">        -  _disable_nipype_copy: Recursively check and disable the copy flag</span>
<span class="sd">                                 for Nipype processes in the pipeline.</span>
<span class="sd">        - run: Run the pipeline in a background thread</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RunWorker.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the worker thread for pipeline execution.</span>

<span class="sd">        :param pipeline_manager (PipelineManager): The manager responsible for</span>
<span class="sd">                                                   configuring, running, and</span>
<span class="sd">                                                   monitoring the pipeline</span>
<span class="sd">                                                   execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="c1"># Use this lock to modify the worker state from GUI/other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span>
        <span class="c1"># When interrupt_request is set (within a lock session from a</span>
        <span class="c1"># different thread), the worker will interrupt execution and leave</span>
        <span class="c1"># the thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec_id</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether an interrupt has been requested.</span>

<span class="sd">        If an interrupt is detected, log the event and optionally stop</span>
<span class="sd">        the execution engine.</span>

<span class="sd">        :param engine (CapsulEngine): Execution engine to interrupt if</span>
<span class="sd">                                      running.</span>

<span class="sd">        :return (bool): True if an interrupt was requested, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">engine</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_id</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exec_id</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_disable_nipype_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively check and disable the copy flag for Nipype processes in</span>
<span class="sd">        the pipeline.</span>

<span class="sd">        This function traverses the pipeline&#39;s nodes and checks if the</span>
<span class="sd">        nodes contain a NipypeProcess. If it does, it sets the</span>
<span class="sd">        `activate_copy` flag to `False`. The recursion handles nested</span>
<span class="sd">        pipelines.</span>

<span class="sd">        :param proc: A Pipeline or NipypeProcess instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>

                    <span class="c1"># Only recurse for named nodes (not for inputs/outputs</span>
                    <span class="c1"># nodes)</span>
                    <span class="k">if</span> <span class="n">node_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_nipype_copy</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">NipypeProcess</span><span class="p">):</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">activate_copy</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">NipypeProcess</span><span class="p">):</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">activate_copy</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="RunWorker.run">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the pipeline in a background thread.</span>

<span class="sd">        The method prepares the pipeline, disables unnecessary copy flags</span>
<span class="sd">        for Nipype processes, rebuilds workflows when file transfer or path</span>
<span class="sd">        translation is required, and starts execution using the Capsul engine.</span>
<span class="sd">        The status is monitored until the workflow completes or an interrupt</span>
<span class="sd">        is requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupt</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_nipype_copy</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupt</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupt</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">engine</span><span class="o">.</span><span class="n">study_config</span><span class="o">.</span><span class="n">reset_process_counter</span><span class="p">()</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupt</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Pipeline running&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ****************&quot;</span><span class="p">)</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">workflow</span>
        <span class="c1"># If we are running with file transfers / translations, then we must</span>
        <span class="c1"># rebuild the workflow, because it has not been made with them.</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connected_to</span><span class="p">()</span>
        <span class="n">resource_conf</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
            <span class="n">resource_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;somaworkflow&quot;</span><span class="p">:</span> <span class="s1">&#39;config_id==&quot;somaworkflow&quot;&#39;</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.somaworkflow&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">resource_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transfer_paths&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resource_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;path_translations&quot;</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Rebuilding workflow for file transfers / translations...&quot;</span>
            <span class="p">)</span>
            <span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow_from_pipeline</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">complete_parameters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">resource_id</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running now...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">protected_logging</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_id</span><span class="p">,</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
                    <span class="n">pipeline</span><span class="p">,</span>
                    <span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span>
                    <span class="n">get_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span><span class="p">,</span>
                <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_IN_PROGRESS</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exec_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupt</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
                    <span class="k">return</span>

            <span class="c1"># Postprocess each node to index outputs, even if workflow failed</span>
            <span class="k">with</span> <span class="n">protected_logging</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">postprocess_pipeline_execution</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has not run correctly: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span>
            <span class="c1"># Restore current working directory in case it has been changed</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="StatusWidget">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StatusWidget</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     A widget that displays the current or last pipeline execution status</span>
<span class="sd">    along with logs and an optional Soma-Workflow monitoring panel.</span>

<span class="sd">    Features:</span>
<span class="sd">        - Shows the last known pipeline status (or a default message if</span>
<span class="sd">          unavailable).</span>
<span class="sd">        - Displays the execution log of the most recent run.</span>
<span class="sd">        - Provides a toggleable Soma-Workflow monitoring section.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - toggle_soma_workflow: Show or hide the Soma-Workflow monitoring</span>
<span class="sd">                                widget</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StatusWidget.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the execution status window for monitoring pipeline runs.</span>

<span class="sd">        This window displays the latest pipeline execution status, the</span>
<span class="sd">        execution log, and provides an optional section for Soma-Workflow</span>
<span class="sd">        monitoring. The log is automatically populated from the pipeline</span>
<span class="sd">        manager&#39;s last recorded run.</span>

<span class="sd">        :param pipeline_manager: The pipeline manager instance containing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="c1"># Main layout</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Execution log viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTextBrowser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline_manager</span><span class="p">,</span> <span class="s2">&quot;last_run_log&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="c1"># Status box</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">pipeline_manager</span><span class="p">,</span> <span class="s2">&quot;last_status&quot;</span><span class="p">,</span> <span class="s2">&quot;No pipeline execution&quot;</span>
        <span class="p">)</span>
        <span class="n">status_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Status:&quot;</span><span class="p">)</span>
        <span class="n">s_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">status_box</span><span class="p">)</span>
        <span class="n">s_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;status:&lt;/b&gt; </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="c1"># Soma-Workflow monitoring box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Soma-Workflow monitoring:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_soma_workflow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QVBoxLayout</span><span class="p">())</span>
        <span class="c1"># Assemble layout</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">status_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Execution log:&quot;</span><span class="p">))</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edit</span><span class="p">)</span>
        <span class="c1"># Window setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Execution status&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="StatusWidget.toggle_soma_workflow">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget.toggle_soma_workflow">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_soma_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checked</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show or hide the Soma-Workflow monitoring widget.</span>

<span class="sd">        If enabled and the widget does not yet exist, it is created and</span>
<span class="sd">        added below the status section.</span>

<span class="sd">        :param checked (bool): Whether the monitoring panel is enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">checked</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">soma_workflow.gui.workflowGui</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">ApplicationModel</span><span class="p">,</span>
                <span class="n">MainWindow</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">ApplicationModel</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">protected_logging</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="o">=</span> <span class="n">MainWindow</span><span class="p">(</span>
                    <span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span><span class="p">)</span></div>
</div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>