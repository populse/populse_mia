<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>populse_mia.user_interface.pipeline_manager.pipeline_manager_tab &#8212; populse_mia 3.0.0-dev+881d2af6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=f63d8bfa" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/haiku.css?v=dfa0e015" />
    <script src="../../../../_static/documentation_options.js?v=a73ba755"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>populse_mia 3.0.0-dev+881d2af6 documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.user_interface.pipeline_manager.pipeline_manager_tab</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for populse_mia.user_interface.pipeline_manager.pipeline_manager_tab</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to define pipeline manager tab appearance, settings and methods.</span>

<span class="sd">Contains:</span>
<span class="sd">    Class:</span>
<span class="sd">        - PipelineManagerTab</span>
<span class="sd">        - RunProgress</span>
<span class="sd">        - RunWorker</span>
<span class="sd">        - StatusWidget</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># Other imports</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="c1"># Soma_workflow import</span>
<span class="kn">import</span> <span class="nn">soma_workflow.constants</span> <span class="k">as</span> <span class="nn">swconstants</span>
<span class="kn">import</span> <span class="nn">traits.api</span> <span class="k">as</span> <span class="nn">traits</span>

<span class="c1"># Capsul imports</span>
<span class="kn">from</span> <span class="nn">capsul.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NipypeProcess</span><span class="p">,</span>
    <span class="n">Pipeline</span><span class="p">,</span>
    <span class="n">PipelineNode</span><span class="p">,</span>
    <span class="n">Process</span><span class="p">,</span>
    <span class="n">ProcessNode</span><span class="p">,</span>
    <span class="n">get_process_instance</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">capsul.attributes.completion_engine</span> <span class="kn">import</span> <span class="n">ProcessCompletionEngine</span>
<span class="kn">from</span> <span class="nn">capsul.engine</span> <span class="kn">import</span> <span class="n">WorkflowExecutionError</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline</span> <span class="kn">import</span> <span class="n">pipeline_tools</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.pipeline_workflow</span> <span class="kn">import</span> <span class="n">workflow_from_pipeline</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.process_iteration</span> <span class="kn">import</span> <span class="n">ProcessIteration</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.qt_compat</span> <span class="kn">import</span> <span class="n">QtWidgets</span>

<span class="c1"># PyQt5 imports</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">pyqtSignal</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QCursor</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QMovie</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">QAction</span><span class="p">,</span>
    <span class="n">QApplication</span><span class="p">,</span>
    <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QMenu</span><span class="p">,</span>
    <span class="n">QMessageBox</span><span class="p">,</span>
    <span class="n">QScrollArea</span><span class="p">,</span>
    <span class="n">QSplitter</span><span class="p">,</span>
    <span class="n">QToolBar</span><span class="p">,</span>
    <span class="n">QVBoxLayout</span><span class="p">,</span>
    <span class="n">QWidget</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Soma_base import</span>
<span class="kn">from</span> <span class="nn">soma.controller.trait_utils</span> <span class="kn">import</span> <span class="n">is_file_trait</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qtThread</span> <span class="kn">import</span> <span class="n">QtThreadCall</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">TraitListObject</span><span class="p">,</span> <span class="n">Undefined</span>

<span class="c1"># Populse_MIA imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BRICK_EXEC</span><span class="p">,</span>
    <span class="n">BRICK_EXEC_TIME</span><span class="p">,</span>
    <span class="n">BRICK_INIT</span><span class="p">,</span>
    <span class="n">BRICK_INIT_TIME</span><span class="p">,</span>
    <span class="n">BRICK_INPUTS</span><span class="p">,</span>
    <span class="n">BRICK_NAME</span><span class="p">,</span>
    <span class="n">BRICK_OUTPUTS</span><span class="p">,</span>
    <span class="n">COLLECTION_BRICK</span><span class="p">,</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
    <span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
    <span class="n">HISTORY_BRICKS</span><span class="p">,</span>
    <span class="n">HISTORY_PIPELINE</span><span class="p">,</span>
    <span class="n">TAG_BRICKS</span><span class="p">,</span>
    <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
    <span class="n">TAG_FILENAME</span><span class="p">,</span>
    <span class="n">TAG_HISTORY</span><span class="p">,</span>
    <span class="n">TAG_TYPE</span><span class="p">,</span>
    <span class="n">TYPE_MAT</span><span class="p">,</span>
    <span class="n">TYPE_NII</span><span class="p">,</span>
    <span class="n">TYPE_TXT</span><span class="p">,</span>
    <span class="n">TYPE_UNKNOWN</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.software_properties</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.iteration_table</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IterationTable</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.node_controller</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CapsulNodeController</span><span class="p">,</span>
    <span class="n">NodeController</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.pipeline_editor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PipelineEditorTabs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_library</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProcessLibraryWidget</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pop_ups</span> <span class="kn">import</span> <span class="n">PopUpInheritanceDict</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="PipelineManagerTab">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab">[docs]</a>
<span class="k">class</span> <span class="nc">PipelineManagerTab</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget that handles the Pipeline Manager tab.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - _register_node_io_in_database: bla bla bla</span>
<span class="sd">        - _set_anim_frame: Callback which sets the animated icon frame to</span>
<span class="sd">          the status action icon</span>
<span class="sd">        - _show_preview:</span>
<span class="sd">        - add_plug_value_to_database: add the plug value to the database.</span>
<span class="sd">        - add_process_to_preview: add a process to the pipeline</span>
<span class="sd">        - build_iterated_pipeline: build a new pipeline with an iteration node</span>
<span class="sd">        - check_requirements: return the configuration of a pipeline</span>
<span class="sd">          as required</span>
<span class="sd">        - cleanup_older_init: remove non-existent entries from the databrowser</span>
<span class="sd">        - complete_pipeline_parameters:</span>
<span class="sd">        - controller_value_changed: update history when a pipeline node is</span>
<span class="sd">          changed</span>
<span class="sd">        - displayNodeParameters: display the node controller when a node is</span>
<span class="sd">          clicked</span>
<span class="sd">        - find_process:</span>
<span class="sd">        - finish_execution:</span>
<span class="sd">        - garbage_collect:</span>
<span class="sd">        - get_capsul_engine:</span>
<span class="sd">        - get_missing_mandatory_parameters: check on missing parameters for</span>
<span class="sd">          each job</span>
<span class="sd">        - get_pipeline_or_process:</span>
<span class="sd">        - initialize: clean previous initialization then initialize the current</span>
<span class="sd">          pipeline</span>
<span class="sd">        - init_pipeline: initialize the current pipeline of the pipeline</span>
<span class="sd">          editor</span>
<span class="sd">        - layout_view : initialize layout for the pipeline manager</span>
<span class="sd">        - loadParameters: load pipeline parameters to the current pipeline of</span>
<span class="sd">          the pipeline editor</span>
<span class="sd">        - loadPipeline: load a pipeline to the pipeline editor</span>
<span class="sd">        - postprocess_pipeline_execution:</span>
<span class="sd">        - redo: redo the last undone action on the current pipeline editor</span>
<span class="sd">        - register_completion_attributes:</span>
<span class="sd">        - runPipeline: run the current pipeline of the pipeline editor</span>
<span class="sd">        - saveParameters: save the pipeline parameters of the the current</span>
<span class="sd">          pipeline of the pipeline editor</span>
<span class="sd">        - savePipeline: save the current pipeline of the pipeline editor</span>
<span class="sd">        - savePipelineAs: save the current pipeline of the pipeline editor</span>
<span class="sd">          under another name</span>
<span class="sd">        - show_status:</span>
<span class="sd">        - stop_execution:</span>
<span class="sd">        - undo: undo the last action made on the current pipeline editor</span>
<span class="sd">        - update_auto_inheritance: get database tags for output parameters</span>
<span class="sd">        - update_node_list: update the list of nodes in workflow</span>
<span class="sd">        - updateProcessLibrary: update the library of processes when a</span>
<span class="sd">          pipeline is saved</span>
<span class="sd">        - update_project: update the project attribute of several objects</span>
<span class="sd">        - update_scans_list: update the user-selected list of scans</span>
<span class="sd">        - update_user_buttons_states: Update the visibility of initialize/</span>
<span class="sd">          run/save actions according to pipeline state</span>
<span class="sd">        - update_user_mode: update the visibility of widgets/actions</span>
<span class="sd">          depending of the chosen mode</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">item_library_clicked</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="PipelineManagerTab.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">scan_list</span><span class="p">,</span> <span class="n">main_window</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization of the Pipeline Manager tab</span>

<span class="sd">        :param project: current project in the software</span>
<span class="sd">        :param scan_list: list of the selected database files</span>
<span class="sd">        :param main_window: main window of the software</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">isControlV1</span><span class="p">():</span>
            <span class="n">Node_Controller</span> <span class="o">=</span> <span class="n">CapsulNodeController</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">Node_Controller</span> <span class="o">=</span> <span class="n">NodeController</span>

        <span class="c1"># Necessary for using MIA bricks</span>
        <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">scan_list</span>
                <span class="k">if</span> <span class="n">scan_list</span>
                <span class="k">else</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="n">main_window</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_progress_bar</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># This list is the list of scans contained in the iteration table</span>
            <span class="c1"># If it is empty, the scan list in the Pipeline Manager is the scan</span>
            <span class="c1"># list from the data_browser</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Used for the inheritance dictionary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">QWidget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span> <span class="o">=</span> <span class="n">ProcessLibraryWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">process_library</span><span class="o">.</span><span class="n">item_library_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_library_clicked</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span> <span class="o">=</span> <span class="n">PipelineEditorTabs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">node_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">process_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">switch_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">pipeline_saved</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateProcessLibrary</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span> <span class="o">=</span> <span class="n">Node_Controller</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">visibles_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span> <span class="o">=</span> <span class="n">IterationTable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">iteration_table_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_scans_list</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startedConnection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Load pipeline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadPipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Save pipeline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savePipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Save pipeline as&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savePipelineAs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="s2">&quot;Load pipeline parameters&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadParameters</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="s2">&quot;Save pipeline parameters&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveParameters</span>
        <span class="p">)</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;run32.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Run pipeline&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runPipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;stop32.png&quot;</span><span class="p">)),</span> <span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_execution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;gray_cross.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Status&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;garbage_collect.png&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;Cleanup&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
            <span class="s2">&quot;Cleanup obsolete items in the database (pipeline inits, &quot;</span>
            <span class="s2">&quot;obsolete data...). Not needed in normal situations, but useful &quot;</span>
            <span class="s2">&quot;after a reconnection (client/server) or application crash.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Initialize toolbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span> <span class="o">=</span> <span class="n">QToolBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QToolButton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span> <span class="o">=</span> <span class="n">QScrollArea</span><span class="p">()</span>
        <span class="c1"># Initialize Qt layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_view</span><span class="p">()</span>
        <span class="c1"># To undo/redo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">value_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller_value_changed</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_register_node_io_in_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">history_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register the input and output values of a node into the database.</span>

<span class="sd">        This method processes the inputs and outputs of a given node,</span>
<span class="sd">        associates them with a job, and updates the database with the</span>
<span class="sd">        appropriate values. It handles leaf processes, user-defined traits,</span>
<span class="sd">        and completion attributes, ensuring that initialization data is</span>
<span class="sd">        recorded correctly.</span>

<span class="sd">        Args:</span>
<span class="sd">            job: The job object containing parameter values and a unique</span>
<span class="sd">                 identifier (UUID).</span>
<span class="sd">            node: The node (e.g., process, pipeline, or custom node) whose</span>
<span class="sd">                  I/O values need to be registered in the database.</span>
<span class="sd">            pipeline_name (str, optional): The name of the pipeline containing</span>
<span class="sd">                                           the node. Defaults to an empty</span>
<span class="sd">                                           string.</span>
<span class="sd">            history_id (str, optional): An identifier for the history entry in</span>
<span class="sd">                                        the database. Defaults to an empty</span>
<span class="sd">                                        string.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_serialize_tmp</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Serialize temporary or special values for JSON compatibility.</span>

<span class="sd">            This function serializes specific object types, such as Undefined</span>
<span class="sd">            values, temporary paths, datetime objects, and sets, to ensure</span>
<span class="sd">            they can be safely stored in JSON format. For unsupported types,</span>
<span class="sd">            a TypeError is raised.</span>

<span class="sd">            Args:</span>
<span class="sd">                item: The object to be serialized.</span>

<span class="sd">            Returns:</span>
<span class="sd">                str, list, or the serialized representation of the item.</span>

<span class="sd">            Raises:</span>
<span class="sd">                TypeError: If the item type is not supported for serialization.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="kn">import</span> <span class="nn">soma_workflow.client</span> <span class="k">as</span> <span class="nn">swc</span>

            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Undefined</span><span class="p">,</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]):</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">swc</span><span class="o">.</span><span class="n">TemporaryPath</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;temp&gt;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">TypeError</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">PipelineNode</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)):</span>
            <span class="c1"># only leaf processes produce output data</span>
            <span class="k">return</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>

            <span class="c1"># ProcessMIA / Process_Mia specific</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;list_outputs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span>
            <span class="p">):</span>
                <span class="c1"># normally same as outputs, but it may contain an additional</span>
                <span class="c1"># &quot;notInDb&quot; key.</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>

        <span class="c1"># Fill inputs and outputs values with job</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                        <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                        <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># also get completion attributes</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">()</span>

        <span class="c1"># Adding I/O to database history</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="c1"># filter Undefined / temp</span>
            <span class="c1"># this is an overhead since we convert to/from json, and it will</span>
            <span class="c1"># be converted again in the database. But the &quot;default&quot; function</span>
            <span class="c1"># for json is not in the database API.</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">_serialize_tmp</span><span class="p">)</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="c1"># filter Undefined / temp</span>
            <span class="c1"># this is an overhead since we convert to/from json, and it will</span>
            <span class="c1"># be converted again in the database.</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">_serialize_tmp</span><span class="p">)</span>
            <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="n">node_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Updating the database with output values obtained from</span>
        <span class="c1"># initialisation. If a plug name is in outputs[&#39;notInDb&#39;], then</span>
        <span class="c1"># the corresponding output value is not added to the database.</span>
        <span class="n">notInDb</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notInDb&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug_value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">plug_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">traits</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">plug_value</span> <span class="o">!=</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">plug_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notInDb</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">pipeline_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">full_name</span> <span class="o">=</span> <span class="n">node_name</span>

                    <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plug_value_to_database</span><span class="p">(</span>
                        <span class="n">plug_value</span><span class="p">,</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                        <span class="n">history_id</span><span class="p">,</span>
                        <span class="n">node_name</span><span class="p">,</span>
                        <span class="n">plug_name</span><span class="p">,</span>
                        <span class="n">full_name</span><span class="p">,</span>
                        <span class="n">job</span><span class="p">,</span>
                        <span class="n">trait</span><span class="p">,</span>
                        <span class="n">inputs</span><span class="p">,</span>
                        <span class="n">attributes</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="c1"># Adding I/O to database history</span>
            <span class="c1"># Setting brick init state if init finished correctly</span>
            <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                <span class="n">primary_key</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">BRICK_INPUTS</span><span class="p">:</span> <span class="n">inputs</span><span class="p">,</span>
                    <span class="n">BRICK_OUTPUTS</span><span class="p">:</span> <span class="n">outputs</span><span class="p">,</span>
                    <span class="n">BRICK_INIT</span><span class="p">:</span> <span class="s2">&quot;Done&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_anim_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback which sets the animated icon frame to the status action icon</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">currentPixmap</span><span class="p">())</span>
        <span class="p">)</span>

<div class="viewcode-block" id="PipelineManagerTab.add_plug_value_to_database">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.add_plug_value_to_database">[docs]</a>
    <span class="k">def</span> <span class="nf">add_plug_value_to_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p_value</span><span class="p">,</span>
        <span class="n">brick_id</span><span class="p">,</span>
        <span class="n">history_id</span><span class="p">,</span>
        <span class="n">node_name</span><span class="p">,</span>
        <span class="n">plug_name</span><span class="p">,</span>
        <span class="n">full_name</span><span class="p">,</span>
        <span class="n">job</span><span class="p">,</span>
        <span class="n">trait</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">,</span>
        <span class="n">attributes</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the plug value to the database.</span>

<span class="sd">        :param p_value: plug value, a file name or a list of file names (any)</span>
<span class="sd">        :param brick_id: brick uuid in the database (str)</span>
<span class="sd">        :param history_id: history uuid in the database (str)</span>
<span class="sd">        :param node_name: name of the node (str)</span>
<span class="sd">        :param plug_name: name of the plug (str)</span>
<span class="sd">        :param full_name: full name of the node, including parent</span>
<span class="sd">                          brick(s) (str). If there is no parent brick,</span>
<span class="sd">                          full_name = node_name.</span>
<span class="sd">        :param job: job containing the plug (Job)</span>
<span class="sd">        :param trait: handler of the plug trait, or sub-trait if the plug is</span>
<span class="sd">                      a list (Trait). It will be used to check the value type</span>
<span class="sd">                      (file or not).</span>
<span class="sd">        :param inputs: input values for the process/node (dict)</span>
<span class="sd">        :param attributes: attributes set coming from Capsul completion engine</span>
<span class="sd">                           to be set on all outputs of the node (dict)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">)):</span>
            <span class="n">inner_trait</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_value</span><span class="p">):</span>
                <span class="n">new_attributes</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                            <span class="n">new_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">add_plug_value_to_database</span><span class="p">(</span>
                    <span class="n">elt</span><span class="p">,</span>
                    <span class="n">brick_id</span><span class="p">,</span>
                    <span class="n">history_id</span><span class="p">,</span>
                    <span class="n">node_name</span><span class="p">,</span>
                    <span class="n">plug_name</span><span class="p">,</span>
                    <span class="n">full_name</span><span class="p">,</span>
                    <span class="n">job</span><span class="p">,</span>
                    <span class="n">inner_trait</span><span class="p">,</span>
                    <span class="n">inputs</span><span class="p">,</span>
                    <span class="n">new_attributes</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">allow_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p_value</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
            <span class="n">Undefined</span><span class="p">,</span>
            <span class="p">[</span><span class="n">Undefined</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="c1"># This means that the value is not a filename</span>
            <span class="k">return</span>

        <span class="c1"># Deleting the project&#39;s folder in the file name so it can</span>
        <span class="c1"># fit to the database&#39;s syntax</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="n">p_value</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p_value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="c1"># file name is outside the project folder: don&#39;t index it in the</span>
            <span class="c1"># database</span>
            <span class="k">return</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="n">p_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p_value</span> <span class="ow">and</span> <span class="n">p_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">p_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># If the file name is already in the database,</span>
        <span class="c1"># no exception is raised, but the user is warned</span>
        <span class="n">already_in_db</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_schema</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">database_schema</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="n">p_value</span>
                <span class="p">):</span>
                    <span class="n">already_in_db</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path </span><span class="si">{</span><span class="n">p_value</span><span class="si">}</span><span class="s2"> already in database.&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>

                <span class="c1"># Adding the new brick to the output files</span>
                <span class="n">bricks</span> <span class="o">=</span> <span class="p">[</span><span class="n">brick_id</span><span class="p">]</span>
                <span class="c1"># Type tag</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

                <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_UNKNOWN</span>

                <span class="k">if</span> <span class="n">file_extension</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;.mnc&quot;</span><span class="p">,</span> <span class="s2">&quot;.ima&quot;</span><span class="p">,</span> <span class="s2">&quot;.img&quot;</span><span class="p">):</span>
                    <span class="c1"># (not all nifti but all volumes, image &quot;scans&quot;)</span>
                    <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_NII</span>

                <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.mat&quot;</span><span class="p">:</span>
                    <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_MAT</span>

                <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.txt&quot;</span><span class="p">:</span>
                    <span class="n">ptype</span> <span class="o">=</span> <span class="n">TYPE_TXT</span>

                <span class="c1"># determine which value the output should inherit its</span>
                <span class="c1"># database tags from.</span>
                <span class="c1"># Each process may have an &quot;inheritance_dict&quot; (prepared using</span>
                <span class="c1"># list_outputs() during completion, if it has this method).</span>
                <span class="c1"># If not, or if the parameter value is not found there, we</span>
                <span class="c1"># also have an &quot;auto_inheritance_dict&quot; which automatically</span>
                <span class="c1"># maps outputs to inputs. If there is no ambiguity, we can</span>
                <span class="c1"># process automatically.</span>
                <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">job</span><span class="p">,</span> <span class="s2">&quot;auto_inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">)</span>
                <span class="n">parent_files</span> <span class="o">=</span> <span class="n">inheritance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span>
                <span class="n">own_tags</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tags2del</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># the dicts may have several shapes.</span>
                <span class="c1"># Keys are output filenames (str).</span>
                <span class="c1"># Values may be:</span>
                <span class="c1"># - an input filename: get the tags from it (deprecated)</span>
                <span class="c1"># - in inheritance_dict: a dict</span>
                <span class="c1">#   {   &#39;parent&#39;: input_filename,</span>
                <span class="c1">#       &#39;own_tags&#39;: list of dict of additional forced tags</span>
                <span class="c1">#       &#39;tags2del&#39;: list of tags (str) whose value will be</span>
                <span class="c1">#                   deleted</span>
                <span class="c1">#   }</span>
                <span class="c1"># auto_inheritance_dict: a dict</span>
                <span class="c1"># - if there is no ambiguity :</span>
                <span class="c1">#    key: value of the output file (string)</span>
                <span class="c1">#    value: value of the input file (string)</span>
                <span class="c1"># - if ambiguous :</span>
                <span class="c1">#    key: output plug value (string)</span>
                <span class="c1">#    value: a dict: with key / value corresponding to each</span>
                <span class="c1">#                   possible input file</span>
                <span class="c1">#               =&gt; key: name of the input plug</span>
                <span class="c1">#               =&gt; value: value of the input plug</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">own_tags</span> <span class="o">=</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;own_tags&quot;</span><span class="p">)</span>
                    <span class="n">tags2del</span> <span class="o">=</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags2del&quot;</span><span class="p">)</span>
                    <span class="n">parent_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent_files</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]}</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">parent_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent_files</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">parent_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parent_files</span> <span class="o">=</span> <span class="n">auto_inheritance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_value</span><span class="p">,</span> <span class="p">{})</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">parent_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">parent_files</span><span class="p">}</span>

                <span class="n">db_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">field_names</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
                <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># get all tags values for inputs</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">parent_file</span> <span class="ow">in</span> <span class="n">parent_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># database_parent_file = None</span>
                    <span class="c1"># fmt: off</span>
                    <span class="n">relfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">parent_file</span><span class="p">)</span>
                    <span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">db_dir</span><span class="p">):]</span>
                    <span class="c1"># fmt: on</span>

                    <span class="k">if</span> <span class="n">relfile</span> <span class="o">==</span> <span class="n">p_value</span><span class="p">:</span>
                        <span class="c1"># output is one of the inputs: OK nothing to be done.</span>
                        <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">break</span>

                    <span class="n">scan</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_keys</span><span class="o">=</span><span class="n">relfile</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">scan</span><span class="p">:</span>
                        <span class="n">banished_tags</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">TAG_TYPE</span><span class="p">,</span>
                            <span class="n">TAG_BRICKS</span><span class="p">,</span>
                            <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
                            <span class="n">TAG_FILENAME</span><span class="p">,</span>
                            <span class="n">TAG_HISTORY</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">cvalues</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">field</span><span class="p">:</span> <span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span>
                            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">banished_tags</span>
                        <span class="p">}</span>
                        <span class="n">iscan</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                            <span class="n">primary_keys</span><span class="o">=</span><span class="n">relfile</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">iscan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cvalues</span><span class="p">}</span>
                        <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">cvalues</span>
                        <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivalues</span>

                <span class="c1"># If there are several possible inputs: there is more work</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cvalues</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">node_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="c1"># if all inputs have the same tags set: then pick either</span>
                    <span class="c1"># of them, they are all the same, there is no ambiguity</span>
                    <span class="n">eq</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">cvalues</span> <span class="ow">in</span> <span class="n">all_cvalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                        <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">first</span> <span class="o">=</span> <span class="n">cvalues</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">eq</span> <span class="o">=</span> <span class="n">cvalues</span> <span class="o">==</span> <span class="n">first</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                                <span class="k">break</span>

                    <span class="k">if</span> <span class="n">eq</span><span class="p">:</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">ivalues</span> <span class="ow">in</span> <span class="n">all_ivalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                            <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">first</span> <span class="o">=</span> <span class="n">ivalues</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">eq</span> <span class="o">=</span> <span class="n">ivalues</span> <span class="o">==</span> <span class="n">first</span>

                                <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                                    <span class="k">break</span>

                    <span class="k">if</span> <span class="n">eq</span><span class="p">:</span>
                        <span class="c1"># all values equal, no ambiguity</span>
                        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                        <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>
                        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                        <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ambiguous inputs -&gt; output</span>
                        <span class="c1"># ask the user, or use previously setup answers.</span>

                        <span class="c1"># FIXME: There is a GUI dialog here, involving user</span>
                        <span class="c1">#        interaction. This should probably be avoided</span>
                        <span class="c1">#        here in a processing loop. Some pipelines,</span>
                        <span class="c1">#        especially with iterations, may ask many</span>
                        <span class="c1">#        many questions to users. These should be</span>
                        <span class="c1">#        worked on earlier.</span>

                        <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">parent_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                            <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">old_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                            <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>

                        <span class="k">elif</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">parent_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                            <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">old_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>
                            <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">param</span><span class="p">]}</span>

                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_in_db</span><span class="p">:</span>
                            <span class="c1"># If there are attributes from completion, use</span>
                            <span class="c1"># them without asking.</span>
                            <span class="c1"># Using %s defers string formatting until needed.</span>
                            <span class="c1"># (better than f-string for logger)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;no attributes for: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">node_name</span><span class="p">,</span>
                                <span class="n">plug_name</span><span class="p">,</span>
                                <span class="n">full_name</span><span class="p">,</span>
                                <span class="n">p_value</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">pop_up</span> <span class="o">=</span> <span class="n">PopUpInheritanceDict</span><span class="p">(</span>
                                <span class="n">parent_files</span><span class="p">,</span>
                                <span class="n">full_name</span><span class="p">,</span>
                                <span class="n">plug_name</span><span class="p">,</span>
                                <span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span>
                                    <span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                            <span class="c1"># fmt: on</span>
                            <span class="n">pop_up</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">everything</span>

                            <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                                <span class="n">inheritance_dict</span> <span class="o">=</span> <span class="kc">None</span>

                                <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="kc">True</span>
                                    <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">value</span>

                                <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>
                                    <span class="p">)</span>

                                <span class="n">inheritance_dict</span><span class="p">[</span><span class="n">old_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="n">all_cvalues</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">all_cvalues</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
                                <span class="p">}</span>
                                <span class="n">all_ivalues</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">all_ivalues</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
                                <span class="p">}</span>

                <span class="n">cvalues</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">TAG_TYPE</span><span class="p">:</span> <span class="n">ptype</span><span class="p">,</span>
                    <span class="n">TAG_BRICKS</span><span class="p">:</span> <span class="n">bricks</span><span class="p">,</span>
                    <span class="n">TAG_HISTORY</span><span class="p">:</span> <span class="n">history_id</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ivalues</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">TAG_TYPE</span><span class="p">:</span> <span class="n">ptype</span><span class="p">,</span>
                    <span class="n">TAG_BRICKS</span><span class="p">:</span> <span class="n">bricks</span><span class="p">,</span>
                    <span class="n">TAG_HISTORY</span><span class="p">:</span> <span class="n">history_id</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># from here if we still have several tags sets,</span>
                <span class="c1"># we do not assign them at all. Otherwise, set them.</span>

                <span class="c1"># Adding inherited tags</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cvalues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ivalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_ivalues</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
                    <span class="n">cvalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_cvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

                <span class="c1"># use also completion attributes values</span>
                <span class="n">cvalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">ivalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">own_tags</span><span class="p">:</span>

                    <span class="c1"># own_tags may insert new fields in the database</span>
                    <span class="k">for</span> <span class="n">tag_to_add</span> <span class="ow">in</span> <span class="n">own_tags</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                            <span class="n">database_schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;collection_name&quot;</span><span class="p">:</span> <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                                    <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="p">(</span>
                                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span>
                                    <span class="p">),</span>
                                <span class="p">}</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                            <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">database_schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;collection_name&quot;</span><span class="p">:</span> <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                                    <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="p">(</span>
                                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span>
                                    <span class="p">),</span>
                                <span class="p">}</span>
                            <span class="p">)</span>

                        <span class="n">cvalues</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                        <span class="n">ivalues</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">cvalues</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">ivalues</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">tags2del</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">tag_to_del</span> <span class="ow">in</span> <span class="n">tags2del</span><span class="p">:</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">database_data</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                                <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">tag_to_del</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c1"># The collection does not exist</span>
                            <span class="c1"># or the field does not exist</span>
                            <span class="c1"># or the document does not exist</span>
                            <span class="k">pass</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">database_data</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                                <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">tag_to_del</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c1"># The collection does not exist</span>
                            <span class="c1"># or the field does not exist</span>
                            <span class="c1"># or the document does not exist</span>
                            <span class="k">pass</span></div>


<div class="viewcode-block" id="PipelineManagerTab.ask_iterated_pipeline_plugs">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.ask_iterated_pipeline_plugs">[docs]</a>
    <span class="k">def</span> <span class="nf">ask_iterated_pipeline_plugs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens a dialog to configure pipeline plugs for iteration or</span>
<span class="sd">        database connection.</span>

<span class="sd">        This method displays a dialog allowing the user to specify which</span>
<span class="sd">        pipeline plugs should be iterated, not iterated, or connected to a</span>
<span class="sd">        database filter (input_filter node). The user can configure inputs</span>
<span class="sd">        and outputs of the pipeline, and the configuration is returned upon</span>
<span class="sd">        acceptance of the dialog.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline: The pipeline object whose plugs need to be configured.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                - iterated_plugs (list): A list of plug names marked for</span>
<span class="sd">                                        iteration.</span>
<span class="sd">                - database_plugs (list): A list of plug names connected to</span>
<span class="sd">                                        the database.</span>

<span class="sd">            Returns `None` if the dialog is canceled by the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_db_compat</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">plug</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if a pipeline plug is compatible with a database filter.</span>

<span class="sd">            This helper function verifies whether a plug can be connected to</span>
<span class="sd">            a database filter based on its trait type.</span>

<span class="sd">            Args:</span>
<span class="sd">                process: The process or pipeline containing the plug.</span>
<span class="sd">                plug: The name of the plug to check.</span>

<span class="sd">            Returns:</span>
<span class="sd">                bool: True if the plug is compatible with a database filter,</span>
<span class="sd">                      False otherwise.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">iter_clicked</span><span class="p">(</span><span class="n">param_btns</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Handle toggle events for the iteration checkbox.</span>

<span class="sd">            When the iteration checkbox is toggled off, it ensures that the</span>
<span class="sd">            corresponding database checkbox is also unchecked.</span>

<span class="sd">            Args:</span>
<span class="sd">                param_btns (list): List of parameter button configurations.</span>
<span class="sd">                p (int): Index of the plug in the parameter list.</span>
<span class="sd">                state (bool): The current state of the iteration checkbox.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">param_btns</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_btns</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">db_clicked</span><span class="p">(</span><span class="n">param_btns</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Handle toggle events for the database checkbox.</span>

<span class="sd">            When the database checkbox is toggled on, it ensures that the</span>
<span class="sd">            corresponding iteration checkbox is also checked.</span>

<span class="sd">            Args:</span>
<span class="sd">                param_btns (list): List of parameter button configurations.</span>
<span class="sd">                p (int): Index of the plug in the parameter list.</span>
<span class="sd">                state (bool): The current state of the database checkbox.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">param_btns</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">dialog</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialog</span><span class="p">()</span>
        <span class="n">buttonbox</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Cancel</span>
        <span class="p">)</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Iterate over parameters:&quot;</span><span class="p">)</span>
        <span class="n">pblayout</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">pblayout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">scroll</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">()</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">scroll</span><span class="o">.</span><span class="n">NoFrame</span><span class="p">)</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setViewportMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pblayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">scroll</span><span class="p">)</span>
        <span class="n">param_lay</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">()</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">wid</span><span class="p">)</span>
        <span class="n">wid</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_lay</span><span class="p">)</span>
        <span class="n">param_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">pblayout</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">buttonbox</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        <span class="n">buttonbox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">buttonbox</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;iter. / database:&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;iter.:&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_lay</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="n">param_btns</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>  <span class="c1"># inputs, outputs</span>
        <span class="n">forbidden</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nodes_activation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selection_changed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pipeline_steps&quot;</span><span class="p">,</span>
            <span class="s2">&quot;visible_groups&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>

                <span class="k">if</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">forbidden</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">it_btn</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">()</span>
                <span class="n">db_btn</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">db_btn</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">()</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_db_compat</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">plug</span><span class="p">):</span>
                        <span class="n">db_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="mi">4</span>

                <span class="n">it_btn</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">iter_clicked</span><span class="p">,</span> <span class="n">param_btns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">it_btn</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">db_btn</span><span class="p">:</span>
                    <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">db_btn</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">db_btn</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">db_clicked</span><span class="p">,</span> <span class="n">param_btns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">param_lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">plug</span><span class="p">),</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">param_btns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">plug</span><span class="p">,</span> <span class="n">it_btn</span><span class="p">,</span> <span class="n">db_btn</span><span class="p">])</span>
                <span class="n">it_btn</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">param_lay</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">Accepted</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">iterated_plugs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">database_plugs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">param_btns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">iterated_plugs</span><span class="p">,</span> <span class="n">database_plugs</span></div>


<div class="viewcode-block" id="PipelineManagerTab.build_iterated_pipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.build_iterated_pipeline">[docs]</a>
    <span class="k">def</span> <span class="nf">build_iterated_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a new pipeline with an iteration node, iterating over the current</span>
<span class="sd">        pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>
        <span class="n">pipeline_name</span> <span class="o">=</span> <span class="s2">&quot;Iteration_pipeline&quot;</span>
        <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;Pipeline&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">):</span>
            <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span>

            <span class="k">if</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
                <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># get interactively iterated plugs and plugs that should be connected</span>
        <span class="c1"># to an input_filter node</span>
        <span class="n">iterated_plugs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_iterated_pipeline_plugs</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iterated_plugs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># abort</span>

        <span class="n">iterated_plugs</span><span class="p">,</span> <span class="n">database_plugs</span> <span class="o">=</span> <span class="n">iterated_plugs</span>

        <span class="c1"># if the pipeline is an unconnected inner node, fix it</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;parent_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">parent_pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">parent_pipeline</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;update_nodes_and_plugs_activation&quot;</span><span class="p">):</span>
                <span class="c1"># only if it is a pipeline - a single node does not have it</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>

        <span class="c1"># input_filer node outputs a single list. Some processes (before</span>
        <span class="c1"># iteration) already take a list as input, which will end up with a</span>
        <span class="c1"># double list (list of lists) in the iteration pipeline. To overcome</span>
        <span class="c1"># this, we use a single input for each iteration (list of one element)</span>
        <span class="c1"># before actually building the iterative pipeline. In other words,</span>
        <span class="c1"># we insert Reduce nodes before list inputs which will be</span>
        <span class="c1"># connected to the database inputs</span>
        <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">database_plugs</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;pipeline_node&quot;</span><span class="p">):</span>

                <span class="c1"># propagate non-completion status</span>
                <span class="c1"># (TODO: needs something better)</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">plug</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">:</span>
                    <span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_trait</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                <span class="c1"># &quot;pipeline&quot; is actually a single process (or should, if it</span>
                <span class="c1"># is not a # pipeline). Get it into a pipeline (with a</span>
                <span class="c1"># single node) to  make the workflow.</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span>
                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">set_study_config</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">study_config</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;.&quot;</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                <span class="p">):</span>
                    <span class="n">old_node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                            <span class="s2">&quot;.&quot;</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">old_node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>

                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">old_node_name</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>
                <span class="n">new_pipeline</span><span class="o">.</span><span class="n">autoexport_nodes_parameters</span><span class="p">(</span><span class="n">include_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">new_pipeline</span>
                <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">old_node_name</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;un_list_</span><span class="si">{</span><span class="n">plug</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">ftol</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">add_custom_node</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span>
                    <span class="s2">&quot;capsul.pipeline.custom_nodes.reduce_node.ReduceNode&quot;</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;input_types&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;File&quot;</span><span class="p">]},</span>
                <span class="p">)</span>
                <span class="n">ftol</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># reconnect all former connection from this plug to their</span>
                <span class="c1"># destination, from the output of the ftol node</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">plug</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">):</span>
                    <span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.outputs-&gt;</span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># then remove the former pipeline plug, and re-create it by</span>
                <span class="c1"># exporting the input of the ftol node</span>
                <span class="c1"># keep traits order</span>
                <span class="n">old_traits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">remove_trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">export_parameter</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="s2">&quot;input_0&quot;</span><span class="p">,</span> <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">plug</span>
                <span class="p">)</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span><span class="o">.</span><span class="n">forbid_completion</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">reorder_traits</span><span class="p">(</span><span class="n">old_traits</span><span class="p">)</span>

        <span class="c1"># now replace the pipeline with an iterative node</span>
        <span class="n">iteration_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;iterated_</span><span class="si">{</span><span class="n">iteration_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">it_pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_iteration_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">iteration_name</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="p">,</span>
            <span class="n">iterative_plugs</span><span class="o">=</span><span class="n">iterated_plugs</span><span class="p">,</span>
            <span class="n">do_not_export</span><span class="o">=</span><span class="n">database_plugs</span><span class="p">,</span>
            <span class="n">make_optional</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># plugs which should be connected to a database filter: add some</span>
        <span class="c1"># Input_Filter nodes for them, and connect them to the special</span>
        <span class="c1"># database_scans input</span>
        <span class="n">in_filter_not_found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">database_plugs</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">in_filter</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes.bricks.tools.Input_Filter&quot;</span>
                <span class="p">)</span>
                <span class="n">in_filter</span><span class="o">.</span><span class="n">pipmantab</span> <span class="o">=</span> <span class="bp">self</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">in_filter_not_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input filter not found in library.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plug</span><span class="si">}</span><span class="s2">_filter&quot;</span>
            <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">in_filter</span><span class="p">)</span>
            <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.output-&gt;</span><span class="si">{</span><span class="n">iteration_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">plug</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># If database_scans is already a pipeline global input, the plug</span>
            <span class="c1"># cannot be exported. A link as to be added between database_scans</span>
            <span class="c1"># and the input of the filter.</span>
            <span class="k">if</span> <span class="s2">&quot;database_scans&quot;</span> <span class="ow">in</span> <span class="n">it_pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;database_scans-&gt;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.input&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_traits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it_pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">export_parameter</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">pipeline_parameter</span><span class="o">=</span><span class="s2">&quot;database_scans&quot;</span>
                <span class="p">)</span>
                <span class="n">it_pipeline</span><span class="o">.</span><span class="n">reorder_traits</span><span class="p">([</span><span class="s2">&quot;database_scans&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">old_traits</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_filter_not_found</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">iterated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">it_pipeline</span></div>


<div class="viewcode-block" id="PipelineManagerTab.check_requirements">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.check_requirements">[docs]</a>
    <span class="k">def</span> <span class="nf">check_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="s2">&quot;global&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check and return the configuration of a pipeline based on its</span>
<span class="sd">        requirements.</span>

<span class="sd">        This method iterates through the nodes in the pipeline, gathers their</span>
<span class="sd">        requirements, and determines the appropriate configuration for each</span>
<span class="sd">        node in the specified environment. It uses the settings from the study</span>
<span class="sd">        configuration engine to select configurations that match the</span>
<span class="sd">        requirements.</span>

<span class="sd">        Args:</span>
<span class="sd">            environment (str, optional): The target environment for checking</span>
<span class="sd">                                         configurations. Defaults to &quot;global&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary where the keys are pipeline nodes and the values</span>
<span class="sd">                  are the configurations selected for each node based on their</span>
<span class="sd">                  requirements.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config_pipeline</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">requirements</span><span class="p">()</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span>
            <span class="n">config_pipeline</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="n">req</span><span class="p">)}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">config_pipeline</span></div>


<div class="viewcode-block" id="PipelineManagerTab.cleanup_older_init">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.cleanup_older_init">[docs]</a>
    <span class="k">def</span> <span class="nf">cleanup_older_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove non-existent entries from the databrowser.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">brick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cleanup brick </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">brick</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">delete_from_brick</span><span class="p">(</span><span class="n">brick</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">QtThreadCall</span><span class="p">()</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.complete_pipeline_parameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.complete_pipeline_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">complete_pipeline_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically complete pipeline parameters using Capsul&#39;s completion</span>
<span class="sd">        engine.</span>

<span class="sd">        This method utilizes Capsul&#39;s completion engine to automatically</span>
<span class="sd">        populate the parameters of a pipeline based on a set of attributes.</span>
<span class="sd">        These attributes can be retrieved from an associated database. If no</span>
<span class="sd">        pipeline is specified, the current pipeline or process is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (Pipeline, optional): The pipeline object to be completed.</span>
<span class="sd">                                           If not provided, the method</span>
<span class="sd">                                           retrieves the current pipeline</span>
<span class="sd">                                           or process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: It seems that the following line is only used for UTs (test.</span>
        <span class="c1">#        testMIAPipelineManageTab.test_complete_pipeline_parameters).</span>
        <span class="c1">#        I think we could find a cleaner way ...</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>

        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
            <span class="n">completion</span><span class="o">.</span><span class="n">complete_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.controller_value_changed">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.controller_value_changed">[docs]</a>
    <span class="k">def</span> <span class="nf">controller_value_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update history when a pipeline node is changed</span>

<span class="sd">        :param signal_list: list of the needed parameters to update history.</span>
<span class="sd">                            [&quot;plug_value&quot; or &quot;node_name&quot;, node_name, old_value,</span>
<span class="sd">                            plug_name, plug_name_type, new_value]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">signal_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># For history</span>
        <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="s2">&quot;node_name&quot;</span><span class="p">:</span>
            <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;update_node_name&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">signal_list</span><span class="p">:</span>
                <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

            <span class="c1"># update pipeline view</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">()</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
            <span class="n">editor</span><span class="o">.</span><span class="n">setTransform</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="s2">&quot;plug_value&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">signal_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;protected_parameters&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;protected_parameters_items&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;selection_changed&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;trait_added&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;user_traits_changed&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="ow">or</span> <span class="n">signal_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">signal_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">signal_list</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span>

            <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;update_plug_value&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">signal_list</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">]:</span>
                    <span class="n">element</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">history_maker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="c1"># For history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.displayNodeParameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.displayNodeParameters">[docs]</a>
    <span class="k">def</span> <span class="nf">displayNodeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the node controller when a node is clicked</span>

<span class="sd">        :param node_name: name of the node to display parameters</span>
<span class="sd">        :param process: process instance of the corresponding node</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">display_parameters</span><span class="p">(</span>
            <span class="n">node_name</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.finish_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.finish_execution">[docs]</a>
    <span class="k">def</span> <span class="nf">finish_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback called after a pipeline execution ends (in any way)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">soma_workflow</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">swconstants</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish_execution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_run_pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;exec_id&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Execution aborted before running&quot;</span><span class="p">)</span>

            <span class="n">engine</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">WorkflowExecutionError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;When the pipeline was launched, the following &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;exception was raised: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">...&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pipeline &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span><span class="si">}</span><span class="s2">&#39; has not &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;been correctly run.&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pipeline &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span><span class="si">}</span><span class="s2">&#39; has been &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;correctly run.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_DONE</span><span class="p">:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;green_v.png&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;red_cross32.png&quot;</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span>
            <span class="n">QIcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="n">icon</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span>
        <span class="n">Qt</span><span class="o">.</span><span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.remove_progress">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.remove_progress">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove and clean up the progress widget.</span>

<span class="sd">        This method ensures that the progress widget is properly cleaned up</span>
<span class="sd">        and deleted to free up resources. It performs the following steps:</span>
<span class="sd">            1. Calls the `cleanup` method on the progress widget.</span>
<span class="sd">            2. Closes the widget to remove it from view.</span>
<span class="sd">            3. Deletes the widget later to free memory.</span>
<span class="sd">            4. Deletes the reference to the progress widget from the instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="c1"># self.hLayout.removeWidget(self.progress)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span></div>


<div class="viewcode-block" id="PipelineManagerTab.garbage_collect">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.garbage_collect">[docs]</a>
    <span class="k">def</span> <span class="nf">garbage_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform cleanup of obsolete data and database entries.</span>

<span class="sd">        This method indexes finished brick executions, identifies and removes</span>
<span class="sd">        obsolete bricks and data, and performs postprocessing on the database</span>
<span class="sd">        to ensure it remains consistent and up-to-date. It also updates the</span>
<span class="sd">        user interface and the state of the pipeline editor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postprocess_pipeline_execution</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">(),</span> <span class="s2">&quot;initialized&quot;</span>
            <span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">initialized</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_user_buttons_states</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.get_capsul_engine">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_capsul_engine">[docs]</a>
    <span class="k">def</span> <span class="nf">get_capsul_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a CapsulEngine object from the edited pipeline, and set it up from</span>
<span class="sd">        MIA config object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.get_pipeline_or_process">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_pipeline_or_process">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pipeline_or_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the input pipeline or its sole unconnected child process.</span>

<span class="sd">        This method retrieves the pipeline currently being edited in the GUI</span>
<span class="sd">        or returns its single unconnected child process if applicable. This</span>
<span class="sd">        allows a single process node to be used as a pipeline for iteration or</span>
<span class="sd">        execution from the GUI.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (Pipeline, optional):</span>
<span class="sd">                The pipeline to evaluate. If not provided, the method</span>
<span class="sd">                retrieves the currently selected pipeline from the editor GUI.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pipeline or Process:</span>
<span class="sd">                - If the pipeline has a single child process node that is not</span>
<span class="sd">                  connected to other nodes, the child process is returned.</span>
<span class="sd">                - Otherwise, the input pipeline is returned.</span>

<span class="sd">        Behavior:</span>
<span class="sd">            - If `pipeline` is not specified, the currently selected pipeline</span>
<span class="sd">              pipeline editor is used.</span>
<span class="sd">            - If the pipeline contains only two nodes (the root node and one</span>
<span class="sd">              process node) and the root node has no plugs, the method returns</span>
<span class="sd">              the child process instead of the entire pipeline.</span>

<span class="sd">        Example Use Case:</span>
<span class="sd">            This method is useful for scenarios where a single process node</span>
<span class="sd">            can act as a simplified pipeline, facilitating iterations or</span>
<span class="sd">            execution in a GUI-based workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="o">.</span><span class="n">plugs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>

        <span class="k">return</span> <span class="n">pipeline</span></div>


<div class="viewcode-block" id="PipelineManagerTab.get_missing_mandatory_parameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.get_missing_mandatory_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_missing_mandatory_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check on missing parameters for each job&quot;&quot;&quot;</span>
        <span class="n">missing_mandatory_param</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
            <span class="p">):</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get_missing_mandatory_parameters</span><span class="p">():</span>

                <span class="c1"># we must also check that the parameter is not a temporary</span>
                <span class="c1"># in the workflow</span>
                <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">j</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">process</span><span class="p">()</span> <span class="ow">is</span> <span class="n">node</span>
                    <span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="c1"># gets a non-null value in the workflow</span>
                            <span class="k">continue</span>

                <span class="c1"># fmt: off</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">node</span> <span class="ow">is</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span>
                        <span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">pipeline_node</span>
                <span class="p">):</span>
                    <span class="n">item_name</span> <span class="o">=</span> <span class="n">item</span>
                <span class="c1"># fmt: on</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">missing_mandatory_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">missing_mandatory_param</span></div>


<div class="viewcode-block" id="PipelineManagerTab.initialize">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.initialize">[docs]</a>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean previous initialization then initialize the current pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">setOverrideCursor</span><span class="p">(</span><span class="n">QCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WaitCursor</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_older_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_pipeline</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
                <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error during initialisation of the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline...&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Pipeline &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; was not initialised successfully.&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_current_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">())</span><span class="o">.</span><span class="n">node_parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">node_parameters_tmp</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_current_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.init_pipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.init_pipeline">[docs]</a>
    <span class="k">def</span> <span class="nf">init_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the current pipeline of the pipeline editor</span>

<span class="sd">        :param pipeline: not None if this method call a sub-pipeline</span>
<span class="sd">        :param pipeline_name: name of the parent pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Pipeline initializing&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  *********************&quot;</span><span class="p">)</span>
        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="c1"># If the initialisation is launch for the main pipeline</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">get_process_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">())</span>
            <span class="n">main_pipeline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Process</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span>
            <span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_1&quot;</span>
                <span class="c1"># FIXME: We leave the possibility of launching a brick without</span>
                <span class="c1">#        exporting all the plugs. I don&#39;t know if there could</span>
                <span class="c1">#        be a side effect. To be seen...</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_pipeline</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline is getting initialized. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Please wait...&quot;</span>
        <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="c1"># complete config for completion</span>
        <span class="n">study_config</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
        <span class="n">study_config</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">req_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">init_messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># completion / retrieve workflow</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Workflow generation / completion for the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline...&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow_from_pipeline</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">check_requirements</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">complete_parameters</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Workflow done!&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">traceback_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">))</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error when building the workflow for the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;pipeline:</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">,</span> <span class="s2">&quot;jobs&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">init_result</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline was not successfully initialised...&quot;</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span>
                    <span class="o">-</span><span class="nb">int</span><span class="p">(</span>
                        <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                            <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">modf</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialisation phase completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">s!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Pipeline initialization warning!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="s2">&quot;No bricks were detected when the workflow was &quot;</span>
                <span class="s2">&quot;generated...!</span><span class="se">\n</span><span class="s2">Please check that the pipeline has &quot;</span>
                <span class="s2">&quot;been correctly built and configured (have all the necessary &quot;</span>
                <span class="s2">&quot;plugs been exported? have all the input parameters been &quot;</span>
                <span class="s2">&quot;set?, etc.)&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span><span class="p">)</span>
            <span class="n">yes_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
                <span class="s2">&quot;Open MIA preferences&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesRole</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">yes_button</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">software_preferences_pop_up</span><span class="p">()</span>
                <span class="c1"># fmt: off</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">pop_up_preferences</span><span class="o">.</span>
                    <span class="n">tab_widget</span><span class="o">.</span><span class="n">setCurrentIndex</span>
                <span class="p">)(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># fmt: on</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline was not initialised successfully...&quot;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">err_mess</span> <span class="ow">in</span> <span class="n">init_messages</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err_mess</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">init_result</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># retrieve node list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_node_list</span><span class="p">(</span><span class="n">brick</span><span class="o">=</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="c1"># check missing mandatory parameters</span>
            <span class="n">missing_mandat_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_mandatory_parameters</span><span class="p">()</span>
            <span class="c1"># check requirements</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_requirements</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing_mandat_param</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_mandat_param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_mandat_param</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing mandatory parameters in &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline:</span><span class="se">\n</span><span class="s2">    - &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">requirements</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">check_requirements</span><span class="p">(</span><span class="n">message_list</span><span class="o">=</span><span class="n">req_messages</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pipeline requirements are not met:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_messages</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current configuration:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">study_config</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">export_config_dict</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">req_messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Please see the standard output for more information.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># FIXME: Would it be better to write a general method for</span>
            <span class="c1">#        testing all modules (currently each module test is</span>
            <span class="c1">#        hard coded below)?</span>
            <span class="c1"># FIXME: Are these tests compatible with remote run?</span>
            <span class="c1"># FIXME: Make a requirement check for FreeSurfer:</span>
            <span class="k">for</span> <span class="n">req_node</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;.&quot;</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                <span class="p">):</span>
                    <span class="n">req_node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                            <span class="s2">&quot;.&quot;</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">req_node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">req_node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">req_node</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>

                <span class="c1"># FreeSurfer</span>

                <span class="c1"># FSL:</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.fsl&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need FSL</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.fsl&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.fsl&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires FSL but it &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;seems FSL is not configured in Mia &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires FSL but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems FSL is not configured in Mia &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># AFNI:</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.afni&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need AFNI</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.afni&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.afni&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires AFNI but it &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;seems AFNI is not configured in Mia &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires AFNI but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems AFNI is not configured in Mia &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># ANTS:</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.ants&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need ANTS</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.ants&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.ants&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires ANTS but it &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;seems ANTS is not configured in Mia &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires ANTS but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems ANTS is not configured in Mia &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># Matlab:</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.matlab&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                        <span class="c1"># or Config().get_use_spm_standalone()</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need matlab</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.matlab&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_spm</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span>
                            <span class="n">req_node</span>
                        <span class="p">][</span><span class="s2">&quot;capsul.engine.module.matlab&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;executable&quot;</span><span class="p">,</span> <span class="kc">False</span>
                        <span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires Matlab but it &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;seems Matlab is not configured in Mia &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_spm_standalone</span><span class="p">()</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                                <span class="s2">&quot;capsul.engine.module.matlab&quot;</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mcr_directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires Matlab MCR &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;but it seems Matlab MCR is not configured &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;in Mia preferences.&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires Matlab but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems Matlab is not configured in Mia &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># mrtrix:</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.mrtrix&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need mrtrix</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.mrtrix&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.mrtrix&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires MRtrix but it &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;seems MRtrix is not configured in Mia &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires MRtrix but it &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;seems MRtrix is not configured in Mia &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># SPM</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span><span class="s2">&quot;capsul_engine&quot;</span><span class="p">][</span><span class="s2">&quot;uses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;capsul.engine.module.spm&quot;</span>
                        <span class="p">)</span>
                        <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># The process don&#39;t need spm</span>
                    <span class="k">pass</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.spm&quot;</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.spm&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires SPM but it &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;seems SPM is not configured in Mia &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;preferences.&quot;</span>
                            <span class="p">)</span>

                        <span class="k">elif</span> <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                            <span class="s2">&quot;capsul.engine.module.spm&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;standalone&quot;</span><span class="p">]:</span>

                            <span class="c1"># if Config().get_matlab_standalone_path() is None:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_use_matlab_standalone</span><span class="p">():</span>
                                <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires SPM but &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;it seems that in Mia preferences, SPM &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;has been configured as standalone &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;while matlab MCR is not configured.&quot;</span>
                                <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">requirements</span><span class="p">[</span><span class="n">req_node</span><span class="p">][</span>
                                    <span class="s2">&quot;capsul.engine.module.matlab&quot;</span>
                                <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executable&quot;</span><span class="p">)</span>

                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires SPM but &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;it seems that in Mia preferences, SPM &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;has been configured as non-standalone &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;while matlab with license is not &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;configured.&quot;</span>
                                <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">req_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">req_node_name</span><span class="si">}</span><span class="s2"> requires SPM but it seems &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;SPM is not configured in Mia preferences.&quot;</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req_messages</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_messages</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The pipeline requirements are not met for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;pipeline:</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="c1"># Check that completion for output parameters is fine (for each job)</span>
        <span class="n">missing_mandat_out_param</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missing_all_out_param</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
                    <span class="p">):</span>
                        <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                <span class="s2">&quot;.&quot;</span>
                            <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                    <span class="c1"># All output plugs (except spm_script_file),</span>
                    <span class="c1"># optional or not:</span>
                    <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">trait_name</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">trait_name</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;spm_script_file&quot;</span><span class="p">,</span> <span class="s2">&quot;_spm_script_file&quot;</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="c1"># If none of the outputs have a value, there is a problem.</span>
                    <span class="c1"># Checked only for ProcessMIA bricks because it seems that</span>
                    <span class="c1"># for some nipype processes the output parameters are only</span>
                    <span class="c1"># generated at runtime (for example:</span>
                    <span class="c1"># nipype.interfaces.utility.base.Rename).</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">output_name</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span>
                        <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">output_names</span>
                    <span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessMIA</span><span class="p">):</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">missing_all_out_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>

                    <span class="c1"># All output plugs (except spm_script_file), not optional</span>
                    <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">trait_name</span>
                        <span class="k">for</span> <span class="n">trait_name</span> <span class="ow">in</span> <span class="n">output_names</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span>
                    <span class="p">]</span>

                    <span class="c1"># If a non-optional output has no value, there&#39;s issue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="n">output_name</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span>
                        <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">output_names</span>
                    <span class="p">):</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">missing_mandat_out_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;init_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;An issue has been detected when initializing &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;the &#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&#39; brick in the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;pipeline.</span><span class="se">\n</span><span class="s2">The pipeline cannot be launched &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;under these conditions...</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_mandat_out_param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_mandat_out_param</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing mandatory output parameter(s) for the following &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;brick(s) in the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline:</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_all_out_param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_all_out_param</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;None of the output parameters have been completed for the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;following brick(s) in the &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline.</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{</span><span class="n">mes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please check the configuration and input parameters for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;these bricks...&quot;</span>
            <span class="p">)</span>
            <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssg</span><span class="p">)</span>

        <span class="c1"># with self.project.database.data(write=True) as database_data:</span>

        <span class="k">if</span> <span class="n">init_result</span><span class="p">:</span>
            <span class="c1"># add pipeline to the history collection</span>
            <span class="n">history_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_HISTORY</span><span class="p">,</span> <span class="n">history_id</span><span class="p">)</span>
                <span class="c1"># serialize pipeline</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Iteration_pipeline&quot;</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">list_process_in_pipeline</span><span class="p">:</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">ProcessIteration</span><span class="p">):</span>
                            <span class="n">inner_pipeline</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">process</span>
                            <span class="k">break</span>

                    <span class="n">pipeline_tools</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span>
                        <span class="n">inner_pipeline</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pipeline_tools</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span>
                        <span class="n">pipeline</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span>
                    <span class="p">)</span>

                <span class="n">pipeline_xml</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">history_id</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">HISTORY_PIPELINE</span><span class="p">:</span> <span class="n">pipeline_xml</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="c1"># add process characteristics in the database</span>
            <span class="c1"># if init is otherwise OK</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
                        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>

                    <span class="c1"># trick to eliminate &quot;ReduceJob&quot; in jobs would it be</span>
                    <span class="c1"># better to test if process is a ReduceNode ?</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">):</span>
                        <span class="n">node_name</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">context_name</span>

                        <span class="k">if</span> <span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
                            <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">update_auto_inheritance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_inheritance</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

                        <span class="c1"># Adding the brick to the bricks history</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">PipelineNode</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)):</span>
                            <span class="c1"># check if brick_id has already been assigned</span>
                            <span class="n">brick_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">brick_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">brick_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">brick_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">brick_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

                            <span class="c1"># set brick_id in process</span>
                            <span class="n">job</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">brick_id</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">brick_id</span><span class="p">)</span>

                            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span>
                                <span class="n">write</span><span class="o">=</span><span class="kc">True</span>
                            <span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
                                        <span class="n">COLLECTION_BRICK</span><span class="p">,</span> <span class="n">brick_id</span>
                                    <span class="p">)</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="c1"># id is not unique. It happens in</span>
                                    <span class="c1"># iterations</span>
                                    <span class="c1"># FIXME: we need a better way to handle</span>
                                    <span class="c1">#        UUIDs in iterated processes</span>
                                    <span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">init_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;Error while setting job uuid on &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&#39; brick.&quot;</span>
                                    <span class="p">)</span>

                                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                                    <span class="n">primary_key</span><span class="o">=</span><span class="n">brick_id</span><span class="p">,</span>
                                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span>
                                        <span class="n">BRICK_NAME</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
                                        <span class="n">BRICK_INIT_TIME</span><span class="p">:</span> <span class="p">(</span>
                                            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                                        <span class="p">),</span>
                                        <span class="n">BRICK_INIT</span><span class="p">:</span> <span class="s2">&quot;Not Done&quot;</span><span class="p">,</span>
                                        <span class="n">BRICK_EXEC</span><span class="p">:</span> <span class="s2">&quot;Not Done&quot;</span><span class="p">,</span>
                                    <span class="p">},</span>
                                <span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">_register_node_io_in_database</span><span class="p">(</span>
                                <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="p">,</span> <span class="n">history_id</span>
                            <span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="c1"># add bricklist into history collection</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_HISTORY</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">history_id</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span><span class="n">HISTORY_BRICKS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span><span class="p">},</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_completion_attributes</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">saveModifications</span><span class="p">()</span>

        <span class="c1"># Updating the node controller</span>
        <span class="c1"># Display the updated parameters in right part of</span>
        <span class="c1"># the Pipeline Manager (controller)</span>
        <span class="k">if</span> <span class="n">main_pipeline</span><span class="p">:</span>
            <span class="n">node_controller_node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">node_name</span>

            <span class="c1"># TODO: Fix the problem of the controller that</span>
            <span class="c1">#       keeps the name of the old brick deleted until</span>
            <span class="c1">#       a click on the new one. This can cause a Mia</span>
            <span class="c1">#       crash during the initialisation, for example.</span>

            <span class="k">if</span> <span class="n">node_controller_node_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">]:</span>
                <span class="n">node_controller_node_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">process</span> <span class="o">=</span> <span class="n">pipeline</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">node_controller_node_name</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span>
            <span class="p">):</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_controller_node_name</span><span class="p">]</span><span class="o">.</span><span class="n">process</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">display_parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">node_name</span><span class="p">,</span>
                <span class="n">process</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">init_result</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span>
                        <span class="o">-</span><span class="nb">int</span><span class="p">(</span>
                            <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                                <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">modf</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

                <span class="k">if</span> <span class="n">init_messages</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The pipeline could not be initialized properly:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">mssg</span> <span class="ow">in</span> <span class="n">init_messages</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">- </span><span class="si">{</span><span class="n">mssg</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The pipeline could not be initialized &quot;</span>
                        <span class="s2">&quot;correctly, for an unknown reason!&quot;</span>
                    <span class="p">)</span>

                <span class="n">lineCnt</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Pipeline initialization warning!&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lineCnt</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">scroll</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">()</span>
                    <span class="n">scroll</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
                    <span class="n">scroll</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">tmpLabel</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">tmpLabel</span><span class="o">.</span><span class="n">setTextInteractionFlags</span><span class="p">(</span>
                        <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextSelectableByMouse</span>
                    <span class="p">)</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">tmpLabel</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span>
                        <span class="n">scroll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
                        <span class="s2">&quot;QScrollArea{min-width:550 px; min-height: 300px}&quot;</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span><span class="p">)</span>

                <span class="n">yes_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
                    <span class="s2">&quot;Open MIA preferences&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesRole</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">yes_button</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">software_preferences_pop_up</span><span class="p">()</span>
                    <span class="c1"># fmt: off</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">pop_up_preferences</span><span class="o">.</span>
                        <span class="n">tab_widget</span><span class="o">.</span><span class="n">setCurrentIndex</span>
                    <span class="p">)(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># fmt: on</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline was not initialised successfully.&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&quot;</span><span class="si">%s</span><span class="s1">&quot; pipeline was not successfully initialised.&#39;</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_editor_by_index</span><span class="p">(</span>
                        <span class="n">i</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; pipeline has been successfully initialised.&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&quot;</span><span class="si">%s</span><span class="s1">&quot; pipeline has been successfully initialised.&#39;</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span>
                        <span class="o">-</span><span class="nb">int</span><span class="p">(</span>
                            <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                                <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">modf</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

        <span class="c1"># FIXME: I don&#39;t understand when main_pipeline can be False. If it is,</span>
        <span class="c1">#        we&#39;ll get an exception because duration won&#39;t be</span>
        <span class="c1">#        defined (done in the &quot;if main_pipeline:&quot;!).</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialisation phase completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">s!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">init_result</span></div>


<div class="viewcode-block" id="PipelineManagerTab.layout_view">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.layout_view">[docs]</a>
    <span class="k">def</span> <span class="nf">layout_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize layout for the pipeline manager tab&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Diagram editor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="p">)</span>
        <span class="c1"># Toolbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_mode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">False</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_as_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_pipeline_parameters_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_parameters_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Pipeline&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setPopupMode</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QToolButton</span><span class="o">.</span><span class="n">MenuButtonPopup</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="o">.</span><span class="n">setMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_pipeline_status_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Fixed</span>
        <span class="p">)</span>
        <span class="c1"># Layouts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags_tool_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu_toolbar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrollArea</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitterRight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter1</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.loadParameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.loadParameters">[docs]</a>
    <span class="k">def</span> <span class="nf">loadParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load pipeline parameters to the current pipeline of the pipeline</span>
<span class="sd">        editor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">load_pipeline_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.loadPipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.loadPipeline">[docs]</a>
    <span class="k">def</span> <span class="nf">loadPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a pipeline to the pipeline editor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">load_pipeline</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.postprocess_pipeline_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.postprocess_pipeline_execution">[docs]</a>
    <span class="k">def</span> <span class="nf">postprocess_pipeline_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Operations to be performed after a run has been completed.</span>

<span class="sd">        It can be called either within the run procedure (the user clicks on</span>
<span class="sd">        the &quot;run&quot; button and waits for the results), or after a disconnetion /</span>
<span class="sd">        reconnection of the client app: the user clicks on &quot;run&quot; with</span>
<span class="sd">        distributed/remote execution activated, then closes the client MIA.</span>
<span class="sd">        Processing takes place (possibly remotely) within a soma-workflow</span>
<span class="sd">        server. Then the user runs MIA again, and we have to collect the</span>
<span class="sd">        outputs of runs which happened (finished) while we were disconnected.</span>

<span class="sd">        Such post-processing includes database indexing of output data, and</span>
<span class="sd">        should take into account not only the current pipeline, but all past</span>
<span class="sd">        runs which have not been postprocessed yet.</span>

<span class="sd">        When called with a pipeline argument, it only deals with this one.</span>

<span class="sd">        The method can be called from within a worker run thread, thus has to</span>
<span class="sd">        be thread-safe.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (Pipeline, optional):</span>
<span class="sd">                The pipeline to postprocess. If not provided, the method will</span>
<span class="sd">                use `self.last_run_pipeline` or fetch the currently selected</span>
<span class="sd">                pipeline from the pipeline editor.</span>

<span class="sd">        Question 1: do we have to postprocess failed runs (pipelines which</span>
<span class="sd">        started and failed) ? Probably yes because they may have produced some</span>
<span class="sd">        results during the first steps, and failed later.</span>

<span class="sd">        Question 2: how to decide which pipelines / runs have to be</span>
<span class="sd">        posptocessed now ? A pipeline may be started, then stopped or could</span>
<span class="sd">        have failed, then be postprocessed. But the user can still restart</span>
<span class="sd">        them in soma-workflow (or maybe mia one day), thus they should be</span>
<span class="sd">        postprocessed again then.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;last_run_pipeline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>

        <span class="n">to_upate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">finished_bricks</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">(),</span> <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">bricks</span> <span class="o">=</span> <span class="n">to_upate</span><span class="p">[</span><span class="s2">&quot;bricks&quot;</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="c1"># set state of bricks: done + exec date</span>
            <span class="k">for</span> <span class="n">brid</span><span class="p">,</span> <span class="n">brick</span> <span class="ow">in</span> <span class="n">bricks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">swf_status</span> <span class="o">=</span> <span class="n">brick</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;swf_status&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">swf_status</span><span class="p">:</span>
                    <span class="n">exec_date</span> <span class="o">=</span> <span class="n">swf_status</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no real info about exec time</span>
                    <span class="n">exec_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set exec status on: </span><span class="si">{</span><span class="n">brid</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">exec_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_BRICK</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">brid</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">BRICK_EXEC</span><span class="p">:</span> <span class="s2">&quot;Done&quot;</span><span class="p">,</span>
                        <span class="n">BRICK_EXEC_TIME</span><span class="p">:</span> <span class="n">exec_date</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

        <span class="c1"># now cleanup earlier history of data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_nonexisting_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">cleanup_orphan_history</span><span class="p">()</span>
        <span class="n">QtThreadCall</span><span class="p">()</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">data_browser</span><span class="o">.</span><span class="n">table_data</span><span class="o">.</span><span class="n">update_table</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">saveModifications</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.redo">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.redo">[docs]</a>
    <span class="k">def</span> <span class="nf">redo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redo the last undone action on the current pipeline editor</span>

<span class="sd">        Actions that can be redone:</span>
<span class="sd">            - add_process</span>
<span class="sd">            - delete_process</span>
<span class="sd">            - export_plug</span>
<span class="sd">            - export_plugs</span>
<span class="sd">            - remove_plug</span>
<span class="sd">            - update_node_name</span>
<span class="sd">            - update_plug_value</span>
<span class="sd">            - add_link</span>
<span class="sd">            - delete_link</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>

        <span class="c1"># We can redo if we have an action to make again</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">redos</span><span class="p">[</span><span class="n">c_e</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_redo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">redos</span><span class="p">[</span><span class="n">c_e</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c1"># The first element of the list is the type of action made</span>
            <span class="c1"># by the user</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">class_process</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_named_process</span><span class="p">(</span>
                    <span class="n">class_process</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">del_node</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;export_plugs&quot;</span><span class="p">:</span>
                <span class="n">temp_plug_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">_remove_plug</span><span class="p">(</span>
                    <span class="n">_temp_plug_name</span><span class="o">=</span><span class="n">temp_plug_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove_plug&quot;</span><span class="p">:</span>
                <span class="n">tot_plug_names</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tot_pip_plug_name</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">tot_plug_name</span> <span class="ow">in</span> <span class="n">tot_plug_names</span><span class="p">:</span>
                    <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">node_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">optional</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tot_pip_plug_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">_export_plug</span><span class="p">(</span>
                        <span class="n">temp_plug_name</span><span class="o">=</span><span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">weak_link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span>
                        <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">multi_export</span><span class="o">=</span><span class="n">multi_export</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Connecting all the plugs that were connected</span>
                    <span class="c1"># to the original plugs.</span>
                    <span class="c1"># Checking if the original plug is a pipeline</span>
                    <span class="c1"># input or output to adapt the links to add.</span>
                    <span class="k">if</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Writing a string to represent the link</span>
                    <span class="n">source_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                    <span class="n">dest_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="s2">&quot;-&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">source_parameters</span><span class="p">,</span> <span class="n">dest_parameters</span><span class="p">))</span>
                    <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update_pipeline</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">multi_export</span><span class="p">:</span>
                    <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;export_plugs&quot;</span><span class="p">,</span>
                        <span class="n">tot_pip_plug_name</span><span class="p">,</span>
                        <span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">]</span>
                    <span class="n">c_e</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_node_name&quot;</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">old_node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_node_name</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span> <span class="n">new_node_name</span><span class="p">,</span> <span class="n">old_node_name</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_plug_value&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">plug_name</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">value_type</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_plug_value</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_link&quot;</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">_del_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_link&quot;</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">active</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">weak</span> <span class="o">=</span> <span class="n">to_redo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">from_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.register_completion_attributes">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.register_completion_attributes">[docs]</a>
    <span class="k">def</span> <span class="nf">register_completion_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register completion attributes for a given pipeline in the database.</span>

<span class="sd">        This method extracts attribute values associated with a pipeline&#39;s</span>
<span class="sd">        completion engine and records these attributes in the project database.</span>
<span class="sd">        It ensures that attributes are associated only with valid fields</span>
<span class="sd">        (tags) already defined in the database schema.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline:</span>
<span class="sd">                The pipeline whose completion attributes need to be registered.</span>
<span class="sd">                The pipeline should have a completion engine capable of</span>
<span class="sd">                providing the relevant attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">ProcessCompletionEngine</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">completion</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">pl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">tag_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">))</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

                <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">todo</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">apath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">apath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apath</span><span class="p">[</span><span class="n">pl</span><span class="p">:])</span>

                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">values_dict</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">values_dict</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>  <span class="c1"># outputs not used / inactivated</span></div>


<div class="viewcode-block" id="PipelineManagerTab.runPipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.runPipeline">[docs]</a>
    <span class="k">def</span> <span class="nf">runPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the current pipeline of the pipeline editor.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">soma_workflow</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">swconstants</span>

        <span class="c1"># Initialize the pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_init</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;NoName&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">brick_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Pipeline &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; is getting run. Please wait.&#39;</span>
            <span class="p">)</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_run_log</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_pipeline_name</span> <span class="o">=</span> <span class="s2">&quot;NoName&quot;</span>

            <span class="c1"># soma-workflow remote credentials</span>
            <span class="kn">from</span> <span class="nn">soma_workflow</span> <span class="kn">import</span> <span class="n">configuration</span>
            <span class="kn">from</span> <span class="nn">soma_workflow.gui.workflowGui</span> <span class="kn">import</span> <span class="n">ConnectionDialog</span>

            <span class="n">config_file</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">search_config_path</span><span class="p">()</span>
            <span class="n">resource_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_configured_resources</span><span class="p">(</span>
                    <span class="n">config_file</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">login_list</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_logins</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>
            <span class="n">swf_config</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
                <span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;somaworkflow&quot;</span><span class="p">:</span> <span class="s1">&#39;config_id==&quot;somaworkflow&quot;&#39;</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">swf_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">cd</span> <span class="o">=</span> <span class="n">ConnectionDialog</span><span class="p">(</span><span class="n">login_list</span><span class="p">,</span> <span class="n">resource_list</span><span class="p">)</span>
                <span class="n">sel_resource</span> <span class="o">=</span> <span class="n">swf_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;computing_resource&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sel_resource</span> <span class="ow">and</span> <span class="n">sel_resource</span> <span class="ow">in</span> <span class="n">resource_list</span><span class="p">:</span>
                    <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">combo_resources</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="n">sel_resource</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">resource</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">combo_resources</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
                <span class="n">passwd</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lineEdit_password</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">rsa_key</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lineEdit_rsa_password</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">resource</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
                    <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">get_local_resource_id</span><span class="p">(),</span>
                <span class="p">):</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">study_config</span>

                    <span class="k">if</span> <span class="s2">&quot;SomaWorkflowConfig&quot;</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                        <span class="c1"># not sure this is needed...</span>
                        <span class="n">sc</span><span class="o">.</span><span class="n">somaworkflow_computing_resource</span> <span class="o">=</span> <span class="n">resource</span>
                        <span class="n">swc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;SomaWorkflowConfig&quot;</span><span class="p">]</span>
                        <span class="n">swc</span><span class="o">.</span><span class="n">set_computing_resource_password</span><span class="p">(</span>
                            <span class="n">resource</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">rsa_key</span>
                        <span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connect to: </span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">RunProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
                <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Fixed</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_pipeline_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
            <span class="n">sources_images_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getSourceImageDir</span><span class="p">()</span>
            <span class="n">mmovie</span> <span class="o">=</span> <span class="n">QMovie</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_images_dir</span><span class="p">,</span> <span class="s2">&quot;rotatingBrainVISA.gif&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mmovie</span> <span class="o">=</span> <span class="n">mmovie</span>
            <span class="n">mmovie</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">mmovie</span><span class="o">.</span><span class="n">frameChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_anim_frame</span><span class="p">)</span>
            <span class="n">mmovie</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">garbage_collect_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish_execution</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_clicked</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="PipelineManagerTab.saveParameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.saveParameters">[docs]</a>
    <span class="k">def</span> <span class="nf">saveParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the pipeline parameters of the the current pipeline of the</span>
<span class="sd">        pipeline editor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.savePipeline">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.savePipeline">[docs]</a>
    <span class="k">def</span> <span class="nf">savePipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncheck</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current pipeline of the pipeline editor</span>

<span class="sd">        :param uncheck: a flag to warn (False) or not (True) if a pipeline is</span>
<span class="sd">                        going to be overwritten during saving operation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="s2">&quot;The pipeline is getting saved. Please wait.&quot;</span>
        <span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_filename</span><span class="p">()</span>

        <span class="c1"># save</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">filename</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">uncheck</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;mia_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;mia_processes&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;populse_mia - Save pipeline Warning!&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The following module will be overwritten:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Do you agree?&quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span><span class="n">new_file_name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; pipeline has been saved.&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; pipeline was not saved.&quot;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">filename</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;mia_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;mia_processes&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">(</span><span class="n">new_file_name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; pipeline has been saved.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># save as</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saveResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">saveResult</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">saveResult</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;pipeline has been saved.&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                    <span class="s2">&quot;The pipeline was not saved.&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.savePipelineAs">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.savePipelineAs">[docs]</a>
    <span class="k">def</span> <span class="nf">savePipelineAs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current pipeline of the pipeline editor under another name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
            <span class="s2">&quot;The pipeline is getting saved. Please wait.&quot;</span>
        <span class="p">)</span>
        <span class="n">saveResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">save_pipeline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">saveResult</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">saveResult</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;pipeline has been saved.&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="s2">&quot;The pipeline was not saved.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.show_status">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.show_status">[docs]</a>
    <span class="k">def</span> <span class="nf">show_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the last run status and execution info, errors etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;show_status&quot;</span><span class="p">)</span>
        <span class="n">status_widget</span> <span class="o">=</span> <span class="n">StatusWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">status_widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_widget</span> <span class="o">=</span> <span class="n">status_widget</span></div>


<div class="viewcode-block" id="PipelineManagerTab.stop_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.stop_execution">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request interruption of pipeline execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stop_execution&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">stop_execution</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.undo">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.undo">[docs]</a>
    <span class="k">def</span> <span class="nf">undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo the last action made on the current pipeline editor</span>

<span class="sd">        Actions that can be undone:</span>
<span class="sd">            - add_process</span>
<span class="sd">            - delete_process</span>
<span class="sd">            - export_plug</span>
<span class="sd">            - export_plugs</span>
<span class="sd">            - remove_plug</span>
<span class="sd">            - update_node_name</span>
<span class="sd">            - update_plug_value</span>
<span class="sd">            - add_link</span>
<span class="sd">            - delete_link</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>

        <span class="c1"># We can undo if we have an action to revert</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span><span class="n">c_e</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">undos</span><span class="p">[</span><span class="n">c_e</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c1"># The first element of the list is the type of action made</span>
            <span class="c1"># by the user</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">del_node</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_process&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_named_process</span><span class="p">(</span>
                    <span class="n">class_name</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;export_plugs&quot;</span><span class="p">:</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">]</span>

                <span class="n">temp_plug_name</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plugs</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">:</span>
                        <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>

                    <span class="n">temp_plug_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pip_plug_name</span><span class="p">)</span>

                <span class="n">c_e</span><span class="o">.</span><span class="n">_remove_plug</span><span class="p">(</span>
                    <span class="n">_temp_plug_name</span><span class="o">=</span><span class="n">temp_plug_name</span><span class="p">,</span>
                    <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">from_export_plugs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove_plug&quot;</span><span class="p">:</span>
                <span class="n">tot_plug_names</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tot_pip_plug_name</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">tot_plug_name</span> <span class="ow">in</span> <span class="n">tot_plug_names</span><span class="p">:</span>
                    <span class="n">pip_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">node_plug_name</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">optional</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tot_plug_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">multi_export</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tot_pip_plug_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">_export_plug</span><span class="p">(</span>
                        <span class="n">temp_plug_name</span><span class="o">=</span><span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">weak_link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span>
                        <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">pipeline_parameter</span><span class="o">=</span><span class="n">pip_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">multi_export</span><span class="o">=</span><span class="n">multi_export</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Connecting all the plugs that were connected</span>
                    <span class="c1"># to the original plugs.</span>

                    <span class="k">if</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                        <span class="c1"># Checking if the original plug is a pipeline</span>
                        <span class="c1"># input or output to adapt the links to add.</span>
                        <span class="k">if</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                            <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">dest</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">source</span> <span class="o">=</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tot_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                        <span class="c1"># Writing a string to represent the link</span>
                        <span class="n">source_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                        <span class="n">dest_parameters</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="s2">&quot;-&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">source_parameters</span><span class="p">,</span> <span class="n">dest_parameters</span><span class="p">))</span>
                        <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update_pipeline</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">multi_export</span><span class="p">:</span>
                    <span class="n">history_maker</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;export_plugs&quot;</span><span class="p">,</span>
                        <span class="n">tot_pip_plug_name</span><span class="p">,</span>
                        <span class="n">node_plug_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">]</span>
                    <span class="n">c_e</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_maker</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_node_name&quot;</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">old_node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_node_name</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span> <span class="n">new_node_name</span><span class="p">,</span> <span class="n">old_node_name</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update_plug_value&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">plug_name</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">value_type</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">update_plug_value</span><span class="p">(</span>
                    <span class="n">node_name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add_link&quot;</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">_del_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete_link&quot;</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">active</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">weak</span> <span class="o">=</span> <span class="n">to_undo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span>
                    <span class="n">dest</span><span class="p">,</span>
                    <span class="n">active</span><span class="p">,</span>
                    <span class="n">weak</span><span class="p">,</span>
                    <span class="n">from_undo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">allow_export</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">c_e</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_auto_inheritance">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_auto_inheritance">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_auto_inheritance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically infer database tags for output parameters from input</span>
<span class="sd">        parameters.</span>

<span class="sd">        When a node has only one input with a value (filename) in the database,</span>
<span class="sd">        then output filenames are considered to inherit from it.</span>
<span class="sd">        When several input parameters have values in the database, then if they</span>
<span class="sd">        are all equal, we can fallback to the first case.</span>
<span class="sd">        When values are different, and have different database tags, then the</span>
<span class="sd">        ambiguity remains, and we keep track of the several possible inputs</span>
<span class="sd">        which can provide tags for outputs.</span>

<span class="sd">        The process attribute auto_inheritance_dict is filled with these</span>
<span class="sd">        values. It&#39;s a dict with the shape::</span>

<span class="sd">            {output_filename: &lt;input_spec&gt;}</span>

<span class="sd">        `output_filename` is the relative filename in the database</span>

<span class="sd">        `&lt;input_spec&gt;` can be:</span>

<span class="sd">        * a string: filename</span>
<span class="sd">        * a dict::</span>

<span class="sd">                {input_param: input_filename}</span>

<span class="sd">        `auto_inheritance_dict` is built automatically, and is used as a</span>
<span class="sd">        fallback to :class:`ProcessMIA` `inheritance_dict`, built &quot;manually&quot;</span>
<span class="sd">        (specialized for each process) in the :meth:`ProcessMIA.list_outputs`</span>
<span class="sd">        when the latter does not exist, or does not specify what an output</span>
<span class="sd">        inherits from.</span>

<span class="sd">        If ambiguities still subsist, the MIA infrastructure will ask the user</span>
<span class="sd">        how to solve them, which is not very convenient, and error-prone, thus</span>
<span class="sd">        should be avoided.</span>

<span class="sd">        Args:</span>
<span class="sd">            node:</span>
<span class="sd">                The node (typically a process or process node) whose inputs</span>
<span class="sd">                and outputs are analyzed for tag inheritance.</span>
<span class="sd">            job:</span>
<span class="sd">                An optional job object containing parameter values to override</span>
<span class="sd">                or populate the node&#39;s inputs and outputs. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="c1"># keep only leaf processes that actually produce outputs</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;auto_inheritance_dict&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">process</span><span class="o">.</span><span class="n">auto_inheritance_dict</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
        <span class="n">project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">project</span><span class="p">:</span>
            <span class="c1"># no databasing, nothing to be done.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">pl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">)</span>

        <span class="c1"># retrieve inputs and outputs keys in process,</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>

            <span class="c1"># ProcessMIA / Process_Mia specific</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;list_outputs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span>
            <span class="p">):</span>
                <span class="c1"># normally same as outputs, but it may contain an additional</span>
                <span class="c1"># &quot;notInDb&quot; key.</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_plug_value</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span>
            <span class="p">}</span>

        <span class="c1"># Fill inputs and outputs values with job if job is not None</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                            <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                            <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># if the process has a single input with a value in the database,</span>
        <span class="c1"># then we can deduce its output database tags/attributes from it</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                        <span class="n">rpath</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">pl</span><span class="p">:]</span>

                        <span class="k">if</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
                            <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                            <span class="n">primary_key</span><span class="o">=</span><span class="n">rpath</span><span class="p">,</span>
                        <span class="p">):</span>
                            <span class="c1"># we&#39;d better use rpath, but inheritance_dict</span>
                            <span class="c1"># is using full paths.</span>
                            <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                            <span class="k">break</span>
                            <span class="c1"># TODO: What if several path values are valid ?</span>
                            <span class="c1">#       Currently we keep only the first element of</span>
                            <span class="c1">#       the plug parameters</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># zero inputs are registered in the database: we cannot</span>
            <span class="c1"># infer outputs tags automatically. OK we leave.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">main_param</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">main_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">main_param</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># several inputs are registered in the database: we cannot</span>
            <span class="c1"># infer outputs tags automatically too, but we mark the ambiguity</span>
            <span class="c1"># to ask the user later</span>
            <span class="n">main_value</span> <span class="o">=</span> <span class="n">values</span>

        <span class="n">notInDb</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notInDb&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug_value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">plug_name</span> <span class="o">==</span> <span class="s2">&quot;notInDb&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">plug_name</span> <span class="ow">in</span> <span class="n">notInDb</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_file_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">plug_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">plug_value</span><span class="p">]</span>

            <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                        <span class="n">plug_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">plug_values</span><span class="p">:</span>
                <span class="n">auto_inheritance_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_value</span>

        <span class="k">if</span> <span class="n">auto_inheritance_dict</span> <span class="ow">and</span> <span class="n">job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="n">auto_inheritance_dict</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">auto_inheritance_dict</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_inheritance">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_inheritance">[docs]</a>
    <span class="k">def</span> <span class="nf">update_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the inheritance dictionary for a process node in a pipeline</span>
<span class="sd">        execution.</span>

<span class="sd">        This method updates the `inheritance_dict` attribute of a job based on</span>
<span class="sd">        the node&#39;s context and the project&#39;s inheritance history. It</span>
<span class="sd">        determines the metadata relationships between input and output</span>
<span class="sd">        parameters, which can then be used to propagate database tags and</span>
<span class="sd">        other properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            job:</span>
<span class="sd">                A job object that represents the execution of the process.</span>
<span class="sd">                It contains the `param_dict` attribute, which maps parameter</span>
<span class="sd">                names to their values.</span>
<span class="sd">            node:</span>
<span class="sd">                The process node being evaluated. It can be a `ProcessNode` or</span>
<span class="sd">                a `Process` object and is used to identify the appropriate</span>
<span class="sd">                inheritance rules.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span>
        <span class="p">):</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">new_inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">inherit_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">[</span>
                <span class="n">node_name</span>
            <span class="p">]:</span>
                <span class="n">dict_found</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">inheritance_dict_key</span> <span class="ow">in</span> <span class="n">inherit_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                    <span class="k">for</span> <span class="n">param_key</span><span class="p">,</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">inheritance_dict_key</span> <span class="o">==</span> <span class="n">param_value</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">dict_found</span>
                        <span class="p">):</span>
                            <span class="n">new_inheritance_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inherit_dict</span><span class="p">)</span>
                            <span class="n">dict_found</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_inheritance_dict</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span>

            <span class="n">job</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="n">new_inheritance_dict</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_node_list">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_node_list">[docs]</a>
    <span class="k">def</span> <span class="nf">update_node_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brick</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the list of nodes in the workflow by checking the jobs.</span>

<span class="sd">        This method iterates over all jobs in the current workflow and updates</span>
<span class="sd">        the `node_list` with the associated nodes that have not been added</span>
<span class="sd">        previously. Each job is expected to have an associated `process`,</span>
<span class="sd">        and the corresponding node is added to the `node_list` if it is not</span>
<span class="sd">        already present.</span>

<span class="sd">        Args:</span>
<span class="sd">            brick (optional):</span>
<span class="sd">                An optional parameter that is currently unused. It could be</span>
<span class="sd">                used for future extensions or to apply filters when</span>
<span class="sd">                selecting nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.updateProcessLibrary">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.updateProcessLibrary">[docs]</a>
    <span class="k">def</span> <span class="nf">updateProcessLibrary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the library of processes when a pipeline is saved</span>

<span class="sd">        :param filename: file name of the pipeline that has been saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename_folder</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">)</span>

        <span class="c1"># Changing the &quot;Pipeline&quot; class name to the name of file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s2">&quot;class &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;class </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(Pipeline):&quot;</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filename_folder</span><span class="p">)</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get_properties_path</span><span class="p">(),</span> <span class="s2">&quot;processes&quot;</span><span class="p">,</span> <span class="s2">&quot;User_processes&quot;</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Updating __init__.py</span>
        <span class="n">init_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get_properties_path</span><span class="p">(),</span>
            <span class="s2">&quot;processes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;User_processes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;__init__.py&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Checking that import line is not already in the file</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from .</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">init_file</span><span class="p">)</span>
        <span class="n">flines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flines</span><span class="p">:</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">init_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from .</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">package</span> <span class="o">=</span> <span class="s2">&quot;User_processes&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename_folder</span><span class="p">)</span>

        <span class="c1"># If the pipeline has already been saved</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;User_processes.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># removing the previous version of the module</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;User_processes.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="c1"># this adds the new module version to the sys.modules dictionary</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;User_processes&quot;</span><span class="p">)</span>

        <span class="c1"># Adding the module path to the system path</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">add_package</span><span class="p">(</span>
            <span class="n">package</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">init_package_tree</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processLibrary</span><span class="o">.</span><span class="n">pkg_library</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_project">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_project">[docs]</a>
    <span class="k">def</span> <span class="nf">update_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the project attribute of several objects.</span>

<span class="sd">        :param project: current project in the software.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">visibles_tags</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="c1"># Necessary for using Mia bricks</span>
        <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_scans_list">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_scans_list">[docs]</a>
    <span class="k">def</span> <span class="nf">update_scans_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_list</span><span class="p">,</span> <span class="n">all_iterations_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the user-selected list of scans.</span>

<span class="sd">        :param iteration_list: current list of scans in the iteration table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_user_buttons_states</span><span class="p">()</span>
        <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>
        <span class="n">has_iteration</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">iteration_name</span> <span class="o">=</span> <span class="s2">&quot;iteration&quot;</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">sortedKeys</span><span class="p">:</span>

                <span class="k">if</span> <span class="s2">&quot;iterated_&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">has_iteration</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">key</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_iteration</span><span class="p">:</span>
                <span class="c1"># move to an iteration pipeline</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_iterated_pipeline</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">new_pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># abort</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">iterationTable</span><span class="o">.</span><span class="n">check_box_iterate</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span>
                        <span class="n">Qt</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">c_e</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">new_pipeline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">new_pipeline</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="n">all_iterations_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">all_iterations_list</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">has_iteration</span><span class="p">:</span>
                <span class="c1"># get the pipeline out from the iteration node</span>
                <span class="n">new_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">iteration_name</span><span class="p">]</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">process</span>
                <span class="n">c_e</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">new_pipeline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayNodeParameters</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">new_pipeline</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_table_scans_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_list</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span><span class="p">:</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">scan_list</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">get_document_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">update_scans_list</span><span class="p">()</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_user_buttons_states">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_user_buttons_states">[docs]</a>
    <span class="k">def</span> <span class="nf">update_user_buttons_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the visibility and enabled/disabled state of pipeline-related</span>
<span class="sd">        actions (such as &quot;Run&quot; and &quot;Save&quot;) based on the current state of the</span>
<span class="sd">        pipeline or editor.</span>

<span class="sd">        This method checks the pipeline associated with the current or</span>
<span class="sd">        specified editor and updates the state of the UI buttons accordingly:</span>
<span class="sd">            - The &quot;Run Pipeline&quot; button is disabled if there are no processes</span>
<span class="sd">              in the pipeline.</span>
<span class="sd">            - The &quot;Save Pipeline&quot; and &quot;Save Pipeline As&quot; buttons are only</span>
<span class="sd">            enabled if the pipeline is not marked as iterated.</span>

<span class="sd">        Args:</span>
<span class="sd">            index (int, optional): The index of the editor to check for a</span>
<span class="sd">                                   pipeline. If not provided (default is -1),</span>
<span class="sd">                                   the current editor will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_editor_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">editor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">editor</span><span class="o">.</span><span class="n">scene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_pipeline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">list_process_in_pipeline</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="PipelineManagerTab.update_user_mode">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.PipelineManagerTab.update_user_mode">[docs]</a>
    <span class="k">def</span> <span class="nf">update_user_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the visibility of widgets/actions depending of the chosen mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

        <span class="c1"># If the user mode is chosen, the process library is not available</span>
        <span class="c1"># and the user cannot save a pipeline</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_user_mode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">action_delete_project</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pipeline_action</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">disable_overwrite</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">action_delete_project</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">userlevel</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_user_level</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">userlevel</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">userlevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipelineEditorTabs</span><span class="o">.</span><span class="n">get_current_editor</span><span class="p">()</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="n">userlevel</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">process_widget</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodeController</span><span class="o">.</span><span class="n">process_widget</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="n">userlevel</span></div>
</div>



<div class="viewcode-block" id="RunProgress">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress">[docs]</a>
<span class="k">class</span> <span class="nc">RunProgress</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and manage the progress bar for the pipeline execution. This class</span>
<span class="sd">    creates a UI with a progress bar and launches a worker thread to handle</span>
<span class="sd">    the pipeline&#39;s execution process. The progress bar will be updated during</span>
<span class="sd">    the execution, and it will be closed when the thread finishes.</span>

<span class="sd">    This class is designed to integrate with a `PipelineManagerTab` to control</span>
<span class="sd">    the pipeline&#39;s lifecycle, providing feedback on the progress and handling</span>
<span class="sd">    any errors that occur during the execution.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pipeline_manager (PipelineManagerTab):</span>
<span class="sd">            The pipeline manager instance that handles the pipeline operations.</span>
<span class="sd">        progressbar (QProgressBar):</span>
<span class="sd">            The progress bar widget to show execution progress.</span>
<span class="sd">        worker (RunWorker):</span>
<span class="sd">            The worker thread that runs the pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        pipeline_manager (PipelineManagerTab):</span>
<span class="sd">            A `PipelineManagerTab` instance responsible for managing</span>
<span class="sd">            the pipeline.</span>
<span class="sd">        settings (dict, optional):</span>
<span class="sd">            A dictionary of settings to customize pipeline iteration, default</span>
<span class="sd">            is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RunProgress.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QProgressBar</span><span class="p">()</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>  <span class="c1"># For mac OS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">RunWorker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_progress</span><span class="p">)</span></div>


<div class="viewcode-block" id="RunProgress.cleanup">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.cleanup">[docs]</a>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans up resources used by the `RunProgress` widget after the</span>
<span class="sd">        pipeline execution has finished.</span>

<span class="sd">        This method stops the worker thread, disconnects the finished signal</span>
<span class="sd">        from the slot, and deletes the worker instance to free up resources.</span>
<span class="sd">        It ensures that the worker thread has completed its execution before</span>
<span class="sd">        proceeding with cleanup.</span>

<span class="sd">        Optionally, it can also delete or hide UI components such as the</span>
<span class="sd">        progress bar, though these actions are currently commented out for</span>
<span class="sd">        flexibility.</span>

<span class="sd">        If this method is called, the worker thread should no longer be used,</span>
<span class="sd">        and any UI elements related to progress should be cleaned up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span></div>


<div class="viewcode-block" id="RunProgress.end_progress">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.end_progress">[docs]</a>
    <span class="k">def</span> <span class="nf">end_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalizes the pipeline execution process and displays a message box</span>
<span class="sd">        indicating the outcome of the execution.</span>

<span class="sd">        This method is called when the pipeline execution finishes.</span>
<span class="sd">        It restores the cursor, waits for the worker thread to complete, and</span>
<span class="sd">        then determines the status of the pipeline execution. A message box is</span>
<span class="sd">        displayed to inform the user about the success or failure of the</span>
<span class="sd">        execution.</span>

<span class="sd">        If the execution fails before running, a critical message box will be</span>
<span class="sd">        shown. If the pipeline execution fails during its run, an error</span>
<span class="sd">        message with details will be shown. If the execution is successful,</span>
<span class="sd">        a success message will be displayed.</span>

<span class="sd">        It also sets a timer to automatically close the message box after</span>
<span class="sd">        2 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;exec_id&quot;</span><span class="p">):</span>
            <span class="n">mbox_icon</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span>
            <span class="n">mbox_title</span> <span class="o">=</span> <span class="s2">&quot;Failure&quot;</span>
            <span class="n">mbox_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Execution has failed before running.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Please see details using the status report button&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">exec_id</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="n">WorkflowExecutionError</span><span class="p">:</span>
                <span class="n">mbox_icon</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Critical</span>
                <span class="n">mbox_title</span> <span class="o">=</span> <span class="s2">&quot;Failure&quot;</span>
                <span class="n">mbox_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Pipeline execution has failed:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Please see details using the status report button&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">mbox_icon</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Information</span>
                <span class="n">mbox_title</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
                <span class="n">mbox_text</span> <span class="o">=</span> <span class="s2">&quot;Pipeline execution was OK.&quot;</span>

        <span class="n">mbox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="n">mbox_icon</span><span class="p">,</span> <span class="n">mbox_title</span><span class="p">,</span> <span class="n">mbox_text</span><span class="p">)</span>
        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">mbox</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">mbox</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>


<div class="viewcode-block" id="RunProgress.start">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.start">[docs]</a>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the worker thread to begin the pipeline execution process.</span>

<span class="sd">        This method initiates the worker thread by calling its `start` method,</span>
<span class="sd">        which in turn triggers the execution of the pipeline. The progress bar</span>
<span class="sd">        could be updated to show the progress of the execution (though this</span>
<span class="sd">        functionality is currently commented out).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="RunProgress.stop_execution">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunProgress.stop_execution">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the execution of the pipeline by signaling the worker to</span>
<span class="sd">        interrupt.</span>

<span class="sd">        This method sets the `interrupt_request` flag to `True` within the</span>
<span class="sd">        worker thread&#39;s lock, which tells the worker to stop its execution.</span>
<span class="sd">        The method can be used to cancel the pipeline execution at any point</span>
<span class="sd">        during its run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** CANCEL ***&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">interrupt_request</span> <span class="o">=</span> <span class="kc">True</span></div>
</div>



<div class="viewcode-block" id="RunWorker">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker">[docs]</a>
<span class="k">class</span> <span class="nc">RunWorker</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Worker thread to run the pipeline execution.</span>

<span class="sd">    This class manages the execution of a pipeline and allows it to be run</span>
<span class="sd">    in the background using a separate thread. The worker can also be</span>
<span class="sd">    interrupted by setting the `interrupt_request` flag.</span>

<span class="sd">    :param pipeline_manager: The PipelineManager instance that manages the</span>
<span class="sd">                             pipeline execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RunWorker.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="c1"># use this lock to modify the worker state from GUI/other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span>
        <span class="c1"># when interrupt_request is set (within a lock session from a different</span>
        <span class="c1"># thread), the worker will interrupt execution and leave the thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="RunWorker.run">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.RunWorker.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the pipeline and manage its status.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_check_nipype_processes</span><span class="p">(</span><span class="n">pplne</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Recursively check and activate copy flag for Nipype processes in</span>
<span class="sd">            the pipeline.</span>

<span class="sd">            This function traverses the pipeline&#39;s nodes and checks if the</span>
<span class="sd">            nodes contain a NipypeProcess. If it does, it sets the</span>
<span class="sd">            `activate_copy` flag to `False`. The recursion handles nested</span>
<span class="sd">            pipelines.</span>

<span class="sd">            :param pplne: A Pipeline or NipypeProcess instance.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pplne</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pplne</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>  <span class="c1"># not a process node</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">node_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">_check_nipype_processes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">NipypeProcess</span><span class="p">):</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">activate_copy</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">NipypeProcess</span><span class="p">):</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">activate_copy</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_pipeline_or_process</span><span class="p">()</span>
        <span class="n">_check_nipype_processes</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">get_capsul_engine</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">engine</span><span class="o">.</span><span class="n">study_config</span><span class="o">.</span><span class="n">reset_process_counter</span><span class="p">()</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Pipeline running&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ****************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">workflow</span>
        <span class="c1"># if we are running with file transfers / translations, then we must</span>
        <span class="c1"># rebuild the workflow, because it has not been made with them.</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connected_to</span><span class="p">()</span>
        <span class="n">resource_conf</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
            <span class="n">resource_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;somaworkflow&quot;</span><span class="p">:</span> <span class="s1">&#39;config_id==&quot;somaworkflow&quot;&#39;</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capsul.engine.module.somaworkflow&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">resource_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transfer_paths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resource_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;path_translations&quot;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Rebuilding workflow for file transfers / translations...&quot;</span>
            <span class="p">)</span>
            <span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow_from_pipeline</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">complete_parameters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">resource_id</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running now...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec_id</span><span class="p">,</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span>
                <span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span>
                <span class="n">get_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_id</span> <span class="o">=</span> <span class="n">exec_id</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_NOT_STARTED</span><span class="p">,</span>
                <span class="n">swconstants</span><span class="o">.</span><span class="n">WORKFLOW_IN_PROGRESS</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">exec_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_request</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** INTERRUPT ***&quot;</span><span class="p">)</span>
                        <span class="n">engine</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">exec_id</span><span class="p">)</span>

            <span class="c1"># postprocess each node to index outputs</span>
            <span class="c1"># if self.status == swconstants.WORKFLOW_DONE:</span>
            <span class="c1"># do it even in case of failure to get partial outputs and clean</span>
            <span class="c1"># the remainings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span><span class="o">.</span><span class="n">postprocess_pipeline_execution</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has not run correctly: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span>
        <span class="c1"># restore current working directory in case it has been changed</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="StatusWidget">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget">[docs]</a>
<span class="k">class</span> <span class="nc">StatusWidget</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A widget to display the current or last pipeline execution status and</span>
<span class="sd">    logs.</span>

<span class="sd">    This widget shows:</span>
<span class="sd">        - The current status of the pipeline (or &quot;No pipeline execution&quot; if</span>
<span class="sd">          not available).</span>
<span class="sd">        - A log of the most recent pipeline execution.</span>
<span class="sd">        - A toggleable section for Soma-Workflow monitoring.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StatusWidget.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_manager</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_manager</span> <span class="o">=</span> <span class="n">pipeline_manager</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTextBrowser</span><span class="p">()</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline_manager</span><span class="p">,</span> <span class="s2">&quot;last_run_log&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="n">status_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Status:&quot;</span><span class="p">)</span>
        <span class="n">slayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">status_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">slayout</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">pipeline_manager</span><span class="p">,</span> <span class="s2">&quot;last_status&quot;</span><span class="p">,</span> <span class="s2">&quot;No pipeline execution&quot;</span>
        <span class="p">)</span>
        <span class="n">slayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;status:&lt;/b&gt; </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">swf_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Soma-Workflow monitoring:&quot;</span><span class="p">)</span>
        <span class="n">wlayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">wlayout</span><span class="p">)</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span> <span class="o">=</span> <span class="n">swf_box</span>
        <span class="n">swf_box</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_soma_workflow</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">status_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">swf_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Execution log:&quot;</span><span class="p">))</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Execution status&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="StatusWidget.toggle_soma_workflow">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.pipeline_manager_tab.StatusWidget.toggle_soma_workflow">[docs]</a>
    <span class="k">def</span> <span class="nf">toggle_soma_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checked</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Toggles the visibility of the Soma-Workflow monitoring widget.</span>

<span class="sd">        When enabled, the Soma-Workflow monitoring widget will be displayed</span>
<span class="sd">        below the status section. If it&#39;s not yet created, it will be</span>
<span class="sd">        instantiated.</span>

<span class="sd">        Args:</span>
<span class="sd">            checked (bool): Whether the toggle box is checked (True) or</span>
<span class="sd">                            unchecked (False).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">checked</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">checked</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">soma_workflow.gui.workflowGui</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">ApplicationModel</span><span class="p">,</span>
                <span class="n">MainWindow</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">ApplicationModel</span><span class="p">()</span>
            <span class="n">sw_widget</span> <span class="o">=</span> <span class="n">MainWindow</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swf_widget</span> <span class="o">=</span> <span class="n">sw_widget</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swf_box</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sw_widget</span><span class="p">)</span></div>
</div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>