<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>populse_mia.user_interface.pipeline_manager.process_mia &#8212; populse_mia 3.0.0-dev+881d2af6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=f63d8bfa" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/haiku.css?v=dfa0e015" />
    <script src="../../../../_static/documentation_options.js?v=a73ba755"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>populse_mia 3.0.0-dev+881d2af6 documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.user_interface.pipeline_manager.process_mia</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for populse_mia.user_interface.pipeline_manager.process_mia</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for managing and running processes within the Populse_mia framework.</span>

<span class="sd">This module provides specialized classes and methods to handle the execution</span>
<span class="sd">and completion of processes within the Populse_mia framework. It includes</span>
<span class="sd">functionalities for managing process attributes, handling database</span>
<span class="sd">interactions, and ensuring proper inheritance of metadata tags.</span>
<span class="sd">The module supports various process types, including those from</span>
<span class="sd">mia_processes, Nipype, and Capsul.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - MIAProcessCompletionEngine</span>
<span class="sd">        - MIAProcessCompletionEngineFactory</span>
<span class="sd">        - ProcessMIA</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># Other imports</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">traits.api</span> <span class="k">as</span> <span class="nn">traits</span>

<span class="c1"># Capsul imports</span>
<span class="kn">from</span> <span class="nn">capsul.api</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">capsul_engine</span>
<span class="kn">from</span> <span class="nn">capsul.attributes.completion_engine</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProcessCompletionEngine</span><span class="p">,</span>
    <span class="n">ProcessCompletionEngineFactory</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">capsul.attributes.completion_engine_factory</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BuiltinProcessCompletionEngineFactory</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.pipeline_nodes</span> <span class="kn">import</span> <span class="n">ProcessNode</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.process_iteration</span> <span class="kn">import</span> <span class="n">ProcessIteration</span>
<span class="kn">from</span> <span class="nn">capsul.process.process</span> <span class="kn">import</span> <span class="n">NipypeProcess</span>

<span class="c1"># nipype imports</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="n">File</span><span class="p">,</span> <span class="n">InputMultiObject</span><span class="p">,</span> <span class="n">traits_extension</span>

<span class="c1"># Soma-base import</span>
<span class="kn">from</span> <span class="nn">soma.controller.trait_utils</span> <span class="kn">import</span> <span class="n">relax_exists_constraint</span>
<span class="kn">from</span> <span class="nn">soma.utils.weak_proxy</span> <span class="kn">import</span> <span class="n">get_ref</span>

<span class="c1"># Populse_MIA imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
    <span class="n">TAG_BRICKS</span><span class="p">,</span>
    <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
    <span class="n">TAG_FILENAME</span><span class="p">,</span>
    <span class="n">TAG_HISTORY</span><span class="p">,</span>
    <span class="n">TAG_TYPE</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.software_properties</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="MIAProcessCompletionEngine">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine">[docs]</a>
<span class="k">class</span> <span class="nc">MIAProcessCompletionEngine</span><span class="p">(</span><span class="n">ProcessCompletionEngine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A specialized completion engine for all processes within the Populse_mia</span>
<span class="sd">    context.</span>

<span class="sd">    This engine handles both PopulseMIA processes and NipypeProcess instances</span>
<span class="sd">    with special consideration for their unique requirements:</span>

<span class="sd">    - PopulseMIA processes use their `list_outputs` method to generate outputs</span>
<span class="sd">      based on input parameters, primarily using filename patterns rather</span>
<span class="sd">      than attributes.</span>

<span class="sd">    - NipypeProcess instances have their MATLAB/SPM settings configured from</span>
<span class="sd">      the application configuration.</span>

<span class="sd">    The engine also manages project-specific parameters including &quot;project&quot;</span>
<span class="sd">    and &quot;output_directory&quot; when available in the study configuration.</span>

<span class="sd">    The completion system is augmented with Mia database integration, where</span>
<span class="sd">    attributes from input parameters (called &quot;tags&quot; in Mia) are added to the</span>
<span class="sd">    completion attributes.</span>

<span class="sd">    This engine tracks completed processes in the correct order, enabling</span>
<span class="sd">    other operations to be performed in the same sequence later.</span>

<span class="sd">    :Contains:</span>
<span class="sd">        :Method:</span>
<span class="sd">            - _complete_mia_process: Complete parameters for Mia-specific</span>
<span class="sd">                                     processes.</span>
<span class="sd">            - _complete_standard_process: Complete parameters for standard</span>
<span class="sd">                                          (non-Mia) processes.</span>
<span class="sd">            - complete_attributes_with_database: Augments the Capsul</span>
<span class="sd">                                                 completion system attributes</span>
<span class="sd">                                                 associated with a process.</span>
<span class="sd">            - complete_nipype_common: Set Nipype parameters for SPM.</span>
<span class="sd">            - complete_parameters: Completes file parameters from</span>
<span class="sd">                                   given inputs parameters.</span>
<span class="sd">            - complete_parameters_mia: Completion for :class:`ProcessMIA`</span>
<span class="sd">                                       instances.</span>
<span class="sd">            - get_attribute_values: Get attribute values from the fallback</span>
<span class="sd">                                    engine.</span>
<span class="sd">            - get_path_completion_engine: Get the path completion engine from</span>
<span class="sd">                                          the fallback engine.</span>
<span class="sd">            - get_project: Get the project associated with the process</span>
<span class="sd">            - path_attributes: Get path attributes from the fallback engine.</span>
<span class="sd">            - remove_switch_observe: Reimplemented since it is expects</span>
<span class="sd">                                     in switches completion engine.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MIAProcessCompletionEngine.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fallback_engine</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Mia process completion engine.</span>

<span class="sd">        :param process: The process instance to be completed.</span>
<span class="sd">        :param name (str): The name of the process.</span>
<span class="sd">        :param fallback_engine: The fallback engine to use when MIA-specific</span>
<span class="sd">                                completion is not applicable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span> <span class="o">=</span> <span class="n">fallback_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress_total</span> <span class="o">=</span> <span class="mf">0.0</span></div>


    <span class="k">def</span> <span class="nf">_complete_standard_process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">process_inputs</span><span class="p">,</span> <span class="n">complete_iterations</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete parameters for standard (non-Mia) processes.</span>

<span class="sd">        :param process: The process to complete.</span>
<span class="sd">        :param process_inputs (dict): Parameters to set on the process.</span>
<span class="sd">        :param complete_iterations (bool): Whether to complete iteration</span>
<span class="sd">                                           nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Determine node name for logging</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="n">context_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="n">context_name</span>

            <span class="c1"># Log the node type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">NipypeProcess</span><span class="p">):</span>
                <span class="n">interface_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">process</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                        <span class="n">process</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">. </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">interface_path</span><span class="si">}</span><span class="s2">) nipype brick ...&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">process_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">process</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">. </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">process_path</span><span class="si">}</span><span class="s2">) regular brick ...&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Use fallback engine to complete parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">complete_parameters</span><span class="p">(</span>
            <span class="n">process_inputs</span><span class="p">,</span> <span class="n">complete_iterations</span><span class="o">=</span><span class="n">complete_iterations</span>
        <span class="p">)</span>
        <span class="c1"># Update progress tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">completion_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress_total</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">completion_progress_total</span>
        <span class="p">)</span>
        <span class="c1"># Handle tag inheritance</span>
        <span class="c1"># Import here to avoid circular imports</span>
        <span class="c1"># isort: off</span>
        <span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">pipeline_manager_tab</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># isort: on</span>

        <span class="n">PipelineManagerTab</span> <span class="o">=</span> <span class="n">pipeline_manager_tab</span><span class="o">.</span><span class="n">PipelineManagerTab</span>
        <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="n">PipelineManagerTab</span><span class="o">.</span><span class="n">update_auto_inheritance</span><span class="p">(</span>
            <span class="n">process</span>
        <span class="p">)</span>
        <span class="c1"># auto_inheritance_dict (dict) object format:</span>
        <span class="c1"># - if there is no ambiguity :</span>
        <span class="c1">#    key: value of the output file (str)</span>
        <span class="c1">#    value: value of the input file (str)</span>
        <span class="c1"># - if ambiguous :</span>
        <span class="c1">#    key: output plug value (string)</span>
        <span class="c1">#    value: a dictionary: with key / value corresponding to each</span>
        <span class="c1">#           possible input file</span>
        <span class="c1">#           =&gt; key: name of the input plug</span>
        <span class="c1">#              value: value of the input plug</span>

        <span class="k">if</span> <span class="n">auto_inheritance_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Ensure project is set</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">):</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span><span class="p">):</span>
                    <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
                    <span class="n">project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">process</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

            <span class="c1"># Apply tag inheritance if project is available</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="n">auto_inheritance_dict</span><span class="p">:</span>
                    <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                        <span class="n">process</span><span class="p">,</span>
                        <span class="n">auto_inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">],</span>
                        <span class="n">out_file</span><span class="p">,</span>
                        <span class="n">node_name</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_complete_mia_process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">process_inputs</span><span class="p">,</span> <span class="n">complete_iterations</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete parameters for Mia-specific processes.</span>

<span class="sd">        :param process: The Mia process to complete.</span>
<span class="sd">        :param process_inputs (dict): Parameters to set on the process.</span>
<span class="sd">        :param complete_iterations (bool): Whether to complete iteration</span>
<span class="sd">                                           nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Here the process is a ProcessMIA instance. Use the specific</span>
        <span class="c1"># method.</span>
        <span class="c1"># Determine node name for logging</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pipeline&quot;</span><span class="p">:</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># Log the node type</span>
        <span class="n">process_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">process</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">. </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">process_path</span><span class="si">}</span><span class="s2">) Mia brick ...&quot;</span><span class="p">)</span>
        <span class="c1"># Complete parameters using MIA-specific method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_parameters_mia</span><span class="p">(</span>
            <span class="n">process_inputs</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="n">complete_iterations</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress_total</span>

        <span class="c1"># Check if initialization succeeded</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;init_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Handle tag inheritance</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">inheritance_dict</span>
        <span class="p">):</span>
            <span class="c1"># The tags_inheritance() function has not been implemented in</span>
            <span class="c1"># the brick, so we are using auto-inheritance.</span>
            <span class="c1"># We&#39;re only importing PipelineManagerTab now, to avoid a</span>
            <span class="c1"># circular import issue</span>
            <span class="c1"># isort: off</span>
            <span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">pipeline_manager_tab</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># isort: on</span>

            <span class="n">PipelineManagerTab</span> <span class="o">=</span> <span class="n">pipeline_manager_tab</span><span class="o">.</span><span class="n">PipelineManagerTab</span>
            <span class="n">auto_inheritance_dict</span> <span class="o">=</span> <span class="n">PipelineManagerTab</span><span class="o">.</span><span class="n">update_auto_inheritance</span><span class="p">(</span>
                <span class="n">process</span>
            <span class="p">)</span>
            <span class="c1"># auto_inheritance_dict (dict) object format:</span>
            <span class="c1"># - if there is no ambiguity :</span>
            <span class="c1">#    key: value of the output file (str)</span>
            <span class="c1">#    value: value of the input file (str)</span>
            <span class="c1"># - if ambiguous :</span>
            <span class="c1">#    key: output plug value (string)</span>
            <span class="c1">#    value: a dictionary: with key / value corresponding to</span>
            <span class="c1">#           each possible input file</span>
            <span class="c1">#           =&gt; key: name of the input plug</span>
            <span class="c1">#              value: value of the input plug</span>

            <span class="k">if</span> <span class="n">auto_inheritance_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Ensure project is set</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">):</span>

                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span><span class="p">):</span>
                        <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
                        <span class="n">project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">process</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

                <span class="c1"># Apply tag inheritance if project is available</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="n">auto_inheritance_dict</span><span class="p">:</span>
                        <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                            <span class="n">process</span><span class="p">,</span>
                            <span class="n">auto_inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">],</span>
                            <span class="n">out_file</span><span class="p">,</span>
                            <span class="n">node_name</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="c1"># We must keep a copy of inheritance dict, since it changes</span>
        <span class="c1"># at each iteration and is not included in workflow.</span>
        <span class="c1"># TODO: A better solution would be to save for each</span>
        <span class="c1">#       node the inheritance between plugs and not between</span>
        <span class="c1">#       filenames (that changes over iteration).</span>
        <span class="c1"># Record completion for later indexation</span>
        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_project</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Record completion order to perform 2nd pass tags recording</span>
            <span class="c1"># and indexation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="s2">&quot;node_inheritance_history&quot;</span><span class="p">):</span>
                <span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pipeline_node</span>

            <span class="c1"># Store inheritance dict for this node</span>
            <span class="k">if</span> <span class="n">node_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">:</span>
                <span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">):</span>
                <span class="n">project</span><span class="o">.</span><span class="n">node_inheritance_history</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">inheritance_dict</span>
                <span class="p">)</span>

<div class="viewcode-block" id="MIAProcessCompletionEngine.complete_attributes_with_database">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.complete_attributes_with_database">[docs]</a>
    <span class="k">def</span> <span class="nf">complete_attributes_with_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Augment the completion attributes with values from the Mia database.</span>

<span class="sd">        Queries the database for attributes associated with input parameters</span>
<span class="sd">        and adds them to the completion attributes if matches are found.</span>

<span class="sd">        :param process_inputs (dict): Parameters to be set on the process.</span>
<span class="sd">        :return: The augmented attributes collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process_inputs</span> <span class="o">=</span> <span class="n">process_inputs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="c1"># Get attributes from the fallback engine</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span>
        <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Process</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">attributes</span>

        <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
        <span class="n">project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">project</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attributes</span>

        <span class="k">with</span> <span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="c1"># Get fields that match attributes traits</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
            <span class="n">pfields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">attributes</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">field</span><span class="p">)]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">pfields</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">attributes</span>

            <span class="c1"># Get project directory path</span>
            <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">proj_dir_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">par_value</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># update value from given forced input</span>
                <span class="n">par_value</span> <span class="o">=</span> <span class="n">process_inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">par_value</span><span class="p">)</span>
                <span class="n">par_values</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">par_value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">par_value</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Initialize field values lists</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pfields</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">par_values</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get relative path from project root</span>
                    <span class="n">rel_value</span> <span class="o">=</span> <span class="n">abs_path</span><span class="p">[</span><span class="n">proj_dir_len</span><span class="p">:]</span>
                    <span class="c1"># Query document from database</span>
                    <span class="n">document</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                        <span class="n">primary_keys</span><span class="o">=</span><span class="n">rel_value</span><span class="p">,</span>
                        <span class="n">fields</span><span class="o">=</span><span class="n">pfields</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">document</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">field_val_list</span><span class="p">,</span> <span class="n">doc_value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">field_values</span><span class="p">,</span> <span class="n">document</span>
                        <span class="p">):</span>
                            <span class="n">field_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">doc_value</span> <span class="k">if</span> <span class="n">doc_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="c1"># Mark as None if not found in database</span>
                        <span class="k">for</span> <span class="n">field_val_list</span> <span class="ow">in</span> <span class="n">field_values</span><span class="p">:</span>
                            <span class="n">field_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                <span class="c1"># Temporarily block attributes change notification in order to</span>
                <span class="c1"># avoid triggering another completion while we are already in</span>
                <span class="c1"># this process.</span>
                <span class="n">was_fallback_ongoing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">completion_ongoing</span>
                <span class="n">was_self_ongoing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion_ongoing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">completion_ongoing</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">completion_ongoing</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Update attributes if valid values found</span>
                <span class="k">if</span> <span class="n">field_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">field_values</span>
                <span class="p">):</span>

                    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pfields</span><span class="p">,</span> <span class="n">field_values</span><span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span>
                            <span class="n">attributes</span><span class="p">,</span>
                            <span class="n">field</span><span class="p">,</span>
                            <span class="p">(</span>
                                <span class="n">values</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                                <span class="k">else</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="p">),</span>
                        <span class="p">)</span>

                <span class="c1"># Restore notification state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">completion_ongoing</span> <span class="o">=</span> <span class="n">was_fallback_ongoing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">completion_ongoing</span> <span class="o">=</span> <span class="n">was_self_ongoing</span>

        <span class="k">return</span> <span class="n">attributes</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.complete_nipype_common">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.complete_nipype_common">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">complete_nipype_common</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure Nipype/SPM parameters for a process.</span>

<span class="sd">        Sets MATLAB/SPM paths, commands, and project-specific parameters</span>
<span class="sd">        based on the configuration.</span>

<span class="sd">        :param process: The process to configure.</span>
<span class="sd">        :param output_dir (bool): If False, the output_directory attribute</span>
<span class="sd">                                  value is not initialised.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Test for matlab launch</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s2">&quot;use_mcr&quot;</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_use_spm_standalone</span><span class="p">():</span>
                <span class="n">process</span><span class="o">.</span><span class="n">use_mcr</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">process</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_spm_standalone_path</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">process</span><span class="o">.</span><span class="n">matlab_cmd</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_matlab_command</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">get_use_spm</span><span class="p">():</span>
                <span class="n">process</span><span class="o">.</span><span class="n">use_mcr</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_spm_path</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">process</span><span class="o">.</span><span class="n">matlab_cmd</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_matlab_command</span><span class="p">()</span>

        <span class="c1"># Set project attribute if available</span>
        <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
        <span class="n">project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">project</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">process</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="c1"># Set output directory if needed</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s2">&quot;output_directory&quot;</span><span class="p">):</span>
            <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;derived_data&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The output_directory trait does not exist for the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">context_name</span><span class="si">}</span><span class="s2"> process!&quot;</span>
            <span class="p">)</span>
            <span class="n">out_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">and</span> <span class="n">out_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Ensure this output_directory exists since it is not</span>
            <span class="c1"># actually an output but an input, and thus it is supposed</span>
            <span class="c1"># to exist in Capsul.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

            <span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">out_dir</span>

        <span class="c1"># Handle SPM-specific configuration</span>
        <span class="n">is_spm</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;_nipype_interface_name&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;spm&quot;</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;_nipype_interface_name&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;spm&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_spm</span><span class="p">:</span>
            <span class="c1"># Configure SPM script file</span>
            <span class="n">tname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;_nipype_trait_mapping&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">tname</span> <span class="o">=</span> <span class="n">tmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_spm_script_file&quot;</span><span class="p">,</span> <span class="s2">&quot;_spm_script_file&quot;</span><span class="p">)</span>
            <span class="c1"># FIXME: I don&#39;t understand why the _spm_script_file is in a</span>
            <span class="c1">#       mia_processes process (normally it should be in</span>
            <span class="c1">#       process.process!).</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">tname</span><span class="p">):</span>
                <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">tname</span><span class="p">):</span>
                <span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span><span class="n">userlevel</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s2">&quot;spm_script_file&quot;</span><span class="p">):</span>
                <span class="n">tname</span> <span class="o">=</span> <span class="s2">&quot;spm_script_file&quot;</span>

            <span class="k">if</span> <span class="n">tname</span><span class="p">:</span>

                <span class="c1"># Get interface script file</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;_nipype_interface&quot;</span><span class="p">):</span>
                    <span class="n">iscript</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">mlab</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">script_file</span>

                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;_nipype_interface&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># ProcessMIA with a NipypeProcess inside</span>
                    <span class="c1"># fmt: off</span>
                    <span class="n">iscript</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">mlab</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span>
                        <span class="n">script_file</span>
                    <span class="p">)</span>
                    <span class="c1"># fmt: on</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iscript</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.m&quot;</span>

                <span class="c1"># Generate unique script file name</span>

                <span class="n">process</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                <span class="n">script_name</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">iscript</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">.m&quot;</span>
                <span class="p">)</span>
                <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;scripts&quot;</span><span class="p">,</span> <span class="n">script_name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">script_path</span><span class="p">)</span>

            <span class="n">process</span><span class="o">.</span><span class="n">mfile</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.complete_parameters">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.complete_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">complete_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">process_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complete_iterations</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete process parameters based on input values.</span>

<span class="sd">        This method handles both standard Capsul processes and Mia-specific</span>
<span class="sd">        processes, applying the appropriate completion strategy for each.</span>

<span class="sd">        :param process_inputs (dict): Parameters to be set on the process.</span>
<span class="sd">                                      May include regular parameters and</span>
<span class="sd">                                      completion attributes (under</span>
<span class="sd">                                      &#39;capsul_attributes&#39; key).</span>
<span class="sd">        :param complete_iterations (bool): If False, iteration nodes in</span>
<span class="sd">                                           pipelines will not complete their</span>
<span class="sd">                                           parameters. This prevents</span>
<span class="sd">                                           modification of the input pipeline</span>
<span class="sd">                                           and avoids redundant iterations</span>
<span class="sd">                                           completion that will be done again</span>
<span class="sd">                                           during workflow building.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process_inputs</span> <span class="o">=</span> <span class="n">process_inputs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="c1"># Update progress tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">completion_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_progress_total</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">completion_progress_total</span>
        <span class="p">)</span>
        <span class="c1"># Handle database attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_attributes_with_database</span><span class="p">(</span><span class="n">process_inputs</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span>

        <span class="c1"># Handle Nipype/ProcessMIA special cases</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">(</span><span class="n">NipypeProcess</span><span class="p">,</span> <span class="n">ProcessMIA</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete_nipype_common</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

        <span class="c1"># Process completion based on type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessMIA</span><span class="p">):</span>
            <span class="c1"># Standard process completion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_standard_process</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="n">process_inputs</span><span class="p">,</span> <span class="n">complete_iterations</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Mia-specific process completion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_mia_process</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="n">process_inputs</span><span class="p">,</span> <span class="n">complete_iterations</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.complete_parameters_mia">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.complete_parameters_mia">[docs]</a>
    <span class="k">def</span> <span class="nf">complete_parameters_mia</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">process_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete parameters for ProcessMIA instances.</span>

<span class="sd">        Uses the ProcessMIA.list_outputs method to generate output parameters</span>
<span class="sd">        based on input values and sets the inheritance_dict for data</span>
<span class="sd">        indexation.</span>

<span class="sd">        :param process_inputs (dict): Parameters to set on the process.</span>
<span class="sd">        :param iteration (bool): Whether this completion is for an iteration</span>
<span class="sd">                                 node.</span>
<span class="sd">        :param verbose (bool): If true, makes the method verbose</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process_inputs</span> <span class="o">=</span> <span class="n">process_inputs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="c1"># Set input parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">process_inputs</span><span class="p">)</span>
        <span class="c1"># Get process and plugs information</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">is_plugged</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
            <span class="c1"># Identify which parameters are connected to other nodes</span>
            <span class="n">is_plugged</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">plug</span><span class="o">.</span><span class="n">links_to</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">plug</span><span class="o">.</span><span class="n">links_from</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">plugs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="n">process</span><span class="o">.</span><span class="n">init_result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get outputs from the process</span>
            <span class="n">initResult_dict</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">(</span>
                <span class="n">is_plugged</span><span class="o">=</span><span class="n">is_plugged</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error during initialisation ...!&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">initResult_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Check if initialization was successful</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">initResult_dict</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>  <span class="c1"># the process is not really configured</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">initResult_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">init_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>  <span class="c1"># the process is not really configured</span>

        <span class="c1"># Set output parameters</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># Skip special parameters</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s2">&quot;notInDb&quot;</span> <span class="ow">or</span> <span class="n">process</span><span class="o">.</span><span class="n">is_parameter_protected</span><span class="p">(</span>
                <span class="n">parameter</span>
            <span class="p">):</span>
                <span class="c1"># Special non-param or set manually:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Issue with </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.get_attribute_values">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.get_attribute_values">[docs]</a>
    <span class="k">def</span> <span class="nf">get_attribute_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get attribute values from the fallback engine.</span>

<span class="sd">        :return: The attribute values collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">()</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.get_path_completion_engine">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.get_path_completion_engine">[docs]</a>
    <span class="k">def</span> <span class="nf">get_path_completion_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path completion engine from the fallback engine.</span>

<span class="sd">        :return: The path completion engine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">get_path_completion_engine</span><span class="p">()</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.get_project">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.get_project">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_project</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the project associated with a process.</span>

<span class="sd">        :param process: The process to get the project for.</span>

<span class="sd">        :return: The associated project or None if not found.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">process</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span><span class="p">):</span>
            <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">study_config</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.path_attributes">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.path_attributes">[docs]</a>
    <span class="k">def</span> <span class="nf">path_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get path attributes from the fallback engine.</span>

<span class="sd">        :param filename (str): The filename to get attributes for.</span>
<span class="sd">        :param parameter (str): The parameter name associated with the</span>
<span class="sd">                                filename.</span>

<span class="sd">        :return: The path attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">path_attributes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span></div>


<div class="viewcode-block" id="MIAProcessCompletionEngine.remove_switch_observer">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngine.remove_switch_observer">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_switch_observer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a switch observer from the fallback engine.</span>

<span class="sd">        :param observer: The observer to remove.</span>

<span class="sd">        :return: The result from the fallback engine.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_engine</span><span class="o">.</span><span class="n">remove_switch_observer</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MIAProcessCompletionEngineFactory">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngineFactory">[docs]</a>
<span class="k">class</span> <span class="nc">MIAProcessCompletionEngineFactory</span><span class="p">(</span><span class="n">ProcessCompletionEngineFactory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of the ProcessCompletionEngineFactory for the Populse Mia</span>
<span class="sd">    context.</span>

<span class="sd">    This factory is identified by ``factory_id = &quot;mia_completion&quot;`` and is</span>
<span class="sd">    activated in a :class:`~capsul.study_config.study_config.StudyConfig`</span>
<span class="sd">    instance by setting the following 2 parameters:</span>

<span class="sd">        study_config.attributes_schema_paths += [</span>
<span class="sd">            &#39;populse_mia.user_interface.pipeline_manager.process_mia&#39;</span>
<span class="sd">        ]</span>
<span class="sd">        study_config.process_completion = &#39;mia_completion&#39;</span>


<span class="sd">    Once activated, the completion system is applied to all processes,</span>
<span class="sd">    distinguishing between MIA and Nipype processes. For standard processes,</span>
<span class="sd">    additional database operations are performed before invoking the underlying</span>
<span class="sd">    completion system (such as FOM or others).</span>

<span class="sd">    :Contains:</span>
<span class="sd">        :Method:</span>
<span class="sd">            - get_completion_engine: get a ProcessCompletionEngine instance for</span>
<span class="sd">              a given process/node</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">factory_id</span> <span class="o">=</span> <span class="s2">&quot;mia_completion&quot;</span>

<div class="viewcode-block" id="MIAProcessCompletionEngineFactory.get_completion_engine">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.MIAProcessCompletionEngineFactory.get_completion_engine">[docs]</a>
    <span class="k">def</span> <span class="nf">get_completion_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a `ProcessCompletionEngine` instance for the given process</span>
<span class="sd">        or node.</span>

<span class="sd">        :param process (Process or Node): The process or node for which to get</span>
<span class="sd">                                          the completion engine.</span>
<span class="sd">        :param name (str, optional): An optional name for the completion</span>
<span class="sd">                                     engine.</span>

<span class="sd">        :return (ProcessCompletionEngine): A completion engine instance</span>
<span class="sd">                                           associated with the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;completion_engine&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">process</span><span class="o">.</span><span class="n">completion_engine</span>

        <span class="n">engine_factory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;get_study_config&quot;</span><span class="p">):</span>
            <span class="n">study_config</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">study_config</span><span class="o">.</span><span class="n">engine</span>

            <span class="k">if</span> <span class="s2">&quot;capsul.engine.module.attributes&quot;</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">_loaded_modules</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># TODO: Define a method to store this!</span>
                    <span class="n">former_factory</span> <span class="o">=</span> <span class="s2">&quot;builtin&quot;</span>
                    <span class="n">engine_factory</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">_modules_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;attributes_factory&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_completion&quot;</span><span class="p">,</span> <span class="n">former_factory</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Not found</span>

        <span class="k">if</span> <span class="n">engine_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">engine_factory</span> <span class="o">=</span> <span class="n">BuiltinProcessCompletionEngineFactory</span><span class="p">()</span>

        <span class="n">fallback</span> <span class="o">=</span> <span class="n">engine_factory</span><span class="o">.</span><span class="n">get_completion_engine</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Handle process iteration</span>
        <span class="n">in_process</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">process</span><span class="o">.</span><span class="n">process</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">)</span> <span class="k">else</span> <span class="n">process</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_process</span><span class="p">,</span> <span class="n">ProcessIteration</span><span class="p">):</span>
            <span class="c1"># iteration nodes must follow their own way</span>
            <span class="k">return</span> <span class="n">fallback</span>

        <span class="k">return</span> <span class="n">MIAProcessCompletionEngine</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fallback</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ProcessMIA">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA">[docs]</a>
<span class="k">class</span> <span class="nc">ProcessMIA</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extends the Capsul Process class to customize execution for Mia bricks.</span>

<span class="sd">    This class provides specialized methods for Mia bricks, including process</span>
<span class="sd">    initialization, output handling, and trait management.</span>

<span class="sd">    .. Methods:</span>
<span class="sd">        - _add_field_to_collections: Add a new field to the specified</span>
<span class="sd">                                     collection in the database.</span>
<span class="sd">        - _add_or_modify_tags: Add new tags or modify existing tag values in</span>
<span class="sd">                               the database.</span>
<span class="sd">        - _all_values_identical: Checks if all dictionaries have identical</span>
<span class="sd">                                 content</span>
<span class="sd">        - _after_run_process: Try to recover the output values, when the</span>
<span class="sd">                              calculation has been delegated to a process in</span>
<span class="sd">                              ProcessMIA.</span>
<span class="sd">        - _find_plug_for_output:  Find the plug name associated with the given</span>
<span class="sd">                                  output file.</span>
<span class="sd">        - _get_relative_path: Converts an absolute file path to a relative</span>
<span class="sd">                              path based on the project folder.</span>
<span class="sd">        - _remove_tags: Remove specified tags from value dictionaries and the</span>
<span class="sd">                        database.</span>
<span class="sd">        - _resolve_inheritance_ambiguity: Resolves ambiguity when multiple</span>
<span class="sd">                                          input files could provide tags.</span>
<span class="sd">        - _run_process: call the run_process_mia method in the ProcessMIA</span>
<span class="sd">                        subclass.</span>
<span class="sd">        - _save_tag_values: Save tag values to the database.</span>
<span class="sd">        - init_default_traits: Automatically initialise necessary parameters</span>
<span class="sd">                               for nipype or capsul.</span>
<span class="sd">        - init_process: Instantiation of the process attribute given a</span>
<span class="sd">                        process identifier.</span>
<span class="sd">        - list_outputs: Override the outputs of the process.</span>
<span class="sd">        - load_nii: Return the header and the data of a nibabel image object.</span>
<span class="sd">        - make_initResult: Make the final dictionary for outputs,</span>
<span class="sd">                           inheritance and requirement from the</span>
<span class="sd">                           initialisation of a brick.</span>
<span class="sd">        - relax_nipype_exists_constraints: Relax the exists constraint of</span>
<span class="sd">                                           the process.inputs traits.</span>
<span class="sd">        - requirements: Capsul Process.requirements() implementation using</span>
<span class="sd">                        MIA&#39;s ProcessMIA.requirement attribute.</span>
<span class="sd">        - run_process_mia: Implements specific runs for ProcessMia</span>
<span class="sd">                           subclasses.</span>
<span class="sd">        - tags_inheritance: create tags for data.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class attributes used for the inheritance dictionary</span>
    <span class="n">ignore_node</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ignore</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="ProcessMIA.__init__">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the process instance with default attributes.</span>

<span class="sd">        :param args (tuple): Positional arguments passed to the parent class.</span>
<span class="sd">        :param kwargs (dict): Keyword arguments passed to the parent class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_result</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">_add_field_to_collections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_schema</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">tag_def</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new field to the specified collection in the database.</span>

<span class="sd">        :param database_schema: The database schema context used for modifying</span>
<span class="sd">                                collections.</span>
<span class="sd">        :param collection (str): The name of the collection to which the field</span>
<span class="sd">                                 should be added.</span>
<span class="sd">        :param tag_def (dict): Dictionary containing the field definition with</span>
<span class="sd">                               the following keys:</span>
<span class="sd">                               - &#39;name&#39; (str): The name of the field.</span>
<span class="sd">                               - &#39;field_type&#39; (str): The type of the field.</span>
<span class="sd">                               - &#39;description&#39; (str): A description of the</span>
<span class="sd">                                                      field.</span>
<span class="sd">                               - &#39;visibility&#39; (str): The visibility status of</span>
<span class="sd">                                                     the field.</span>
<span class="sd">                               - &#39;origin&#39; (str): The origin of the field.</span>
<span class="sd">                               - &#39;unit&#39; (str): The unit associated with the</span>
<span class="sd">                                               field.</span>
<span class="sd">                               - &#39;default_value&#39; (Any): The default value of</span>
<span class="sd">                                                        the field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">tag_def</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="n">tag_def</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tag_def</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
            <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="n">tag_def</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
            <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">tag_def</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">tag_def</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
            <span class="s2">&quot;default_value&quot;</span><span class="p">:</span> <span class="n">tag_def</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="c1"># Add to the collection</span>
        <span class="n">database_schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;collection_name&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">field_config</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_or_modify_tags</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">own_tags</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">,</span> <span class="n">field_names</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add new tags or modify existing tag values in the current and initial</span>
<span class="sd">        collections.</span>

<span class="sd">        :param own_tags (list[dict]): List of tags to be added or modified,</span>
<span class="sd">                                      where each tag is a dictionary with</span>
<span class="sd">                                      &#39;name&#39;, &#39;value&#39;, &#39;description&#39;, etc.,</span>
<span class="sd">                                      keys.</span>
<span class="sd">        :param current_values (dict): Dictionary storing the current tag</span>
<span class="sd">                                      values.</span>
<span class="sd">        :param initial_values (dict): Dictionary storing the initial tag</span>
<span class="sd">                                      values.</span>
<span class="sd">        :param field_names (set[str]): Set of field names that exist in the</span>
<span class="sd">                                       database schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_schema</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">database_schema</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">tag_to_add</span> <span class="ow">in</span> <span class="n">own_tags</span><span class="p">:</span>

                    <span class="c1"># Ensure tag exists in the database schema</span>
                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_field_to_collections</span><span class="p">(</span>
                            <span class="n">database_schema</span><span class="p">,</span> <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_to_add</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span>
                    <span class="p">)(</span><span class="n">COLLECTION_INITIAL</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_field_to_collections</span><span class="p">(</span>
                            <span class="n">database_schema</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">tag_to_add</span>
                        <span class="p">)</span>

                    <span class="c1"># Set tag values</span>
                    <span class="n">current_values</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="n">initial_values</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_all_values_identical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if all dictionaries in `values_dict` have identical content.</span>

<span class="sd">        :param values_dict (dict): A dictionary where each value is expected</span>
<span class="sd">                                   to be comparable to the others.</span>

<span class="sd">        :return (bool): True if all values in `values_dict` are identical or</span>
<span class="sd">                         if the dictionary is empty, otherwise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">values_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">first</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">values_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">values</span>

            <span class="k">elif</span> <span class="n">values</span> <span class="o">!=</span> <span class="n">first</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_after_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_process_result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve output values when the process is a NipypeProcess.</span>

<span class="sd">        :param run_process_result: The result of the process execution.</span>
<span class="sd">                                   (unused)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">NipypeProcess</span>
        <span class="p">):</span>

            <span class="k">for</span> <span class="n">mia_output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">wrapped_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">mia_output</span><span class="p">)</span><span class="o">.</span><span class="n">nipype_process_name</span>

                <span class="k">if</span> <span class="n">wrapped_output</span><span class="p">:</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">wrapped_output</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">new_value</span>
                        <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mia_output</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">new_value</span>
                    <span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mia_output</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_plug_for_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the plug name associated with the given output file.</span>

<span class="sd">        :param out_file (str): The output file to search for in user traits.</span>

<span class="sd">        :return (str | None): The name of the plug (trait) if found,</span>
<span class="sd">                               otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">trait_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="s2">&quot;___nothing___&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">trait_name</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_relative_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts an absolute file path to a relative path based on the</span>
<span class="sd">        project folder.</span>

<span class="sd">        :param file_path (str): The absolute path of the file.</span>
<span class="sd">        :param base_dir (str): The base directory to make the path relative to.</span>

<span class="sd">        :return (str): The relative file path.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rel_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">altsep</span><span class="p">}:</span>
            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">rel_path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">rel_path</span>

    <span class="k">def</span> <span class="nf">_remove_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags2del</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove specified tags from value dictionaries and the database.</span>

<span class="sd">        :param tags2del (list[str]): List of tag names to be removed.</span>
<span class="sd">        :param current_values (dict): Dictionary storing the current tag</span>
<span class="sd">                                      values.</span>
<span class="sd">        :param initial_values (dict): Dictionary storing the initial tag</span>
<span class="sd">                                      values.</span>
<span class="sd">        :param out_file (str): The output file associated with the tags being</span>
<span class="sd">                               removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">tag_to_del</span> <span class="ow">in</span> <span class="n">tags2del</span><span class="p">:</span>
            <span class="n">current_values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tag_to_del</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">initial_values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tag_to_del</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># If tag_to_del is only in out_file, remove it from database</span>
        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">out_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags2del</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">):</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">database_data</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                            <span class="n">collection</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">,</span> <span class="n">tag</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># Collection, field, or document may not exist — ignore</span>
                        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_resolve_inheritance_ambiguity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">all_current_values</span><span class="p">,</span>
        <span class="n">all_initial_values</span><span class="p">,</span>
        <span class="n">in_files</span><span class="p">,</span>
        <span class="n">node_name</span><span class="p">,</span>
        <span class="n">plug_name</span><span class="p">,</span>
        <span class="n">out_file</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolves ambiguity when multiple input files could provide tags.</span>

<span class="sd">        This method applies a series of resolution strategies in order:</span>
<span class="sd">        1. If all input files have identical tag values, the first input is</span>
<span class="sd">           selected.</span>
<span class="sd">        2. If a previously stored selection rule exists, it is used.</span>
<span class="sd">        3. If neither condition applies, the user is prompted to manually</span>
<span class="sd">           resolve the ambiguity, and their decision is stored for future use.</span>

<span class="sd">        :param all_current_values (dict): A dictionary containing the current</span>
<span class="sd">                                          values for each possible input file.</span>
<span class="sd">        :param all_initial_values (dict): A dictionary containing the initial</span>
<span class="sd">                                          values for each possible input file.</span>
<span class="sd">        :param in_files (dict): A mapping of input file indices to their</span>
<span class="sd">                                corresponding file paths.</span>
<span class="sd">        :param node_name (str): The name of the processing node.</span>
<span class="sd">        :param plug_name (str | None): The name of the plug (trait) causing</span>
<span class="sd">                                       the ambiguity.</span>
<span class="sd">        :param out_file (str): The output file for which inheritance needs to</span>
<span class="sd">                               be resolved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if all inputs have identical tag values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_values_identical</span><span class="p">(</span>
            <span class="n">all_current_values</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_values_identical</span><span class="p">(</span><span class="n">all_initial_values</span><span class="p">):</span>
            <span class="c1"># All values equal, no ambiguity - select first input</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_current_values</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">all_current_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">all_current_values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_initial_values</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">all_initial_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">all_initial_values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c1"># Try to use previously stored selection rules</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">in_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="n">value_param</span> <span class="o">=</span> <span class="n">all_current_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">all_current_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">value_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_current_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_param</span>

            <span class="n">value_param</span> <span class="o">=</span> <span class="n">all_initial_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">all_initial_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">value_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_initial_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_param</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">plug_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">key</span>
        <span class="p">):</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">in_files</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="n">value_param</span> <span class="o">=</span> <span class="n">all_current_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">all_current_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">value_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_current_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_param</span>

            <span class="n">value_param</span> <span class="o">=</span> <span class="n">all_initial_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">all_initial_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">value_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_initial_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_param</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span>

        <span class="c1"># No resolution strategy worked, prompt user</span>
        <span class="c1"># FIXME: There is a GUI dialog here, involving user</span>
        <span class="c1">#        interaction. This should probably be avoided here in</span>
        <span class="c1">#        a processing loop. Some pipelines, especially with</span>
        <span class="c1">#        iterations, may ask many many questions to users.</span>
        <span class="c1">#        These should be worked on earlier.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Ambiguity in tag inheritance for: </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> - &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># We&#39;re only importing PopUpInheritanceDict now, to avoid a</span>
        <span class="c1"># circular import issue</span>
        <span class="kn">from</span> <span class="nn">populse_mia.user_interface.pop_ups</span> <span class="kn">import</span> <span class="n">PopUpInheritanceDict</span>

        <span class="n">pop_up</span> <span class="o">=</span> <span class="n">PopUpInheritanceDict</span><span class="p">(</span>
            <span class="n">in_files</span><span class="p">,</span>
            <span class="n">node_name</span><span class="p">,</span>
            <span class="n">plug_name</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pop_up</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">ignore_node</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">everything</span>

        <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">value</span>

            <span class="k">if</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_up</span><span class="o">.</span><span class="n">key</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">all_current_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="n">all_current_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_current_values</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">all_initial_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="n">all_initial_values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_initial_values</span><span class="p">[</span><span class="n">pop_up</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the specific run method for ProcessMIA subclasses.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_save_tag_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_out_file</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save tag values to the CURRENT and INITIAL database collections.</span>

<span class="sd">        :param rel_out_file (str): The relative path of the output file used</span>
<span class="sd">                                   as the document&#39;s primary key.</span>
<span class="sd">        :param current_values (dict): Dictionary containing the current tag</span>
<span class="sd">                                      values to be saved.</span>
<span class="sd">        :param initial_values (dict): Dictionary containing the initial tag</span>
<span class="sd">                                      values to be saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">current_values</span><span class="p">:</span>

                <span class="c1"># Ensure document exists in CURRENT collection</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">rel_out_file</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
                        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">rel_out_file</span>
                    <span class="p">)</span>

                <span class="c1"># Update values</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">rel_out_file</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">current_values</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">initial_values</span><span class="p">:</span>

                <span class="c1"># Ensure document exists in INITIAL collection</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">database_data</span><span class="o">.</span><span class="n">has_document</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">rel_out_file</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">database_data</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
                        <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">rel_out_file</span>
                    <span class="p">)</span>

                <span class="c1"># Update values</span>
                <span class="n">database_data</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                    <span class="n">primary_key</span><span class="o">=</span><span class="n">rel_out_file</span><span class="p">,</span>
                    <span class="n">values_dict</span><span class="o">=</span><span class="n">initial_values</span><span class="p">,</span>
                <span class="p">)</span>

<div class="viewcode-block" id="ProcessMIA.init_default_traits">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.init_default_traits">[docs]</a>
    <span class="k">def</span> <span class="nf">init_default_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize required traits for Nipype or Capsul processes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;output_directory&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
                <span class="s2">&quot;output_directory&quot;</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="ow">and</span> <span class="s2">&quot;spm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span><span class="p">:</span>
            <span class="n">required_traits</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;use_mcr&quot;</span><span class="p">:</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="n">InputMultiObject</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">),</span>
                <span class="s2">&quot;matlab_cmd&quot;</span><span class="p">:</span> <span class="n">traits_extension</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;mfile&quot;</span><span class="p">:</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;spm_script_file&quot;</span><span class="p">:</span> <span class="n">File</span><span class="p">(</span>
                    <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">input_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Path to the generated SPM Matlab script.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">required_traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProcessMIA.init_process">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.init_process">[docs]</a>
    <span class="k">def</span> <span class="nf">init_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">int_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate the process attribute given a process identifier.</span>

<span class="sd">        :param int_name (str): A process identifier used to fetch the</span>
<span class="sd">                               process instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span><span class="o">.</span><span class="n">engine</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;study_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">capsul_engine</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span><span class="n">int_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProcessMIA.list_outputs">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.list_outputs">[docs]</a>
    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset and override process outputs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relax_nipype_exists_constraints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProcessMIA.load_nii">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.load_nii">[docs]</a>
    <span class="k">def</span> <span class="nf">load_nii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">matlab_like</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a NIfTI image and return its header and data, optionally</span>
<span class="sd">        adjusting for MATLAB conventions.</span>

<span class="sd">        MATLAB and Python (in particular NumPy) treat the order of dimensions</span>
<span class="sd">        and the origin of the coordinate system differently. MATLAB uses main</span>
<span class="sd">        column order (also known as Fortran order). NumPy (and Python in</span>
<span class="sd">        general) uses the order of the main rows (C order). For a 3D array</span>
<span class="sd">        data(x, y, z) in MATLAB, the equivalent in NumPy is data[y, x, z].</span>
<span class="sd">        MATLAB and NumPy also handle the origin of the coordinate system</span>
<span class="sd">        differently:</span>
<span class="sd">        MATLAB&#39;s coordinate system starts with the origin in the lower</span>
<span class="sd">        left-hand corner (as in traditional matrix mathematics).</span>
<span class="sd">        NumPy&#39;s coordinate system starts with the origin in the top left-hand</span>
<span class="sd">        corner.</span>
<span class="sd">        When taking matlab_like=True as argument, the numpy matrix is</span>
<span class="sd">        rearranged to follow MATLAB conventions.</span>
<span class="sd">        Using scaled=False generates a raw unscaled data matrix (as in MATLAB</span>
<span class="sd">        with `header = loadnifti(fnii)` and `header.reco.data`).</span>

<span class="sd">        :param file_path (str): The path to a NIfTI file.</span>
<span class="sd">        :param scaled (bool): If True the data is scaled.</span>
<span class="sd">        :param matlab_like (bool): If True the data is rearranged to match the</span>
<span class="sd">                                   order of the dimensions and the origin of</span>
<span class="sd">                                   the coordinate system in Matlab.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="k">if</span> <span class="n">scaled</span> <span class="k">else</span> <span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="o">.</span><span class="n">get_unscaled</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">matlab_like</span><span class="p">:</span>
            <span class="c1"># TODO: Should transpose for ndim&gt;4 cases be implemented?</span>
            <span class="c1"># fmt: off</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[:</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="p">]</span>
            <span class="c1"># fmt: on</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span></div>


<div class="viewcode-block" id="ProcessMIA.make_initResult">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.make_initResult">[docs]</a>
    <span class="k">def</span> <span class="nf">make_initResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the initialization result dictionary.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;requirement&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span><span class="p">,</span>
            <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">]</span>
            <span class="n">context_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;context_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Issues detected during &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">context_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; initialization:&quot;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2"> attribute is missing...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="ow">and</span> <span class="s2">&quot;spm&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="ow">or</span> <span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm_script_file&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;requirement&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span>
            <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="ProcessMIA.relax_nipype_exists_constraints">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.relax_nipype_exists_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">relax_nipype_exists_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relax the &#39;exists&#39; constraint of the process.inputs traits.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">trait</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">relax_exists_constraint</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProcessMIA.requirements">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.requirements">[docs]</a>
    <span class="k">def</span> <span class="nf">requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the process requirements using MIA&#39;s requirement attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">req</span><span class="p">:</span> <span class="s2">&quot;any&quot;</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="ProcessMIA.run_process_mia">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.run_process_mia">[docs]</a>
    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a customized run for ProcessMIA subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="ow">and</span> <span class="s2">&quot;spm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;use_mcr&quot;</span><span class="p">,</span> <span class="s2">&quot;paths&quot;</span><span class="p">,</span> <span class="s2">&quot;matlab_cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;mfile&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;spm_script_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_spm_script_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_script_file</span></div>


<div class="viewcode-block" id="ProcessMIA.tags_inheritance">
<a class="viewcode-back" href="../../../../populse_mia.user_interface.pipeline_manager.html#populse_mia.user_interface.pipeline_manager.process_mia.ProcessMIA.tags_inheritance">[docs]</a>
    <span class="k">def</span> <span class="nf">tags_inheritance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">in_file</span><span class="p">,</span>
        <span class="n">out_file</span><span class="p">,</span>
        <span class="n">node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">own_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tags2del</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inherit and manage data tags from input file(s) to an output file.</span>

<span class="sd">        This method handles the inheritance of metadata tags from one or</span>
<span class="sd">        more input files to an output file. It also allows adding new tags,</span>
<span class="sd">        modifying existing ones, or deleting unwanted tags in the process.</span>

<span class="sd">        Notes:</span>
<span class="sd">        This method performs inheritance in two ways:</span>
<span class="sd">        1. Immediate inheritance during process execution</span>
<span class="sd">        2. Deferred inheritance by storing inheritance information for later</span>
<span class="sd">           use during workflow generation (addresses issue #290, #310)</span>

<span class="sd">        In ambiguous cases (multiple input files), the method will either:</span>
<span class="sd">        - Use previously stored inheritance rules</span>
<span class="sd">        - Prompt the user for a decision if no rule exists</span>
<span class="sd">        - Auto-resolve if all inputs have identical tag values</span>

<span class="sd">        :param in_file (str or dict): Source of tag inheritance. Either:</span>
<span class="sd">                                      - A string representing a single input</span>
<span class="sd">                                        file path (unambiguous case)</span>
<span class="sd">                                      - A dictionary mapping plug names to</span>
<span class="sd">                                        corresponding input file paths</span>
<span class="sd">                                        (ambiguous case)</span>
<span class="sd">        :param out_file (str): Path of the output file that will inherit the</span>
<span class="sd">                               tags.</span>
<span class="sd">        :param node_name (str): Name of the processing node in the workflow.</span>
<span class="sd">        :param own_tags (list of dict): Tags to be added or modified. Each</span>
<span class="sd">                                        dictionary must contain:</span>
<span class="sd">                                        - &quot;name&quot;: Tag identifier</span>
<span class="sd">                                        - &quot;field_type&quot;: Data type of the tag</span>
<span class="sd">                                        - &quot;description&quot;: Human-readable</span>
<span class="sd">                                                         description</span>
<span class="sd">                                        - &quot;visibility&quot;: Boolean or visibility</span>
<span class="sd">                                                        level</span>
<span class="sd">                                        - &quot;origin&quot;: Source of the tag</span>
<span class="sd">                                        - &quot;unit&quot;: Unit of measurement</span>
<span class="sd">                                                  (if applicable)</span>
<span class="sd">                                        - &quot;default_value&quot;: Default value</span>
<span class="sd">                                        - &quot;value&quot;: Current value to set</span>
<span class="sd">        :param tags2del (list of str): Tags to be deleted from the output</span>
<span class="sd">                                       file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1- We want out_file to inherit all the tags from in_file.</span>
        <span class="c1"># FIXME: We&#39;re trying to do the inheritance now. However, as in_file</span>
        <span class="c1">#        may not have inherited any tags yet (in the case of a</span>
        <span class="c1">#        non-mia_processes brick, for example, etc.), the same</span>
        <span class="c1">#        inheritance operation will also be performed at the end of</span>
        <span class="c1">#        the workflow generation (inheritance must be possible in all</span>
        <span class="c1">#        cases after workflow generation, see #290 and #310 and</span>
        <span class="c1">#        populse/mia_processes#39). This is sub-optimal, but until the</span>
        <span class="c1">#        #290 fix, it&#39;s the best solution we&#39;re using.</span>

        <span class="c1"># Initialize inheritance dictionary if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;inheritance_dict&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Store inheritance information for post-workflow processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;own_tags&quot;</span><span class="p">:</span> <span class="n">own_tags</span><span class="p">,</span>
            <span class="s2">&quot;tags2del&quot;</span><span class="p">:</span> <span class="n">tags2del</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Find the plug name associated with this output file</span>
        <span class="n">plug_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_plug_for_output</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
        <span class="c1"># Tags that should never be inherited</span>
        <span class="n">excluded_tags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TAG_TYPE</span><span class="p">,</span>
            <span class="n">TAG_BRICKS</span><span class="p">,</span>
            <span class="n">TAG_CHECKSUM</span><span class="p">,</span>
            <span class="n">TAG_FILENAME</span><span class="p">,</span>
            <span class="n">TAG_HISTORY</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Normalize input file format</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">in_files</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">in_file</span><span class="p">}</span>
            <span class="c1"># Store parent for inheritance at workflow completion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_file</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_file</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Ambiguous case - multiple potential parents</span>
            <span class="c1"># self.inheritance_dict will be defined later</span>
            <span class="n">in_files</span> <span class="o">=</span> <span class="n">in_file</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;in_file must be either a string or dictionary&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare paths for database operations</span>
        <span class="n">db_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">as</span> <span class="n">database_data</span><span class="p">:</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
            <span class="n">rel_out_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_path</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">db_dir</span><span class="p">)</span>
            <span class="c1"># Collect tag values from all input files</span>
            <span class="n">all_current_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_initial_values</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Get all tags values for inputs</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">parent_file</span> <span class="ow">in</span> <span class="n">in_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">rel_in_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_path</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">parent_file</span><span class="p">)),</span> <span class="n">db_dir</span>
                <span class="p">)</span>

                <span class="c1"># Skip self-reference case (output is one of the inputs)</span>
                <span class="k">if</span> <span class="n">rel_in_file</span> <span class="o">==</span> <span class="n">rel_out_file</span><span class="p">:</span>
                    <span class="n">all_current_values</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">all_initial_values</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">current_values</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">initial_values</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">break</span>

                <span class="c1"># Get current tag values for this input</span>
                <span class="n">current_doc</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                    <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                    <span class="n">primary_keys</span><span class="o">=</span><span class="n">rel_in_file</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">current_doc</span><span class="p">:</span>
                    <span class="c1"># Extract relevant fields from CURRENT collection</span>
                    <span class="n">current_values</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">field</span><span class="p">:</span> <span class="n">current_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_tags</span>
                    <span class="p">}</span>
                    <span class="c1"># Get matching INITIAL values if available</span>
                    <span class="n">initial_doc</span> <span class="o">=</span> <span class="n">database_data</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                        <span class="n">collection_name</span><span class="o">=</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                        <span class="n">primary_keys</span><span class="o">=</span><span class="n">rel_in_file</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Tags in COLLECTION_CURRENT for in_file</span>
                    <span class="c1"># FIXME: If initial_doc is None, do we want a message in</span>
                    <span class="c1">#        stdout like the one below (currently a message is</span>
                    <span class="c1">#        only visible in stdout if the document is not in</span>
                    <span class="c1">#        the CURRENT collection)?</span>
                    <span class="n">initial_values</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">{</span>
                            <span class="n">field</span><span class="p">:</span> <span class="n">initial_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">current_values</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="n">initial_doc</span>
                        <span class="k">else</span> <span class="p">{}</span>
                    <span class="p">)</span>
                    <span class="n">all_current_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_values</span>
                    <span class="n">all_initial_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_values</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="si">}</span><span class="s2"> brick initialization warning: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_file</span><span class="si">}</span><span class="s2"> has no tags registered yet. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Therefore, </span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2"> cannot inherit its tags. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;This may cause subsequent initialization issues...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">initial_values</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">current_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Resolve ambiguous parent selection if needed</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">ignore_node</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_current_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">node_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}{</span><span class="n">plug_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ProcessMIA</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_inheritance_ambiguity</span><span class="p">(</span>
                <span class="n">all_current_values</span><span class="p">,</span>
                <span class="n">all_initial_values</span><span class="p">,</span>
                <span class="n">in_files</span><span class="p">,</span>
                <span class="n">node_name</span><span class="p">,</span>
                <span class="n">plug_name</span><span class="p">,</span>
                <span class="n">out_file</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Extract final values after ambiguity resolution:</span>
        <span class="c1"># From here if we still have several tags sets, we do not assign them</span>
        <span class="c1"># at all. Otherwise, set them.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_current_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">initial_values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_initial_values</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
            <span class="n">current_values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_current_values</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="c1"># Apply custom tag modifications</span>
        <span class="k">if</span> <span class="n">own_tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_or_modify_tags</span><span class="p">(</span>
                <span class="n">own_tags</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">,</span> <span class="n">field_names</span>
            <span class="p">)</span>

        <span class="c1"># Remove specified tags</span>
        <span class="k">if</span> <span class="n">tags2del</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_tags</span><span class="p">(</span>
                <span class="n">tags2del</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">,</span> <span class="n">out_file</span>
            <span class="p">)</span>

        <span class="c1"># Save updated tag values to database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_tag_values</span><span class="p">(</span><span class="n">rel_out_file</span><span class="p">,</span> <span class="n">current_values</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">)</span></div>
</div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>